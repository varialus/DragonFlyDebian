#DPATCHLEVEL=1
diff -Naur ufsutils.orig/bsdlabel/bsdlabel.c ufsutils.new/bsdlabel/bsdlabel.c
--- ufsutils.orig/bsdlabel/bsdlabel.c	2004-03-31 01:15:03.000000000 +0200
+++ ufsutils.new/bsdlabel/bsdlabel.c	2004-05-21 05:18:50.000000000 +0200
@@ -40,6 +40,8 @@
  *	from: $NetBSD: disksubr.c,v 1.13 2000/12/17 22:39:18 pk $
  */
 
+#define _GNU_SOURCE
+
 #if 0
 #ifndef lint
 static const char copyright[] =
@@ -60,7 +62,9 @@
 #include <sys/file.h>
 #include <sys/stat.h>
 #include <sys/wait.h>
+#if HAVE_BSD_DISKLABEL
 #include <sys/disk.h>
+#endif
 #define DKTYPENAMES
 #define FSTYPENAMES
 #include <sys/disklabel.h>
@@ -68,7 +72,7 @@
 #include <unistd.h>
 #include <string.h>
 #include <stdio.h>
-#include <libgeom.h>
+//#include <libgeom.h>
 #include <stdlib.h>
 #include <signal.h>
 #include <stdarg.h>
@@ -473,8 +477,12 @@
 		err(1, specname);
 	if (is_file)
 		get_file_parms(f);
+#if HAVE_BSD_DISKLABEL
 	else if ((ioctl(f, DIOCGMEDIASIZE, &mediasize) != 0) ||
 	    (ioctl(f, DIOCGSECTORSIZE, &secsize) != 0)) {
+#else
+	else {
+#endif
 		err(4, "cannot get disk geometry");
 	}
 	(void)lseek(f, (off_t)0, SEEK_SET);
@@ -659,10 +667,12 @@
 
 	omask = sigblock(sigmask(SIGINT)|sigmask(SIGQUIT)|sigmask(SIGHUP));
 	while ((pid = fork()) < 0) {
+#if HAVE_BSD_ERRNO
 		if (errno == EPROCLIM) {
 			warnx("you have too many processes");
 			return(0);
 		}
+#endif
 		if (errno != EAGAIN) {
 			warn("fork");
 			return(0);
@@ -1357,8 +1367,12 @@
 
 	if (is_file)
 		get_file_parms(f);
+#if HAVE_BSD_DISKLABEL
 	else if ((ioctl(f, DIOCGMEDIASIZE, &mediasize) != 0) ||
 	    (ioctl(f, DIOCGSECTORSIZE, &secsize) != 0)) {
+#else
+	else {
+#endif
 		close (f);
 		return (NULL);
 	}
@@ -1374,13 +1388,18 @@
 	 * to get any good ideas from the device, construct something
 	 * which is IBM-PC friendly.
 	 */
+#if HAVE_BSD_DISKLABEL
 	if (ioctl(f, DIOCGFWSECTORS, &u) == 0)
 		loclab.d_nsectors = u;
 	else
+#endif
 		loclab.d_nsectors = 63;
+#if HAVE_BSD_DISKLABEL
 	if (ioctl(f, DIOCGFWHEADS, &u) == 0)
 		loclab.d_ntracks = u;
-	else if (loclab.d_secperunit <= 63*1*1024)
+	else
+#endif
+	if (loclab.d_secperunit <= 63*1*1024)
 		loclab.d_ntracks = 1;
 	else if (loclab.d_secperunit <= 63*16*1024)
 		loclab.d_ntracks = 16;
diff -Naur ufsutils.orig/bsdlabel/Makefile ufsutils.new/bsdlabel/Makefile
--- ufsutils.orig/bsdlabel/Makefile	2004-01-11 10:11:10.000000000 +0100
+++ ufsutils.new/bsdlabel/Makefile	2004-05-21 05:10:36.000000000 +0200
@@ -1,26 +1,25 @@
 #	@(#)Makefile	8.2 (Berkeley) 3/17/94
 # $FreeBSD: src/sbin/bsdlabel/Makefile,v 1.19 2004/01/11 09:11:10 nyan Exp $
 
-.PATH: ${.CURDIR}/../../sys/geom
 
-PROG=	bsdlabel
-SRCS=	bsdlabel.c geom_bsd_enc.c
-#MAN=	bsdlabel.5
-MAN+=	bsdlabel.8
-
-.if ${MACHINE_ARCH} == "i386" || ${MACHINE_ARCH} == "alpha" || \
-    ${MACHINE_ARCH} == "amd64"
-LINKS=	${BINDIR}/bsdlabel ${BINDIR}/disklabel
-MLINKS=	bsdlabel.8 disklabel.8
-.endif
+PROG = bsdlabel
+SRCS = bsdlabel.c ../libdisklabel/geom_bsd_enc.c
+MAN = bsdlabel.8:bsdlabel.8
+
+#if ${MACHINE_ARCH} == "i386" || ${MACHINE_ARCH} == "alpha" || \
+#    ${MACHINE_ARCH} == "amd64"
+#LINKS = ${BINDIR}/bsdlabel ${BINDIR}/disklabel
+#MLINKS = bsdlabel.8 disklabel.8
+#endif
 
-DPADD=	${LIBGEOM}
-LDADD=	-lgeom
-
-.include <bsd.prog.mk>
+DPADD = ${LIBGEOM}
+LDADD = -lgeom
 
 test: ${PROG}
-	sh ${.CURDIR}/runtest.sh
+	sh ${CURDIR}/runtest.sh
 
 testx: ${PROG}
-	sh -x ${.CURDIR}/runtest.sh
+	sh -x ${CURDIR}/runtest.sh
+
+include ../Makefile.common
+
