---
 sbin/bsdlabel/Makefile   |   16 ++++++----------
 sbin/bsdlabel/bsdlabel.c |   21 +++++++++++++++++++--
 2 files changed, 25 insertions(+), 12 deletions(-)

--- a/sbin/bsdlabel/bsdlabel.c
+++ b/sbin/bsdlabel/bsdlabel.c
@@ -60,7 +60,9 @@ __FBSDID("$FreeBSD$");
 #include <sys/file.h>
 #include <sys/stat.h>
 #include <sys/wait.h>
+#if HAVE_BSD_DISKLABEL
 #include <sys/disk.h>
+#endif
 #define DKTYPENAMES
 #define FSTYPENAMES
 #include <sys/disklabel.h>
@@ -68,7 +70,7 @@ __FBSDID("$FreeBSD$");
 #include <unistd.h>
 #include <string.h>
 #include <stdio.h>
-#include <libgeom.h>
+//#include <libgeom.h>
 #include <stdlib.h>
 #include <signal.h>
 #include <stdarg.h>
@@ -476,8 +478,12 @@ readlabel(int flag)
 		err(1, specname);
 	if (is_file)
 		get_file_parms(f);
+#if HAVE_BSD_DISKLABEL
 	else if ((ioctl(f, DIOCGMEDIASIZE, &mediasize) != 0) ||
 	    (ioctl(f, DIOCGSECTORSIZE, &secsize) != 0)) {
+#else
+	else {
+#endif
 		err(4, "cannot get disk geometry");
 	}
 	if (mediasize > (off_t)0xffffffff * secsize)
@@ -665,10 +671,12 @@ editit(void)
 
 	omask = sigblock(sigmask(SIGINT)|sigmask(SIGQUIT)|sigmask(SIGHUP));
 	while ((pid = fork()) < 0) {
+#if HAVE_BSD_ERRNO
 		if (errno == EPROCLIM) {
 			warnx("you have too many processes");
 			return(0);
 		}
+#endif
 		if (errno != EAGAIN) {
 			warn("fork");
 			return(0);
@@ -1426,8 +1434,12 @@ getvirginlabel(void)
 
 	if (is_file)
 		get_file_parms(f);
+#if HAVE_BSD_DISKLABEL
 	else if ((ioctl(f, DIOCGMEDIASIZE, &mediasize) != 0) ||
 	    (ioctl(f, DIOCGSECTORSIZE, &secsize) != 0)) {
+#else
+	else {
+#endif
 		close (f);
 		return (NULL);
 	}
@@ -1443,13 +1455,18 @@ getvirginlabel(void)
 	 * to get any good ideas from the device, construct something
 	 * which is IBM-PC friendly.
 	 */
+#if HAVE_BSD_DISKLABEL
 	if (ioctl(f, DIOCGFWSECTORS, &u) == 0)
 		loclab.d_nsectors = u;
 	else
+#endif
 		loclab.d_nsectors = 63;
+#if HAVE_BSD_DISKLABEL
 	if (ioctl(f, DIOCGFWHEADS, &u) == 0)
 		loclab.d_ntracks = u;
-	else if (loclab.d_secperunit <= 63*1*1024)
+	else
+#endif
+	if (loclab.d_secperunit <= 63*1*1024)
 		loclab.d_ntracks = 1;
 	else if (loclab.d_secperunit <= 63*16*1024)
 		loclab.d_ntracks = 16;
--- a/sbin/bsdlabel/Makefile
+++ b/sbin/bsdlabel/Makefile
@@ -4,14 +4,8 @@
 .PATH: ${.CURDIR}/../../sys/geom
 
 PROG=	bsdlabel
-SRCS=	bsdlabel.c geom_bsd_enc.c
-#MAN=	bsdlabel.5
-MAN+=	bsdlabel.8
-
-.if ${MACHINE_ARCH} == "i386" || ${MACHINE_ARCH} == "amd64"
-LINKS=	${BINDIR}/bsdlabel ${BINDIR}/disklabel
-MLINKS=	bsdlabel.8 disklabel.8
-.endif
+SRCS=	bsdlabel.c ../../libdisklabel/geom_bsd_enc.c
+MAN = bsdlabel.8:bsdlabel.8
 
 DPADD=	${LIBGEOM}
 LDADD=	-lgeom
@@ -19,7 +13,9 @@ LDADD=	-lgeom
 .include <bsd.prog.mk>
 
 test: ${PROG}
-	sh ${.CURDIR}/runtest.sh
+	sh ${CURDIR}/runtest.sh
 
 testx: ${PROG}
-	sh -x ${.CURDIR}/runtest.sh
+	sh -x ${CURDIR}/runtest.sh
+
+include ../../Makefile.common
