diff -ur src.old/sys/cam/scsi/scsi_low.c src/sys/cam/scsi/scsi_low.c
--- src.old/sys/cam/scsi/scsi_low.c	2003-06-15 00:17:38.000000000 +0200
+++ src/sys/cam/scsi/scsi_low.c	2005-04-05 14:11:39.000000000 +0200
@@ -18,9 +18,9 @@
 #define	SCSI_LOW_TARGET_OPEN
 #endif	/* __NetBSD__ */
 
-#ifdef	__FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define	SCSI_LOW_FLAGS_QUIRKS_OK
-#endif	/* __FreeBSD__ */
+#endif	/* 5 */
 
 /*
  * [NetBSD for NEC PC-98 series]
@@ -72,13 +72,13 @@
 #include <sys/systm.h>
 #include <sys/kernel.h>
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #if __FreeBSD_version >= 500001
 #include <sys/bio.h>
 #else
 #include <machine/clock.h>
 #endif
-#endif	/* __FreeBSD__ */
+#endif	/* 5 */
 
 #include <sys/buf.h>
 #include <sys/queue.h>
@@ -86,7 +86,7 @@
 #include <sys/errno.h>
 
 #ifdef	__NetBSD__
-#include <sys/device.h>
+
 #include <vm/vm.h>
 
 #include <machine/bus.h>
@@ -105,7 +105,7 @@
 #include <i386/Cbus/dev/scsi_low.h>
 #endif	/* __NetBSD__ */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <cam/cam.h>
 #include <cam/cam_ccb.h>
 #include <cam/cam_sim.h>
@@ -118,7 +118,7 @@
 #include <cam/scsi/scsi_low.h>
 
 #include <sys/cons.h>
-#endif	/* __FreeBSD__ */
+#endif	/* 5 */
 
 /**************************************************************
  * Constants
diff -ur src.old/sys/cam/scsi/scsi_low.h src/sys/cam/scsi/scsi_low.h
--- src.old/sys/cam/scsi/scsi_low.h	2004-07-10 22:54:01.000000000 +0200
+++ src/sys/cam/scsi/scsi_low.h	2005-04-05 14:11:40.000000000 +0200
@@ -53,10 +53,10 @@
 #define	SCSI_LOW_INTERFACE_XS
 #endif	/* __NetBSD__ */
 
-#ifdef	__FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define	SCSI_LOW_INTERFACE_CAM
 #define	CAM
-#endif	/* __FreeBSD__ */
+#endif	/* 5 */
 
 /******** includes *******************************/
 #ifdef	__NetBSD__
@@ -64,7 +64,7 @@
 #include <dev/isa/ccbque.h>
 #endif	/* __NetBSD__ */
 
-#ifdef	__FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <sys/device_port.h>
 #include <sys/kdb.h>
 #include <cam/cam.h>
@@ -75,7 +75,7 @@
 
 #include <cam/scsi/scsi_dvcfg.h>
 #include <i386/isa/ccbque.h>
-#endif	/* __FreeBSD__ */
+#endif	/* 5 */
 
 /******** functions macro ************************/
 #ifdef	__NetBSD__
@@ -85,13 +85,13 @@
 #define	SCSI_LOW_BZERO(pt, size)	memset((pt), 0, (size))
 #endif	/* __NetBSD__ */
 
-#ifdef	__FreeBSD__
+#ifdef __FreeBSD_kernel__
 #undef	MSG_IDENTIFY
 #define	SCSI_LOW_DEBUGGER(dev)	kdb_enter(dev)
 #define	SCSI_LOW_DELAY(mu)	DELAY((mu))
 #define	SCSI_LOW_SPLSCSI	splcam
 #define	SCSI_LOW_BZERO(pt, size)	bzero((pt), (size))
-#endif	/* __FreeBSD__ */
+#endif	/* 5 */
 
 /******** os depend interface structures **********/
 #ifdef	__NetBSD__
@@ -111,7 +111,7 @@
 };
 #endif	/* __NetBSD__ */
 
-#ifdef	__FreeBSD__
+#ifdef __FreeBSD_kernel__
 typedef	struct scsi_sense_data scsi_low_osdep_sense_data_t;
 
 struct scsi_low_osdep_interface {
@@ -134,7 +134,7 @@
 
 struct scsi_low_osdep_lun_interface {
 };
-#endif	/* __FreeBSD__ */
+#endif	/* 5 */
 
 /******** os depend interface functions *************/
 struct slccb;
diff -ur src.old/sys/cam/scsi/scsi_low_pisa.c src/sys/cam/scsi/scsi_low_pisa.c
--- src.old/sys/cam/scsi/scsi_low_pisa.c	2003-06-10 20:14:05.000000000 +0200
+++ src/sys/cam/scsi/scsi_low_pisa.c	2005-04-05 14:11:39.000000000 +0200
@@ -38,7 +38,7 @@
 #include <sys/param.h>
 #include <sys/systm.h>
 #include <sys/kernel.h>
-#include <sys/device.h>
+
 #include <sys/errno.h>
 
 #include <machine/bus.h>
@@ -117,7 +117,7 @@
 }
 #endif	/* __NetBSD__ */
 
-#ifdef	__FreeBSD__ 
+#ifdef __FreeBSD_kernel__ 
 #include <sys/param.h>
 #include <sys/systm.h>
 #include <sys/kernel.h>
@@ -165,4 +165,4 @@
 DECLARE_MODULE(scsi_low, scsi_low_moduledata, SI_SUB_DRIVERS, SI_ORDER_MIDDLE);
 MODULE_VERSION(scsi_low, 1);
 MODULE_DEPEND(scsi_low, cam, 1, 1, 1);
-#endif	/* __FreeBSD__ */
+#endif	/* 5 */
diff -ur src.old/sys/cam/scsi/scsi_low_pisa.h src/sys/cam/scsi/scsi_low_pisa.h
--- src.old/sys/cam/scsi/scsi_low_pisa.h	2002-03-20 09:55:22.000000000 +0100
+++ src/sys/cam/scsi/scsi_low_pisa.h	2005-04-05 14:11:40.000000000 +0200
@@ -40,8 +40,8 @@
 int scsi_low_notify_pisa(pisa_device_handle_t, pisa_event_t);
 #endif	/* __NetBSD__ */
 
-#ifdef	__FreeBSD__
+#ifdef __FreeBSD_kernel__
 int scsi_low_activate_pisa(struct scsi_low_softc *, int);
 int scsi_low_deactivate_pisa(struct scsi_low_softc *);
-#endif	/* __FreeBSD__ */
+#endif	/* 5 */
 #endif	/* !_SCSI_LOW_PISA_H_ */
diff -ur src.old/sys/compat/svr4/svr4_misc.c src/sys/compat/svr4/svr4_misc.c
--- src.old/sys/compat/svr4/svr4_misc.c	2004-03-17 21:00:00.000000000 +0100
+++ src/sys/compat/svr4/svr4_misc.c	2005-04-05 14:11:50.000000000 +0200
@@ -85,7 +85,7 @@
 #include <vm/vm.h>
 #include <vm/vm_param.h>
 #include <vm/vm_map.h>
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #include <vm/uma.h>
 #include <vm/vm_extern.h>
 #endif
@@ -1351,7 +1351,7 @@
 #if defined(__NetBSD__)
 			pool_put(&proc_pool, q);
 #endif
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			mtx_destroy(&q->p_mtx);
 #ifdef MAC
                         mac_destroy_proc(q);
diff -ur src.old/sys/contrib/altq/altq/altq_cbq.c src/sys/contrib/altq/altq/altq_cbq.c
--- src.old/sys/contrib/altq/altq/altq_cbq.c	2004-06-12 02:57:20.000000000 +0200
+++ src/sys/contrib/altq/altq/altq_cbq.c	2005-04-05 14:11:55.000000000 +0200
@@ -31,15 +31,15 @@
  * These notices must be retained in any copies of any part of this software.
  */
 
-#if defined(__FreeBSD__) || defined(__NetBSD__)
+#if defined(__FreeBSD_kernel__) || defined(__NetBSD__)
 #include "opt_altq.h"
-#if (__FreeBSD__ != 2)
+#if (5 != 2)
 #include "opt_inet.h"
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include "opt_inet6.h"
 #endif
 #endif
-#endif /* __FreeBSD__ || __NetBSD__ */
+#endif /* 5 || __NetBSD__ */
 #ifdef ALTQ_CBQ	/* cbq is enabled by ALTQ_CBQ option in opt_altq.h */
 
 #include <sys/param.h>
@@ -509,7 +509,7 @@
 	if ((m->m_flags & M_PKTHDR) == 0) {
 		/* should not happen */
 #if defined(__NetBSD__) || defined(__OpenBSD__)\
-    || (defined(__FreeBSD__) && __FreeBSD_version >= 501113)
+    || (defined(__FreeBSD_kernel__) && __FreeBSD_version >= 501113)
 		printf("altq: packet for %s does not have pkthdr\n",
 		    ifq->altq_ifp->if_xname);
 #else
@@ -1028,7 +1028,7 @@
 	while (cbq_list) {
 		ifp = cbq_list->ifnp.ifq_->altq_ifp;
 #if defined(__NetBSD__) || defined(__OpenBSD__)\
-    || (defined(__FreeBSD__) && __FreeBSD_version >= 501113)
+    || (defined(__FreeBSD_kernel__) && __FreeBSD_version >= 501113)
 		sprintf(iface.cbq_ifacename, "%s", ifp->if_xname);
 #else
 		sprintf(iface.cbq_ifacename,
diff -ur src.old/sys/contrib/altq/altq/altq_cdnr.c src/sys/contrib/altq/altq/altq_cdnr.c
--- src.old/sys/contrib/altq/altq/altq_cdnr.c	2004-06-12 02:57:20.000000000 +0200
+++ src/sys/contrib/altq/altq/altq_cdnr.c	2005-04-05 14:11:55.000000000 +0200
@@ -27,15 +27,15 @@
  * SUCH DAMAGE.
  */
 
-#if defined(__FreeBSD__) || defined(__NetBSD__)
+#if defined(__FreeBSD_kernel__) || defined(__NetBSD__)
 #include "opt_altq.h"
-#if (__FreeBSD__ != 2)
+#if (5 != 2)
 #include "opt_inet.h"
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include "opt_inet6.h"
 #endif
 #endif
-#endif /* __FreeBSD__ || __NetBSD__ */
+#endif /* 5 || __NetBSD__ */
 
 #include <sys/param.h>
 #include <sys/malloc.h>
diff -ur src.old/sys/contrib/altq/altq/altq_hfsc.c src/sys/contrib/altq/altq/altq_hfsc.c
--- src.old/sys/contrib/altq/altq/altq_hfsc.c	2004-06-12 02:57:20.000000000 +0200
+++ src/sys/contrib/altq/altq/altq_hfsc.c	2005-04-05 14:11:56.000000000 +0200
@@ -42,15 +42,15 @@
  * a class whose fit-time exceeds the current time.
  */
 
-#if defined(__FreeBSD__) || defined(__NetBSD__)
+#if defined(__FreeBSD_kernel__) || defined(__NetBSD__)
 #include "opt_altq.h"
-#if (__FreeBSD__ != 2)
+#if (5 != 2)
 #include "opt_inet.h"
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include "opt_inet6.h"
 #endif
 #endif
-#endif /* __FreeBSD__ || __NetBSD__ */
+#endif /* 5 || __NetBSD__ */
 
 #ifdef ALTQ_HFSC  /* hfsc is enabled by ALTQ_HFSC option in opt_altq.h */
 
@@ -702,7 +702,7 @@
 	if ((m->m_flags & M_PKTHDR) == 0) {
 		/* should not happen */
 #if defined(__NetBSD__) || defined(__OpenBSD__)\
-    || (defined(__FreeBSD__) && __FreeBSD_version >= 501113)
+    || (defined(__FreeBSD_kernel__) && __FreeBSD_version >= 501113)
 		printf("altq: packet for %s does not have pkthdr\n",
 		    ifq->altq_ifp->if_xname);
 #else
diff -ur src.old/sys/contrib/altq/altq/altq_priq.c src/sys/contrib/altq/altq/altq_priq.c
--- src.old/sys/contrib/altq/altq/altq_priq.c	2004-06-12 02:57:20.000000000 +0200
+++ src/sys/contrib/altq/altq/altq_priq.c	2005-04-05 14:11:56.000000000 +0200
@@ -29,15 +29,15 @@
  * priority queue
  */
 
-#if defined(__FreeBSD__) || defined(__NetBSD__)
+#if defined(__FreeBSD_kernel__) || defined(__NetBSD__)
 #include "opt_altq.h"
-#if (__FreeBSD__ != 2)
+#if (5 != 2)
 #include "opt_inet.h"
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include "opt_inet6.h"
 #endif
 #endif
-#endif /* __FreeBSD__ || __NetBSD__ */
+#endif /* 5 || __NetBSD__ */
 
 #ifdef ALTQ_PRIQ  /* priq is enabled by ALTQ_PRIQ option in opt_altq.h */
 
@@ -470,7 +470,7 @@
 	if ((m->m_flags & M_PKTHDR) == 0) {
 		/* should not happen */
 #if defined(__NetBSD__) || defined(__OpenBSD__)\
-    || (defined(__FreeBSD__) && __FreeBSD_version >= 501113)
+    || (defined(__FreeBSD_kernel__) && __FreeBSD_version >= 501113)
 		printf("altq: packet for %s does not have pkthdr\n",
 		    ifq->altq_ifp->if_xname);
 #else
diff -ur src.old/sys/contrib/altq/altq/altq_red.c src/sys/contrib/altq/altq/altq_red.c
--- src.old/sys/contrib/altq/altq/altq_red.c	2004-06-12 02:57:20.000000000 +0200
+++ src/sys/contrib/altq/altq/altq_red.c	2005-04-05 14:11:56.000000000 +0200
@@ -60,15 +60,15 @@
  * SUCH DAMAGE.
  */
 
-#if defined(__FreeBSD__) || defined(__NetBSD__)
+#if defined(__FreeBSD_kernel__) || defined(__NetBSD__)
 #include "opt_altq.h"
-#if (__FreeBSD__ != 2)
+#if (5 != 2)
 #include "opt_inet.h"
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include "opt_inet6.h"
 #endif
 #endif
-#endif /* __FreeBSD__ || __NetBSD__ */
+#endif /* 5 || __NetBSD__ */
 #ifdef ALTQ_RED	/* red is enabled by ALTQ_RED option in opt_altq.h */
 
 #include <sys/param.h>
diff -ur src.old/sys/contrib/altq/altq/altq_rio.c src/sys/contrib/altq/altq/altq_rio.c
--- src.old/sys/contrib/altq/altq/altq_rio.c	2004-06-12 02:57:20.000000000 +0200
+++ src/sys/contrib/altq/altq/altq_rio.c	2005-04-05 14:11:56.000000000 +0200
@@ -59,15 +59,15 @@
  * SUCH DAMAGE.
  */
 
-#if defined(__FreeBSD__) || defined(__NetBSD__)
+#if defined(__FreeBSD_kernel__) || defined(__NetBSD__)
 #include "opt_altq.h"
-#if (__FreeBSD__ != 2)
+#if (5 != 2)
 #include "opt_inet.h"
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include "opt_inet6.h"
 #endif
 #endif
-#endif /* __FreeBSD__ || __NetBSD__ */
+#endif /* 5 || __NetBSD__ */
 #ifdef ALTQ_RIO	/* rio is enabled by ALTQ_RIO option in opt_altq.h */
 
 #include <sys/param.h>
diff -ur src.old/sys/contrib/altq/altq/altq_rmclass.c src/sys/contrib/altq/altq/altq_rmclass.c
--- src.old/sys/contrib/altq/altq/altq_rmclass.c	2004-06-12 02:57:20.000000000 +0200
+++ src/sys/contrib/altq/altq/altq_rmclass.c	2005-04-05 14:11:56.000000000 +0200
@@ -39,15 +39,15 @@
 
 #ident "@(#)rm_class.c  1.48     97/12/05 SMI"
 
-#if defined(__FreeBSD__) || defined(__NetBSD__)
+#if defined(__FreeBSD_kernel__) || defined(__NetBSD__)
 #include "opt_altq.h"
-#if (__FreeBSD__ != 2)
+#if (5 != 2)
 #include "opt_inet.h"
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include "opt_inet6.h"
 #endif
 #endif
-#endif /* __FreeBSD__ || __NetBSD__ */
+#endif /* 5 || __NetBSD__ */
 #ifdef ALTQ_CBQ	/* cbq is enabled by ALTQ_CBQ option in opt_altq.h */
 
 #include <sys/param.h>
@@ -1536,7 +1536,7 @@
 		 * a 'backstop' to restart this class.
 		 */
 		if (delay > tick * 2) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			/* FreeBSD rounds up the tick */
 			t = hzto(&cl->undertime_);
 #else
diff -ur src.old/sys/contrib/altq/altq/altq_subr.c src/sys/contrib/altq/altq/altq_subr.c
--- src.old/sys/contrib/altq/altq/altq_subr.c	2004-06-16 01:59:37.000000000 +0200
+++ src/sys/contrib/altq/altq/altq_subr.c	2005-04-05 14:11:57.000000000 +0200
@@ -27,15 +27,15 @@
  * SUCH DAMAGE.
  */
 
-#if defined(__FreeBSD__) || defined(__NetBSD__)
+#if defined(__FreeBSD_kernel__) || defined(__NetBSD__)
 #include "opt_altq.h"
-#if (__FreeBSD__ != 2)
+#if (5 != 2)
 #include "opt_inet.h"
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include "opt_inet6.h"
 #endif
 #endif
-#endif /* __FreeBSD__ || __NetBSD__ */
+#endif /* 5 || __NetBSD__ */
 
 #include <sys/param.h>
 #include <sys/malloc.h>
@@ -70,8 +70,8 @@
 #endif
 
 /* machine dependent clock related includes */
-#ifdef __FreeBSD__
-#if __FreeBSD__ < 3
+#ifdef __FreeBSD_kernel__
+#if 5 < 3
 #include "opt_cpu.h"	/* for FreeBSD-2.2.8 to get i586_ctr_freq */
 #endif
 #include <machine/clock.h>
@@ -79,7 +79,7 @@
 #if defined(__i386__)
 #include <machine/cpufunc.h>		/* for pentium tsc */
 #include <machine/specialreg.h>		/* for CPUID_TSC */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <machine/md_var.h>		/* for cpu_feature */
 #elif defined(__NetBSD__) || defined(__OpenBSD__)
 #include <machine/cpu.h>		/* for cpu_feature */
@@ -450,7 +450,7 @@
 #else
 	s = splimp();
 #endif
-#if defined(__FreeBSD__) && (__FreeBSD_version >= 500000)
+#if defined(__FreeBSD_kernel__) && (__FreeBSD_version >= 500000)
 	IFNET_RLOCK();
 #endif
 	for (ifp = TAILQ_FIRST(&ifnet); ifp; ifp = TAILQ_NEXT(ifp, if_list)) {
@@ -461,7 +461,7 @@
 		if (!IFQ_IS_EMPTY(&ifp->if_snd) && ifp->if_start != NULL)
 			(*ifp->if_start)(ifp);
 	}
-#if defined(__FreeBSD__) && (__FreeBSD_version >= 500000)
+#if defined(__FreeBSD_kernel__) && (__FreeBSD_version >= 500000)
 	IFNET_RUNLOCK();
 #endif
 	splx(s);
@@ -884,7 +884,7 @@
 u_int32_t machclk_per_tick = 0;
 
 #ifdef __alpha__
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 extern u_int32_t cycles_per_sec;	/* alpha cpu clock frequency */
 #elif defined(__NetBSD__) || defined(__OpenBSD__)
 extern u_int64_t cycles_per_usec;	/* alpha cpu clock frequency */
@@ -902,7 +902,7 @@
 #if (!defined(__i386__) && !defined(__alpha__)) || defined(ALTQ_NOPCC)
 	machclk_usepcc = 0;
 #endif
-#if defined(__FreeBSD__) && defined(SMP)
+#if defined(__FreeBSD_kernel__) && defined(SMP)
 	machclk_usepcc = 0;
 #endif
 #if defined(__NetBSD__) && defined(MULTIPROCESSOR)
@@ -929,7 +929,7 @@
 	 * accessible, just use it.
 	 */
 #ifdef __i386__
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #if (__FreeBSD_version > 300000)
 	machclk_freq = tsc_freq;
 #else
@@ -941,7 +941,7 @@
 	machclk_freq = pentium_mhz * 1000000;
 #endif
 #elif defined(__alpha__)
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	machclk_freq = cycles_per_sec;
 #elif defined(__NetBSD__) || defined(__OpenBSD__)
 	machclk_freq = (u_int32_t)(cycles_per_usec * 1000000);
diff -ur src.old/sys/contrib/altq/altq/altq_var.h src/sys/contrib/altq/altq/altq_var.h
--- src.old/sys/contrib/altq/altq/altq_var.h	2004-06-12 02:09:55.000000000 +0200
+++ src/sys/contrib/altq/altq/altq_var.h	2005-04-05 14:11:57.000000000 +0200
@@ -140,7 +140,7 @@
  * misc stuff for compatibility
  */
 /* ioctl cmd type */
-#if defined(__FreeBSD__) && (__FreeBSD__ < 3)
+#if defined(__FreeBSD_kernel__) && (5 < 3)
 typedef int ioctlcmd_t;
 #else
 typedef u_long ioctlcmd_t;
@@ -204,7 +204,7 @@
 #define	CALLOUT_STOP(c)		untimeout((c)->c_func,(c)->c_arg)
 #define	CALLOUT_INITIALIZER	{ NULL, NULL }
 #endif
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 typedef void (timeout_t)(void *);
 #endif
 
diff -ur src.old/sys/contrib/altq/altq/if_altq.h src/sys/contrib/altq/altq/if_altq.h
--- src.old/sys/contrib/altq/altq/if_altq.h	2004-06-15 03:45:19.000000000 +0200
+++ src/sys/contrib/altq/altq/if_altq.h	2005-04-05 14:11:57.000000000 +0200
@@ -29,7 +29,7 @@
 #ifndef _ALTQ_IF_ALTQ_H_
 #define	_ALTQ_IF_ALTQ_H_
 
-#if (defined(__FreeBSD__) && __FreeBSD_version >= 500000)
+#if (defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500000)
 #include <sys/lock.h>		/* XXX */
 #include <sys/mutex.h>		/* XXX */
 #include <sys/event.h>		/* XXX */
@@ -51,7 +51,7 @@
 	int	ifq_len;
 	int	ifq_maxlen;
 	int	ifq_drops;
-#if (defined(__FreeBSD__) && __FreeBSD_version >= 500000)
+#if (defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500000)
 	struct	mtx ifq_mtx;
 #endif
 
diff -ur src.old/sys/contrib/dev/acpica/acenv.h src/sys/contrib/dev/acpica/acenv.h
--- src.old/sys/contrib/dev/acpica/acenv.h	2004-05-25 04:39:01.000000000 +0200
+++ src/sys/contrib/dev/acpica/acenv.h	2005-04-05 14:11:58.000000000 +0200
@@ -204,7 +204,7 @@
 #elif defined(MSDOS)        /* Must appear after WIN32 and WIN64 check */
 #include "acdos16.h"
 
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 #include "acfreebsd.h"
 
 #elif defined(__NetBSD__)
diff -ur src.old/sys/contrib/ipfilter/netinet/fil.c src/sys/contrib/ipfilter/netinet/fil.c
--- src.old/sys/contrib/ipfilter/netinet/fil.c	2004-06-29 05:39:06.000000000 +0200
+++ src/sys/contrib/ipfilter/netinet/fil.c	2005-04-05 14:12:20.000000000 +0200
@@ -897,7 +897,7 @@
 	int up;
 
 #  if !defined(NETBSD_PF) && \
-      ((defined(__FreeBSD__) && (__FreeBSD_version < 500011)) || \
+      ((defined(__FreeBSD_kernel__) && (__FreeBSD_version < 500011)) || \
        defined(__OpenBSD__) || defined(_BSDI_VERSION))
 	if (fr_checkp != fr_check && fr_running > 0) {
 		static int counter = 0;
@@ -1051,7 +1051,7 @@
 	fin->fin_out = out;
 #endif /* _KERNEL */
 	
-#ifndef __FreeBSD__
+#ifndef __FreeBSD_kernel__
 	/*
 	 * Be careful here: ip_id is in network byte order when called
 	 * from ip_output()
@@ -1305,7 +1305,7 @@
 	}
 #endif /* IPFILTER_LOG */
 
-#ifndef __FreeBSD__	
+#ifndef __FreeBSD_kernel__	
 	if ((out) && (v == 4))
 		ip->ip_id = htons(ip->ip_id);
 #endif
diff -ur src.old/sys/contrib/ipfilter/netinet/ip_auth.c src/sys/contrib/ipfilter/netinet/ip_auth.c
--- src.old/sys/contrib/ipfilter/netinet/ip_auth.c	2004-06-22 07:20:30.000000000 +0200
+++ src/sys/contrib/ipfilter/netinet/ip_auth.c	2005-04-05 14:12:20.000000000 +0200
@@ -91,7 +91,7 @@
 #include "netinet/ip_auth.h"
 #if !SOLARIS && !defined(linux)
 # include <net/netisr.h>
-# ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #  include <machine/cpufunc.h>
 # endif
 #endif
@@ -283,7 +283,7 @@
 
 		bo = ip->ip_len;
 		ip->ip_len = htons(bo);
-# if !SOLARIS && !defined(__NetBSD__) && !defined(__FreeBSD__)
+# if !SOLARIS && !defined(__NetBSD__) && !defined(__FreeBSD_kernel__)
 		/* 4.4BSD converts this ip_input.c, but I don't in solaris.c */
 		bo = ip->ip_id;
 		ip->ip_id = htons(bo);
diff -ur src.old/sys/contrib/ipfilter/netinet/ip_compat.h src/sys/contrib/ipfilter/netinet/ip_compat.h
--- src.old/sys/contrib/ipfilter/netinet/ip_compat.h	2004-06-22 00:46:35.000000000 +0200
+++ src/sys/contrib/ipfilter/netinet/ip_compat.h	2005-04-05 14:12:21.000000000 +0200
@@ -216,7 +216,7 @@
 #endif /* BSD > 199306 */
 
 
-#if defined(__FreeBSD__) && (defined(KERNEL) || defined(_KERNEL))
+#if defined(__FreeBSD_kernel__) && (defined(KERNEL) || defined(_KERNEL))
 # include <sys/param.h>
 # ifndef __FreeBSD_version
 #  ifdef IPFILTER_LKM
@@ -237,7 +237,7 @@
 #   endif
 #  endif
 # endif
-#endif /* __FreeBSD__ && KERNEL */
+#endif /* 5 && KERNEL */
 
 #if defined(__FreeBSD_version) && (__FreeBSD_version >= 500000) && \
     defined(_KERNEL)
@@ -247,7 +247,7 @@
 /*
  * These operating systems already take care of the problem for us.
  */
-#if defined(__NetBSD__) || defined(__OpenBSD__) || defined(__FreeBSD__) || \
+#if defined(__NetBSD__) || defined(__OpenBSD__) || defined(__FreeBSD_kernel__) || \
     defined(__sgi)
 typedef u_int32_t       u_32_t;
 # if defined(_KERNEL) && !defined(IPFILTER_LKM)
@@ -283,10 +283,10 @@
 typedef unsigned int	u_32_t;
 #  endif
 # endif
-#endif /* __NetBSD__ || __OpenBSD__ || __FreeBSD__ || __sgi */
+#endif /* __NetBSD__ || __OpenBSD__ || 5 || __sgi */
 
 #ifdef	USE_INET6
-# if defined(__NetBSD__) || defined(__OpenBSD__) || defined(__FreeBSD__)
+# if defined(__NetBSD__) || defined(__OpenBSD__) || defined(__FreeBSD_kernel__)
 #  include <netinet/ip6.h>
 #  ifdef	_KERNEL
 #   include <netinet6/ip6_var.h>
@@ -547,7 +547,7 @@
 #   define	GETUNIT(n, v)	ifunit(n)
 #   if (defined(NetBSD) && (NetBSD <= 1991011) && (NetBSD >= 199606)) || \
         (defined(OpenBSD) && (OpenBSD >= 199603)) || \
-	(defined(__FreeBSD__) && (__FreeBSD_version >= 501113))
+	(defined(__FreeBSD_kernel__) && (__FreeBSD_version >= 501113))
 #    define	IFNAME(x)	((struct ifnet *)x)->if_xname
 #   else
 #    define	USE_GETIFNAME	1
@@ -584,13 +584,13 @@
 # ifndef	GET_MINOR
 #  define	GET_MINOR(x)	minor(x)
 # endif
-# if (BSD >= 199306) || defined(__FreeBSD__)
+# if (BSD >= 199306) || defined(__FreeBSD_kernel__)
 #  if (defined(__NetBSD_Version__) && (__NetBSD_Version__ < 105180000)) || \
-       defined(__FreeBSD__) || (defined(OpenBSD) && (OpenBSD < 200206)) || \
+       defined(__FreeBSD_kernel__) || (defined(OpenBSD) && (OpenBSD < 200206)) || \
        defined(_BSDI_VERSION)
 #   include <vm/vm.h>
 #  endif
-#  if !defined(__FreeBSD__) || (defined (__FreeBSD_version) && \
+#  if !defined(__FreeBSD_kernel__) || (defined (__FreeBSD_version) && \
       (__FreeBSD_version >= 300000))
 #   if (defined(__NetBSD_Version__) && (__NetBSD_Version__ >= 105180000)) || \
        (defined(OpenBSD) && (OpenBSD >= 200111))
@@ -600,9 +600,9 @@
 extern	vm_map_t	kmem_map;
 #   endif
 #   include <sys/proc.h>
-#  else /* !__FreeBSD__ || (__FreeBSD__ && __FreeBSD_version >= 300000) */
+#  else /* !5 || (5 && __FreeBSD_version >= 300000) */
 #   include <vm/vm_kern.h>
-#  endif /* !__FreeBSD__ || (__FreeBSD__ && __FreeBSD_version >= 300000) */
+#  endif /* !5 || (5 && __FreeBSD_version >= 300000) */
 #  ifdef	M_PFIL
 #   define	KMALLOC(a, b)	MALLOC((a), b, sizeof(*(a)), M_PFIL, M_NOWAIT)
 #   define	KMALLOCS(a, b, c)	MALLOC((a), b, (c), M_PFIL, M_NOWAIT)
diff -ur src.old/sys/contrib/ipfilter/netinet/ip_fil.c src/sys/contrib/ipfilter/netinet/ip_fil.c
--- src.old/sys/contrib/ipfilter/netinet/ip_fil.c	2004-10-03 19:04:38.000000000 +0200
+++ src/sys/contrib/ipfilter/netinet/ip_fil.c	2005-04-05 14:12:21.000000000 +0200
@@ -20,7 +20,7 @@
     defined(_KERNEL)  && !defined(_LKM)
 # include "opt_ipfilter_log.h"
 #endif
-#if defined(__FreeBSD__) && !defined(__FreeBSD_version)
+#if defined(__FreeBSD_kernel__) && !defined(__FreeBSD_version)
 # if !defined(_KERNEL) || defined(IPFILTER_LKM)
 #  include <osreldate.h>
 # endif
@@ -213,7 +213,7 @@
 #endif
 
 #if (_BSDI_VERSION >= 199510) && defined(_KERNEL)
-# include <sys/device.h>
+
 # include <sys/conf.h>
 
 struct cfdriver iplcd = {
@@ -1805,7 +1805,7 @@
 	 */
 	if (ip->ip_len <= ifp->if_mtu) {
 # ifndef sparc
-#  if (!defined(__FreeBSD__) && !(_BSDI_VERSION >= 199510)) && \
+#  if (!defined(__FreeBSD_kernel__) && !(_BSDI_VERSION >= 199510)) && \
       !(__NetBSD_Version__ >= 105110000)
 		ip->ip_id = htons(ip->ip_id);
 #  endif
@@ -2057,7 +2057,7 @@
 	if (ifp == NULL)
 		return -2;
 
-#if defined(__FreeBSD__) || defined(__NetBSD__) || defined(__OpenBSD__)
+#if defined(__FreeBSD_kernel__) || defined(__NetBSD__) || defined(__OpenBSD__)
 	/* KAME */
 	if (IN6_IS_ADDR_LINKLOCAL(&dst6->sin6_addr))
 		dst6->sin6_addr.s6_addr16[1] = htons(ifp->if_index);
@@ -2144,7 +2144,7 @@
 
 # if (defined(NetBSD) && (NetBSD <= 1991011) && (NetBSD >= 199606)) || \
 	(defined(OpenBSD) && (OpenBSD >= 199603)) || \
-	(defined(__FreeBSD__) && (__FreeBSD_version >= 501113))
+	(defined(__FreeBSD_kernel__) && (__FreeBSD_version >= 501113))
 	sprintf(fname, "%s", ifp->if_xname);
 # else
 	sprintf(fname, "%s%d", ifp->if_name, ifp->if_unit);
@@ -2165,7 +2165,7 @@
 {
 # if (defined(NetBSD) && (NetBSD <= 1991011) && (NetBSD >= 199606)) || \
      (defined(OpenBSD) && (OpenBSD >= 199603)) || \
-     (defined(__FreeBSD__) && (__FreeBSD_version >= 501113))
+     (defined(__FreeBSD_kernel__) && (__FreeBSD_version >= 501113))
 	return ifp->if_xname;
 # else
 	static char fullifname[LIFNAMSIZ];
@@ -2185,7 +2185,7 @@
 	for (ifa = ifneta; ifa && (ifp = *ifa); ifa++) {
 # if (defined(NetBSD) && (NetBSD <= 1991011) && (NetBSD >= 199606)) || \
      (defined(OpenBSD) && (OpenBSD >= 199603)) || \
-     (defined(__FreeBSD__) && (__FreeBSD_version >= 501113))
+     (defined(__FreeBSD_kernel__) && (__FreeBSD_version >= 501113))
 		if (!strncmp(ifname, ifp->if_xname, sizeof(ifp->if_xname)))
 # else
 		char fullname[LIFNAMSIZ];
@@ -2228,7 +2228,7 @@
 
 # if (defined(NetBSD) && (NetBSD <= 1991011) && (NetBSD >= 199606)) || \
      (defined(OpenBSD) && (OpenBSD >= 199603)) || \
-     (defined(__FreeBSD__) && (__FreeBSD_version >= 501113))
+     (defined(__FreeBSD_kernel__) && (__FreeBSD_version >= 501113))
 	strncpy(ifp->if_xname, ifname, sizeof(ifp->if_xname));
 # else
 	ifp->if_name = strdup(ifname);
@@ -2256,7 +2256,7 @@
 
 # if (defined(NetBSD) && (NetBSD <= 1991011) && (NetBSD >= 199606)) || \
      (defined(OpenBSD) && (OpenBSD >= 199603)) || \
-     (defined(__FreeBSD__) && (__FreeBSD_version >= 501113))
+     (defined(__FreeBSD_kernel__) && (__FreeBSD_version >= 501113))
 	for (ifa = ifneta; ifa && (ifp = *ifa); ifa++) {
 		ifp->if_output = write_output;
 		sprintf(fname, "/tmp/%s", ifp->if_xname);
diff -ur src.old/sys/contrib/ipfilter/netinet/ip_log.c src/sys/contrib/ipfilter/netinet/ip_log.c
--- src.old/sys/contrib/ipfilter/netinet/ip_log.c	2004-06-22 00:46:35.000000000 +0200
+++ src/sys/contrib/ipfilter/netinet/ip_log.c	2005-04-05 14:12:21.000000000 +0200
@@ -14,7 +14,7 @@
     defined(_KERNEL)
 # include "opt_ipfilter_log.h"
 #endif
-#ifdef  __FreeBSD__
+#ifdef __FreeBSD_kernel__
 # if defined(IPFILTER_LKM) || defined(_KERNEL)
 #  if !defined(__FreeBSD_version) 
 #   include <sys/osreldate.h>
@@ -254,7 +254,7 @@
 # else
 #  if (defined(NetBSD) && (NetBSD <= 1991011) && (NetBSD >= 199603)) || \
       (defined(OpenBSD) && (OpenBSD >= 199603)) || \
-      (defined(__FreeBSD__) && (__FreeBSD_version >= 501113))
+      (defined(__FreeBSD_kernel__) && (__FreeBSD_version >= 501113))
 	strncpy(ipfl.fl_ifname, ifp->if_xname, IFNAMSIZ);
 #  else
 	ipfl.fl_unit = (u_int)ifp->if_unit;
@@ -366,7 +366,7 @@
 #  if SOLARIS || defined(sun)
 	uniqtime(&ipl->ipl_tv);
 #  else
-#   if BSD >= 199306 || defined(__FreeBSD__) || defined(__sgi)
+#   if BSD >= 199306 || defined(__FreeBSD_kernel__) || defined(__sgi)
 	microtime(&ipl->ipl_tv);
 #   endif
 #  endif
@@ -452,7 +452,7 @@
 # endif /* SOLARIS */
 	}
 
-# if BSD >= 199306 || defined(__FreeBSD__)
+# if BSD >= 199306 || defined(__FreeBSD_kernel__)
 	uio->uio_rw = UIO_READ;
 # endif
 
diff -ur src.old/sys/contrib/ipfilter/netinet/ip_nat.c src/sys/contrib/ipfilter/netinet/ip_nat.c
--- src.old/sys/contrib/ipfilter/netinet/ip_nat.c	2004-06-22 00:46:35.000000000 +0200
+++ src/sys/contrib/ipfilter/netinet/ip_nat.c	2005-04-05 14:12:22.000000000 +0200
@@ -6,7 +6,7 @@
  * Added redirect stuff and a LOT of bug fixes. (mcn@EnGarde.com)
  */
 
-#if defined(__FreeBSD__) && defined(KERNEL) && !defined(_KERNEL)
+#if defined(__FreeBSD_kernel__) && defined(KERNEL) && !defined(_KERNEL)
 #define _KERNEL
 #endif
 
diff -ur src.old/sys/contrib/ipfilter/netinet/ip_proxy.c src/sys/contrib/ipfilter/netinet/ip_proxy.c
--- src.old/sys/contrib/ipfilter/netinet/ip_proxy.c	2003-02-15 07:23:45.000000000 +0100
+++ src/sys/contrib/ipfilter/netinet/ip_proxy.c	2005-04-05 14:12:22.000000000 +0200
@@ -4,7 +4,7 @@
  * See the IPFILTER.LICENCE file for details on licencing.
  */
 
-#if defined(__FreeBSD__) && defined(KERNEL) && !defined(_KERNEL)
+#if defined(__FreeBSD_kernel__) && defined(KERNEL) && !defined(_KERNEL)
 # define	_KERNEL
 #endif
 
@@ -48,7 +48,7 @@
 # include <sys/stream.h>
 # include <sys/kmem.h>
 #endif
-#if __FreeBSD__ > 2
+#if 5 > 2
 # include <sys/queue.h>
 #endif
 #include <net/if.h>
diff -ur src.old/sys/contrib/ngatm/netnatm/api/cc_dump.c src/sys/contrib/ngatm/netnatm/api/cc_dump.c
--- src.old/sys/contrib/ngatm/netnatm/api/cc_dump.c	2004-08-11 14:21:31.000000000 +0200
+++ src/sys/contrib/ngatm/netnatm/api/cc_dump.c	2005-04-05 14:12:23.000000000 +0200
@@ -42,7 +42,7 @@
 #include <netnatm/api/ccpriv.h>
 
 #ifdef _KERNEL
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <machine/stdarg.h>
 #endif
 #else	/* !_KERNEL */
diff -ur src.old/sys/contrib/ngatm/netnatm/api/ccpriv.h src/sys/contrib/ngatm/netnatm/api/ccpriv.h
--- src.old/sys/contrib/ngatm/netnatm/api/ccpriv.h	2004-07-08 18:39:02.000000000 +0200
+++ src/sys/contrib/ngatm/netnatm/api/ccpriv.h	2005-04-05 14:12:24.000000000 +0200
@@ -34,7 +34,7 @@
  * Private declarations.
  */
 #ifdef _KERNEL
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <netgraph/atm/ccatm/ng_ccatm_cust.h>
 #endif
 #else	/* !_KERNEL */
diff -ur src.old/sys/contrib/ngatm/netnatm/saal/sscfu.h src/sys/contrib/ngatm/netnatm/saal/sscfu.h
--- src.old/sys/contrib/ngatm/netnatm/saal/sscfu.h	2004-07-08 18:39:00.000000000 +0200
+++ src/sys/contrib/ngatm/netnatm/saal/sscfu.h	2005-04-05 14:12:27.000000000 +0200
@@ -41,7 +41,7 @@
  * Define how a buffer looks like.
  */
 #ifdef _KERNEL
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define SSCFU_MBUF_T mbuf
 #endif
 #else
diff -ur src.old/sys/contrib/ngatm/netnatm/saal/sscfupriv.h src/sys/contrib/ngatm/netnatm/saal/sscfupriv.h
--- src.old/sys/contrib/ngatm/netnatm/saal/sscfupriv.h	2004-07-08 18:39:00.000000000 +0200
+++ src/sys/contrib/ngatm/netnatm/saal/sscfupriv.h	2005-04-05 14:12:27.000000000 +0200
@@ -31,7 +31,7 @@
  * Private SSCF-UNI definitions.
  */
 #ifdef _KERNEL
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <netgraph/atm/sscfu/ng_sscfu_cust.h>
 #endif
 #else
diff -ur src.old/sys/contrib/ngatm/netnatm/saal/sscop.h src/sys/contrib/ngatm/netnatm/saal/sscop.h
--- src.old/sys/contrib/ngatm/netnatm/saal/sscop.h	2004-07-08 18:39:00.000000000 +0200
+++ src/sys/contrib/ngatm/netnatm/saal/sscop.h	2005-04-05 14:12:27.000000000 +0200
@@ -39,7 +39,7 @@
  * Define how a buffer looks like.
  */
 #ifdef _KERNEL
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define SSCOP_MBUF_T mbuf
 #endif
 #else
diff -ur src.old/sys/contrib/ngatm/netnatm/saal/sscoppriv.h src/sys/contrib/ngatm/netnatm/saal/sscoppriv.h
--- src.old/sys/contrib/ngatm/netnatm/saal/sscoppriv.h	2004-07-08 18:39:00.000000000 +0200
+++ src/sys/contrib/ngatm/netnatm/saal/sscoppriv.h	2005-04-05 14:12:27.000000000 +0200
@@ -32,7 +32,7 @@
  *
  */
 #ifdef _KERNEL
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <netgraph/atm/sscop/ng_sscop_cust.h>
 #endif
 #else	/* !_KERNEL */
diff -ur src.old/sys/contrib/ngatm/netnatm/sig/unipriv.h src/sys/contrib/ngatm/netnatm/sig/unipriv.h
--- src.old/sys/contrib/ngatm/netnatm/sig/unipriv.h	2004-07-08 18:39:02.000000000 +0200
+++ src/sys/contrib/ngatm/netnatm/sig/unipriv.h	2005-04-05 14:12:29.000000000 +0200
@@ -34,7 +34,7 @@
 #define unipriv_h
 
 #ifdef _KERNEL
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <netgraph/atm/uni/ng_uni_cust.h>
 #endif
 #else
diff -ur src.old/sys/contrib/ngatm/netnatm/unimsg.h src/sys/contrib/ngatm/netnatm/unimsg.h
--- src.old/sys/contrib/ngatm/netnatm/unimsg.h	2004-07-08 18:38:58.000000000 +0200
+++ src/sys/contrib/ngatm/netnatm/unimsg.h	2005-04-05 14:12:26.000000000 +0200
@@ -35,7 +35,7 @@
 
 #include <sys/types.h>
 #ifdef _KERNEL
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <sys/systm.h>
 #endif
 #include <sys/stdint.h>
diff -ur src.old/sys/contrib/pf/net/if_pflog.c src/sys/contrib/pf/net/if_pflog.c
--- src.old/sys/contrib/pf/net/if_pflog.c	2004-09-20 17:25:57.000000000 +0200
+++ src/sys/contrib/pf/net/if_pflog.c	2005-04-05 14:12:29.000000000 +0200
@@ -34,15 +34,15 @@
  * PURPOSE.
  */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include "opt_inet.h"
 #include "opt_inet6.h"
 #endif
 
-#ifndef __FreeBSD__
-#include "bpfilter.h"
-#include "pflog.h"
-#elif __FreeBSD__ >= 5
+#ifndef __FreeBSD_kernel__
+
+
+#elif 5 >= 5
 #include "opt_bpf.h"
 #include "opt_pf.h"
 #define	NBPFILTER	DEV_BPF
@@ -53,7 +53,7 @@
 #include <sys/systm.h>
 #include <sys/mbuf.h>
 #include <sys/socket.h>
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <sys/kernel.h>
 #include <sys/malloc.h>
 #include <sys/module.h>
@@ -63,7 +63,7 @@
 #endif
 
 #include <net/if.h>
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #include <net/if_clone.h>
 #endif
 #include <net/if_types.h>
@@ -77,7 +77,7 @@
 #include <netinet/ip.h>
 #endif
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <machine/in_cksum.h>
 #endif
 
@@ -91,7 +91,7 @@
 #include <net/pfvar.h>
 #include <net/if_pflog.h>
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define	PFLOGNAME	"pflog"
 #endif
 
@@ -103,11 +103,11 @@
 #define DPRINTF(x)
 #endif
 
-#ifndef __FreeBSD__
+#ifndef __FreeBSD_kernel__
 struct pflog_softc pflogif[NPFLOG];
 #endif
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 static void	pflog_clone_destroy(struct ifnet *);
 static int	pflog_clone_create(struct if_clone *, int);
 #else
@@ -119,11 +119,11 @@
 void	pflogrtrequest(int, struct rtentry *, struct sockaddr *);
 void	pflogstart(struct ifnet *);
 
-#ifndef __FreeBSD__
+#ifndef __FreeBSD_kernel__
 extern int ifqmaxlen;
 #endif
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 static MALLOC_DEFINE(M_PFLOG, PFLOGNAME, "Packet Filter Logging Interface");
 static LIST_HEAD(pflog_list, pflog_softc) pflog_list;
 IFC_SIMPLE_DECLARE(pflog, 1);
@@ -171,7 +171,7 @@
 
         return (0);
 }
-#else /* !__FreeBSD__ */
+#else /* !5 */
 void
 pflogattach(int npflog)
 {
@@ -200,7 +200,7 @@
 #endif
 	}
 }
-#endif /* __FreeBSD__ */
+#endif /* 5 */
 
 /*
  * Start output on the pflog interface.
@@ -209,12 +209,12 @@
 pflogstart(struct ifnet *ifp)
 {
 	struct mbuf *m;
-#ifndef __FreeBSD__
+#ifndef __FreeBSD_kernel__
 	int s;
 #endif
 
 	for (;;) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		IF_LOCK(&ifp->if_snd);
 		_IF_DROP(&ifp->if_snd);
 		_IF_DEQUEUE(&ifp->if_snd, m);
@@ -283,7 +283,7 @@
 #if NBPFILTER > 0
 	struct ifnet *ifn;
 	struct pfloghdr hdr;
-#ifndef __FreeBSD__
+#ifndef __FreeBSD_kernel__
 	struct mbuf m1;
 #endif
 
@@ -321,13 +321,13 @@
 	}
 #endif /* INET */
 
-#ifndef __FreeBSD__
+#ifndef __FreeBSD_kernel__
 	m1.m_next = m;
 	m1.m_len = PFLOG_HDRLEN;
 	m1.m_data = (char *) &hdr;
 #endif
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	KASSERT((!LIST_EMPTY(&pflog_list)), ("pflog: no interface"));
 	ifn = &LIST_FIRST(&pflog_list)->sc_if;
 	BPF_MTAP2(ifn, &hdr, sizeof(hdr), m);
@@ -342,7 +342,7 @@
 	return (0);
 }
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 static int
 pflog_modevent(module_t mod, int type, void *data)
 {
@@ -379,4 +379,4 @@
 
 DECLARE_MODULE(pflog, pflog_mod, SI_SUB_PROTO_IFATTACHDOMAIN, SI_ORDER_ANY);
 MODULE_VERSION(pflog, PFLOG_MODVER);
-#endif /* __FreeBSD__ */
+#endif /* 5 */
diff -ur src.old/sys/contrib/pf/net/if_pflog.h src/sys/contrib/pf/net/if_pflog.h
--- src.old/sys/contrib/pf/net/if_pflog.h	2004-06-17 01:24:00.000000000 +0200
+++ src/sys/contrib/pf/net/if_pflog.h	2005-04-05 14:12:29.000000000 +0200
@@ -30,7 +30,7 @@
 
 struct pflog_softc {
 	struct ifnet	sc_if;  /* the interface */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	LIST_ENTRY(pflog_softc) sc_next;
 #endif
 };
diff -ur src.old/sys/contrib/pf/net/if_pfsync.c src/sys/contrib/pf/net/if_pfsync.c
--- src.old/sys/contrib/pf/net/if_pfsync.c	2004-09-20 17:25:57.000000000 +0200
+++ src/sys/contrib/pf/net/if_pfsync.c	2005-04-05 14:12:29.000000000 +0200
@@ -27,15 +27,15 @@
  * THE POSSIBILITY OF SUCH DAMAGE.
  */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include "opt_inet.h"
 #include "opt_inet6.h"
 #endif
 
-#ifndef __FreeBSD__
-#include "bpfilter.h"
+#ifndef __FreeBSD_kernel__
+
 #include "pfsync.h"
-#elif __FreeBSD__ >= 5
+#elif 5 >= 5
 #include "opt_bpf.h"
 #include "opt_pf.h"
 #define	NBPFILTER	DEV_BPF
@@ -48,7 +48,7 @@
 #include <sys/time.h>
 #include <sys/mbuf.h>
 #include <sys/socket.h>
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <sys/kernel.h>
 #include <sys/malloc.h>
 #include <sys/module.h>
@@ -61,7 +61,7 @@
 #endif
 
 #include <net/if.h>
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #include <net/if_clone.h>
 #endif
 #include <net/if_types.h>
@@ -86,7 +86,7 @@
 #include <net/pfvar.h>
 #include <net/if_pfsync.h>
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define	PFSYNCNAME	"pfsync"
 #endif
 
@@ -100,13 +100,13 @@
 #define DPRINTF(x)
 #endif
 
-#ifndef __FreeBSD__
+#ifndef __FreeBSD_kernel__
 struct pfsync_softc	pfsyncif;
 #endif
 int			pfsync_sync_ok;
 struct pfsyncstats	pfsyncstats;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 
 /*
  * Locking notes:
@@ -136,14 +136,14 @@
 void	pfsync_bulk_update(void *);
 void	pfsync_bulkfail(void *);
 
-#ifndef __FreeBSD__
+#ifndef __FreeBSD_kernel__
 extern int ifqmaxlen;
 extern struct timeval time;
 extern struct timeval mono_time;
 extern int hz;
 #endif
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 static MALLOC_DEFINE(M_PFSYNC, PFSYNCNAME, "Packet Filter State Sync. Interface");
 static LIST_HEAD(pfsync_list, pfsync_softc) pfsync_list;
 IFC_SIMPLE_DECLARE(pfsync, 1);
@@ -213,7 +213,7 @@
 
 	return (0);
 }
-#else /* !__FreeBSD__ */
+#else /* !5 */
 void
 pfsyncattach(int npfsync)
 {
@@ -257,7 +257,7 @@
 void
 pfsyncstart(struct ifnet *ifp)
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	IF_LOCK(&ifp->if_snd);
 	_IF_DROP(&ifp->if_snd);
 	_IF_DRAIN(&ifp->if_snd);
@@ -287,7 +287,7 @@
 	struct pf_rule *r = NULL;
 	struct pfi_kif	*kif;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	PF_ASSERT(MA_OWNED);
 #endif
 	if (sp->creatorid == 0 && pf_status.debug >= PF_DEBUG_MISC) {
@@ -331,7 +331,7 @@
 	pf_state_peer_ntoh(&sp->dst, &st->dst);
 
 	bcopy(&sp->rt_addr, &st->rt_addr, sizeof(st->rt_addr));
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	st->creation = ntohl(sp->creation) + time_second;
 	st->expire = ntohl(sp->expire) + time_second;
 #else
@@ -361,7 +361,7 @@
 }
 
 void
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 pfsync_input(struct mbuf *m, __unused int off)
 #else
 pfsync_input(struct mbuf *m, ...)
@@ -369,7 +369,7 @@
 {
 	struct ip *ip = mtod(m, struct ip *);
 	struct pfsync_header *ph;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct pfsync_softc *sc = LIST_FIRST(&pfsync_list);
 #else
 	struct pfsync_softc *sc = &pfsyncif;
@@ -450,7 +450,7 @@
 		creatorid = cp->creatorid;
 
 		s = splsoftnet();
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_LOCK();
 #endif
 		if (cp->ifname[0] == '\0') {
@@ -465,7 +465,7 @@
 					printf("pfsync_input: PFSYNC_ACT_CLR "
 					    "bad interface: %s\n", cp->ifname);
 				splx(s);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 				PF_UNLOCK();
 #endif
 				goto done;
@@ -477,7 +477,7 @@
 			}
 		}
 		pf_purge_expired_states();
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_UNLOCK();
 #endif
 		splx(s);
@@ -492,7 +492,7 @@
 		}
 
 		s = splsoftnet();
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_LOCK();
 #endif
 		for (i = 0, sp = (struct pfsync_state *)(mp->m_data + offp);
@@ -513,7 +513,7 @@
 			if ((error = pfsync_insert_net_state(sp))) {
 				if (error == ENOMEM) {
 					splx(s);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 					PF_UNLOCK();
 #endif
 					goto done;
@@ -521,7 +521,7 @@
 				continue;
 			}
 		}
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_UNLOCK();
 #endif
 		splx(s);
@@ -534,7 +534,7 @@
 		}
 
 		s = splsoftnet();
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_LOCK();
 #endif
 		for (i = 0, sp = (struct pfsync_state *)(mp->m_data + offp);
@@ -562,7 +562,7 @@
 			}
 			pf_state_peer_ntoh(&sp->src, &st->src);
 			pf_state_peer_ntoh(&sp->dst, &st->dst);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			st->expire = ntohl(sp->expire) + time_second;
 #else
 			st->expire = ntohl(sp->expire) + time.tv_sec;
@@ -570,7 +570,7 @@
 			st->timeout = sp->timeout;
 
 		}
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_UNLOCK();
 #endif
 		splx(s);
@@ -587,7 +587,7 @@
 		}
 
 		s = splsoftnet();
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_LOCK();
 #endif
 		for (i = 0, sp = (struct pfsync_state *)(mp->m_data + offp);
@@ -609,7 +609,7 @@
 			st->sync_flags |= PFSTATE_FROMSYNC;
 		}
 		pf_purge_expired_states();
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_UNLOCK();
 #endif
 		splx(s);
@@ -624,7 +624,7 @@
 		}
 
 		s = splsoftnet();
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_LOCK();
 #endif
 		for (i = 0, up = (struct pfsync_state_upd *)(mp->m_data + offp);
@@ -654,7 +654,7 @@
 			}
 			pf_state_peer_ntoh(&up->src, &st->src);
 			pf_state_peer_ntoh(&up->dst, &st->dst);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			st->expire = ntohl(up->expire) + time_second;
 #else
 			st->expire = ntohl(up->expire) + time.tv_sec;
@@ -663,7 +663,7 @@
 		}
 		if (update_requested)
 			pfsync_sendout(sc);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_UNLOCK();
 #endif
 		splx(s);
@@ -677,7 +677,7 @@
 		}
 
 		s = splsoftnet();
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_LOCK();
 #endif
 		for (i = 0, dp = (struct pfsync_state_del *)(mp->m_data + offp);
@@ -699,7 +699,7 @@
 			st->sync_flags |= PFSTATE_FROMSYNC;
 		}
 		pf_purge_expired_states();
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_UNLOCK();
 #endif
 		splx(s);
@@ -717,7 +717,7 @@
 
 		s = splsoftnet();
 		/* XXX send existing. pfsync_pack_state should handle this. */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_LOCK();
 #endif
 		if (sc->sc_mbuf != NULL)
@@ -729,7 +729,7 @@
 			key.creatorid = rup->creatorid;
 
 			if (key.id == 0 && key.creatorid == 0) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 				sc->sc_ureq_received = time_uptime;
 #else
 				sc->sc_ureq_received = mono_time.tv_sec;
@@ -738,7 +738,7 @@
 					printf("pfsync: received "
 					    "bulk update request\n");
 				pfsync_send_bus(sc, PFSYNC_BUS_START);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 				callout_reset(&sc->sc_bulk_tmo, 1 * hz,
 				    pfsync_bulk_update,
 				    LIST_FIRST(&pfsync_list));
@@ -756,7 +756,7 @@
 		}
 		if (sc->sc_mbuf != NULL)
 			pfsync_sendout(sc);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_UNLOCK();
 #endif
 		splx(s);
@@ -774,7 +774,7 @@
 		bus = (struct pfsync_state_bus *)(mp->m_data + offp);
 		switch (bus->status) {
 		case PFSYNC_BUS_START:
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			callout_reset(&sc->sc_bulkfail_tmo,
 			    pf_pool_limits[PF_LIMIT_STATES].limit /
 			    (PFSYNC_BULKPACKETS * sc->sc_maxcount), 
@@ -789,7 +789,7 @@
 				    "update start\n");
 			break;
 		case PFSYNC_BUS_END:
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			if (time_uptime - ntohl(bus->endtime) >=
 #else
 			if (mono_time.tv_sec - ntohl(bus->endtime) >=
@@ -798,7 +798,7 @@
 				/* that's it, we're happy */
 				sc->sc_ureq_sent = 0;
 				sc->sc_bulk_tries = 0;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 				callout_stop(&sc->sc_bulkfail_tmo);
 #else
 				timeout_del(&sc->sc_bulkfail_tmo);
@@ -834,7 +834,7 @@
 int
 pfsyncioctl(struct ifnet *ifp, u_long cmd, caddr_t data)
 {
-#ifndef __FreeBSD__
+#ifndef __FreeBSD_kernel__
 	struct proc *p = curproc;
 #endif
 	struct pfsync_softc *sc = ifp->if_softc;
@@ -860,20 +860,20 @@
 		if (ifr->ifr_mtu > MCLBYTES)
 			ifr->ifr_mtu = MCLBYTES;
 		s = splnet();
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_LOCK();
 #endif
 		if (ifr->ifr_mtu < ifp->if_mtu) {
 			pfsync_sendout(sc);
 		}
 		pfsync_setmtu(sc, ifr->ifr_mtu);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_UNLOCK();
 #endif
 		splx(s);
 		break;
 	case SIOCGETPFSYNC:
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		/* XXX: read unlocked */
 #endif
 		bzero(&pfsyncr, sizeof(pfsyncr));
@@ -885,7 +885,7 @@
 			return (error);
 		break;
 	case SIOCSETPFSYNC:
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		if ((error = suser(curthread)) != 0)
 #else
 		if ((error = suser(p, p->p_acflag)) != 0)
@@ -896,7 +896,7 @@
 
 		if (pfsyncr.pfsyncr_maxupdates > 255)
 			return (EINVAL);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_LOCK();
 #endif
 		sc->sc_maxupdates = pfsyncr.pfsyncr_maxupdates;
@@ -911,19 +911,19 @@
 				sc->sc_statep_net.s = NULL;
 				splx(s);
 			}
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			PF_UNLOCK();
 #endif
 			break;
 		}
 		if ((sifp = ifunit(pfsyncr.pfsyncr_syncif)) == NULL) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			PF_UNLOCK();
 #endif
 			return (EINVAL);
 		}
 		else if (sifp == sc->sc_sync_ifp) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			PF_UNLOCK();
 #endif
 			break;
@@ -947,7 +947,7 @@
 		if (sc->sc_sync_ifp) {
 			struct in_addr addr;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			PF_UNLOCK();		/* addmulti mallocs w/ WAITOK */
 			addr.s_addr = htonl(INADDR_PFSYNC_GROUP);
 #else
@@ -964,7 +964,7 @@
 			imo->imo_multicast_loop = 0;
 
 			/* Request a full state table update. */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			PF_LOCK();
 			sc->sc_ureq_sent = time_uptime;
 #else
@@ -973,7 +973,7 @@
 			pfsync_sync_ok = 0;
 			if (pf_status.debug >= PF_DEBUG_MISC)
 				printf("pfsync: requesting bulk update\n");
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			callout_reset(&sc->sc_bulkfail_tmo, 5 * hz,
 			    pfsync_bulkfail, LIST_FIRST(&pfsync_list));
 #else
@@ -982,7 +982,7 @@
 			pfsync_request_update(NULL, NULL);
 			pfsync_sendout(sc);
 		}
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_UNLOCK();
 #endif
 		splx(s);
@@ -1021,7 +1021,7 @@
 	struct mbuf *m;
 	int len;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	PF_ASSERT(MA_OWNED);
 #endif
 	MGETHDR(m, M_DONTWAIT, MT_DATA);
@@ -1077,7 +1077,7 @@
 	h->action = action;
 
 	*sp = (void *)((char *)h + PFSYNC_HDRLEN);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	callout_reset(&sc->sc_tmo, hz, pfsync_timeout,
 	    LIST_FIRST(&pfsync_list));
 #else
@@ -1089,7 +1089,7 @@
 int
 pfsync_pack_state(u_int8_t action, struct pf_state *st, int compress)
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct ifnet *ifp = &(LIST_FIRST(&pfsync_list))->sc_if;
 #else
 	struct ifnet *ifp = &pfsyncif.sc_if;
@@ -1104,7 +1104,7 @@
 	int s, ret = 0;
 	u_int8_t i = 255, newaction = 0;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	PF_ASSERT(MA_OWNED);
 #endif
 	/*
@@ -1165,7 +1165,7 @@
 		}
 	}
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	secs = time_second;
 
 	st->pfsync_time = time_uptime;
@@ -1298,7 +1298,7 @@
 int
 pfsync_request_update(struct pfsync_state_upd *up, struct in_addr *src)
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct ifnet *ifp = &(LIST_FIRST(&pfsync_list))->sc_if;
 #else
 	struct ifnet *ifp = &pfsyncif.sc_if;
@@ -1308,7 +1308,7 @@
 	struct pfsync_state_upd_req *rup;
 	int s = 0, ret = 0;	/* make the compiler happy */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	PF_ASSERT(MA_OWNED);
 #endif
 	if (sc->sc_mbuf == NULL) {
@@ -1351,7 +1351,7 @@
 int
 pfsync_clear_states(u_int32_t creatorid, char *ifname)
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct ifnet *ifp = &(LIST_FIRST(&pfsync_list))->sc_if;
 #else
 	struct ifnet *ifp = &pfsyncif.sc_if;
@@ -1361,7 +1361,7 @@
 	int s, ret;
 
 	s = splnet();
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	PF_ASSERT(MA_OWNED);
 #endif
 	if (sc->sc_mbuf != NULL)
@@ -1389,11 +1389,11 @@
 	int s;
 
 	s = splnet();
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	PF_LOCK();
 #endif
 	pfsync_sendout(sc);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	PF_UNLOCK();
 #endif
 	splx(s);
@@ -1404,7 +1404,7 @@
 {
 	struct pfsync_state_bus *bus;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	PF_ASSERT(MA_OWNED);
 #endif
 	if (sc->sc_mbuf != NULL)
@@ -1417,7 +1417,7 @@
 		bus = sc->sc_statep.b;
 		bus->creatorid = pf_status.hostid;
 		bus->status = status;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		bus->endtime = htonl(time_uptime - sc->sc_ureq_received);
 #else
 		bus->endtime = htonl(mono_time.tv_sec - sc->sc_ureq_received);
@@ -1433,7 +1433,7 @@
 	int s, i = 0;
 	struct pf_state *state;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	PF_LOCK();
 #endif
 	s = splnet();
@@ -1450,7 +1450,7 @@
 			/* we're done */
 			pfsync_send_bus(sc, PFSYNC_BUS_END);
 			sc->sc_ureq_received = 0;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			callout_stop(&sc->sc_bulk_tmo);
 #else
 			timeout_del(&sc->sc_bulk_tmo);
@@ -1462,7 +1462,7 @@
 			/* send an update and move to end of list */
 			if (!state->sync_flags)
 				pfsync_pack_state(PFSYNC_ACT_UPD, state, 0);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			state->pfsync_time = time_uptime;
 #else
 			state->pfsync_time = mono_time.tv_sec;
@@ -1472,7 +1472,7 @@
 			    u.s.entry_updates);
 
 			/* look again for more in a bit */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			callout_reset(&sc->sc_bulk_tmo, 1, pfsync_timeout,
 			    LIST_FIRST(&pfsync_list));
 #else
@@ -1483,7 +1483,7 @@
 	if (sc->sc_mbuf != NULL)
 		pfsync_sendout(sc);
 	splx(s);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	PF_UNLOCK();
 #endif
 }
@@ -1493,12 +1493,12 @@
 {
 	struct pfsync_softc *sc = v;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	PF_LOCK();
 #endif
 	if (sc->sc_bulk_tries++ < PFSYNC_MAX_BULKTRIES) {
 		/* Try again in a bit */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		callout_reset(&sc->sc_bulkfail_tmo, 5 * hz, pfsync_bulkfail,
 		    LIST_FIRST(&pfsync_list));
 #else
@@ -1514,13 +1514,13 @@
 		if (pf_status.debug >= PF_DEBUG_MISC)
 			printf("pfsync: failed to receive "
 			    "bulk update status\n");
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		callout_stop(&sc->sc_bulkfail_tmo);
 #else
 		timeout_del(&sc->sc_bulkfail_tmo);
 #endif
 	}
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	PF_UNLOCK();
 #endif
 }
@@ -1532,7 +1532,7 @@
 	struct ifnet *ifp = &sc->sc_if;
 	struct mbuf *m;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	PF_ASSERT(MA_OWNED);
 	callout_stop(&sc->sc_tmo);
 #else
@@ -1545,7 +1545,7 @@
 	sc->sc_mbuf = NULL;
 	sc->sc_statep.s = NULL;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	KASSERT(m != NULL, ("pfsync_sendout: null mbuf"));
 #endif
 #if NBPFILTER > 0
@@ -1574,13 +1574,13 @@
 		ip->ip_v = IPVERSION;
 		ip->ip_hl = sizeof(*ip) >> 2;
 		ip->ip_tos = IPTOS_LOWDELAY;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		ip->ip_len = m->m_pkthdr.len;
 #else
 		ip->ip_len = htons(m->m_pkthdr.len);
 #endif
 		ip->ip_id = htons(ip_randomid());
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		ip->ip_off = IP_DF;
 #else
 		ip->ip_off = htons(IP_DF);
@@ -1596,14 +1596,14 @@
 			return (0);
 		ip->ip_src.s_addr = ifatoia(ifa)->ia_addr.sin_addr.s_addr;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		if (sc->sc_sendaddr.s_addr == htonl(INADDR_PFSYNC_GROUP))
 #else
 		if (sc->sc_sendaddr.s_addr == INADDR_PFSYNC_GROUP)
 #endif
 			m->m_flags |= M_MCAST;
 		ip->ip_dst = sc->sc_sendaddr;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		sc->sc_sendaddr.s_addr = htonl(INADDR_PFSYNC_GROUP);
 #else
 		sc->sc_sendaddr.s_addr = INADDR_PFSYNC_GROUP;
@@ -1611,13 +1611,13 @@
 
 		pfsyncstats.pfsyncs_opackets++;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_UNLOCK();
 #endif
 		if (ip_output(m, NULL, NULL, IP_RAWOUTPUT, &sc->sc_imo, NULL))
 			pfsyncstats.pfsyncs_oerrors++;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_LOCK();
 #endif
 	} else
@@ -1627,7 +1627,7 @@
 }
 
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 static int
 pfsync_modevent(module_t mod, int type, void *data)
 {
@@ -1664,4 +1664,4 @@
 
 DECLARE_MODULE(pfsync, pfsync_mod, SI_SUB_PROTO_IFATTACHDOMAIN, SI_ORDER_ANY);
 MODULE_VERSION(pfsync, PFSYNC_MODVER);
-#endif /* __FreeBSD__ */
+#endif /* 5 */
diff -ur src.old/sys/contrib/pf/net/if_pfsync.h src/sys/contrib/pf/net/if_pfsync.h
--- src.old/sys/contrib/pf/net/if_pfsync.h	2004-06-17 01:24:00.000000000 +0200
+++ src/sys/contrib/pf/net/if_pfsync.h	2005-04-05 14:12:29.000000000 +0200
@@ -148,7 +148,7 @@
 	struct ifnet		*sc_sync_ifp;
 
 	struct ip_moptions	 sc_imo;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct callout		 sc_tmo;
 	struct callout		 sc_bulk_tmo;
 	struct callout		 sc_bulkfail_tmo;
@@ -167,7 +167,7 @@
 	int			 sc_bulk_tries;
 	int			 sc_maxcount;	/* number of states in mtu */
 	int			 sc_maxupdates;	/* number of updates/state */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	LIST_ENTRY(pfsync_softc) sc_next;
 #endif
 };
@@ -264,7 +264,7 @@
 } while (0)
 
 #ifdef _KERNEL
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 void pfsync_input(struct mbuf *, __unused int);
 #else
 void pfsync_input(struct mbuf *, ...);
diff -ur src.old/sys/contrib/pf/net/pf.c src/sys/contrib/pf/net/pf.c
--- src.old/sys/contrib/pf/net/pf.c	2004-10-03 19:04:39.000000000 +0200
+++ src/sys/contrib/pf/net/pf.c	2005-04-05 14:12:30.000000000 +0200
@@ -37,20 +37,20 @@
  *
  */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include "opt_inet.h"
 #include "opt_inet6.h"
 #endif
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include "opt_bpf.h"
 #include "opt_pf.h"
 #define	NBPFILTER	DEV_BPF
 #define	NPFLOG		DEV_PFLOG
 #define	NPFSYNC		DEV_PFSYNC
 #else
-#include "bpfilter.h"
-#include "pflog.h"
+
+
 #include "pfsync.h"
 #endif
 
@@ -62,11 +62,11 @@
 #include <sys/socketvar.h>
 #include <sys/kernel.h>
 #include <sys/time.h>
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <sys/sysctl.h>
 #include <sys/endian.h>
 #else
-#include <sys/pool.h>
+
 #endif
 
 #include <net/if.h>
@@ -89,8 +89,8 @@
 #include <netinet/udp_var.h>
 #include <netinet/icmp_var.h>
 
-#ifndef __FreeBSD__
-#include <dev/rndvar.h>
+#ifndef __FreeBSD_kernel__
+
 #endif
 #include <net/pfvar.h>
 #include <net/if_pflog.h>
@@ -104,13 +104,13 @@
 #include <netinet/in_pcb.h>
 #include <netinet/icmp6.h>
 #include <netinet6/nd6.h>
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <netinet6/ip6_var.h>
 #include <netinet6/in6_pcb.h>
 #endif
 #endif /* INET6 */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <machine/in_cksum.h>
 #include <sys/limits.h>
 #include <sys/ucred.h>
@@ -137,14 +137,14 @@
 int			 altqs_inactive_open;
 u_int32_t		 ticket_pabuf;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 struct callout	 	 pf_expire_to;			/* expire timeout */
 #else
 struct timeout		 pf_expire_to;			/* expire timeout */
 #endif
 
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 uma_zone_t		 pf_src_tree_pl, pf_rule_pl;
 uma_zone_t		 pf_state_pl, pf_altq_pl, pf_pooladdr_pl;
 #else
@@ -185,7 +185,7 @@
 int			 pf_test_tcp(struct pf_rule **, struct pf_state **,
 			    int, struct pfi_kif *, struct mbuf *, int,
 			    void *, struct pf_pdesc *, struct pf_rule **,
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			    struct pf_ruleset **, struct inpcb *);
 #else
 			    struct pf_ruleset **);
@@ -193,7 +193,7 @@
 int			 pf_test_udp(struct pf_rule **, struct pf_state **,
 			    int, struct pfi_kif *, struct mbuf *, int,
 			    void *, struct pf_pdesc *, struct pf_rule **,
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			    struct pf_ruleset **, struct inpcb *);
 #else
 			    struct pf_ruleset **);
@@ -237,7 +237,7 @@
 			    struct ifnet *, struct pf_state *);
 void			 pf_route6(struct mbuf **, struct pf_rule *, int,
 			    struct ifnet *, struct pf_state *);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 int			 pf_socket_lookup(uid_t *, gid_t *,
 			    int, struct pf_pdesc *, struct inpcb *);
 #else
@@ -260,7 +260,7 @@
 struct pf_state		*pf_find_state_recurse(struct pfi_kif *,
 			    struct pf_state *, u_int8_t);
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 int in4_cksum(struct mbuf *m, u_int8_t nxt, int off, int len);
 
 struct pf_pool_limit pf_pool_limits[PF_LIMIT_MAX];
@@ -304,7 +304,7 @@
 	((r)->rule_flag & PFRULE_GRBOUND) ? (k)->pfik_parent :	       \
 	(k)->pfik_parent->pfik_parent)
 
-#ifndef __FreeBSD__
+#ifndef __FreeBSD_kernel__
 static __inline int pf_src_compare(struct pf_src_node *, struct pf_src_node *);
 static __inline int pf_state_compare_lan_ext(struct pf_state *,
 	struct pf_state *);
@@ -335,7 +335,7 @@
 RB_GENERATE(pf_state_tree_id, pf_state,
     u.s.entry_id, pf_state_compare_id);
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 static int
 #else
 static __inline int
@@ -383,7 +383,7 @@
 	return (0);
 }
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 static int
 #else
 static __inline int
@@ -455,7 +455,7 @@
 	return (0);
 }
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 static int
 #else
 static __inline int
@@ -527,7 +527,7 @@
 	return (0);
 }
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 static int
 #else
 static __inline int
@@ -681,7 +681,7 @@
 			pool_put(&pf_src_tree_pl, *sn);
 			return (-1);
 		}
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		(*sn)->creation = time_second;
 #else
 		(*sn)->creation = time.tv_sec;
@@ -749,7 +749,7 @@
 	}
 	if (RB_INSERT(pf_state_tree_id, &tree_id, state) != NULL) {
 		if (pf_status.debug >= PF_DEBUG_MISC) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			printf("pf: state insert failed: "
 			    "id: %016llx creatorid: %08x",
 			    (long long)be64toh(state->id),
@@ -781,14 +781,14 @@
 void
 pf_purge_timeout(void *arg)
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct callout  *to = arg;
 #else
 	struct timeout	*to = arg;
 #endif
 	int		 s;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	PF_LOCK();
 #endif
 	s = splsoftnet();
@@ -796,11 +796,11 @@
 	pf_purge_expired_fragments();
 	pf_purge_expired_src_nodes();
 	splx(s);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	PF_UNLOCK();
 #endif
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	callout_reset(to, pf_default_rule.timeout[PFTM_INTERVAL] * hz,
 	    pf_purge_timeout, to);
 #else
@@ -818,14 +818,14 @@
 
 	/* handle all PFTM_* > PFTM_MAX here */
 	if (state->timeout == PFTM_PURGE)
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		return (time_second);
 #else
 		return (time.tv_sec);
 #endif
 	if (state->timeout == PFTM_UNTIL_PACKET)
 		return (0);
-#ifdef __FreeBSD__	
+#ifdef __FreeBSD_kernel__	
 	KASSERT((state->timeout < PFTM_MAX), 
 	    ("pf_state_expires: timeout > PFTM_MAX"));
 #else
@@ -848,7 +848,7 @@
 			return (state->expire + timeout * (end - states) /
 			    (end - start));
 		else
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			return (time_second);
 #else
 			return (time.tv_sec);
@@ -865,7 +865,7 @@
 	 for (cur = RB_MIN(pf_src_tree, &tree_src_tracking); cur; cur = next) {
 		 next = RB_NEXT(pf_src_tree, &tree_src_tracking, cur);
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		 if (cur->states <= 0 && cur->expire <= time_second) {
 #else
 		 if (cur->states <= 0 && cur->expire <= time.tv_sec) {
@@ -895,7 +895,7 @@
 			if (!timeout)
 				timeout =
 				    pf_default_rule.timeout[PFTM_SRC_NODE];
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			s->src_node->expire = time_second + timeout;
 #else
 			s->src_node->expire = time.tv_sec + timeout;
@@ -908,7 +908,7 @@
 			if (!timeout)
 				timeout =
 				    pf_default_rule.timeout[PFTM_SRC_NODE];
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			s->nat_src_node->expire = time_second + timeout;
 #else
 			s->nat_src_node->expire = time.tv_sec + timeout;
@@ -927,7 +927,7 @@
 	    cur; cur = next) {
 		next = RB_NEXT(pf_state_tree_id, &tree_id, cur);
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		if (pf_state_expires(cur) <= time_second) {
 #else
 		if (pf_state_expires(cur) <= time.tv_sec) {
@@ -1412,7 +1412,7 @@
 	struct ip6_hdr	*h6 = NULL;		/* make the compiler happy */
 #endif /* INET6 */
 	struct tcphdr	*th = NULL;		/* make the compiler happy */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct ip 	*ip;
 #endif
 	char *opt;
@@ -1436,7 +1436,7 @@
 	}
 
 	/* create outgoing mbuf */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	m = m_gethdr(M_DONTWAIT, MT_HEADER);
 	if (m == NULL)
 		return;
@@ -1527,7 +1527,7 @@
 		h->ip_v = 4;
 		h->ip_hl = sizeof(*h) >> 2;
 		h->ip_tos = IPTOS_LOWDELAY;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		h->ip_off = path_mtu_discovery ? IP_DF : 0;
 		h->ip_len = len;
 #else
@@ -1536,13 +1536,13 @@
 #endif
 		h->ip_ttl = ttl ? ttl : ip_defttl;
 		h->ip_sum = 0;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		ip = mtod(m, struct ip *);
 		PF_UNLOCK();
 		ip_output(m, (void *)NULL, (void *)NULL, 0, (void *)NULL,
 			(void *)NULL);
 		PF_LOCK();
-#else /* ! __FreeBSD__ */
+#else /* ! 5 */
 		ip_output(m, (void *)NULL, (void *)NULL, 0, (void *)NULL,
 		    (void *)NULL);
 #endif
@@ -1557,7 +1557,7 @@
 		h6->ip6_vfc |= IPV6_VERSION;
 		h6->ip6_hlim = IPV6_DEFHLIM;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_UNLOCK();
 		ip6_output(m, NULL, NULL, 0, NULL, NULL, NULL);
 		PF_LOCK();
@@ -1577,11 +1577,11 @@
 	struct m_tag	*mtag;
 #endif
 	struct mbuf	*m0;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct ip *ip;
 #endif
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	m0 = m_copypacket(m, M_DONTWAIT);
 	if (m0 == NULL)
 		return;
@@ -1617,7 +1617,7 @@
 	switch (af) {
 #ifdef INET
 	case AF_INET:
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		/* icmp_error() expects host byte ordering */
 		ip = mtod(m0, struct ip *);
 		NTOHS(ip->ip_len);
@@ -1625,18 +1625,18 @@
 		PF_UNLOCK();
 #endif
 		icmp_error(m0, type, code, 0, (void *)NULL);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_LOCK();
 #endif
 		break;
 #endif /* INET */
 #ifdef INET6
 	case AF_INET6:
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_UNLOCK();
 #endif
 		icmp6_error(m0, type, code, 0);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_LOCK();
 #endif
 		break;
@@ -2389,7 +2389,7 @@
 }
 
 int
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 pf_socket_lookup(uid_t *uid, gid_t *gid, int direction, struct pf_pdesc *pd,
     struct inpcb *inp_arg)
 #else
@@ -2398,7 +2398,7 @@
 {
 	struct pf_addr		*saddr, *daddr;
 	u_int16_t		 sport, dport;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct inpcbinfo	*pi;
 #else
 	struct inpcbtable	*tb;
@@ -2407,7 +2407,7 @@
 
 	*uid = UID_MAX;
 	*gid = GID_MAX;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	if (inp_arg != NULL) {
 		INP_LOCK_ASSERT(inp_arg);
 		if (inp_arg->inp_socket) {
@@ -2422,7 +2422,7 @@
 	case IPPROTO_TCP:
 		sport = pd->hdr.tcp->th_sport;
 		dport = pd->hdr.tcp->th_dport;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		pi = &tcbinfo;
 #else
 		tb = &tcbtable;
@@ -2431,7 +2431,7 @@
 	case IPPROTO_UDP:
 		sport = pd->hdr.udp->uh_sport;
 		dport = pd->hdr.udp->uh_dport;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		pi = &udbinfo;
 #else
 		tb = &udbtable;
@@ -2454,7 +2454,7 @@
 	}
 	switch (pd->af) {
 	case AF_INET:
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		INP_INFO_RLOCK(pi);	/* XXX LOR */
 		inp = in_pcblookup_hash(pi, saddr->v4, sport, daddr->v4,
 			dport, 0, NULL);
@@ -2477,7 +2477,7 @@
 		break;
 #ifdef INET6
 	case AF_INET6:
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		INP_INFO_RLOCK(pi);
 		inp = in6_pcblookup_hash(pi, &saddr->v6, sport,
 			&daddr->v6, dport, 0, NULL);
@@ -2504,7 +2504,7 @@
 	default:
 		return (0);
 	}
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	INP_LOCK(inp);
 	*uid = inp->inp_socket->so_cred->cr_uid;
 	*gid = inp->inp_socket->so_cred->cr_groups[0];
@@ -2618,13 +2618,13 @@
 		dst->sin_family = AF_INET;
 		dst->sin_len = sizeof(*dst);
 		dst->sin_addr = addr->v4;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #ifdef RTF_PRCLONING
 		rtalloc_ign(&ro, (RTF_CLONING | RTF_PRCLONING));
 #else /* !RTF_PRCLONING */
 		rtalloc_ign(&ro, RTF_CLONING);
 #endif
-#else /* ! __FreeBSD__ */
+#else /* ! 5 */
 		rtalloc_noclone(&ro, NO_CLONING);
 #endif
 		rt = ro.ro_rt;
@@ -2638,14 +2638,14 @@
 		dst6->sin6_family = AF_INET6;
 		dst6->sin6_len = sizeof(*dst6);
 		dst6->sin6_addr = addr->v6;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #ifdef RTF_PRCLONING
 		rtalloc_ign((struct route *)&ro6,
 		    (RTF_CLONING | RTF_PRCLONING));
 #else /* !RTF_PRCLONING */
 		rtalloc_ign((struct route *)&ro6, RTF_CLONING);
 #endif
-#else /* ! __FreeBSD__ */
+#else /* ! 5 */
 		rtalloc_noclone((struct route *)&ro6, NO_CLONING);
 #endif
 		rt = ro6.ro_rt;
@@ -2692,7 +2692,7 @@
 int
 pf_test_tcp(struct pf_rule **rm, struct pf_state **sm, int direction,
     struct pfi_kif *kif, struct mbuf *m, int off, void *h,
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
     struct pf_pdesc *pd, struct pf_rule **am, struct pf_ruleset **rsm,
     struct inpcb *inp)
 #else
@@ -2776,7 +2776,7 @@
 		else if ((r->flagset & th->th_flags) != r->flags)
 			r = TAILQ_NEXT(r, entries);
 		else if (r->uid.op && (lookup != -1 || (lookup =
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		    pf_socket_lookup(&uid, &gid, direction, pd, inp), 1)) &&
 #else
 		    pf_socket_lookup(&uid, &gid, direction, pd), 1)) &&
@@ -2785,7 +2785,7 @@
 		    uid))
 			r = TAILQ_NEXT(r, entries);
 		else if (r->gid.op && (lookup != -1 || (lookup =
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		    pf_socket_lookup(&uid, &gid, direction, pd, inp), 1)) &&
 #else
 		    pf_socket_lookup(&uid, &gid, direction, pd), 1)) &&
@@ -2987,7 +2987,7 @@
 		s->dst.max_win = 1;
 		s->src.state = TCPS_SYN_SENT;
 		s->dst.state = TCPS_CLOSED;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		s->creation = time_second;
 		s->expire = time_second;
 #else
@@ -3065,7 +3065,7 @@
 int
 pf_test_udp(struct pf_rule **rm, struct pf_state **sm, int direction,
     struct pfi_kif *kif, struct mbuf *m, int off, void *h,
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
     struct pf_pdesc *pd, struct pf_rule **am, struct pf_ruleset **rsm,
     struct inpcb *inp)
 #else
@@ -3146,7 +3146,7 @@
 		else if (r->rule_flag & PFRULE_FRAGMENT)
 			r = TAILQ_NEXT(r, entries);
 		else if (r->uid.op && (lookup != -1 || (lookup =
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		    pf_socket_lookup(&uid, &gid, direction, pd, inp), 1)) &&
 #else
 		    pf_socket_lookup(&uid, &gid, direction, pd), 1)) &&
@@ -3155,7 +3155,7 @@
 		    uid))
 			r = TAILQ_NEXT(r, entries);
 		else if (r->gid.op && (lookup != -1 || (lookup =
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		    pf_socket_lookup(&uid, &gid, direction, pd, inp), 1)) &&
 #else
 		    pf_socket_lookup(&uid, &gid, direction, pd), 1)) &&
@@ -3309,7 +3309,7 @@
 		}
 		s->src.state = PFUDPS_SINGLE;
 		s->dst.state = PFUDPS_NO_TRAFFIC;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		s->creation = time_second;
 		s->expire = time_second;
 #else
@@ -3590,7 +3590,7 @@
 				PF_ACPY(&s->gwy.addr, &s->lan.addr, af);
 			s->gwy.port = icmpid;
 		}
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		s->creation = time_second;
 		s->expire = time_second;
 #else
@@ -3853,7 +3853,7 @@
 		}
 		s->src.state = PFOTHERS_SINGLE;
 		s->dst.state = PFOTHERS_NO_TRAFFIC;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		s->creation = time_second;
 		s->expire = time_second;
 #else
@@ -4219,7 +4219,7 @@
 			src->state = dst->state = TCPS_TIME_WAIT;
 
 		/* update expire time */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		(*state)->expire = time_second;
 #else
 		(*state)->expire = time.tv_sec;
@@ -4409,7 +4409,7 @@
 		dst->state = PFUDPS_MULTIPLE;
 
 	/* update expire time */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	(*state)->expire = time_second;
 #else
 	(*state)->expire = time.tv_sec;
@@ -4499,7 +4499,7 @@
 
 		STATE_LOOKUP();
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		(*state)->expire = time_second;
 #else
 		(*state)->expire = time.tv_sec;
@@ -5048,7 +5048,7 @@
 		dst->state = PFOTHERS_MULTIPLE;
 
 	/* update expire time */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	(*state)->expire = time_second;
 #else
 	(*state)->expire = time.tv_sec;
@@ -5158,13 +5158,13 @@
 	dst->sin_family = af;
 	dst->sin_len = sizeof(*dst);
 	dst->sin_addr = addr->v4;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #ifdef RTF_PRCLONING
 	rtalloc_ign(&ro, (RTF_CLONING|RTF_PRCLONING));
 #else /* !RTF_PRCLONING */
 	rtalloc_ign(&ro, RTF_CLONING);
 #endif
-#else /* ! __FreeBSD__ */
+#else /* ! 5 */
 	rtalloc_noclone(&ro, NO_CLONING);
 #endif
 
@@ -5192,7 +5192,7 @@
 	struct pf_addr		 naddr;
 	struct pf_src_node	*sn = NULL;
 	int			 error = 0;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	int sw_csum;
 #endif
 
@@ -5219,13 +5219,13 @@
 	}
 
 	if (r->rt == PF_DUPTO) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		if ((m0 = m_dup(*m, M_DONTWAIT)) == NULL)
 #else
 		if ((m0 = m_copym2(*m, 0, M_COPYALL, M_NOWAIT)) == NULL)
 #endif
 			return;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		if ((mtag = m_tag_copy(mtag, M_DONTWAIT)) == NULL)
 #else
 		if ((mtag = m_tag_copy(mtag)) == NULL)
@@ -5282,7 +5282,7 @@
 		goto bad;
 
 	if (oifp != ifp) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_UNLOCK();
 		if (pf_test(PF_OUT, ifp, &m0, NULL) != PF_PASS) {
 			PF_LOCK();
@@ -5303,7 +5303,7 @@
 		ip = mtod(m0, struct ip *);
 	}
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	/* Copied from FreeBSD 5.1-CURRENT ip_output. */
 	m0->m_pkthdr.csum_flags |= CSUM_IP;
 	sw_csum = m0->m_pkthdr.csum_flags & ~ifp->if_hwassist;
@@ -5398,7 +5398,7 @@
 	if (ip->ip_off & htons(IP_DF)) {
 		ipstat.ips_cantfrag++;
 		if (r->rt != PF_DUPTO) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			/* icmp_error() expects host byte ordering */
 			NTOHS(ip->ip_len);
 			NTOHS(ip->ip_off);
@@ -5406,7 +5406,7 @@
 #endif
 			icmp_error(m0, ICMP_UNREACH, ICMP_UNREACH_NEEDFRAG, 0,
 			    ifp);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			PF_LOCK();
 #endif
 			goto done;
@@ -5415,7 +5415,7 @@
 	}
 
 	m1 = m0;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	/*
 	 * XXX: is cheaper + less error prone than own function
 	 */
@@ -5426,7 +5426,7 @@
 	error = ip_fragment(m0, ifp, ifp->if_mtu);
 #endif
 	if (error) {
-#ifndef __FreeBSD__	/* ip_fragment does not do m_freem() on FreeBSD */
+#ifndef __FreeBSD_kernel__	/* ip_fragment does not do m_freem() on FreeBSD */
 		m0 = NULL;
 #endif
 		goto bad;
@@ -5435,7 +5435,7 @@
 	for (m0 = m1; m0; m0 = m1) {
 		m1 = m0->m_nextpkt;
 		m0->m_nextpkt = 0;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		if (error == 0) {
 			PF_UNLOCK();
 			error = (*ifp->if_output)(ifp, m0, sintosa(dst),
@@ -5506,13 +5506,13 @@
 	}
 
 	if (r->rt == PF_DUPTO) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		if ((m0 = m_dup(*m, M_DONTWAIT)) == NULL)
 #else
 		if ((m0 = m_copym2(*m, 0, M_COPYALL, M_NOWAIT)) == NULL)
 #endif
 			return;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		if ((mtag = m_tag_copy(mtag, M_DONTWAIT)) == NULL)
 #else
 		if ((mtag = m_tag_copy(mtag)) == NULL)
@@ -5538,7 +5538,7 @@
 
 	/* Cheat. */
 	if (r->rt == PF_FASTROUTE) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		m0->m_flags |= M_SKIP_FIREWALL;
 		PF_UNLOCK();
 		ip6_output(m0, NULL, NULL, 0, NULL, NULL, NULL);
@@ -5572,7 +5572,7 @@
 		goto bad;
 
 	if (oifp != ifp) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_UNLOCK();
 		if (pf_test6(PF_OUT, ifp, &m0, NULL) != PF_PASS) {
 			PF_LOCK();
@@ -5600,16 +5600,16 @@
 	if (IN6_IS_ADDR_LINKLOCAL(&dst->sin6_addr))
 		dst->sin6_addr.s6_addr16[1] = htons(ifp->if_index);
 	if ((u_long)m0->m_pkthdr.len <= ifp->if_mtu) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_UNLOCK();
 #endif
 		error = nd6_output(ifp, ifp, m0, dst, NULL);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_LOCK();
 #endif
 	} else {
 		in6_ifstat_inc(ifp, ifs6_in_toobig);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		if (r->rt != PF_DUPTO) {
 			PF_UNLOCK();
 			icmp6_error(m0, ICMP6_PACKET_TOO_BIG, 0, ifp->if_mtu);
@@ -5635,7 +5635,7 @@
 #endif /* INET6 */
 
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 /*
  * FreeBSD supports cksum offloads for the following drivers.
  *  em(4), fxp(4), gx(4), ixgb(4), lge(4), ndis(4), nge(4), re(4),
@@ -5866,7 +5866,7 @@
 
 #ifdef INET
 int
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 pf_test(int dir, struct ifnet *ifp, struct mbuf **m0, struct inpcb *inp)
 #else
 pf_test(int dir, struct ifnet *ifp, struct mbuf **m0)
@@ -5882,11 +5882,11 @@
 	struct pf_pdesc		 pd;
 	int			 off, dirndx, pqid = 0;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	PF_LOCK();
 #endif
 	if (!pf_status.running ||
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	    (m->m_flags & M_SKIP_FIREWALL)) {
 		PF_UNLOCK();
 #else
@@ -5897,13 +5897,13 @@
 
 	kif = pfi_index2kif[ifp->if_index];
 	if (kif == NULL) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_UNLOCK();
 #endif
 		return (PF_DROP);
 	}
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	M_ASSERTPKTHDR(m);
 #else
 #ifdef DIAGNOSTIC
@@ -5984,7 +5984,7 @@
 			a = s->anchor.ptr;
 			log = s->log;
 		} else if (s == NULL)
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			action = pf_test_tcp(&r, &s, dir, kif,
 			    m, off, h, &pd, &a, &ruleset, inp);
 #else
@@ -6023,7 +6023,7 @@
 			a = s->anchor.ptr;
 			log = s->log;
 		} else if (s == NULL)
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			action = pf_test_udp(&r, &s, dir, kif,
 			    m, off, h, &pd, &a, &ruleset, inp);
 #else
@@ -6196,7 +6196,7 @@
 		/* pf_route can free the mbuf causing *m0 to become NULL */
 		pf_route(m0, r, dir, ifp, s);
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	PF_UNLOCK();
 #endif
 
@@ -6206,7 +6206,7 @@
 
 #ifdef INET6
 int
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 pf_test6(int dir, struct ifnet *ifp, struct mbuf **m0, struct inpcb *inp)
 #else
 pf_test6(int dir, struct ifnet *ifp, struct mbuf **m0)
@@ -6222,12 +6222,12 @@
 	struct pf_pdesc		 pd;
 	int			 off, terminal = 0, dirndx;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	PF_LOCK();
 #endif
 
 	if (!pf_status.running ||
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	    (m->m_flags & M_SKIP_FIREWALL)) {
 		PF_UNLOCK();
 #else
@@ -6238,13 +6238,13 @@
 
 	kif = pfi_index2kif[ifp->if_index];
 	if (kif == NULL) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_UNLOCK();
 #endif
 		return (PF_DROP);
 	}
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	M_ASSERTPKTHDR(m);
 #else
 #ifdef DIAGNOSTIC
@@ -6347,7 +6347,7 @@
 			a = s->anchor.ptr;
 			log = s->log;
 		} else if (s == NULL)
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			action = pf_test_tcp(&r, &s, dir, kif,
 			    m, off, h, &pd, &a, &ruleset, inp);
 #else
@@ -6386,7 +6386,7 @@
 			a = s->anchor.ptr;
 			log = s->log;
 		} else if (s == NULL)
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			action = pf_test_udp(&r, &s, dir, kif,
 			    m, off, h, &pd, &a, &ruleset, inp);
 #else
@@ -6545,7 +6545,7 @@
 		/* pf_route6 can free the mbuf causing *m0 to become NULL */
 		pf_route6(m0, r, dir, ifp, s);
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	PF_UNLOCK();
 #endif
 	return (action);
diff -ur src.old/sys/contrib/pf/net/pf_if.c src/sys/contrib/pf/net/pf_if.c
--- src.old/sys/contrib/pf/net/pf_if.c	2004-08-16 19:58:12.000000000 +0200
+++ src/sys/contrib/pf/net/pf_if.c	2005-04-05 14:12:30.000000000 +0200
@@ -32,14 +32,14 @@
  * POSSIBILITY OF SUCH DAMAGE.
  */
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #include "opt_inet.h"
 #include "opt_inet6.h"
 #endif
 
 #include <sys/param.h>
 #include <sys/systm.h>
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <sys/malloc.h>
 #endif
 #include <sys/mbuf.h>
@@ -47,8 +47,8 @@
 #include <sys/socket.h>
 #include <sys/socketvar.h>
 #include <sys/kernel.h>
-#ifndef __FreeBSD__
-#include <sys/device.h>
+#ifndef __FreeBSD_kernel__
+
 #endif
 #include <sys/time.h>
 
@@ -83,7 +83,7 @@
 struct pfi_ifhead	  pfi_ifs;
 struct pfi_statehead	  pfi_statehead;
 int			  pfi_ifcnt;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 uma_zone_t		  pfi_addr_pl;
 #else
 struct pool		  pfi_addr_pl;
@@ -96,7 +96,7 @@
 				PF_RESERVED_ANCHOR;
 char			  pfi_interface_ruleset[PF_RULESET_NAME_SIZE] =
 				PF_INTERFACE_RULESET;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 eventhandler_tag	 pfi_clone_cookie = NULL;
 eventhandler_tag	 pfi_attach_cookie = NULL;
 eventhandler_tag	 pfi_detach_cookie = NULL;
@@ -116,7 +116,7 @@
 int		 pfi_skip_if(const char *, struct pfi_kif *, int);
 int		 pfi_unmask(void *);
 void		 pfi_dohooks(struct pfi_kif *);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 void		 pfi_kifaddr_update_event(void *, struct ifnet *);
 void		 pfi_attach_clone_event(void * __unused, struct if_clone *);
 void		 pfi_attach_ifnet_event(void * __unused, struct ifnet *);
@@ -128,7 +128,7 @@
 
 #define PFI_DYNAMIC_BUSES	{ "pcmcia", "cardbus", "uhub" }
 #define PFI_BUFFER_MAX		0x10000
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 MALLOC_DEFINE(PFI_MTYPE, "pf_if", "pf interface table");
 #else
 #define PFI_MTYPE		M_IFADDR
@@ -137,7 +137,7 @@
 void
 pfi_initialize(void)
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct ifnet	*ifp;
 #endif
 
@@ -145,7 +145,7 @@
 		return;
 
 	TAILQ_INIT(&pfi_statehead);
-#ifndef __FreeBSD__
+#ifndef __FreeBSD_kernel__
 	pool_init(&pfi_addr_pl, sizeof(struct pfi_dynaddr), 0, 0, 0,
 	    "pfiaddrpl", &pool_allocator_nointr);
 #endif
@@ -154,7 +154,7 @@
 	    PFI_MTYPE, M_WAITOK);
 	pfi_self = pfi_if_create("self", NULL, PFI_IFLAG_GROUP);
 	pfi_dynamic_drivers();
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	PF_LOCK();
 	IFNET_RLOCK();
 	TAILQ_FOREACH(ifp, &ifnet, if_link)
@@ -176,7 +176,7 @@
 #endif
 }
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 void
 pfi_cleanup(void)
 {
@@ -260,7 +260,7 @@
 	pfi_detach_ifnet(ifp);
 	PF_UNLOCK();
 }
-#endif /* __FreeBSD__ */
+#endif /* 5 */
 
 void
 pfi_attach_clone(struct if_clone *ifc)
@@ -274,7 +274,7 @@
 {
 	struct pfi_kif	*p, *q, key;
 	int		 s;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	int		 realname;
 #endif
 
@@ -297,7 +297,7 @@
 		m = oldlim * sizeof(struct pfi_kif *);
 		mp = pfi_index2kif;
 		n = pfi_indexlim * sizeof(struct pfi_kif *);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		np = malloc(n, PFI_MTYPE, M_NOWAIT);
 #else
 		np = malloc(n, PFI_MTYPE, M_DONTWAIT);
@@ -315,7 +315,7 @@
 
 	strlcpy(key.pfik_name, ifp->if_xname, sizeof(key.pfik_name));
 	p = RB_FIND(pfi_ifhead, &pfi_ifs, &key);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	/* some additional trickery for placeholders */
 	if ((p == NULL) || (p->pfik_parent == pfi_dummy)) {
 		/* are we looking at a renamed instance or not? */
@@ -388,7 +388,7 @@
 		q = p->pfik_parent;
 	p->pfik_ifp = ifp;
 	p->pfik_flags |= PFI_IFLAG_ATTACHED;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	PF_UNLOCK();
 	p->pfik_ah_cookie = EVENTHANDLER_REGISTER(ifaddr_event,
 	    pfi_kifaddr_update_event, p, EVENTHANDLER_PRI_ANY);
@@ -418,7 +418,7 @@
 		splx(s);
 		return;
 	}
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	PF_UNLOCK();
 	EVENTHANDLER_DEREGISTER(ifaddr_event, p->pfik_ah_cookie);
 	PF_LOCK();
@@ -445,7 +445,7 @@
 	if (p == NULL) {
 		pfi_copy_group(key.pfik_name, name, sizeof(key.pfik_name));
 		q = pfi_lookup_if(key.pfik_name);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		if ((q != NULL) && (q->pfik_parent != pfi_dummy))
 			p = pfi_if_create(name, q, PFI_IFLAG_INSTANCE);
 		else {
@@ -699,7 +699,7 @@
 			    pfi_buffer_cnt, PFI_BUFFER_MAX);
 			return;
 		}
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		p = malloc(new_max * sizeof(*pfi_buffer), PFI_MTYPE,
 		    M_NOWAIT);
 #else
@@ -789,7 +789,7 @@
 {
 	struct pfi_kif *p;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	p = malloc(sizeof(*p), PFI_MTYPE, M_NOWAIT);
 #else
 	p = malloc(sizeof(*p), PFI_MTYPE, M_DONTWAIT);
@@ -797,7 +797,7 @@
 	if (p == NULL)
 		return (NULL);
 	bzero(p, sizeof(*p));
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	p->pfik_ah_head = malloc(sizeof(*p->pfik_ah_head), PFI_MTYPE,
 	    M_NOWAIT);
 #else
@@ -816,7 +816,7 @@
 	RB_INIT(&p->pfik_ext_gwy);
 	p->pfik_flags = flags;
 	p->pfik_parent = q;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	p->pfik_tzero = time_second;
 #else
 	p->pfik_tzero = time.tv_sec;
@@ -839,7 +839,7 @@
 
 	if ((p->pfik_flags & (PFI_IFLAG_ATTACHED | PFI_IFLAG_GROUP)) ||
 	    p->pfik_rules > 0 || p->pfik_states > 0)
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		if (!(p->pfik_flags & PFI_IFLAG_PLACEHOLDER))
 #endif
 		return (0);
@@ -853,7 +853,7 @@
 					    p->pfik_bytes[i][j][k];
 					q->pfik_packets[i][j][k] +=
 					    p->pfik_packets[i][j][k];
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			/* clear stats in case we return to the dummy group */
 					p->pfik_bytes[i][j][k] = 0;
 					p->pfik_packets[i][j][k] = 0;
@@ -862,7 +862,7 @@
 		q->pfik_delcnt++;
 		TAILQ_REMOVE(&q->pfik_grouphead, p, pfik_instances);
 	}
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	if (p->pfik_rules > 0 || p->pfik_states > 0) {
 		/* move back to the dummy group */
 		p->pfik_parent = pfi_dummy;
@@ -895,7 +895,7 @@
 void
 pfi_dynamic_drivers(void)
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct ifnet	*ifp;
 
 /*
@@ -995,7 +995,7 @@
 {
 	struct pfi_kif	*p;
 	int		 n = 0, s;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	long		 tzero = time_second;
 #else
 	long		 tzero = time.tv_sec;
@@ -1022,7 +1022,7 @@
 {
 	struct pfi_kif	*p;
 	int		 s, n = 0;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	int		 ec;
 #endif
 
@@ -1034,7 +1034,7 @@
 		if (*size > n++) {
 			if (!p->pfik_tzero)
 				p->pfik_tzero = boottime.tv_sec;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			PF_COPYOUT(p, buf++, sizeof(*buf), ec);
 			if (ec) {
 #else
diff -ur src.old/sys/contrib/pf/net/pf_ioctl.c src/sys/contrib/pf/net/pf_ioctl.c
--- src.old/sys/contrib/pf/net/pf_ioctl.c	2004-10-03 19:04:39.000000000 +0200
+++ src/sys/contrib/pf/net/pf_ioctl.c	2005-04-05 14:12:30.000000000 +0200
@@ -37,20 +37,20 @@
  *
  */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include "opt_inet.h"
 #include "opt_inet6.h"
 #endif
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include "opt_bpf.h"
 #include "opt_pf.h"
 #define	NBPFILTER	DEV_BPF
 #define	NPFLOG		DEV_PFLOG
 #define	NPFSYNC		DEV_PFSYNC
 #else
-#include "bpfilter.h"
-#include "pflog.h"
+
+
 #include "pfsync.h"
 #endif
 
@@ -64,13 +64,13 @@
 #include <sys/kernel.h>
 #include <sys/time.h>
 #include <sys/malloc.h>
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <sys/module.h>
 #include <sys/conf.h>
 #include <sys/proc.h>
 #else
 #include <sys/timeout.h>
-#include <sys/pool.h>
+
 #endif
 
 #include <net/if.h>
@@ -84,8 +84,8 @@
 #include <netinet/ip_var.h>
 #include <netinet/ip_icmp.h>
 
-#ifndef __FreeBSD__
-#include <dev/rndvar.h>
+#ifndef __FreeBSD_kernel__
+
 #endif
 #include <net/pfvar.h>
 
@@ -102,14 +102,14 @@
 #include <altq/altq.h>
 #endif
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <sys/limits.h>
 #include <sys/lock.h>
 #include <sys/mutex.h>
 #include <net/pfil.h>
-#endif /* __FreeBSD__ */
+#endif /* 5 */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 void			 init_zone_var(void);
 void			 cleanup_pf_zone(void);
 int			 pfattach(void);
@@ -124,7 +124,7 @@
 void			 pf_init_ruleset(struct pf_ruleset *);
 void			 pf_mv_pool(struct pf_palist *, struct pf_palist *);
 void			 pf_empty_pool(struct pf_palist *);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 int			 pfioctl(struct cdev *, u_long, caddr_t, int, struct thread *);
 #else
 int			 pfioctl(struct cdev *, u_long, caddr_t, int, struct proc *);
@@ -140,7 +140,7 @@
 int			 pf_rollback_rules(u_int32_t, int, char *, char *);
 int			 pf_commit_rules(u_int32_t, int, char *, char *);
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 extern struct callout	 pf_expire_to;
 #else
 extern struct timeout	 pf_expire_to;
@@ -165,7 +165,7 @@
 #define DPFPRINTF(n, x) if (pf_status.debug >= (n)) printf x
 
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 static struct cdev	*pf_dev;
 
 /*
@@ -340,7 +340,7 @@
 
 	return (error);
 }
-#else /* !__FreeBSD__ */
+#else /* !5 */
 void
 pfattach(int num)
 {
@@ -423,7 +423,7 @@
 		return (ENXIO);
 	return (0);
 }
-#endif /* __FreeBSD__ */
+#endif /* 5 */
 
 struct pf_pool *
 pf_get_pool(char *anchorname, char *rulesetname, u_int32_t ticket,
@@ -922,11 +922,11 @@
 		tb.rate = altq->ifbandwidth;
 		tb.depth = altq->tbrsize;
 		s = splimp();
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_UNLOCK();
 #endif
 		error = tbr_set(&ifp->if_snd, &tb);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_LOCK();
 #endif		
 		splx(s);
@@ -958,11 +958,11 @@
 		/* clear tokenbucket regulator */
 		tb.rate = 0;
 		s = splimp();
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_UNLOCK();
 #endif
 		error = tbr_set(&ifp->if_snd, &tb);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_LOCK();
 #endif
 		splx(s);
@@ -1043,7 +1043,7 @@
 	return (0);
 }
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 int
 pfioctl(struct cdev *dev, u_long cmd, caddr_t addr, int flags, struct thread *td)
 #else
@@ -1057,7 +1057,7 @@
 	int			 error = 0;
 
 	/* XXX keep in sync with switch() below */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	if (securelevel_gt(td->td_ucred, 1))
 #else
 	if (securelevel > 1)
@@ -1100,7 +1100,7 @@
 		case DIOCCLRSRCNODES:
 		case DIOCIGETIFACES:
 		case DIOCICLRISTATS:
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		case DIOCGIFSPEED:
 #endif
 			break;
@@ -1142,7 +1142,7 @@
 		case DIOCOSFPGET:
 		case DIOCGETSRCNODES:
 		case DIOCIGETIFACES:
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		case DIOCGIFSPEED:
 #endif
 			break;
@@ -1163,7 +1163,7 @@
 			return (EACCES);
 		}
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	PF_LOCK();
 #endif
 
@@ -1173,7 +1173,7 @@
 		if (pf_status.running)
 			error = EEXIST;
 		else {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			PF_UNLOCK();
 			error = hook_pf();
 			PF_LOCK();
@@ -1184,13 +1184,13 @@
 			}
 #endif
 			pf_status.running = 1;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			pf_status.since = time_second;
 #else
 			pf_status.since = time.tv_sec;
 #endif
 			if (pf_status.stateid == 0) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 				pf_status.stateid = time_second;
 #else
 				pf_status.stateid = time.tv_sec;
@@ -1206,7 +1206,7 @@
 			error = ENOENT;
 		else {
 			pf_status.running = 0;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			PF_UNLOCK();
 			error = dehook_pf();
 			PF_LOCK();
@@ -1717,7 +1717,7 @@
 		state->nat_rule.ptr = NULL;
 		state->anchor.ptr = NULL;
 		state->rt_kif = NULL;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		state->creation = time_second;
 #else
 		state->creation = time.tv_sec;
@@ -1760,7 +1760,7 @@
 		    -1 : state->anchor.ptr->nr;
 		splx(s);
 		ps->state.expire = pf_state_expires(state);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		if (ps->state.expire > time_second)
 			ps->state.expire -= time_second;
 #else
@@ -1786,7 +1786,7 @@
 				nr += kif->pfik_states;
 			splx(s);
 			ps->ps_len = sizeof(struct pf_state) * nr;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			PF_UNLOCK();
 #endif
 			return (0);
@@ -1797,7 +1797,7 @@
 		TAILQ_FOREACH(kif, &pfi_statehead, pfik_w_states)
 			RB_FOREACH(state, pf_state_tree_ext_gwy,
 			    &kif->pfik_ext_gwy) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 				int	secs = time_second;
 #else
 				int	secs = time.tv_sec;
@@ -1820,7 +1820,7 @@
 					pstore.expire -= secs;
 				else
 					pstore.expire = 0;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 				PF_COPYOUT(&pstore, p, sizeof(*p), error);
 #else
 				error = copyout(&pstore, p, sizeof(*p));
@@ -1976,7 +1976,7 @@
 			error = EINVAL;
 			goto fail;
 		}
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		uma_zone_set_max(pf_pool_limits[pl->index].pp, pl->limit);
 #else
 		if (pool_sethardlimit(pf_pool_limits[pl->index].pp,
@@ -2011,7 +2011,7 @@
 		break;
 	}
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	case DIOCGIFSPEED: {
 		struct pf_ifspeed	*psp = (struct pf_ifspeed *)addr;
 		struct pf_ifspeed	ps;
@@ -2029,7 +2029,7 @@
 			error = EINVAL;
 		break;
 	}
-#endif /* __FreeBSD__ */
+#endif /* 5 */
 
 #ifdef ALTQ
 	case DIOCSTARTALTQ: {
@@ -2111,11 +2111,11 @@
 			}
 		}
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_UNLOCK();
 #endif		
 		error = altq_add(altq);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_LOCK();
 #endif
 		if (error) {
@@ -2202,11 +2202,11 @@
 			splx(s);
 			break;
 		}
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_UNLOCK();
 #endif
 		error = altq_getqstats(altq, pq->buf, &nbytes);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		PF_LOCK();
 #endif
 		splx(s);
@@ -2749,7 +2749,7 @@
 			goto fail;
 		}
 		for (i = 0; i < io->size; i++) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			PF_COPYIN(io->array+i, &ioe, sizeof(ioe), error);
 			if (error) {
 #else
@@ -2785,7 +2785,7 @@
 					goto fail;
 				break;
 			}
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			PF_COPYOUT(&ioe, io->array+i, sizeof(io->array[i]),
 			    error);
 			if (error) {
@@ -2810,7 +2810,7 @@
 			goto fail;
 		}
 		for (i = 0; i < io->size; i++) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			PF_COPYIN(io->array+i, &ioe, sizeof(ioe), error);
 			if (error) {
 #else
@@ -2863,7 +2863,7 @@
 		}
 		/* first makes sure everything will succeed */
 		for (i = 0; i < io->size; i++) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			PF_COPYIN(io->array+i, &ioe, sizeof(ioe), error);
 			if (error) {
 #else
@@ -2913,7 +2913,7 @@
 		}
 		/* now do the commit - no errors should happen here */
 		for (i = 0; i < io->size; i++) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			PF_COPYIN(io->array+i, &ioe, sizeof(ioe), error);
 			if (error) {
 #else
@@ -2962,7 +2962,7 @@
 				nr++;
 			splx(s);
 			psn->psn_len = sizeof(struct pf_src_node) * nr;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			PF_UNLOCK();
 #endif
 			return (0);
@@ -2971,7 +2971,7 @@
 		s = splsoftnet();
 		p = psn->psn_src_nodes;
 		RB_FOREACH(n, pf_src_tree, &tree_src_tracking) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			int	secs = time_second;
 #else
 			int	secs = time.tv_sec;
@@ -2988,7 +2988,7 @@
 				pstore.expire -= secs;
 			else
 				pstore.expire = 0;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			PF_COPYOUT(&pstore, p, sizeof(*p), error);
 #else
 			error = copyout(&pstore, p, sizeof(*p));
@@ -3066,13 +3066,13 @@
 		break;
 	}
 fail:
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	PF_UNLOCK();
 #endif
 	return (error);
 }
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 /*
  * XXX - Check for version missmatch!!!
  */
@@ -3459,4 +3459,4 @@
 
 DECLARE_MODULE(pf, pf_mod, SI_SUB_PROTO_IFATTACHDOMAIN, SI_ORDER_FIRST);
 MODULE_VERSION(pf, PF_MODVER);
-#endif	/* __FreeBSD__ */
+#endif	/* 5 */
diff -ur src.old/sys/contrib/pf/net/pf_norm.c src/sys/contrib/pf/net/pf_norm.c
--- src.old/sys/contrib/pf/net/pf_norm.c	2004-08-14 17:32:40.000000000 +0200
+++ src/sys/contrib/pf/net/pf_norm.c	2005-04-05 14:12:30.000000000 +0200
@@ -27,13 +27,13 @@
  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include "opt_inet.h"
 #include "opt_inet6.h"
 #include "opt_pf.h"
 #define	NPFLOG DEV_PFLOG
 #else
-#include "pflog.h"
+
 #endif
 
 #include <sys/param.h>
@@ -44,10 +44,10 @@
 #include <sys/socket.h>
 #include <sys/kernel.h>
 #include <sys/time.h>
-#ifndef __FreeBSD__
-#include <sys/pool.h>
+#ifndef __FreeBSD_kernel__
+
+
 
-#include <dev/rndvar.h>
 #endif
 #include <net/if.h>
 #include <net/if_types.h>
@@ -71,7 +71,7 @@
 
 #include <net/pfvar.h>
 
-#if defined(__FreeBSD__) && defined(INET6)
+#if defined(__FreeBSD_kernel__) && defined(INET6)
 /*
  * XXX: This should go to netinet/ip6.h (KAME)
  */
@@ -111,9 +111,9 @@
 	u_int8_t ip6or_len;
 	u_int8_t ip6or_value[2];
 } __packed;
-#endif /* __FreeBSD__ && INET6 */
+#endif /* 5 && INET6 */
 
-#ifndef __FreeBSD__
+#ifndef __FreeBSD_kernel__
 struct pf_frent {
 	LIST_ENTRY(pf_frent) fr_next;
 	struct ip *fr_ip;
@@ -132,7 +132,7 @@
 #define PFFRAG_DROP	0x0004		/* Drop all fragments */
 #define BUFFER_FRAGMENTS(fr)	(!((fr)->fr_flags & PFFRAG_NOBUFFER))
 
-#ifndef __FreeBSD__
+#ifndef __FreeBSD_kernel__
 struct pf_fragment {
 	RB_ENTRY(pf_fragment) fr_entry;
 	TAILQ_ENTRY(pf_fragment) frag_next;
@@ -155,7 +155,7 @@
 TAILQ_HEAD(pf_fragqueue, pf_fragment)	pf_fragqueue;
 TAILQ_HEAD(pf_cachequeue, pf_fragment)	pf_cachequeue;
 
-#ifndef __FreeBSD__
+#ifndef __FreeBSD_kernel__
 static __inline int	 pf_frag_compare(struct pf_fragment *,
 			    struct pf_fragment *);
 #else
@@ -183,7 +183,7 @@
 			    { printf("%s: ", __func__); printf x ;}
 
 /* Globals */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 uma_zone_t		 pf_frent_pl, pf_frag_pl, pf_cache_pl, pf_cent_pl;
 uma_zone_t		 pf_state_scrub_pl;
 #else
@@ -195,7 +195,7 @@
 void
 pf_normalize_init(void)
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	/*
 	 * XXX
 	 * No high water mark support(It's hint not hard limit).
@@ -226,7 +226,7 @@
 	TAILQ_INIT(&pf_cachequeue);
 }
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 static int
 #else
 static __inline int
@@ -254,7 +254,7 @@
 pf_purge_expired_fragments(void)
 {
 	struct pf_fragment	*frag;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	u_int32_t		 expire = time_second - 
 				    pf_default_rule.timeout[PFTM_FRAG];
 #else
@@ -263,7 +263,7 @@
 #endif
 
 	while ((frag = TAILQ_LAST(&pf_fragqueue, pf_fragqueue)) != NULL) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		KASSERT((BUFFER_FRAGMENTS(frag)),
 			("BUFFER_FRAGMENTS(frag) == 0: %s", __FUNCTION__));
 #else
@@ -277,7 +277,7 @@
 	}
 
 	while ((frag = TAILQ_LAST(&pf_cachequeue, pf_cachequeue)) != NULL) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		KASSERT((!BUFFER_FRAGMENTS(frag)),
 			("BUFFER_FRAGMENTS(frag) != 0: %s", __FUNCTION__));
 #else
@@ -288,7 +288,7 @@
 
 		DPFPRINTF(("expiring %d(%p)\n", frag->fr_id, frag));
 		pf_free_fragment(frag);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		KASSERT((TAILQ_EMPTY(&pf_cachequeue) ||
 		    TAILQ_LAST(&pf_cachequeue, pf_cachequeue) != frag),
 		    ("!(TAILQ_EMPTY() || TAILQ_LAST() == farg): %s",
@@ -355,7 +355,7 @@
 		    frcache = LIST_FIRST(&frag->fr_cache)) {
 			LIST_REMOVE(frcache, fr_next);
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			KASSERT((LIST_EMPTY(&frag->fr_cache) ||
 			    LIST_FIRST(&frag->fr_cache)->fr_off >
 			    frcache->fr_end),
@@ -395,7 +395,7 @@
 	frag = RB_FIND(pf_frag_tree, tree, &key);
 	if (frag != NULL) {
 		/* XXX Are we sure we want to update the timeout? */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		frag->fr_timeout = time_second;
 #else
 		frag->fr_timeout = time.tv_sec;
@@ -442,7 +442,7 @@
 	u_int16_t	 ip_len = ntohs(ip->ip_len) - ip->ip_hl * 4;
 	u_int16_t	 max = ip_len + off;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	KASSERT((*frag == NULL || BUFFER_FRAGMENTS(*frag)),
 	    ("! (*frag == NULL || BUFFER_FRAGMENTS(*frag)): %s", __FUNCTION__));
 #else
@@ -469,7 +469,7 @@
 		(*frag)->fr_dst = frent->fr_ip->ip_dst;
 		(*frag)->fr_p = frent->fr_ip->ip_p;
 		(*frag)->fr_id = frent->fr_ip->ip_id;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		(*frag)->fr_timeout = time_second;
 #else
 		(*frag)->fr_timeout = time.tv_sec;
@@ -494,7 +494,7 @@
 		frep = frea;
 	}
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	KASSERT((frep != NULL || frea != NULL),
 	    ("!(frep != NULL || frea != NULL): %s", __FUNCTION__));;
 #else
@@ -584,7 +584,7 @@
 
 	/* We have all the data */
 	frent = LIST_FIRST(&(*frag)->fr_queue);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	KASSERT((frent != NULL), ("frent == NULL: %s", __FUNCTION__));
 #else
 	KASSERT(frent != NULL);
@@ -657,7 +657,7 @@
 	u_int16_t		 max = ip_len + off;
 	int			 hosed = 0;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	KASSERT((*frag == NULL || !BUFFER_FRAGMENTS(*frag)),
 	    ("!(*frag == NULL || !BUFFER_FRAGMENTS(*frag)): %s", __FUNCTION__));
 #else
@@ -689,7 +689,7 @@
 		(*frag)->fr_dst = h->ip_dst;
 		(*frag)->fr_p = h->ip_p;
 		(*frag)->fr_id = h->ip_id;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		(*frag)->fr_timeout = time_second;
 #else
 		(*frag)->fr_timeout = time.tv_sec;
@@ -719,7 +719,7 @@
 		frp = fra;
 	}
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	KASSERT((frp != NULL || fra != NULL),
 	    ("!(frp != NULL || fra != NULL): %s", __FUNCTION__));
 #else
@@ -766,7 +766,7 @@
 				 * than this mbuf magic.  For my next trick,
 				 * I'll pull a rabbit out of my laptop.
 				 */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 				*m0 = m_dup(m, M_DONTWAIT);
 				/* From KAME Project : We have missed this! */
 				m_adj(*m0, (h->ip_hl << 2) -
@@ -776,7 +776,7 @@
 #endif
 				if (*m0 == NULL)
 					goto no_mem;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 				KASSERT(((*m0)->m_next == NULL), 
 				    ("(*m0)->m_next != NULL: %s", 
 				    __FUNCTION__));
@@ -797,7 +797,7 @@
 
 				h = mtod(m, struct ip *);
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 				KASSERT(((int)m->m_len ==
 				    ntohs(h->ip_len) - precut),
 				    ("m->m_len != ntohs(h->ip_len) - precut: %s",
@@ -861,7 +861,7 @@
 					m->m_pkthdr.len = plen;
 				}
 				h = mtod(m, struct ip *);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 				KASSERT(((int)m->m_len == ntohs(h->ip_len) - aftercut),
 				    ("m->m_len != ntohs(h->ip_len) - aftercut: %s",
 				    __FUNCTION__));
@@ -906,7 +906,7 @@
 
 			} else if (frp && fra->fr_off <= frp->fr_end) {
 				/* Need to merge in a modified 'frp' */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 				KASSERT((cur == NULL), ("cur != NULL: %s",
 				    __FUNCTION__));
 #else
@@ -1489,7 +1489,7 @@
 	u_int8_t hdr[60];
 	u_int8_t *opt;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	KASSERT((src->scrub == NULL), 
 	    ("pf_normalize_tcp_init: src->scrub != NULL"));
 #else
@@ -1578,7 +1578,7 @@
 	u_int8_t *opt;
 	int copyback = 0;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	KASSERT((src->scrub || dst->scrub), 
 	    ("pf_normalize_tcp_statefull: src->scrub && dst->scrub!"));
 #else
diff -ur src.old/sys/contrib/pf/net/pf_osfp.c src/sys/contrib/pf/net/pf_osfp.c
--- src.old/sys/contrib/pf/net/pf_osfp.c	2004-06-17 01:24:00.000000000 +0200
+++ src/sys/contrib/pf/net/pf_osfp.c	2005-04-05 14:12:31.000000000 +0200
@@ -41,7 +41,7 @@
 # define DPFPRINTF(format, x...)		\
 	if (pf_status.debug >= PF_DEBUG_NOISY)	\
 		printf(format , ##x)
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 typedef uma_zone_t pool_t;
 #else
 typedef struct pool pool_t;
@@ -60,7 +60,7 @@
 # define pool_put(pool, item)	free(item)
 # define pool_init(pool, size, a, ao, f, m, p)	(*(pool)) = (size)
 
-# ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 # define NTOHS(x) (x) = ntohs((u_int16_t)(x))
 # endif
 
@@ -237,14 +237,14 @@
 }
 
 /* Initialize the OS fingerprint system */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 int
 #else
 void
 #endif
 pf_osfp_initialize(void)
 {
-#if defined(__FreeBSD__) && defined(_KERNEL)
+#if defined(__FreeBSD_kernel__) && defined(_KERNEL)
 	int error = ENOMEM;
 	
 	do {
@@ -260,7 +260,7 @@
 	    "pfosfp", NULL);
 #endif
 	SLIST_INIT(&pf_osfp_list);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #ifdef _KERNEL
 	return (error);
 #else
@@ -269,7 +269,7 @@
 #endif
 }
 
-#if defined(__FreeBSD__) && (_KERNEL)
+#if defined(__FreeBSD_kernel__) && (_KERNEL)
 void
 pf_osfp_cleanup(void)
 {
diff -ur src.old/sys/contrib/pf/net/pf_table.c src/sys/contrib/pf/net/pf_table.c
--- src.old/sys/contrib/pf/net/pf_table.c	2004-07-28 08:14:44.000000000 +0200
+++ src/sys/contrib/pf/net/pf_table.c	2005-04-05 14:12:31.000000000 +0200
@@ -31,7 +31,7 @@
  *
  */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include "opt_inet.h"
 #include "opt_inet6.h"
 #endif
@@ -41,15 +41,15 @@
 #include <sys/socket.h>
 #include <sys/mbuf.h>
 #include <sys/kernel.h>
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <sys/malloc.h>
 #endif
 
 #include <net/if.h>
 #include <net/route.h>
 #include <netinet/in.h>
-#ifndef __FreeBSD__
-#include <netinet/ip_ipsp.h>
+#ifndef __FreeBSD_kernel__
+
 #endif
 
 #include <net/pfvar.h>
@@ -61,7 +61,7 @@
 			return (EINVAL);	\
 	} while (0)
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 static inline int
 _copyin(const void *uaddr, void *kaddr, size_t len)
 {
@@ -174,7 +174,7 @@
 
 #define senderr(e)	do { rv = (e); goto _bad; } while (0)
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 uma_zone_t		 pfr_ktable_pl;
 uma_zone_t		 pfr_kentry_pl;
 #else
@@ -242,7 +242,7 @@
 void
 pfr_initialize(void)
 {
-#ifndef __FreeBSD__
+#ifndef __FreeBSD_kernel__
 	pool_init(&pfr_ktable_pl, sizeof(struct pfr_ktable), 0, 0, 0,
 	    "pfrktable", NULL);
 	pool_init(&pfr_kentry_pl, sizeof(struct pfr_kentry), 0, 0, 0,
@@ -299,7 +299,7 @@
 	struct pfr_kentry	*p, *q;
 	struct pfr_addr		 ad;
 	int			 i, rv, s = 0, xadd = 0;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	/*
 	 * XXX Is it OK under LP64 environments?
 	 */
@@ -447,7 +447,7 @@
 	struct pfr_kentry	*p, *q;
 	struct pfr_addr		 ad;
 	int			 i, rv, s = 0, xadd = 0, xdel = 0, xchange = 0;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	/*
 	 * XXX Is it OK under LP64 environments?
 	 */
@@ -619,13 +619,13 @@
 	w.pfrw_addr = addr;
 	w.pfrw_free = kt->pfrkt_cnt;
 	w.pfrw_flags = flags;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	rv = kt->pfrkt_ip4->rnh_walktree(kt->pfrkt_ip4, pfr_walktree, &w);
 #else
 	rv = rn_walktree(kt->pfrkt_ip4, pfr_walktree, &w);
 #endif
 	if (!rv)
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		rv = kt->pfrkt_ip6->rnh_walktree(kt->pfrkt_ip6, pfr_walktree, 
 		    &w);
 #else
@@ -651,7 +651,7 @@
 	struct pfr_walktree	 w;
 	struct pfr_kentryworkq	 workq;
 	int			 rv, s = 0;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	/*
 	 * XXX Is it OK under LP64 environments?
 	 */
@@ -678,13 +678,13 @@
 	w.pfrw_flags = flags;
 	if (flags & PFR_FLAG_ATOMIC)
 		s = splsoftnet();
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	rv = kt->pfrkt_ip4->rnh_walktree(kt->pfrkt_ip4, pfr_walktree, &w);
 #else
 	rv = rn_walktree(kt->pfrkt_ip4, pfr_walktree, &w);
 #endif
 	if (!rv)
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		rv = kt->pfrkt_ip6->rnh_walktree(kt->pfrkt_ip6, pfr_walktree, 
 		    &w);
 #else
@@ -800,7 +800,7 @@
 	w.pfrw_op = sweep ? PFRW_SWEEP : PFRW_ENQUEUE;
 	w.pfrw_workq = workq;
 	if (kt->pfrkt_ip4 != NULL)
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		if (kt->pfrkt_ip4->rnh_walktree(kt->pfrkt_ip4, pfr_walktree, 
 		    &w))
 #else
@@ -808,7 +808,7 @@
 #endif
 			printf("pfr_enqueue_addrs: IPv4 walktree failed.\n");
 	if (kt->pfrkt_ip6 != NULL)
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		if (kt->pfrkt_ip6->rnh_walktree(kt->pfrkt_ip6, pfr_walktree, 
 		    &w))
 #else
@@ -826,13 +826,13 @@
 
 	bzero(&w, sizeof(w));
 	w.pfrw_op = PFRW_MARK;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	if (kt->pfrkt_ip4->rnh_walktree(kt->pfrkt_ip4, pfr_walktree, &w))
 #else
 	if (rn_walktree(kt->pfrkt_ip4, pfr_walktree, &w))
 #endif
 		printf("pfr_mark_addrs: IPv4 walktree failed.\n");
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	if (kt->pfrkt_ip6->rnh_walktree(kt->pfrkt_ip6, pfr_walktree, &w))
 #else
 	if (rn_walktree(kt->pfrkt_ip6, pfr_walktree, &w))
@@ -860,11 +860,11 @@
 	if (ADDR_NETWORK(ad)) {
 		pfr_prepare_network(&mask, ad->pfra_af, ad->pfra_net);
 		s = splsoftnet(); /* rn_lookup makes use of globals */
-#if defined(__FreeBSD__) && (__FreeBSD_version >= 500100)
+#if defined(__FreeBSD_kernel__) && (__FreeBSD_version >= 500100)
 		RADIX_NODE_HEAD_LOCK(head);
 #endif
 		ke = (struct pfr_kentry *)rn_lookup(&sa, &mask, head);
-#if defined(__FreeBSD__) && (__FreeBSD_version >= 500100)
+#if defined(__FreeBSD_kernel__) && (__FreeBSD_version >= 500100)
 		RADIX_NODE_HEAD_UNLOCK(head);
 #endif
 		splx(s);
@@ -1034,7 +1034,7 @@
 		head = kt->pfrkt_ip6;
 
 	s = splsoftnet();
-#if defined(__FreeBSD__) && (__FreeBSD_version >= 500100)
+#if defined(__FreeBSD_kernel__) && (__FreeBSD_version >= 500100)
 	RADIX_NODE_HEAD_LOCK(head);
 #endif
 	if (KENTRY_NETWORK(ke)) {
@@ -1042,7 +1042,7 @@
 		rn = rn_addroute(&ke->pfrke_sa, &mask, head, ke->pfrke_node);
 	} else
 		rn = rn_addroute(&ke->pfrke_sa, NULL, head, ke->pfrke_node);
-#if defined(__FreeBSD__) && (__FreeBSD_version >= 500100)
+#if defined(__FreeBSD_kernel__) && (__FreeBSD_version >= 500100)
 	RADIX_NODE_HEAD_UNLOCK(head);
 #endif
 	splx(s);
@@ -1064,7 +1064,7 @@
 		head = kt->pfrkt_ip6;
 
 	s = splsoftnet();
-#if defined(__FreeBSD__) && (__FreeBSD_version >= 500100)
+#if defined(__FreeBSD_kernel__) && (__FreeBSD_version >= 500100)
 	RADIX_NODE_HEAD_LOCK(head);
 #endif
 	if (KENTRY_NETWORK(ke)) {
@@ -1072,7 +1072,7 @@
 		rn = rn_delete(&ke->pfrke_sa, &mask, head);
 	} else
 		rn = rn_delete(&ke->pfrke_sa, NULL, head);
-#if defined(__FreeBSD__) && (__FreeBSD_version >= 500100)
+#if defined(__FreeBSD_kernel__) && (__FreeBSD_version >= 500100)
 	RADIX_NODE_HEAD_UNLOCK(head);
 #endif
 	splx(s);
@@ -1219,7 +1219,7 @@
 	struct pfr_ktableworkq	 addq, changeq;
 	struct pfr_ktable	*p, *q, *r, key;
 	int			 i, rv, s = 0, xadd = 0;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	/*
 	 * XXX Is it OK under LP64 environments?
 	 */
@@ -1379,7 +1379,7 @@
 	struct pfr_ktable	*p;
 	struct pfr_ktableworkq	 workq;
 	int			 s = 0, n, nn;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	/*
 	 * XXX Is it OK under LP64 environments?
 	 */
@@ -1435,7 +1435,7 @@
 	struct pfr_ktableworkq	 workq;
 	struct pfr_ktable	*p, key;
 	int			 i, s = 0, xzero = 0;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	/*
 	 * XXX Is it OK under LP64 environments?
 	 */
@@ -1695,7 +1695,7 @@
 	struct pfr_ktableworkq	 workq;
 	struct pf_ruleset	*rs;
 	int			 s = 0, xadd = 0, xchange = 0;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	/*
 	 * XXX Is it OK under LP64 environments?
 	 */
@@ -1999,7 +1999,7 @@
 		pfr_clean_node_mask(kt, &addrq);
 		pfr_destroy_kentries(&addrq);
 	}
-#if defined(__FreeBSD__) && (__FreeBSD_version >= 500100)
+#if defined(__FreeBSD_kernel__) && (__FreeBSD_version >= 500100)
 	if (kt->pfrkt_ip4 != NULL) {
 		RADIX_NODE_HEAD_DESTROY(kt->pfrkt_ip4);
 		free((caddr_t)kt->pfrkt_ip4, M_RTABLE);
@@ -2133,7 +2133,7 @@
 	}
 	kt = pfr_lookup_table(&tbl);
 	if (kt == NULL) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		/*
 		 * XXX Is it OK under LP64 environments?
 		 */
@@ -2264,14 +2264,14 @@
 
 	switch (af) {
 	case AF_INET:
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		kt->pfrkt_ip4->rnh_walktree(kt->pfrkt_ip4, pfr_walktree, &w);
 #else
 		rn_walktree(kt->pfrkt_ip4, pfr_walktree, &w);
 #endif
 		return (w.pfrw_kentry);
 	case AF_INET6:
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		kt->pfrkt_ip6->rnh_walktree(kt->pfrkt_ip6, pfr_walktree, &w);
 #else
 		rn_walktree(kt->pfrkt_ip6, pfr_walktree, &w);
@@ -2296,13 +2296,13 @@
 	dyn->pfid_acnt4 = 0;
 	dyn->pfid_acnt6 = 0;
 	if (!dyn->pfid_af || dyn->pfid_af == AF_INET)
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		kt->pfrkt_ip4->rnh_walktree(kt->pfrkt_ip4, pfr_walktree, &w);
 #else
 		rn_walktree(kt->pfrkt_ip4, pfr_walktree, &w);
 #endif
 	if (!dyn->pfid_af || dyn->pfid_af == AF_INET6)
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		kt->pfrkt_ip6->rnh_walktree(kt->pfrkt_ip6, pfr_walktree, &w);
 #else
 		rn_walktree(kt->pfrkt_ip6, pfr_walktree, &w);
diff -ur src.old/sys/contrib/pf/net/pfvar.h src/sys/contrib/pf/net/pfvar.h
--- src.old/sys/contrib/pf/net/pfvar.h	2004-10-03 19:04:39.000000000 +0200
+++ src/sys/contrib/pf/net/pfvar.h	2005-04-05 14:12:31.000000000 +0200
@@ -40,21 +40,21 @@
 #include <sys/tree.h>
 
 #include <net/radix.h>
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <net/if_clone.h>
 #include <vm/uma.h>
 #else
-#include <netinet/ip_ipsp.h>
+
 #endif
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <netinet/in.h>
 #endif
 
 #include <netinet/tcp_fsm.h>
 
 struct ip;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 struct inpcb;
 #endif
 
@@ -160,7 +160,7 @@
  * Address manipulation macros
  */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define splsoftnet()	splnet()
 
 #define	HTONL(x)	(x) = htonl((__uint32_t)(x))
@@ -234,7 +234,7 @@
 
 #define HOOK_REMOVE     0x01
 #define HOOK_FREE       0x02
-#endif	/* __FreeBSD__ */
+#endif	/* 5 */
 
 #ifdef INET
 #ifndef INET6
@@ -1372,7 +1372,7 @@
 #define DIOCSETHOSTID	_IOWR('D', 86, u_int32_t)
 #define DIOCIGETIFACES	_IOWR('D', 87, struct pfioc_iface)
 #define DIOCICLRISTATS  _IOWR('D', 88, struct pfioc_iface)
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 struct pf_ifspeed {
 	char			ifname[IFNAMSIZ];
 	u_int32_t		baudrate;
@@ -1414,7 +1414,7 @@
 extern void			 pf_tbladdr_copyout(struct pf_addr_wrap *);
 extern void			 pf_calc_skip_steps(struct pf_rulequeue *);
 extern void			 pf_update_anchor_rules(void);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 extern uma_zone_t		 pf_src_tree_pl, pf_rule_pl;
 extern uma_zone_t		 pf_state_pl, pf_altq_pl, pf_pooladdr_pl;
 extern uma_zone_t		 pfr_ktable_pl, pfr_kentry_pl;
@@ -1456,7 +1456,7 @@
 				    struct pf_rule *);
 
 #ifdef INET
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 int	pf_test(int, struct ifnet *, struct mbuf **, struct inpcb *);
 #else
 int	pf_test(int, struct ifnet *, struct mbuf **);
@@ -1464,7 +1464,7 @@
 #endif /* INET */
 
 #ifdef INET6
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 int	pf_test6(int, struct ifnet *, struct mbuf **, struct inpcb *);
 #else
 int	pf_test6(int, struct ifnet *, struct mbuf **);
@@ -1538,7 +1538,7 @@
 	    int *, u_int32_t, int);
 
 void		 pfi_initialize(void);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 void		 pfi_cleanup(void);
 #endif
 void		 pfi_attach_clone(struct if_clone *);
@@ -1572,7 +1572,7 @@
 
 extern struct pf_status	pf_status;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 extern uma_zone_t	pf_frent_pl, pf_frag_pl;
 #else
 extern struct pool	pf_frent_pl, pf_frag_pl;
@@ -1584,7 +1584,7 @@
 };
 extern struct pf_pool_limit	pf_pool_limits[PF_LIMIT_MAX];
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 struct pf_frent {
 	LIST_ENTRY(pf_frent) fr_next;
 	struct ip *fr_ip;
@@ -1614,7 +1614,7 @@
 		LIST_HEAD(pf_cacheq, pf_frcache) fru_cache;     /* non-buf */
 	} fr_u;
 };
-#endif /* (__FreeBSD__) */
+#endif /* (5) */
 
 #endif /* _KERNEL */
 
@@ -1629,7 +1629,7 @@
 	pf_osfp_fingerprint_hdr(const struct ip *, const struct tcphdr *);
 void	pf_osfp_flush(void);
 int	pf_osfp_get(struct pf_osfp_ioctl *);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 int	pf_osfp_initialize(void);
 void	pf_osfp_cleanup(void);
 #else
diff -ur src.old/sys/crypto/sha2/sha2.c src/sys/crypto/sha2/sha2.c
--- src.old/sys/crypto/sha2/sha2.c	2003-09-08 20:32:33.000000000 +0200
+++ src/sys/crypto/sha2/sha2.c	2005-04-05 14:12:35.000000000 +0200
@@ -67,7 +67,7 @@
  *
  */
 
-#if defined(__bsdi__) || defined(__FreeBSD__)
+#if defined(__bsdi__) || defined(__FreeBSD_kernel__)
 #define assert(x)
 #endif
 
diff -ur src.old/sys/dev/aic7xxx/aic79xx.c src/sys/dev/aic7xxx/aic79xx.c
--- src.old/sys/dev/aic7xxx/aic79xx.c	2004-09-02 17:33:15.000000000 +0200
+++ src/sys/dev/aic7xxx/aic79xx.c	2005-04-05 14:12:45.000000000 +0200
@@ -2234,7 +2234,7 @@
 			printerror = 0;
 		} else if (ahd_sent_msg(ahd, AHDMSG_1B,
 					MSG_BUS_DEV_RESET, TRUE)) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 			/*
 			 * Don't mark the user's request for this BDR
 			 * as completing with CAM_BDR_SENT.  CAM3
@@ -5225,7 +5225,7 @@
 {
 	struct  ahd_softc *ahd;
 
-#ifndef	__FreeBSD__
+#ifndef __FreeBSD_kernel__
 	ahd = malloc(sizeof(*ahd), M_DEVBUF, M_NOWAIT);
 	if (!ahd) {
 		printf("aic7xxx: cannot malloc softc!\n");
@@ -5239,7 +5239,7 @@
 	ahd->seep_config = malloc(sizeof(*ahd->seep_config),
 				  M_DEVBUF, M_NOWAIT);
 	if (ahd->seep_config == NULL) {
-#ifndef	__FreeBSD__
+#ifndef __FreeBSD_kernel__
 		free(ahd, M_DEVBUF);
 #endif
 		free(name, M_DEVBUF);
@@ -5441,7 +5441,7 @@
 		free(ahd->seep_config, M_DEVBUF);
 	if (ahd->saved_stack != NULL)
 		free(ahd->saved_stack, M_DEVBUF);
-#ifndef __FreeBSD__
+#ifndef __FreeBSD_kernel__
 	free(ahd, M_DEVBUF);
 #endif
 	return;
diff -ur src.old/sys/dev/aic7xxx/aic7xxx.c src/sys/dev/aic7xxx/aic7xxx.c
--- src.old/sys/dev/aic7xxx/aic7xxx.c	2004-08-17 02:14:30.000000000 +0200
+++ src/sys/dev/aic7xxx/aic7xxx.c	2005-04-05 14:12:47.000000000 +0200
@@ -1280,7 +1280,7 @@
 				printerror = 0;
 			} else if (ahc_sent_msg(ahc, AHCMSG_1B,
 						MSG_BUS_DEV_RESET, TRUE)) {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 				/*
 				 * Don't mark the user's request for this BDR
 				 * as completing with CAM_BDR_SENT.  CAM3
@@ -3830,7 +3830,7 @@
 	struct  ahc_softc *ahc;
 	int	i;
 
-#ifndef	__FreeBSD__
+#ifndef __FreeBSD_kernel__
 	ahc = malloc(sizeof(*ahc), M_DEVBUF, M_NOWAIT);
 	if (!ahc) {
 		printf("aic7xxx: cannot malloc softc!\n");
@@ -3844,7 +3844,7 @@
 	ahc->seep_config = malloc(sizeof(*ahc->seep_config),
 				  M_DEVBUF, M_NOWAIT);
 	if (ahc->seep_config == NULL) {
-#ifndef	__FreeBSD__
+#ifndef __FreeBSD_kernel__
 		free(ahc, M_DEVBUF);
 #endif
 		free(name, M_DEVBUF);
@@ -4053,7 +4053,7 @@
 		free(ahc->name, M_DEVBUF);
 	if (ahc->seep_config != NULL)
 		free(ahc->seep_config, M_DEVBUF);
-#ifndef __FreeBSD__
+#ifndef __FreeBSD_kernel__
 	free(ahc, M_DEVBUF);
 #endif
 	return;
diff -ur src.old/sys/dev/asr/i2oadptr.h src/sys/dev/asr/i2oadptr.h
--- src.old/sys/dev/asr/i2oadptr.h	2002-05-14 23:59:10.000000000 +0200
+++ src/sys/dev/asr/i2oadptr.h	2005-04-05 14:12:53.000000000 +0200
@@ -83,7 +83,7 @@
 #if !defined(I2O_ADPTR_HDR)
 #define	I2O_ADPTR_HDR
 
-#if ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD__))
+#if ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD_kernel__))
 # if (KERN_VERSION < 3)
 #  include "i386/pci/i2omsg.h"
 # else
diff -ur src.old/sys/dev/asr/i2obscsi.h src/sys/dev/asr/i2obscsi.h
--- src.old/sys/dev/asr/i2obscsi.h	2002-05-14 23:59:10.000000000 +0200
+++ src/sys/dev/asr/i2obscsi.h	2005-04-05 14:12:53.000000000 +0200
@@ -83,7 +83,7 @@
 #if !defined(I2O_BASE_SCSI_HDR)
 #define	I2O_BASE_SCSI_HDR
 
-#if ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD__))
+#if ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD_kernel__))
 # if (KERN_VERSION < 3)
 #  include    "i386/pci/i2omsg.h"	   /* Include the Base Message file */
 # else
diff -ur src.old/sys/dev/asr/i2oexec.h src/sys/dev/asr/i2oexec.h
--- src.old/sys/dev/asr/i2oexec.h	2002-05-14 23:59:10.000000000 +0200
+++ src/sys/dev/asr/i2oexec.h	2005-04-05 14:12:53.000000000 +0200
@@ -92,7 +92,7 @@
 
 #define	I2OEXEC_REV 1_5_4  /* I2OExec header file revision string */
 
-#if ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD__))
+#if ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD_kernel__))
 # if (!defined(KERN_VERSION))
 #  include <sys/sysctl.h>
 # endif
diff -ur src.old/sys/dev/asr/i2omsg.h src/sys/dev/asr/i2omsg.h
--- src.old/sys/dev/asr/i2omsg.h	2002-05-14 23:59:10.000000000 +0200
+++ src/sys/dev/asr/i2omsg.h	2005-04-05 14:12:53.000000000 +0200
@@ -116,7 +116,7 @@
 
 
 
-#if ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD__))
+#if ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD_kernel__))
 # if (KERN_VERSION < 3)
 #  include "i386/pci/i2otypes.h"
 # else
diff -ur src.old/sys/dev/asr/i2otypes.h src/sys/dev/asr/i2otypes.h
--- src.old/sys/dev/asr/i2otypes.h	2002-05-14 23:59:10.000000000 +0200
+++ src/sys/dev/asr/i2otypes.h	2005-04-05 14:12:53.000000000 +0200
@@ -87,7 +87,7 @@
 
 /* include architecture/compiler dependencies */
 
-#if ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD__))
+#if ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD_kernel__))
 # if (KERN_VERSION < 3)
 #  include "i386/pci/i2odep.h"
 # else
diff -ur src.old/sys/dev/asr/i2outil.h src/sys/dev/asr/i2outil.h
--- src.old/sys/dev/asr/i2outil.h	2002-05-14 23:59:10.000000000 +0200
+++ src/sys/dev/asr/i2outil.h	2005-04-05 14:12:54.000000000 +0200
@@ -92,7 +92,7 @@
 
 #define	I2OUTIL_REV 1_5_4  /* I2OUtil header file revision string */
 
-#if ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD__))
+#if ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD_kernel__))
 # if (KERN_VERSION < 3)
 #  include   "i386/pci/i2omsg.h"      /* Include the Base Message file */
 # else
diff -ur src.old/sys/dev/asr/osd_defs.h src/sys/dev/asr/osd_defs.h
--- src.old/sys/dev/asr/osd_defs.h	2002-05-14 23:54:56.000000000 +0200
+++ src/sys/dev/asr/osd_defs.h	2005-04-05 14:12:54.000000000 +0200
@@ -56,7 +56,7 @@
 # define _DPT_LINUX
 #elif (defined(__bsdi__))
 # define _DPT_BSDI
-#elif (defined(__FreeBSD__))
+#elif (defined(__FreeBSD_kernel__))
 # undef _DPT_FREE_BSD
 # define _DPT_FREE_BSD
 #else
diff -ur src.old/sys/dev/asr/osd_util.h src/sys/dev/asr/osd_util.h
--- src.old/sys/dev/asr/osd_util.h	2003-01-01 19:48:49.000000000 +0100
+++ src/sys/dev/asr/osd_util.h	2005-04-05 14:12:54.000000000 +0200
@@ -78,7 +78,7 @@
 
 #if (defined(KERNEL) && defined(__bsdi__))
 # include	 "i386/isa/dpt_osd_defs.h"
-#elif ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD__))
+#elif ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD_kernel__))
 # if (KERN_VERSION < 3)
 #  include	  "i386/isa/dpt_osd_defs.h"
 # else
diff -ur src.old/sys/dev/asr/sys_info.h src/sys/dev/asr/sys_info.h
--- src.old/sys/dev/asr/sys_info.h	2002-05-14 23:59:10.000000000 +0200
+++ src/sys/dev/asr/sys_info.h	2005-04-05 14:12:54.000000000 +0200
@@ -53,7 +53,7 @@
 
 #if (defined(KERNEL) && defined(__bsdi__))
 # include	 "i386/isa/dpt_osd_util.h"
-#elif ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD__))
+#elif ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD_kernel__))
 # if (KERN_VERSION < 3)
 #  include	  "i386/isa/dpt_osd_util.h"
 # else
diff -ur src.old/sys/dev/awi/am79c930.c src/sys/dev/awi/am79c930.c
--- src.old/sys/dev/awi/am79c930.c	2004-01-15 11:04:20.000000000 +0100
+++ src/sys/dev/awi/am79c930.c	2005-04-05 14:12:56.000000000 +0200
@@ -64,19 +64,19 @@
 #ifdef __NetBSD__
 __KERNEL_RCSID(0, "$NetBSD: am79c930.c,v 1.9 2004/01/15 09:33:48 onoe Exp $");
 #endif
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 __FBSDID("$FreeBSD: src/sys/dev/awi/am79c930.c,v 1.6 2004/01/15 10:04:20 onoe Exp $");
 #endif
 
 #include <sys/param.h>
 #include <sys/systm.h>
 #include <sys/endian.h>
-#ifndef __FreeBSD__
-#include <sys/device.h>
+#ifndef __FreeBSD_kernel__
+
 #endif
 
 #include <machine/cpu.h>
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <machine/bus_pio.h>
 #include <machine/bus_memio.h>
 #endif
@@ -89,7 +89,7 @@
 #include <dev/ic/am79c930reg.h>
 #include <dev/ic/am79c930var.h>
 #endif
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <dev/awi/am79c930reg.h>
 #include <dev/awi/am79c930var.h>
 #endif
diff -ur src.old/sys/dev/awi/awi.c src/sys/dev/awi/awi.c
--- src.old/sys/dev/awi/awi.c	2004-08-14 00:55:25.000000000 +0200
+++ src/sys/dev/awi/awi.c	2005-04-05 14:12:56.000000000 +0200
@@ -88,15 +88,15 @@
 #ifdef __NetBSD__
 __KERNEL_RCSID(0, "$NetBSD: awi.c,v 1.62 2004/01/16 14:13:15 onoe Exp $");
 #endif
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 __FBSDID("$FreeBSD: src/sys/dev/awi/awi.c,v 1.34 2004/08/13 22:55:25 rwatson Exp $");
 #endif
 
 #include "opt_inet.h"
 #ifdef __NetBSD__
-#include "bpfilter.h"
+
 #endif
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define	NBPFILTER	1
 #endif
 
@@ -110,11 +110,11 @@
 #include <sys/sockio.h>
 #include <sys/errno.h>
 #include <sys/endian.h>
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <sys/bus.h>
 #endif
 #ifdef __NetBSD__
-#include <sys/device.h>
+
 #endif
 
 #include <net/if.h>
@@ -122,7 +122,7 @@
 #ifdef __NetBSD__
 #include <net/if_ether.h>
 #endif
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <net/ethernet.h>
 #include <net/if_arp.h>
 #endif
@@ -147,14 +147,14 @@
 #include <dev/ic/awireg.h>
 #include <dev/ic/awivar.h>
 #endif
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <dev/awi/am79c930reg.h>
 #include <dev/awi/am79c930var.h>
 #include <dev/awi/awireg.h>
 #include <dev/awi/awivar.h>
 #endif
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 static void awi_init0(void *);
 #endif
 static int  awi_init(struct ifnet *);
@@ -219,7 +219,7 @@
     { 0, 0 }
 };
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 devclass_t awi_devclass;
 
 #if __FreeBSD_version < 500043
@@ -293,7 +293,7 @@
 	IFQ_SET_READY(&ifp->if_snd);
 	memcpy(ifp->if_xname, sc->sc_dev.dv_xname, IFNAMSIZ);
 #endif
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	ifp->if_init = awi_init0;
 	ifp->if_snd.ifq_maxlen = IFQ_MAXLEN;
 	if_initname(ifp, device_get_name(sc->sc_dev),
@@ -533,7 +533,7 @@
 	return handled;
 }
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 static void
 awi_init0(void *arg)
 {
@@ -938,7 +938,7 @@
 		break;
 	case SIOCADDMULTI:
 	case SIOCDELMULTI:
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		error = ENETRESET;	/* XXX */
 #else
 		error = (cmd == SIOCADDMULTI) ?
@@ -1097,7 +1097,7 @@
 {
 	struct ifnet *ifp = &sc->sc_ic.ic_if;
 	int n, error;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct ifmultiaddr *ifma;
 #else
 	struct ether_multi *enm;
@@ -1113,7 +1113,7 @@
 		goto set_mib;
 	}
 	sc->sc_mib_mac.aPromiscuous_Enable = 0;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	if (ifp->if_flags & IFF_ALLMULTI)
 		goto set_mib;
 	TAILQ_FOREACH(ifma, &ifp->if_multiaddrs, ifma_link) {
@@ -1143,7 +1143,7 @@
 	sc->sc_mib_local.Accept_All_Multicast_Dis = 1;
 
   set_mib:
-#ifndef __FreeBSD__
+#ifndef __FreeBSD_kernel__
 	if (sc->sc_mib_local.Accept_All_Multicast_Dis)
 		ifp->if_flags &= ~IFF_ALLMULTI;
 	else
diff -ur src.old/sys/dev/awi/awivar.h src/sys/dev/awi/awivar.h
--- src.old/sys/dev/awi/awivar.h	2004-01-15 11:04:20.000000000 +0100
+++ src/sys/dev/awi/awivar.h	2005-04-05 14:12:56.000000000 +0200
@@ -77,7 +77,7 @@
 #ifdef __NetBSD__
 	struct device		sc_dev;
 #endif
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	device_t		sc_dev;
 #endif
 	struct am79c930_softc 	sc_chip;
diff -ur src.old/sys/dev/bktr/bktr_audio.c src/sys/dev/bktr/bktr_audio.c
--- src.old/sys/dev/bktr/bktr_audio.c	2003-12-08 08:59:18.000000000 +0100
+++ src/sys/dev/bktr/bktr_audio.c	2005-04-05 14:12:58.000000000 +0200
@@ -55,7 +55,7 @@
 #include <sys/kernel.h>
 #include <sys/vnode.h>
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 
 #if (__FreeBSD_version < 500000)
 #include <machine/clock.h>              /* for DELAY */
diff -ur src.old/sys/dev/bktr/bktr_card.c src/sys/dev/bktr/bktr_card.c
--- src.old/sys/dev/bktr/bktr_card.c	2004-08-08 03:23:39.000000000 +0200
+++ src/sys/dev/bktr/bktr_card.c	2005-04-05 14:12:58.000000000 +0200
@@ -53,7 +53,7 @@
 #include <sys/systm.h>
 #include <sys/vnode.h>
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 
 #if (__FreeBSD_version < 500000)
 #include <machine/clock.h>              /* for DELAY */
diff -ur src.old/sys/dev/bktr/bktr_core.c src/sys/dev/bktr/bktr_core.c
--- src.old/sys/dev/bktr/bktr_core.c	2004-06-16 11:46:38.000000000 +0200
+++ src/sys/dev/bktr/bktr_core.c	2005-04-05 14:12:58.000000000 +0200
@@ -92,7 +92,7 @@
 #include "opt_bktr.h"		/* Include any kernel config options */
 
 #if (                                                            \
-       (defined(__FreeBSD__))                                    \
+       (defined(__FreeBSD_kernel__))                                    \
     || (defined(__bsdi__))                                       \
     || (defined(__OpenBSD__))                                    \
     || (defined(__NetBSD__))                                     \
@@ -102,7 +102,7 @@
 /*******************/
 /* *** FreeBSD *** */
 /*******************/
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 
 #include <sys/param.h>
 #include <sys/systm.h>
@@ -165,7 +165,7 @@
 }
 
 
-#endif  /* __FreeBSD__ */
+#endif  /* 5 */
 
 
 /****************/
@@ -494,7 +494,7 @@
                 buf = 0;
 #endif
 
-#if defined(__FreeBSD__) || defined(__bsdi__)
+#if defined(__FreeBSD_kernel__) || defined(__bsdi__)
 
 /* If this is a module, check if there is any currently saved contiguous memory */
 #if defined(BKTR_FREEBSD_MODULE)
@@ -614,7 +614,7 @@
         bktr->msp_source_selected = -1;
 	bktr->audio_mux_present = 1;
 
-#if defined(__FreeBSD__) 
+#if defined(__FreeBSD_kernel__) 
 #ifdef BKTR_NEW_MSP34XX_DRIVER
 	/* get hint on short programming of the msp34xx, so we know */
 	/* if the decision what thread to start should be overwritten */
diff -ur src.old/sys/dev/bktr/bktr_os.c src/sys/dev/bktr/bktr_os.c
--- src.old/sys/dev/bktr/bktr_os.c	2004-06-16 11:46:38.000000000 +0200
+++ src/sys/dev/bktr/bktr_os.c	2005-04-05 14:12:59.000000000 +0200
@@ -55,7 +55,7 @@
 /*******************/
 /* *** FreeBSD *** */
 /*******************/
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 
 #include <sys/param.h>
 #include <sys/systm.h>
@@ -163,7 +163,7 @@
 #include <vm/vm_extern.h>
 #endif
 
-#include <sys/device.h>
+
 #include <dev/pci/pcivar.h>
 #include <dev/pci/pcireg.h>
 #include <dev/pci/pcidevs.h>
diff -ur src.old/sys/dev/bktr/bktr_os.h src/sys/dev/bktr/bktr_os.h
--- src.old/sys/dev/bktr/bktr_os.h	2003-12-01 20:03:50.000000000 +0100
+++ src/sys/dev/bktr/bktr_os.h	2005-04-05 14:12:59.000000000 +0200
@@ -47,7 +47,7 @@
 /******************************/
 /* *** Memory Allocation  *** */
 /******************************/
-#if (defined(__FreeBSD__) || defined(__bsdi__))
+#if (defined(__FreeBSD_kernel__) || defined(__bsdi__))
 vm_offset_t     get_bktr_mem( int unit, unsigned size );
 #endif
 
@@ -59,7 +59,7 @@
 /************************************/
 /* *** Interrupt Enable/Disable *** */
 /************************************/
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #if (__FreeBSD_version >=500000)
 #define USE_VBIMUTEX
 #define	DECLARE_INTR_MASK(s)	/* no need to declare 's' */
diff -ur src.old/sys/dev/bktr/bktr_reg.h src/sys/dev/bktr/bktr_reg.h
--- src.old/sys/dev/bktr/bktr_reg.h	2004-06-16 11:46:38.000000000 +0200
+++ src/sys/dev/bktr/bktr_reg.h	2005-04-05 14:12:59.000000000 +0200
@@ -36,7 +36,7 @@
 
 #ifdef __NetBSD__
 #include <machine/bus.h>		/* struct device */
-#include <sys/device.h>
+
 #include <sys/select.h>			/* struct selinfo */
 # ifdef DEBUG
 #  define	bootverbose 1
@@ -50,7 +50,7 @@
  * Support the older kernel options on FreeBSD and OpenBSD.
  *
  */
-#if defined(__FreeBSD__) || defined(__OpenBSD__)
+#if defined(__FreeBSD_kernel__) || defined(__OpenBSD__)
 #if defined(BROOKTREE_ALLOC_PAGES)
 #define BKTR_ALLOC_PAGES BROOKTREE_ALLOC_PAGES
 #endif
@@ -461,7 +461,7 @@
  * memory mapped structure method only works on 32 bit processors
  * with the right type of endianness.
  */
-#if defined(__NetBSD__) || ( defined(__FreeBSD__) && (__FreeBSD_version >=300000) )
+#if defined(__NetBSD__) || ( defined(__FreeBSD_kernel__) && (__FreeBSD_version >=300000) )
 #define INB(bktr,offset)	bus_space_read_1((bktr)->memt,(bktr)->memh,(offset))
 #define INW(bktr,offset)	bus_space_read_2((bktr)->memt,(bktr)->memh,(offset))
 #define INL(bktr,offset)	bus_space_read_4((bktr)->memt,(bktr)->memh,(offset))
@@ -524,7 +524,7 @@
     vm_offset_t		phys_base;	/* Bt848 register physical address */
 #endif
 
-#if defined (__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
     #if (__FreeBSD_version < 400000)
     vm_offset_t     phys_base;	/* 2.x Bt848 register physical address */
     pcici_t         tag;	/* 2.x PCI tag, for doing PCI commands */
@@ -725,11 +725,11 @@
 /* ioctl_cmd_t int on old versions, u_long on new versions */
 /***********************************************************/
 
-#if (__FreeBSD__ == 2)
+#if (5 == 2)
 typedef int ioctl_cmd_t;
 #endif
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #if (__FreeBSD_version >= 300000)
 typedef u_long ioctl_cmd_t;
 #endif
diff -ur src.old/sys/dev/bktr/bktr_tuner.c src/sys/dev/bktr/bktr_tuner.c
--- src.old/sys/dev/bktr/bktr_tuner.c	2004-06-27 11:59:02.000000000 +0200
+++ src/sys/dev/bktr/bktr_tuner.c	2005-04-05 14:12:59.000000000 +0200
@@ -51,7 +51,7 @@
 #include <sys/proc.h>
 #endif
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #if (__FreeBSD_version < 500000)
 #include <machine/clock.h>              /* for DELAY */
 #include <pci/pcivar.h>
diff -ur src.old/sys/dev/cnw/if_cnw.c src/sys/dev/cnw/if_cnw.c
--- src.old/sys/dev/cnw/if_cnw.c	2004-05-23 18:11:46.000000000 +0200
+++ src/sys/dev/cnw/if_cnw.c	2005-04-05 14:13:02.000000000 +0200
@@ -115,13 +115,13 @@
  * multicast. Volunteers are welcome, of course :-).
  */
 
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 #include "opt_inet.h"
-#include "bpfilter.h"
+
 
 #include <sys/param.h>
 #include <sys/systm.h>
-#include <sys/device.h>
+
 #include <sys/socket.h>
 #include <sys/mbuf.h>
 #include <sys/ioctl.h>
@@ -342,11 +342,11 @@
 DRIVER_MODULE(cnw, pccard, cnw_pccard_driver, cnw_pccard_devclass, 0, 0);
 MODULE_DEPEND(cnw, ether, 1, 1, 1);
 
-#endif /* !defined(__FreeBSD__) */
+#endif /* !defined(__FreeBSD_kernel__) */
 
 void cnw_reset(struct cnw_softc *);
 void cnw_init(struct cnw_softc *);
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 int cnw_enable(struct cnw_softc *sc);
 void cnw_disable(struct cnw_softc *sc);
 void cnw_config(struct cnw_softc *sc, u_int8_t *);
@@ -355,7 +355,7 @@
 void cnw_transmit(struct cnw_softc *, struct mbuf *);
 struct mbuf *cnw_read(struct cnw_softc *);
 void cnw_recv(struct cnw_softc *);
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 int cnw_intr(void *arg);
 #else
 void cnw_intr(void *arg);
@@ -395,7 +395,7 @@
 		DELAY(100);
 	}
 	if (line > 0)
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 		printf("%s: wedged at line %d\n", sc->sc_dev.dv_xname, line);
 #else
 		device_printf(sc->dev, "wedged at line %d\n", line);
@@ -438,7 +438,7 @@
 	int ptr = sc->sc_memoff + CNW_EREG_CB;
 
 	if (wait_WOC(sc, 0)) {
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 		printf("%s: wedged when issuing cmd 0x%x\n",
 		    sc->sc_dev.dv_xname, cmd);
 #else
@@ -508,7 +508,7 @@
 cnw_init(sc)
 	struct cnw_softc *sc;
 {
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 	struct ifnet *ifp = &sc->sc_ethercom.ec_if;
 #else	/* FreeBSD */
 	struct ifnet *ifp = &sc->arpcom.ac_if;
@@ -562,7 +562,7 @@
 }
 
 
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 /*
  * Enable and initialize the card.
  */
@@ -754,7 +754,7 @@
 		sc->sc_resource &= ~CNW_RES_PCIC;
 	}
 }
-#endif /* !defined(__FreeBSD__) */
+#endif /* !defined(__FreeBSD_kernel__) */
 
 /*
  * Start outputting on the interface.
@@ -778,7 +778,7 @@
 		printf("%s: cnw_start reentered\n", ifp->if_xname);
 #endif
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	if (sc->cnw_gone)
 		return;
 #endif
@@ -847,7 +847,7 @@
 		if (m0 == 0)
 			break;
 
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 #if NBPFILTER > 0
 		if (ifp->if_bpf)
 			bpf_mtap(ifp->if_bpf, m0);
@@ -947,7 +947,7 @@
 	MGETHDR(m, M_DONTWAIT, MT_DATA);
 	if (m == 0)
 		return (0);
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 	m->m_pkthdr.rcvif = &sc->sc_ethercom.ec_if;
 #else	/* FreeBSD */
 	m->m_pkthdr.rcvif = &sc->arpcom.ac_if;
@@ -1022,7 +1022,7 @@
 	struct cnw_softc *sc;
 {
 	int rser;
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 	struct ifnet *ifp = &sc->sc_ethercom.ec_if;
 #else
 	struct ifnet *ifp = &sc->arpcom.ac_if;
@@ -1049,7 +1049,7 @@
 		}
 		++ifp->if_ipackets;
 
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 #if NBPFILTER > 0
 		if (ifp->if_bpf)
 			bpf_mtap(ifp->if_bpf, m);
@@ -1065,7 +1065,7 @@
 /*
  * Interrupt handler.
  */
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 int
 #else
 void
@@ -1074,7 +1074,7 @@
 	void *arg;
 {
 	struct cnw_softc *sc = arg;
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 	struct ifnet *ifp = &sc->sc_ethercom.ec_if;
 #else
 	struct ifnet *ifp = &sc->arpcom.ac_if;
@@ -1082,7 +1082,7 @@
 	int ret, status, rser, tser;
 
 
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 	if ((sc->sc_ethercom.ec_if.if_flags & IFF_RUNNING) == 0 ||
 	    (sc->sc_dev.dv_flags & DVF_ACTIVE) == 0)
 		return (0);
@@ -1103,7 +1103,7 @@
 		    sc->sc_memoff + CNW_IOM_OFF + CNW_REG_CCSR);
 #endif
 
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 		if (!(status & 0x02)) {
 			if (ret == 0)
 				printf("%s: spurious interrupt\n",
@@ -1205,7 +1205,7 @@
 			ifp->if_flags &= ~IFF_OACTIVE;
 
 			/* Continue to send packets from the queue */
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 			cnw_start(&sc->sc_ethercom.ec_if);
 #else
 			cnw_start(ifp);
@@ -1226,12 +1226,12 @@
 	caddr_t data;
 {
 	struct cnw_softc *sc = ifp->if_softc;
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 	struct ifaddr *ifa = (struct ifaddr *)data;
 #endif
 	struct ifreq *ifr = (struct ifreq *)data;
 	int s, error = 0;
-#if __FreeBSD__ >= 5
+#if 5 >= 5
 	struct thread *td = curthread;	/* XXX */
 #else
 	struct proc *td = curproc;	/*XXX*/
@@ -1239,7 +1239,7 @@
 
 	s = splnet();
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	if (sc->cnw_gone) {
 		splx(s);
 		return(ENODEV);
@@ -1249,7 +1249,7 @@
 	switch (cmd) {
 
 	case SIOCSIFADDR:
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 		if (!(ifp->if_flags & IFF_RUNNING) &&
 		    (error = cnw_enable(sc)) != 0)
 			break;
@@ -1271,7 +1271,7 @@
 		break;
 
 	case SIOCSIFFLAGS:
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 		if ((ifp->if_flags & (IFF_UP | IFF_RUNNING)) == IFF_RUNNING) {
 			/*
 			 * The interface is marked down and it is running, so
@@ -1304,7 +1304,7 @@
 
 	case SIOCADDMULTI:
 	case SIOCDELMULTI:
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 		/* Update our multicast list. */
 		error = (cmd == SIOCADDMULTI) ?
 		    ether_addmulti(ifr, &sc->sc_ethercom) :
@@ -1324,7 +1324,7 @@
 		break;
 
 	case SIOCSCNWDOMAIN:
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 		error = suser(p->p_ucred, &p->p_acflag);
 #else
 		error = suser(td);
@@ -1335,7 +1335,7 @@
 		break;
 
 	case SIOCSCNWKEY:
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 		error = suser(p->p_ucred, &p->p_acflag);
 #else
 		error = suser(td);
@@ -1346,7 +1346,7 @@
 		break;
 
 	case SIOCGCNWSTATUS:
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 		error = suser(p->p_ucred, &p->p_acflag);
 #else
 		error = suser(td);
@@ -1387,7 +1387,7 @@
 {
 	struct cnw_softc *sc = ifp->if_softc;
 
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 	printf("%s: device timeout; card reset\n", sc->sc_dev.dv_xname);
 	++ifp->if_oerrors;
 	cnw_init(sc);
@@ -1434,7 +1434,7 @@
 	return 0;
 }
 
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 int
 cnw_activate(self, act)
 	struct device *self;
@@ -1494,7 +1494,7 @@
 }
 #endif
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 static void cnw_freebsd_init(xsc)
 	void	*xsc;
 {
diff -ur src.old/sys/dev/cnw/if_cnwioctl.h src/sys/dev/cnw/if_cnwioctl.h
--- src.old/sys/dev/cnw/if_cnwioctl.h	2001-03-16 08:25:42.000000000 +0100
+++ src/sys/dev/cnw/if_cnwioctl.h	2005-04-05 14:13:02.000000000 +0200
@@ -98,7 +98,7 @@
 	struct cnwtrail trail[128];
 };
 
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 #define ifr_domain	ifr_ifru.ifru_flags     /* domain */
 #define ifr_key		ifr_ifru.ifru_flags     /* scramble key */
 #else
diff -ur src.old/sys/dev/ct/bshw_machdep.c src/sys/dev/ct/bshw_machdep.c
--- src.old/sys/dev/ct/bshw_machdep.c	2004-03-13 20:46:27.000000000 +0100
+++ src/sys/dev/ct/bshw_machdep.c	2005-04-05 14:13:04.000000000 +0200
@@ -41,7 +41,7 @@
 #include <sys/param.h>
 #include <sys/systm.h>
 #include <sys/kernel.h>
-#if defined(__FreeBSD__) && __FreeBSD_version > 500001
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version > 500001
 #include <sys/bio.h>
 #endif	/* __ FreeBSD__ */
 #include <sys/buf.h>
@@ -52,7 +52,7 @@
 #include <vm/vm.h>
 
 #ifdef __NetBSD__
-#include <sys/device.h>
+
 
 #include <machine/bus.h>
 #include <machine/intr.h>
@@ -73,7 +73,7 @@
 #include <i386/Cbus/dev/ct/bshwvar.h>
 #endif /* __NetBSD__ */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <machine/bus.h>
 #include <machine/clock.h>
 #include <machine/md_var.h>
@@ -89,7 +89,7 @@
 #include <dev/ct/bshwvar.h>
 
 #include <vm/pmap.h>
-#endif /* __FreeBSD__ */
+#endif /* 5 */
 
 #define	BSHW_IO_CONTROL_FLAGS	0
 
@@ -104,10 +104,10 @@
 #define	BSHW_PAGE_SIZE NBPG
 #endif	/* __NetBSD__ */
 
-#ifdef	__FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define	BSHW_PAGE_SIZE PAGE_SIZE
 typedef	unsigned long vaddr_t;
-#endif /* __FreeBSD__ */
+#endif /* 5 */
 
 /*********************************************************
  * GENERIC MACHDEP FUNCTIONS
diff -ur src.old/sys/dev/ct/ct.c src/sys/dev/ct/ct.c
--- src.old/sys/dev/ct/ct.c	2004-07-10 22:57:43.000000000 +0200
+++ src/sys/dev/ct/ct.c	2005-04-05 14:13:04.000000000 +0200
@@ -42,7 +42,7 @@
 #include <sys/param.h>
 #include <sys/systm.h>
 #include <sys/kernel.h>
-#if defined(__FreeBSD__) && __FreeBSD_version > 500001
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version > 500001
 #include <sys/bio.h>
 #endif	/* __ FreeBSD__ */
 #include <sys/buf.h>
@@ -51,7 +51,7 @@
 #include <sys/errno.h>
 
 #ifdef __NetBSD__
-#include <sys/device.h>
+
 
 #include <machine/bus.h>
 #include <machine/intr.h>
@@ -71,7 +71,7 @@
 #include <i386/Cbus/dev/ct/ct_machdep.h>
 #endif /* __NetBSD__ */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <machine/bus.h>
 
 #include <compat/netbsd/dvcfg.h>
@@ -82,7 +82,7 @@
 #include <dev/ic/wd33c93reg.h>
 #include <dev/ct/ctvar.h>
 #include <dev/ct/ct_machdep.h>
-#endif /* __FreeBSD__ */
+#endif /* 5 */
 
 #define	CT_NTARGETS		8
 #define	CT_NLUNS		8
diff -ur src.old/sys/dev/ct/ct_isa.c src/sys/dev/ct/ct_isa.c
--- src.old/sys/dev/ct/ct_isa.c	2004-03-17 18:50:30.000000000 +0100
+++ src/sys/dev/ct/ct_isa.c	2005-04-05 14:13:04.000000000 +0200
@@ -71,7 +71,7 @@
 #include <i386/Cbus/dev/ct/bshwvar.h>
 #endif /* __NetBSD__ */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <machine/bus.h>
 #include <machine/resource.h>
 #include <sys/bus.h>
@@ -89,7 +89,7 @@
 #include <dev/ic/wd33c93reg.h>
 #include <dev/ct/ctvar.h>
 #include <dev/ct/bshwvar.h>
-#endif /* __FreeBSD__ */
+#endif /* 5 */
 
 #define	BSHW_IOSZ	0x08
 #define	BSHW_IOBASE 	0xcc0
diff -ur src.old/sys/dev/ct/ctvar.h src/sys/dev/ct/ctvar.h
--- src.old/sys/dev/ct/ctvar.h	2002-03-20 03:04:09.000000000 +0100
+++ src/sys/dev/ct/ctvar.h	2005-04-05 14:13:04.000000000 +0200
@@ -72,7 +72,7 @@
 	void *sc_ih;
 #endif	/* __NetBSD__ */
 
-#ifdef	__FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct resource *port_res;
 	struct resource *mem_res;
 	struct resource *irq_res;
@@ -82,7 +82,7 @@
 	bus_dmamap_t sc_dmamapt;		/* data DMAMAP tag */
 
 	void *sc_ih;
-#endif	/* __FreeBSD__ */
+#endif	/* 5 */
 
 	int sc_chiprev;			/* chip version */	
 #define	CT_WD33C93			0x00000
diff -ur src.old/sys/dev/cx/machdep.h src/sys/dev/cx/machdep.h
--- src.old/sys/dev/cx/machdep.h	2004-03-12 22:45:26.000000000 +0100
+++ src/sys/dev/cx/machdep.h	2005-04-05 14:13:07.000000000 +0200
@@ -68,7 +68,7 @@
 /*
  * FreeBSD and BSD/OS
  */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #   include <sys/param.h>
 #   include <machine/cpufunc.h>
 #   include <sys/libkern.h>
diff -ur src.old/sys/dev/drm/drm.h src/sys/dev/drm/drm.h
--- src.old/sys/dev/drm/drm.h	2004-06-11 05:26:59.000000000 +0200
+++ src/sys/dev/drm/drm.h	2005-04-05 14:13:15.000000000 +0200
@@ -48,15 +48,15 @@
 #define DRM_IOC_WRITE		_IOC_WRITE
 #define DRM_IOC_READWRITE	_IOC_READ|_IOC_WRITE
 #define DRM_IOC(dir, group, nr, size) _IOC(dir, group, nr, size)
-#elif defined(__FreeBSD__) || defined(__NetBSD__) || defined(__OpenBSD__)
-#if defined(__FreeBSD__) && defined(IN_MODULE)
+#elif defined(__FreeBSD_kernel__) || defined(__NetBSD__) || defined(__OpenBSD__)
+#if defined(__FreeBSD_kernel__) && defined(IN_MODULE)
 /* Prevent name collision when including sys/ioccom.h */
 #undef ioctl
 #include <sys/ioccom.h>
 #define ioctl(a,b,c)		xf86ioctl(a,b,c)
 #else
 #include <sys/ioccom.h>
-#endif /* __FreeBSD__ && xf86ioctl */
+#endif /* 5 && xf86ioctl */
 #define DRM_IOCTL_NR(n)		((n) & 0xff)
 #define DRM_IOC_VOID		IOC_VOID
 #define DRM_IOC_READ		IOC_OUT
diff -ur src.old/sys/dev/drm/drmP.h src/sys/dev/drm/drmP.h
--- src.old/sys/dev/drm/drmP.h	2004-06-16 11:46:42.000000000 +0200
+++ src/sys/dev/drm/drmP.h	2005-04-05 14:13:15.000000000 +0200
@@ -62,7 +62,7 @@
 
 /* There's undoubtably more of this file to go into these OS dependent ones. */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include "dev/drm/drm_os_freebsd.h"
 #elif defined __NetBSD__
 #include "dev/drm/drm_os_netbsd.h"
@@ -310,7 +310,7 @@
 	const char	  *name;	/* Simple driver name		   */
 	char		  *unique;	/* Unique identifier: e.g., busid  */
 	int		  unique_len;	/* Length of unique field	   */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	device_t	  device;	/* Device instance from newbus     */
 #endif
 	struct cdev *devnode;	/* Device number for mknod	   */
@@ -319,7 +319,7 @@
 	int		  flags;	/* Flags to open(2)		   */
 
 				/* Locks */
-#if defined(__FreeBSD__) && __FreeBSD_version > 500000
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version > 500000
 #if __HAVE_DMA
 	struct mtx	  dma_lock;	/* protects dev->dma */
 #endif
@@ -355,7 +355,7 @@
 				/* Context support */
 	int		  irq;		/* Interrupt used by board	   */
 	int		  irq_enabled;	/* True if the irq handler is enabled */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	int		  irqrid;	/* Interrupt used by board */
 	struct resource   *irqr;	/* Resource for interrupt used by board	   */
 #elif defined(__NetBSD__)
@@ -379,7 +379,7 @@
    	atomic_t          vbl_received;
 #endif
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct sigio      *buf_sigio;	/* Processes waiting for SIGIO     */
 #elif defined(__NetBSD__)
 	pid_t		  buf_pgid;
diff -ur src.old/sys/dev/drm/drm_bufs.h src/sys/dev/drm/drm_bufs.h
--- src.old/sys/dev/drm/drm_bufs.h	2004-01-06 05:34:52.000000000 +0100
+++ src/sys/dev/drm/drm_bufs.h	2005-04-05 14:13:15.000000000 +0200
@@ -872,11 +872,11 @@
 	const int zero = 0;
 	vm_offset_t address;
 	struct vmspace *vms;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	vm_ooffset_t foff;
 	vm_size_t size;
 	vm_offset_t vaddr;
-#endif /* __FreeBSD__ */
+#endif /* 5 */
 #ifdef __NetBSD__
 	struct vnode *vn;
 	vm_size_t size;
@@ -893,7 +893,7 @@
 		return 0;	/* FIXME: Shouldn't this be EINVAL or something? */
 #endif /* __NetBSD__ */
 
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500000
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500000
 	vms = p->td_proc->p_vmspace;
 #else
 	vms = p->p_vmspace;
@@ -921,7 +921,7 @@
 		foff = 0;
 	}
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	vaddr = round_page((vm_offset_t)vms->vm_daddr + MAXDSIZ);
 	retcode = vm_mmap(&vms->vm_map, &vaddr, size, PROT_READ | PROT_WRITE,
 	    VM_PROT_ALL, MAP_SHARED, SLIST_FIRST(&kdev->si_hlist), foff );
diff -ur src.old/sys/dev/drm/drm_drv.h src/sys/dev/drm/drm_drv.h
--- src.old/sys/dev/drm/drm_drv.h	2004-08-05 09:20:24.000000000 +0200
+++ src/sys/dev/drm/drm_drv.h	2005-04-05 14:13:15.000000000 +0200
@@ -117,7 +117,7 @@
 static int DRM(init)(device_t nbdev);
 static void DRM(cleanup)(drm_device_t *dev);
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define DRIVER_SOFTC(unit) \
 	((drm_device_t *) devclass_get_softc(DRM(devclass), unit))
 
@@ -125,7 +125,7 @@
 MODULE_DEPEND(DRIVER_NAME, agp, 1, 1, 1);
 #endif
 MODULE_DEPEND(DRIVER_NAME, mem, 1, 1, 1);
-#endif /* __FreeBSD__ */
+#endif /* 5 */
 
 #ifdef __NetBSD__
 #define DRIVER_SOFTC(unit) \
@@ -211,7 +211,7 @@
 
 const char *DRM(find_description)(int vendor, int device);
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 static struct cdevsw DRM(cdevsw) = {
 #if __FreeBSD_version >= 502103
 	.d_version =	D_VERSION,
@@ -497,7 +497,7 @@
 	dev->last_context = 0;
 	dev->if_version = 0;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	dev->buf_sigio = NULL;
 #elif defined(__NetBSD__)
 	dev->buf_pgid = 0;
@@ -627,7 +627,7 @@
 static int DRM(init)( device_t nbdev )
 {
 	int unit;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	drm_device_t *dev;
 #elif defined(__NetBSD__)
 	drm_device_t *dev = nbdev;
@@ -638,7 +638,7 @@
 	DRM_DEBUG( "\n" );
 	DRIVER_PREINIT(dev);
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	unit = device_get_unit(nbdev);
 	dev = device_get_softc(nbdev);
 	memset( (void *)dev, 0, sizeof(*dev) );
@@ -723,7 +723,7 @@
 	DRM_LOCK();
 	DRM(takedown)(dev);
 	DRM_UNLOCK();
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	destroy_dev(dev->devnode);
 #if __FreeBSD_version >= 500000
 	mtx_destroy(&dev->dev_lock);
@@ -743,7 +743,7 @@
 	DRM_DEBUG( "\n" );
 
 	DRM(sysctl_cleanup)( dev );
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	destroy_dev(dev->devnode);
 #endif
 #if __HAVE_CTX_BITMAP
@@ -773,7 +773,7 @@
 #endif
 	DRIVER_POSTCLEANUP();
 	DRM(mem_uninit)();
-#if defined(__FreeBSD__) &&  __FreeBSD_version >= 500000
+#if defined(__FreeBSD_kernel__) &&  __FreeBSD_version >= 500000
 	mtx_destroy(&dev->dev_lock);
 #endif
 	DRM(free)(dev->maplist, sizeof(*dev->maplist), DRM_MEM_MAPS);
@@ -823,7 +823,7 @@
 	if ( !retcode ) {
 		atomic_inc( &dev->counts[_DRM_STAT_OPENS] );
 		DRM_LOCK();
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		device_busy(dev->device);
 #endif
 		if ( !dev->open_count++ )
@@ -858,7 +858,7 @@
 	 * Begin inline drm_release
 	 */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	DRM_DEBUG( "pid = %d, device = 0x%lx, open_count = %d\n",
 		   DRM_CURRENTPID, (long)dev->device, dev->open_count );
 #elif defined(__NetBSD__)
@@ -900,7 +900,7 @@
 				break;	/* Got lock */
 			}
 				/* Contention */
-#if defined(__FreeBSD__) && __FreeBSD_version > 500000
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version > 500000
 			retcode = msleep((void *)&dev->lock.lock_queue,
 			    dev->dev_lock, PZERO | PCATCH, "drmlk2", 0);
 #else
@@ -920,9 +920,9 @@
 	DRM(reclaim_buffers)( dev, (void *)(uintptr_t)priv->pid );
 #endif
 
-#if defined (__FreeBSD__) && (__FreeBSD_version >= 500000)
+#if defined(__FreeBSD_kernel__) && (__FreeBSD_version >= 500000)
 	funsetown(&dev->buf_sigio);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	funsetown(dev->buf_sigio);
 #elif defined(__NetBSD__)
 	dev->buf_pgid = 0;
@@ -938,7 +938,7 @@
 	 */
 
 	atomic_inc( &dev->counts[_DRM_STAT_CLOSES] );
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	device_unbusy(dev->device);
 #endif
 	if (--dev->open_count == 0) {
@@ -967,7 +967,7 @@
 	atomic_inc( &dev->counts[_DRM_STAT_IOCTLS] );
 	++priv->ioctl_count;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	DRM_DEBUG( "pid=%d, cmd=0x%02lx, nr=0x%02x, dev 0x%lx, auth=%d\n",
 		 DRM_CURRENTPID, cmd, nr, (long)dev->device, priv->authenticated );
 #elif defined(__NetBSD__)
@@ -980,7 +980,7 @@
 	case FIOASYNC:
 		return 0;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	case FIOSETOWN:
 		return fsetown(*(int *)data, &dev->buf_sigio);
 
@@ -991,7 +991,7 @@
 		*(int *) data = fgetown(dev->buf_sigio);
 #endif
 		return 0;
-#endif /* __FreeBSD__ */
+#endif /* 5 */
 #ifdef __NetBSD__
 	case TIOCSPGRP:
 		dev->buf_pgid = *(int *)data;
@@ -1055,7 +1055,7 @@
 		}
 
 		/* Contention */
-#if defined(__FreeBSD__) && __FreeBSD_version > 500000
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version > 500000
 		ret = msleep((void *)&dev->lock.lock_queue, &dev->dev_lock,
 		    PZERO | PCATCH, "drmlk2", 0);
 #else
diff -ur src.old/sys/dev/drm/drm_fops.h src/sys/dev/drm/drm_fops.h
--- src.old/sys/dev/drm/drm_fops.h	2004-06-16 11:46:42.000000000 +0200
+++ src/sys/dev/drm/drm_fops.h	2005-04-05 14:13:15.000000000 +0200
@@ -96,7 +96,7 @@
 		TAILQ_INSERT_TAIL(&dev->files, priv, link);
 	}
 	DRM_UNLOCK();
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	kdev->si_drv1 = dev;
 #endif
 	return 0;
diff -ur src.old/sys/dev/drm/drm_irq.h src/sys/dev/drm/drm_irq.h
--- src.old/sys/dev/drm/drm_irq.h	2004-03-17 18:50:31.000000000 +0100
+++ src/sys/dev/drm/drm_irq.h	2005-04-05 14:13:16.000000000 +0200
@@ -52,7 +52,7 @@
 	return 0;
 }
 
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500000
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500000
 static irqreturn_t
 DRM(irq_handler_wrap)(DRM_IRQ_ARGS)
 {
@@ -96,7 +96,7 @@
 	DRM(driver_irq_preinstall)( dev );
 
 				/* Install handler */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	dev->irqrid = 0;
 	dev->irqr = bus_alloc_resource_any(dev->device, SYS_RES_IRQ, 
 				      &dev->irqrid, RF_SHAREABLE);
@@ -133,7 +133,7 @@
 err:
 	DRM_LOCK();
 	dev->irq_enabled = 0;
-#ifdef ___FreeBSD__
+#ifdef _5
 	if (dev->irqrid != 0) {
 		bus_release_resource(dev->device, SYS_RES_IRQ, dev->irqrid,
 		    dev->irqr);
@@ -163,7 +163,7 @@
 
 	DRM(driver_irq_uninstall)( dev );
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	bus_teardown_intr(dev->device, dev->irqr, dev->irqh);
 	bus_release_resource(dev->device, SYS_RES_IRQ, irqrid, dev->irqr);
 #elif defined(__NetBSD__)
diff -ur src.old/sys/dev/drm/drm_memory.h src/sys/dev/drm/drm_memory.h
--- src.old/sys/dev/drm/drm_memory.h	2003-10-24 03:48:16.000000000 +0200
+++ src/sys/dev/drm/drm_memory.h	2005-04-05 14:13:16.000000000 +0200
@@ -33,7 +33,7 @@
 
 #include "dev/drm/drmP.h"
 
-#if defined(__FreeBSD__) || defined(__NetBSD__)
+#if defined(__FreeBSD_kernel__) || defined(__NetBSD__)
 #define malloctype DRM(M_DRM)
 /* The macros conflicted in the MALLOC_DEFINE */
 MALLOC_DEFINE(malloctype, "drm", "DRM Data Structures");
@@ -85,7 +85,7 @@
 
 void *DRM(ioremap)( drm_device_t *dev, drm_local_map_t *map )
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	return pmap_mapdev(map->offset, map->size);
 #elif defined(__NetBSD__)
 	map->iot = dev->pa.pa_memt;
@@ -98,7 +98,7 @@
 
 void DRM(ioremapfree)(drm_local_map_t *map)
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	pmap_unmapdev((vm_offset_t) map->handle, map->size);
 #elif defined(__NetBSD__)
 	bus_space_unmap(map->iot, map->ioh, map->size);
@@ -127,7 +127,7 @@
 }
 #endif /* __REALLY_HAVE_AGP */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 int
 DRM(mtrr_add)(unsigned long offset, size_t size, int flags)
 {
diff -ur src.old/sys/dev/drm/drm_memory_debug.h src/sys/dev/drm/drm_memory_debug.h
--- src.old/sys/dev/drm/drm_memory_debug.h	2003-10-24 03:48:16.000000000 +0200
+++ src/sys/dev/drm/drm_memory_debug.h	2005-04-05 14:13:16.000000000 +0200
@@ -104,7 +104,7 @@
 	DRM_SPINUNINIT(DRM(mem_lock));
 }
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 /* drm_mem_info is called whenever a process reads /dev/drm/mem. */
 static int
 DRM(_mem_info)(drm_mem_stats_t *stats, struct sysctl_oid *oidp, void *arg1, 
@@ -158,7 +158,7 @@
 	free(stats, DRM(M_DRM));
 	return ret;
 }
-#endif /* __FreeBSD__ */
+#endif /* 5 */
 
 void *DRM(alloc)(size_t size, int area)
 {
@@ -226,7 +226,7 @@
 	map->iot = dev->pa.pa_memt;
 #endif
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	if (!(pt = pmap_mapdev(map->offset, map->size))) {
 #elif defined(__NetBSD__)
 	if (bus_space_map(map->iot, map->offset, map->size, 
@@ -283,7 +283,7 @@
 		DRM_MEM_ERROR(DRM_MEM_MAPPINGS,
 			      "Attempt to free NULL pointer\n");
 	else
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		pmap_unmapdev((vm_offset_t) map->handle, map->size);
 #elif defined(__NetBSD__)
 		bus_space_unmap(map->iot, map->ioh, map->size);
diff -ur src.old/sys/dev/drm/drm_os_freebsd.h src/sys/dev/drm/drm_os_freebsd.h
--- src.old/sys/dev/drm/drm_os_freebsd.h	2004-06-16 11:46:42.000000000 +0200
+++ src/sys/dev/drm/drm_os_freebsd.h	2005-04-05 14:13:16.000000000 +0200
@@ -228,7 +228,7 @@
 
 #define DRM_HZ hz
 
-#if defined(__FreeBSD__) && __FreeBSD_version > 500000
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version > 500000
 #define DRM_WAIT_ON( ret, queue, timeout, condition )		\
 for ( ret = 0 ; !ret && !(condition) ; ) {			\
 	mtx_lock(&dev->irq_lock);				\
diff -ur src.old/sys/dev/drm/drm_sysctl.h src/sys/dev/drm/drm_sysctl.h
--- src.old/sys/dev/drm/drm_sysctl.h	2004-01-06 05:34:52.000000000 +0100
+++ src/sys/dev/drm/drm_sysctl.h	2005-04-05 14:13:16.000000000 +0200
@@ -24,7 +24,7 @@
  * $FreeBSD: src/sys/dev/drm/drm_sysctl.h,v 1.7 2004/01/06 04:34:52 anholt Exp $
  */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 
 #include <sys/sysctl.h>
 
diff -ur src.old/sys/dev/drm/drm_vm.h src/sys/dev/drm/drm_vm.h
--- src.old/sys/dev/drm/drm_vm.h	2004-06-16 11:46:42.000000000 +0200
+++ src/sys/dev/drm/drm_vm.h	2005-04-05 14:13:16.000000000 +0200
@@ -25,10 +25,10 @@
  * $FreeBSD: src/sys/dev/drm/drm_vm.h,v 1.11 2004/06/16 09:46:42 phk Exp $
  */
 
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500102
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500102
 static int DRM(dma_mmap)(struct cdev *kdev, vm_offset_t offset, vm_paddr_t *paddr, 
     int prot)
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 static int DRM(dma_mmap)(dev_t kdev, vm_offset_t offset, int prot)
 #elif defined(__NetBSD__)
 static paddr_t DRM(dma_mmap)(dev_t kdev, vm_offset_t offset, int prot)
@@ -46,7 +46,7 @@
 	physical = dma->pagelist[page];
 
 	DRM_DEBUG("0x%08lx (page %lu) => 0x%08lx\n", (long)offset, page, physical);
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500102
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500102
 	*paddr = physical;
 	return 0;
 #else
@@ -54,10 +54,10 @@
 #endif
 }
 
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500102
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500102
 int DRM(mmap)(struct cdev *kdev, vm_offset_t offset, vm_paddr_t *paddr, 
     int prot)
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 int DRM(mmap)(dev_t kdev, vm_offset_t offset, int prot)
 #elif defined(__NetBSD__)
 paddr_t DRM(mmap)(dev_t kdev, off_t offset, int prot)
@@ -76,7 +76,7 @@
 	if (dev->dma
 	    && offset >= 0
 	    && offset < ptoa(dev->dma->page_count))
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500102
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500102
 		return DRM(dma_mmap)(kdev, offset, paddr, prot);
 #else
 		return DRM(dma_mmap)(kdev, offset, prot);
@@ -109,7 +109,7 @@
 	case _DRM_FRAME_BUFFER:
 	case _DRM_REGISTERS:
 	case _DRM_AGP:
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500102
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500102
 		*paddr = offset;
 		return 0;
 #else
@@ -117,7 +117,7 @@
 #endif
 	case _DRM_SCATTER_GATHER:
 	case _DRM_SHM:
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500102
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500102
 		*paddr = vtophys(offset);
 		return 0;
 #else
diff -ur src.old/sys/dev/drm/mga_drv.c src/sys/dev/drm/mga_drv.c
--- src.old/sys/dev/drm/mga_drv.c	2003-10-24 03:48:16.000000000 +0200
+++ src/sys/dev/drm/mga_drv.c	2005-04-05 14:13:16.000000000 +0200
@@ -52,7 +52,7 @@
 #include "dev/drm/drm_vm.h"
 #include "dev/drm/drm_sysctl.h"
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 DRIVER_MODULE(mga, pci, mga_driver, mga_devclass, 0, 0);
 #elif defined(__NetBSD__)
 CFDRIVER_DECL(mga, DV_TTY, NULL);
diff -ur src.old/sys/dev/drm/r128_drv.c src/sys/dev/drm/r128_drv.c
--- src.old/sys/dev/drm/r128_drv.c	2003-10-24 03:48:16.000000000 +0200
+++ src/sys/dev/drm/r128_drv.c	2005-04-05 14:13:18.000000000 +0200
@@ -59,8 +59,8 @@
 #include "dev/drm/drm_scatter.h"
 #endif
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 DRIVER_MODULE(r128, pci, r128_driver, r128_devclass, 0, 0);
 #elif defined(__NetBSD__)
 CFDRIVER_DECL(r128, DV_TTY, NULL);
-#endif /* __FreeBSD__ */
+#endif /* 5 */
diff -ur src.old/sys/dev/drm/radeon_drv.c src/sys/dev/drm/radeon_drv.c
--- src.old/sys/dev/drm/radeon_drv.c	2003-10-24 03:48:17.000000000 +0200
+++ src/sys/dev/drm/radeon_drv.c	2005-04-05 14:13:18.000000000 +0200
@@ -57,8 +57,8 @@
 #include "dev/drm/drm_scatter.h"
 #endif
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 DRIVER_MODULE(DRIVER_NAME, pci, DRM(driver), DRM(devclass), 0, 0);
 #elif defined(__NetBSD__)
 CFDRIVER_DECL(radeon, DV_TTY, NULL);
-#endif /* __FreeBSD__ */
+#endif /* 5 */
diff -ur src.old/sys/dev/drm/sis_drv.c src/sys/dev/drm/sis_drv.c
--- src.old/sys/dev/drm/sis_drv.c	2004-06-11 05:26:59.000000000 +0200
+++ src/sys/dev/drm/sis_drv.c	2005-04-05 14:13:19.000000000 +0200
@@ -45,9 +45,9 @@
 #include "dev/drm/drm_vm.h"
 #include "dev/drm/drm_sysctl.h"
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 /* Avoid clash with sis ethernet */
 DRIVER_MODULE(sisdrm, pci, sisdrv_driver, sisdrv_devclass, 0, 0);
 #elif defined(__NetBSD__)
 CFDRIVER_DECL(sis, DV_TTY, NULL);
-#endif /* __FreeBSD__ */
+#endif /* 5 */
diff -ur src.old/sys/dev/drm/tdfx_drv.c src/sys/dev/drm/tdfx_drv.c
--- src.old/sys/dev/drm/tdfx_drv.c	2003-10-24 03:48:17.000000000 +0200
+++ src/sys/dev/drm/tdfx_drv.c	2005-04-05 14:13:20.000000000 +0200
@@ -48,8 +48,8 @@
 #include "dev/drm/drm_vm.h"
 #include "dev/drm/drm_sysctl.h"
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 DRIVER_MODULE(tdfx, pci, tdfx_driver, tdfx_devclass, 0, 0);
 #elif defined(__NetBSD__)
 CFDRIVER_DECL(tdfx, DV_TTY, NULL);
-#endif /* __FreeBSD__ */
+#endif /* 5 */
diff -ur src.old/sys/dev/firewire/firewire.c src/sys/dev/firewire/firewire.c
--- src.old/sys/dev/firewire/firewire.c	2004-07-28 08:20:01.000000000 +0200
+++ src/sys/dev/firewire/firewire.c	2005-04-05 14:13:30.000000000 +0200
@@ -2254,19 +2254,19 @@
 fw_modevent(module_t mode, int type, void *data)
 {
 	int err = 0;
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500000
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500000
 	static eventhandler_tag fwdev_ehtag = NULL;
 #endif
 
 	switch (type) {
 	case MOD_LOAD:
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500000
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500000
 		fwdev_ehtag = EVENTHANDLER_REGISTER(dev_clone,
 						fwdev_clone, 0, 1000);
 #endif
 		break;
 	case MOD_UNLOAD:
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500000
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500000
 		if (fwdev_ehtag != NULL)
 			EVENTHANDLER_DEREGISTER(dev_clone, fwdev_ehtag);
 #endif
diff -ur src.old/sys/dev/firewire/firewirereg.h src/sys/dev/firewire/firewirereg.h
--- src.old/sys/dev/firewire/firewirereg.h	2004-06-16 11:46:44.000000000 +0200
+++ src/sys/dev/firewire/firewirereg.h	2005-04-05 14:13:30.000000000 +0200
@@ -71,7 +71,7 @@
 };
 
 struct firewire_softc {
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500000
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500000
 	struct cdev *dev;
 #endif
 	struct firewire_comm *fc;
diff -ur src.old/sys/dev/firewire/fwcrom.c src/sys/dev/firewire/fwcrom.c
--- src.old/sys/dev/firewire/fwcrom.c	2004-05-22 18:14:17.000000000 +0200
+++ src/sys/dev/firewire/fwcrom.c	2005-04-05 14:13:30.000000000 +0200
@@ -32,7 +32,7 @@
  * SUCH DAMAGE.
  */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <sys/cdefs.h>
 __FBSDID("$FreeBSD: src/sys/dev/firewire/fwcrom.c,v 1.11 2004/05/22 16:14:17 dfr Exp $");
 #endif
diff -ur src.old/sys/dev/firewire/fwdev.c src/sys/dev/firewire/fwdev.c
--- src.old/sys/dev/firewire/fwdev.c	2004-06-17 19:16:44.000000000 +0200
+++ src/sys/dev/firewire/fwdev.c	2005-04-05 14:13:30.000000000 +0200
@@ -188,7 +188,7 @@
 	if (dev->si_drv1 != NULL)
 		return (EBUSY);
 
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500000
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500000
 	if ((dev->si_flags & SI_NAMED) == 0) {
 		int unit = DEV2UNIT(dev);
 		int sub = DEV2SUB(dev);
@@ -837,7 +837,7 @@
 	return (err);
 }
 
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500000
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500000
 #define NDEVTYPE 2
 void
 fwdev_clone(void *arg, char *name, int namelen, struct cdev **dev)
diff -ur src.old/sys/dev/firewire/fwdma.c src/sys/dev/firewire/fwdma.c
--- src.old/sys/dev/firewire/fwdma.c	2004-03-27 00:17:10.000000000 +0100
+++ src/sys/dev/firewire/fwdma.c	2005-04-05 14:13:30.000000000 +0200
@@ -33,7 +33,7 @@
  * 
  */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <sys/cdefs.h>
 __FBSDID("$FreeBSD: src/sys/dev/firewire/fwdma.c,v 1.6 2004/03/26 23:17:10 simokawa Exp $");
 #endif
@@ -43,7 +43,7 @@
 #include <sys/types.h>
 #include <sys/kernel.h>
 #include <sys/malloc.h>
-#if defined(__FreeBSD__) && __FreeBSD_version >= 501102 
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 501102 
 #include <sys/lock.h>
 #include <sys/mutex.h>
 #endif
@@ -90,7 +90,7 @@
 		/*nsegments*/ 1,
 		/*maxsegsz*/ BUS_SPACE_MAXSIZE_32BIT,
 		/*flags*/ BUS_DMA_ALLOCNOW,
-#if defined(__FreeBSD__) && __FreeBSD_version >= 501102 
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 501102 
 		/*lockfunc*/busdma_lock_mutex,
 		/*lockarg*/&Giant,
 #endif
@@ -188,7 +188,7 @@
 			/*nsegments*/ 1,
 			/*maxsegsz*/ BUS_SPACE_MAXSIZE_32BIT,
 			/*flags*/ BUS_DMA_ALLOCNOW,
-#if defined(__FreeBSD__) && __FreeBSD_version >= 501102
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 501102
 			/*lockfunc*/busdma_lock_mutex,
 			/*lockarg*/&Giant,
 #endif
diff -ur src.old/sys/dev/firewire/fwmem.c src/sys/dev/firewire/fwmem.c
--- src.old/sys/dev/firewire/fwmem.c	2004-06-16 11:46:44.000000000 +0200
+++ src/sys/dev/firewire/fwmem.c	2005-04-05 14:13:30.000000000 +0200
@@ -33,7 +33,7 @@
  * 
  */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <sys/cdefs.h>
 __FBSDID("$FreeBSD: src/sys/dev/firewire/fwmem.c,v 1.29 2004/06/16 09:46:44 phk Exp $");
 #endif
diff -ur src.old/sys/dev/firewire/fwohci.c src/sys/dev/firewire/fwohci.c
--- src.old/sys/dev/firewire/fwohci.c	2004-07-20 06:49:44.000000000 +0200
+++ src/sys/dev/firewire/fwohci.c	2005-04-05 14:13:31.000000000 +0200
@@ -1215,7 +1215,7 @@
 			/*nsegments*/ dbch->ndesc > 3 ? dbch->ndesc - 2 : 1,
 			/*maxsegsz*/ MAX_REQCOUNT,
 			/*flags*/ 0,
-#if defined(__FreeBSD__) && __FreeBSD_version >= 501102
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 501102
 			/*lockfunc*/busdma_lock_mutex,
 			/*lockarg*/&Giant,
 #endif
diff -ur src.old/sys/dev/firewire/fwohci_pci.c src/sys/dev/firewire/fwohci_pci.c
--- src.old/sys/dev/firewire/fwohci_pci.c	2004-08-04 14:18:39.000000000 +0200
+++ src/sys/dev/firewire/fwohci_pci.c	2005-04-05 14:13:31.000000000 +0200
@@ -45,7 +45,7 @@
 #include <machine/bus.h>
 #include <sys/rman.h>
 #include <sys/malloc.h>
-#if defined(__FreeBSD__) && __FreeBSD_version >= 501102
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 501102
 #include <sys/lock.h>
 #include <sys/mutex.h>
 #endif
@@ -357,7 +357,7 @@
 				/*nsegments*/0x20,
 				/*maxsegsz*/0x8000,
 				/*flags*/BUS_DMA_ALLOCNOW,
-#if defined(__FreeBSD__) && __FreeBSD_version >= 501102
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 501102
 				/*lockfunc*/busdma_lock_mutex,
 				/*lockarg*/&Giant,
 #endif
diff -ur src.old/sys/dev/firewire/if_fwe.c src/sys/dev/firewire/if_fwe.c
--- src.old/sys/dev/firewire/if_fwe.c	2004-08-12 05:02:16.000000000 +0200
+++ src/sys/dev/firewire/if_fwe.c	2005-04-05 14:13:31.000000000 +0200
@@ -229,7 +229,7 @@
 
         /* Tell the upper layer(s) we support long frames. */
 	ifp->if_data.ifi_hdrlen = sizeof(struct ether_vlan_header);
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500000
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500000
 	ifp->if_capabilities |= IFCAP_VLAN_MTU;
 	ifp->if_capenable |= IFCAP_VLAN_MTU;
 #endif
@@ -436,7 +436,7 @@
 						fwe->stream_ch, fwe->dma_ch);
 			splx(s);
 			break;
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500000
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500000
 		default:
 #else
 		case SIOCSIFADDR:
diff -ur src.old/sys/dev/firewire/if_fwip.c src/sys/dev/firewire/if_fwip.c
--- src.old/sys/dev/firewire/if_fwip.c	2004-08-14 01:09:41.000000000 +0200
+++ src/sys/dev/firewire/if_fwip.c	2005-04-05 14:13:31.000000000 +0200
@@ -425,7 +425,7 @@
 	case SIOCDELMULTI:
 		break;
 
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500000
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500000
 	default:
 #else
 	case SIOCSIFADDR:
diff -ur src.old/sys/dev/firewire/sbp.c src/sys/dev/firewire/sbp.c
--- src.old/sys/dev/firewire/sbp.c	2004-07-20 06:49:44.000000000 +0200
+++ src/sys/dev/firewire/sbp.c	2005-04-05 14:13:31.000000000 +0200
@@ -43,7 +43,7 @@
 #include <sys/sysctl.h>
 #include <machine/bus.h>
 #include <sys/malloc.h>
-#if defined(__FreeBSD__) && __FreeBSD_version >= 501102
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 501102
 #include <sys/lock.h>
 #include <sys/mutex.h>
 #endif
@@ -1938,7 +1938,7 @@
 				/*maxsize*/0x100000, /*nsegments*/SBP_IND_MAX,
 				/*maxsegsz*/SBP_SEG_MAX,
 				/*flags*/BUS_DMA_ALLOCNOW,
-#if defined(__FreeBSD__) && __FreeBSD_version >= 501102
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 501102
 				/*lockfunc*/busdma_lock_mutex,
 				/*lockarg*/&Giant,
 #endif
@@ -2466,7 +2466,7 @@
 			device_get_nameunit(sbp->fd.dev),
 			cam_sim_path(sbp->sim),
 			ccb->ccb_h.target_id, ccb->ccb_h.target_lun,
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500000
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500000
 			(uintmax_t)
 #endif
 				ccg->volume_size);
diff -ur src.old/sys/dev/isp/isp.c src/sys/dev/isp/isp.c
--- src.old/sys/dev/isp/isp.c	2004-05-24 09:02:24.000000000 +0200
+++ src/sys/dev/isp/isp.c	2005-04-05 14:13:43.000000000 +0200
@@ -42,7 +42,7 @@
 #ifdef	__NetBSD__
 #include <dev/ic/isp_netbsd.h>
 #endif
-#ifdef	__FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <dev/isp/isp_freebsd.h>
 #endif
 #ifdef	__OpenBSD__
diff -ur src.old/sys/dev/isp/isp_target.c src/sys/dev/isp/isp_target.c
--- src.old/sys/dev/isp/isp_target.c	2004-05-24 09:02:25.000000000 +0200
+++ src/sys/dev/isp/isp_target.c	2005-04-05 14:13:44.000000000 +0200
@@ -39,7 +39,7 @@
 #ifdef	__NetBSD__
 #include <dev/ic/isp_netbsd.h>
 #endif
-#ifdef	__FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <dev/isp/isp_freebsd.h>
 #endif
 #ifdef	__OpenBSD__
diff -ur src.old/sys/dev/isp/ispvar.h src/sys/dev/isp/ispvar.h
--- src.old/sys/dev/isp/ispvar.h	2004-05-24 09:02:25.000000000 +0200
+++ src/sys/dev/isp/ispvar.h	2005-04-05 14:13:45.000000000 +0200
@@ -38,7 +38,7 @@
 #include <dev/ic/isp_tpublic.h>
 #endif
 #endif
-#ifdef	__FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <dev/isp/ispmbox.h>
 #ifdef	ISP_TARGET_MODE
 #include <dev/isp/isp_target.h>
diff -ur src.old/sys/dev/ncv/ncr53c500.c src/sys/dev/ncv/ncr53c500.c
--- src.old/sys/dev/ncv/ncr53c500.c	2004-07-10 23:05:14.000000000 +0200
+++ src/sys/dev/ncv/ncr53c500.c	2005-04-05 14:14:01.000000000 +0200
@@ -42,16 +42,16 @@
 #include <sys/param.h>
 #include <sys/systm.h>
 #include <sys/kernel.h>
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500001
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500001
 #include <sys/bio.h>
-#endif	/* __FreeBSD__ */
+#endif	/* 5 */
 #include <sys/buf.h>
 #include <sys/queue.h>
 #include <sys/malloc.h>
 #include <sys/errno.h>
 
 #ifdef __NetBSD__
-#include <sys/device.h>
+
 #include <machine/bus.h>
 #include <machine/intr.h>
 
@@ -72,7 +72,7 @@
 #include <i386/Cbus/dev/ncr53c500hwtab.h>
 #endif /* __NetBSD__ */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <machine/clock.h>
 #include <machine/cpu.h>
 #include <machine/bus_pio.h>
@@ -88,7 +88,7 @@
 #include <dev/ncv/ncr53c500var.h>
 
 #include <dev/ncv/ncr53c500hwtab.h>
-#endif /* __FreeBSD__ */
+#endif /* 5 */
 
 #define	NCV_MAX_DATA_SIZE	(64 * 1024)
 #define	NCV_DELAY_MAX		(2 * 1000 * 1000)
diff -ur src.old/sys/dev/ncv/ncr53c500var.h src/sys/dev/ncv/ncr53c500var.h
--- src.old/sys/dev/ncv/ncr53c500var.h	2002-06-01 01:39:04.000000000 +0200
+++ src/sys/dev/ncv/ncr53c500var.h	2005-04-05 14:14:01.000000000 +0200
@@ -50,7 +50,7 @@
 	void *sc_ih;
 #endif	/* __NetBSD__ */
 
-#ifdef	__FreeBSD__
+#ifdef __FreeBSD_kernel__
 	bus_space_tag_t sc_iot;
 	bus_space_tag_t sc_memt;
 	bus_space_handle_t sc_ioh;
@@ -65,7 +65,7 @@
 	struct resource *mem_res;
 
 	void *ncv_intrhand;
-#endif	/* __FreeBSD__ */
+#endif	/* 5 */
 
 	int sc_tmaxcnt;
 	int sc_selstop;			/* sel atn stop asserted */
diff -ur src.old/sys/dev/nsp/nsp.c src/sys/dev/nsp/nsp.c
--- src.old/sys/dev/nsp/nsp.c	2004-07-10 23:06:08.000000000 +0200
+++ src/sys/dev/nsp/nsp.c	2005-04-05 14:14:02.000000000 +0200
@@ -45,7 +45,7 @@
 #include <sys/param.h>
 #include <sys/systm.h>
 #include <sys/kernel.h>
-#if defined(__FreeBSD__) && __FreeBSD_version > 500001
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version > 500001
 #include <sys/bio.h>
 #endif	/* __ FreeBSD__ */
 #include <sys/buf.h>
@@ -54,7 +54,7 @@
 #include <sys/errno.h>
 
 #ifdef __NetBSD__
-#include <sys/device.h>
+
 #include <machine/bus.h>
 #include <machine/intr.h>
 
@@ -71,7 +71,7 @@
 #include <i386/Cbus/dev/nspvar.h>
 #endif /* __NetBSD__ */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <machine/clock.h>
 #include <machine/cpu.h>
 #include <machine/bus_pio.h>
@@ -84,7 +84,7 @@
 #include <cam/scsi/scsi_low.h>
 #include <dev/nsp/nspreg.h>
 #include <dev/nsp/nspvar.h>
-#endif /* __FreeBSD__ */
+#endif /* 5 */
 
 /***************************************************
  * USER SETTINGS
diff -ur src.old/sys/dev/nsp/nspvar.h src/sys/dev/nsp/nspvar.h
--- src.old/sys/dev/nsp/nspvar.h	2002-06-01 01:39:04.000000000 +0200
+++ src/sys/dev/nsp/nspvar.h	2005-04-05 14:14:02.000000000 +0200
@@ -52,7 +52,7 @@
 	void *sc_ih;
 #endif	/* __NetBSD__ */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	bus_space_tag_t sc_iot;
 	bus_space_handle_t sc_ioh;
 	bus_space_tag_t sc_memt;
@@ -66,7 +66,7 @@
 	struct resource *mem_res;
 
 	void *nsp_intrhand;
-#endif	/* __FreeBSD__ */
+#endif	/* 5 */
 
 	int sc_tmaxcnt;				/* timeout count */
 	int sc_seltout;				/* selection timeout counter */
diff -ur src.old/sys/dev/owi/if_wireg.h src/sys/dev/owi/if_wireg.h
--- src.old/sys/dev/owi/if_wireg.h	2003-08-24 07:42:49.000000000 +0200
+++ src/sys/dev/owi/if_wireg.h	2005-04-05 14:14:03.000000000 +0200
@@ -83,7 +83,7 @@
 #ifdef __NetBSD__
 #define OS_STRING_NAME	"NetBSD"
 #endif
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define OS_STRING_NAME	"FreeBSD"
 #endif
 #ifdef __OpenBSD__
diff -ur src.old/sys/dev/pdq/pdq.c src/sys/dev/pdq/pdq.c
--- src.old/sys/dev/pdq/pdq.c	2003-08-24 19:54:16.000000000 +0200
+++ src/sys/dev/pdq/pdq.c	2005-04-05 14:14:08.000000000 +0200
@@ -49,7 +49,7 @@
 
 #define	PDQ_HWSUPPORT	/* for pdq.h */
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 /*
  * What a botch having to specific includes for FreeBSD!
  */
diff -ur src.old/sys/dev/pdq/pdq_ifsubr.c src/sys/dev/pdq/pdq_ifsubr.c
--- src.old/sys/dev/pdq/pdq_ifsubr.c	2003-08-24 19:54:16.000000000 +0200
+++ src/sys/dev/pdq/pdq_ifsubr.c	2005-04-05 14:14:09.000000000 +0200
@@ -436,14 +436,14 @@
     ifp->if_snd.ifq_maxlen = IFQ_MAXLEN;
     ifp->if_flags = IFF_BROADCAST|IFF_SIMPLEX|IFF_NOTRAILERS|IFF_MULTICAST;
 
-#if (defined(__FreeBSD__) && BSD >= 199506) || defined(__NetBSD__)
+#if (defined(__FreeBSD_kernel__) && BSD >= 199506) || defined(__NetBSD__)
     ifp->if_watchdog = pdq_ifwatchdog;
 #else
     ifp->if_watchdog = ifwatchdog;
 #endif
 
     ifp->if_ioctl = pdq_ifioctl;
-#if !defined(__NetBSD__) && !defined(__FreeBSD__)
+#if !defined(__NetBSD__) && !defined(__FreeBSD_kernel__)
     ifp->if_output = fddi_output;
 #endif
     ifp->if_start = pdq_ifstart;
diff -ur src.old/sys/dev/pdq/pdqvar.h src/sys/dev/pdq/pdqvar.h
--- src.old/sys/dev/pdq/pdqvar.h	2004-01-13 21:36:03.000000000 +0100
+++ src/sys/dev/pdq/pdqvar.h	2005-04-05 14:14:09.000000000 +0200
@@ -61,7 +61,7 @@
 
 #if defined(PDQTEST)
 #include <pdq_os_test.h>
-#elif defined(__FreeBSD__) || defined(__bsdi__) || defined(__NetBSD__)
+#elif defined(__FreeBSD_kernel__) || defined(__bsdi__) || defined(__NetBSD__)
 
 #include <sys/param.h>
 #include <sys/systm.h>
@@ -73,14 +73,14 @@
 #include <vm/vm_kern.h>
 
 #define	PDQ_USE_MBUFS
-#if defined(__NetBSD__) || defined(__FreeBSD__)
+#if defined(__NetBSD__) || defined(__FreeBSD_kernel__)
 #define	PDQ_OS_PREFIX			"%s: "
 #define	PDQ_OS_PREFIX_ARGS		pdq->pdq_os_name
 #else
 #define	PDQ_OS_PREFIX			"%s%d: "
 #define	PDQ_OS_PREFIX_ARGS		pdq->pdq_os_name, pdq->pdq_unit
 #endif
-#if defined(__FreeBSD__) && BSD >= 199506
+#if defined(__FreeBSD_kernel__) && BSD >= 199506
 #define	PDQ_OS_PAGESIZE			PAGE_SIZE
 #else
 #define	PDQ_OS_PAGESIZE			NBPG
@@ -95,7 +95,7 @@
 #endif
 #define	PDQ_OS_MEMALLOC(n)		malloc(n, M_DEVBUF, M_NOWAIT)
 #define	PDQ_OS_MEMFREE(p, n)		free((void *) p, M_DEVBUF)
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define	PDQ_OS_MEMALLOC_CONTIG(n)	contigmalloc(n, M_DEVBUF, M_NOWAIT, 0, 0xffffffff, PAGE_SIZE, 0)
 #define	PDQ_OS_MEMFREE_CONTIG(p, n)	contigfree((void *) p, n, M_DEVBUF)
 #else
@@ -103,9 +103,9 @@
 #define	PDQ_OS_MEMALLOC_CONTIG(n)	uvm_km_alloc(kernel_map, round_page(n))
 #define	PDQ_OS_MEMFREE_CONTIG(p, n)	uvm_km_free(kernel_map, (vaddr_t) p, n)
 #endif
-#endif /* __FreeBSD__ */
+#endif /* 5 */
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #include <vm/pmap.h>
 #include <vm/vm_extern.h>
 #include <machine/cpufunc.h>
@@ -116,7 +116,7 @@
 typedef	u_int16_t pdq_bus_ioport_t;
 typedef volatile pdq_uint32_t *pdq_bus_memaddr_t;
 typedef pdq_bus_memaddr_t pdq_bus_memoffset_t;
-#if BSD >= 199506	/* __FreeBSD__ */
+#if BSD >= 199506	/* 5 */
 #define	PDQ_BPF_MTAP(sc, m)	bpf_mtap(&(sc)->sc_if, m)
 #define	PDQ_BPFATTACH(sc, t, s)	bpfattach(&(sc)->sc_if, t, s)
 #endif
@@ -309,7 +309,7 @@
     struct ethercom sc_ec;
     bus_dma_tag_t sc_dmatag;
 #define	sc_if		sc_ec.ec_if
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
     struct kern_devconf *sc_kdc;	/* freebsd cruft */
     struct arpcom sc_ac;
 #define	sc_if		sc_ac.ac_if
diff -ur src.old/sys/dev/snc/dp83932var.h src/sys/dev/snc/dp83932var.h
--- src.old/sys/dev/snc/dp83932var.h	2003-02-10 14:31:49.000000000 +0100
+++ src/sys/dev/snc/dp83932var.h	2005-04-05 14:14:20.000000000 +0200
@@ -37,7 +37,7 @@
 #ifdef __NetBSD__
 #define	splhardnet	splnet
 #endif
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define	splhardnet	splimp
 #ifndef NBPG
 #define NBPG PAGE_SIZE
diff -ur src.old/sys/dev/sound/usb/uaudio.c src/sys/dev/sound/usb/uaudio.c
--- src.old/sys/dev/sound/usb/uaudio.c	2002-08-25 03:32:22.000000000 +0200
+++ src/sys/dev/sound/usb/uaudio.c	2005-04-05 14:14:28.000000000 +0200
@@ -49,7 +49,7 @@
 #include <sys/kernel.h>
 #include <sys/malloc.h>
 #if defined(__NetBSD__) || defined(__OpenBSD__)
-#include <sys/device.h>
+
 #include <sys/ioctl.h>
 #endif
 #include <sys/tty.h>
@@ -59,8 +59,8 @@
 #include <sys/proc.h>
 #include <sys/vnode.h>
 #if defined(__NetBSD__) || defined(__OpenBSD__)
-#include <sys/device.h>
-#elif defined(__FreeBSD__)
+
+#elif defined(__FreeBSD_kernel__)
 #include <sys/module.h>
 #include <sys/bus.h>
 #include <sys/conf.h>
@@ -73,7 +73,7 @@
 #include <dev/audio_if.h>
 #include <dev/mulaw.h>
 #include <dev/auconv.h>
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 #include <dev/sound/pcm/sound.h>	/* XXXXX */
 #include <dev/sound/chip.h>
 #endif
@@ -117,7 +117,7 @@
 	int		minval, maxval;
 	u_int		delta;
 	u_int		mul;
-#if defined(__FreeBSD__) /* XXXXX */
+#if defined(__FreeBSD_kernel__) /* XXXXX */
 	unsigned	ctl;
 #else
 	u_int8_t	class;
@@ -171,7 +171,7 @@
 	} chanbufs[UAUDIO_NCHANBUFS];
 
 	struct uaudio_softc *sc; /* our softc */
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	u_int32_t format;
 	int	precision;
 	int	channels;
@@ -358,7 +358,7 @@
 	"uaudio"
 };
 
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 Static int	audio_attach_mi(device_t);
 Static void	uaudio_init_params(struct uaudio_softc * sc, struct chan *ch);
 
@@ -382,7 +382,7 @@
 
 USB_DECLARE_DRIVER(uaudio);
 
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 
 USB_DECLARE_DRIVER_INIT(uaudio,
 		DEVMETHOD(device_suspend, bus_generic_suspend),
@@ -424,7 +424,7 @@
 	usbd_devinfo(uaa->device, 0, devinfo);
 	USB_ATTACH_SETUP;
 
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 	printf(": %s\n", devinfo);
 #endif
 
@@ -486,7 +486,7 @@
 		printf("%s: %d mixer controls\n", USBDEVNAME(sc->sc_dev),
 		    sc->sc_nctls);
 
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 	usbd_add_drv_event(USB_EVENT_DRIVER_ATTACH, sc->sc_udev,
 			   USBDEV(sc->sc_dev));
 #endif
@@ -496,7 +496,7 @@
 	audio_attach_mi(&uaudio_hw_if, sc, &sc->sc_dev);
 #elif defined(__NetBSD__)
 	sc->sc_audiodev = audio_attach_mi(&uaudio_hw_if, sc, &sc->sc_dev);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	sc->sc_dying = 0;
 	if (audio_attach_mi(sc->sc_dev)) {
 		printf("audio_attach_mi failed\n");
@@ -547,7 +547,7 @@
 
 	return (rv);
 }
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 
 USB_DETACH(uaudio)
 {
@@ -698,7 +698,7 @@
 		DPRINTF(("uaudio_mixer_add_ctl: wValue=%04x",mc->wValue[0]));
 		for (i = 1; i < mc->nchan; i++)
 			DPRINTF((",%04x", mc->wValue[i]));
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 		DPRINTF((" wIndex=%04x type=%d ctl='%d' "
 			 "min=%d max=%d\n",
 			 mc->wIndex, mc->type, mc->ctl,
@@ -844,11 +844,11 @@
 
 	bm = d1->bmControls;
 	mix.wIndex = MAKE(d->bUnitId, sc->sc_ac_iface);
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 	mix.class = -1;
 #endif
 	mix.type = MIX_SIGNED_16;
-#if !defined(__FreeBSD__)	/* XXXXX */
+#if !defined(__FreeBSD_kernel__)	/* XXXXX */
 	mix.ctlunit = AudioNvolume;
 #endif
 
@@ -875,7 +875,7 @@
 						mix.wValue[k++] = 
 							MAKE(p+c+1, o+1);
 				}
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 			sprintf(mix.ctlname, "mix%d-%s", d->bUnitId,
 				uaudio_id_name(sc, dps, d->baSourceId[i]));
 #endif
@@ -912,7 +912,7 @@
 	uByte *ctls = d->bmaControls;
 	int ctlsize = d->bControlSize;
 	int nchan = (d->bLength - 7) / ctlsize;
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 	int srcId = d->bSourceId;
 #endif
 	u_int fumask, mmask, cmask;
@@ -930,7 +930,7 @@
 		cmask |= GET(chan);
 	}
 
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 	DPRINTFN(1,("uaudio_add_feature: bUnitId=%d bSourceId=%d, "
 		    "%d channels, mmask=0x%04x, cmask=0x%04x\n", 
 		    d->bUnitId, srcId, nchan, mmask, cmask));
@@ -960,13 +960,13 @@
 		}
 #undef GET
 
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 		mix.class = -1;	/* XXX */
 #endif
 		switch (ctl) {
 		case MUTE_CONTROL:
 			mix.type = MIX_ON_OFF;
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 			mix.ctl = SOUND_MIXER_NRDEVICES;
 #else
 			sprintf(mix.ctlname, "fea%d-%s-%s", unit,
@@ -977,7 +977,7 @@
 			break;
 		case VOLUME_CONTROL:
 			mix.type = MIX_SIGNED_16;
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 			/* mix.ctl = SOUND_MIXER_VOLUME; */
 			mix.ctl = SOUND_MIXER_PCM;
 #else
@@ -989,7 +989,7 @@
 			break;
 		case BASS_CONTROL:
 			mix.type = MIX_SIGNED_8;
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 			mix.ctl = SOUND_MIXER_BASS;
 #else
 			sprintf(mix.ctlname, "fea%d-%s-%s", unit,
@@ -1000,7 +1000,7 @@
 			break;
 		case MID_CONTROL:
 			mix.type = MIX_SIGNED_8;
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 			mix.ctl = SOUND_MIXER_NRDEVICES;	/* XXXXX */
 #else
 			sprintf(mix.ctlname, "fea%d-%s-%s", unit,
@@ -1011,7 +1011,7 @@
 			break;
 		case TREBLE_CONTROL:
 			mix.type = MIX_SIGNED_8;
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 			mix.ctl = SOUND_MIXER_TREBLE;
 #else
 			sprintf(mix.ctlname, "fea%d-%s-%s", unit,
@@ -1025,7 +1025,7 @@
 			break;
 		case AGC_CONTROL:
 			mix.type = MIX_ON_OFF;
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 			mix.ctl = SOUND_MIXER_NRDEVICES;	/* XXXXX */
 #else
 			sprintf(mix.ctlname, "fea%d-%s-%s", unit,
@@ -1036,7 +1036,7 @@
 			break;
 		case DELAY_CONTROL:
 			mix.type = MIX_UNSIGNED_16;
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 			mix.ctl = SOUND_MIXER_NRDEVICES;	/* XXXXX */
 #else
 			sprintf(mix.ctlname, "fea%d-%s-%s", unit,
@@ -1047,7 +1047,7 @@
 			break;
 		case BASS_BOOST_CONTROL:
 			mix.type = MIX_ON_OFF;
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 			mix.ctl = SOUND_MIXER_NRDEVICES;	/* XXXXX */
 #else
 			sprintf(mix.ctlname, "fea%d-%s-%s", unit,
@@ -1058,7 +1058,7 @@
 			break;
 		case LOUDNESS_CONTROL:
 			mix.type = MIX_ON_OFF;
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 			mix.ctl = SOUND_MIXER_LOUD;	/* Is this correct ? */
 #else
 			sprintf(mix.ctlname, "fea%d-%s-%s", unit,
@@ -1097,11 +1097,11 @@
 	mix.wIndex = MAKE(d->bUnitId, sc->sc_ac_iface);
 	mix.nchan = 1;
 	mix.wValue[0] = MAKE(UD_MODE_SELECT_CONTROL, 0);
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 	mix.class = -1;
 #endif
 	mix.type = MIX_ON_OFF;	/* XXX */
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 	mix.ctlunit = "";
 	sprintf(mix.ctlname, "pro%d-mode", d->bUnitId);
 #endif
@@ -1132,11 +1132,11 @@
 		mix.wIndex = MAKE(d->bUnitId, sc->sc_ac_iface);
 		mix.nchan = 1;
 		mix.wValue[0] = MAKE(XX_ENABLE_CONTROL, 0);
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 		mix.class = -1;
 #endif
 		mix.type = MIX_ON_OFF;
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 		mix.ctlunit = "";
 		sprintf(mix.ctlname, "pro%d.%d-enable", d->bUnitId, ptype);
 #endif
@@ -1181,11 +1181,11 @@
 		mix.wIndex = MAKE(d->bUnitId, sc->sc_ac_iface);
 		mix.nchan = 1;
 		mix.wValue[0] = MAKE(UA_EXT_ENABLE, 0);
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 		mix.class = -1;
 #endif
 		mix.type = MIX_ON_OFF;
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 		mix.ctlunit = "";
 		sprintf(mix.ctlname, "ext%d-enable", d->bUnitId);
 #endif
@@ -2201,7 +2201,7 @@
 #endif
 
 	ch->transferred += cb->size;
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	/* s = spltty(); */
 	s = splhigh();
 	chn_intr(ch->pcm_ch);
@@ -2320,7 +2320,7 @@
 
 	/* Call back to upper layer */
 	ch->transferred += cb->size;
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	s = spltty();
 	chn_intr(ch->pcm_ch);
 	splx(s);
@@ -2547,7 +2547,7 @@
 }
 
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 /************************************************************/
 void
 uaudio_init_params(struct uaudio_softc *sc, struct chan *ch)
diff -ur src.old/sys/dev/stg/tmc18c30.c src/sys/dev/stg/tmc18c30.c
--- src.old/sys/dev/stg/tmc18c30.c	2004-07-10 23:14:20.000000000 +0200
+++ src/sys/dev/stg/tmc18c30.c	2005-04-05 14:14:29.000000000 +0200
@@ -44,16 +44,16 @@
 #include <sys/param.h>
 #include <sys/systm.h>
 #include <sys/kernel.h>
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500001
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500001
 #include <sys/bio.h>
-#endif	/* __FreeBSD__ */
+#endif	/* 5 */
 #include <sys/buf.h>
 #include <sys/queue.h>
 #include <sys/malloc.h>
 #include <sys/errno.h>
 
 #ifdef __NetBSD__
-#include <sys/device.h>
+
 #include <machine/bus.h>
 #include <machine/intr.h>
 
@@ -70,7 +70,7 @@
 #include <i386/Cbus/dev/tmc18c30var.h>
 #endif /* __NetBSD__ */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <machine/clock.h>
 #include <machine/cpu.h>
 #include <machine/bus_pio.h>
@@ -82,7 +82,7 @@
 #include <cam/scsi/scsi_low.h>
 #include <dev/stg/tmc18c30reg.h>
 #include <dev/stg/tmc18c30var.h>
-#endif /* __FreeBSD__ */
+#endif /* 5 */
 
 /***************************************************
  * USER SETTINGS
diff -ur src.old/sys/dev/stg/tmc18c30var.h src/sys/dev/stg/tmc18c30var.h
--- src.old/sys/dev/stg/tmc18c30var.h	2002-06-01 01:39:04.000000000 +0200
+++ src/sys/dev/stg/tmc18c30var.h	2005-04-05 14:14:29.000000000 +0200
@@ -52,7 +52,7 @@
 	void *sc_ih;
 #endif	/* __NetBSD__ */
 
-#ifdef	__FreeBSD__
+#ifdef __FreeBSD_kernel__
 	bus_space_tag_t sc_iot;
 	bus_space_tag_t sc_memt;
 	bus_space_handle_t sc_ioh;
@@ -65,7 +65,7 @@
 	struct resource *mem_res;
 
 	void *stg_intrhand;
-#endif	/* __FreeBSD__ */
+#endif	/* 5 */
 
 	int sc_tmaxcnt;
 	u_int sc_chip;			/* chip type */
diff -ur src.old/sys/dev/twe/twe_compat.h src/sys/dev/twe/twe_compat.h
--- src.old/sys/dev/twe/twe_compat.h	2004-06-16 11:47:00.000000000 +0200
+++ src/sys/dev/twe/twe_compat.h	2005-04-05 14:14:40.000000000 +0200
@@ -32,7 +32,7 @@
  * Portability and compatibility interfaces.
  */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 /******************************************************************************
  * FreeBSD
  */
diff -ur src.old/sys/dev/usb/dsbr100io.h src/sys/dev/usb/dsbr100io.h
--- src.old/sys/dev/usb/dsbr100io.h	2002-03-04 04:51:19.000000000 +0100
+++ src/sys/dev/usb/dsbr100io.h	2005-04-05 14:14:44.000000000 +0200
@@ -30,11 +30,11 @@
 
 /*  $FreeBSD: src/sys/dev/usb/dsbr100io.h,v 1.1 2002/03/04 03:51:19 alfred Exp $ */
 
-#if defined(__FreeBSD__) || defined(__NetBSD__) || defined(__OpenBSD__)
+#if defined(__FreeBSD_kernel__) || defined(__NetBSD__) || defined(__OpenBSD__)
 #include <sys/ioccom.h>
 #endif
 
-#if defined(__FreeBSD__) || defined(__NetBSD__) || defined(__OpenBSD__)
+#if defined(__FreeBSD_kernel__) || defined(__NetBSD__) || defined(__OpenBSD__)
 #define FM_SET_FREQ	_IOWR('U', 200, int)
 #define FM_GET_FREQ	_IOWR('U', 201, int)
 #define FM_START	_IOWR('U', 202, int)
diff -ur src.old/sys/dev/usb/ehci.c src/sys/dev/usb/ehci.c
--- src.old/sys/dev/usb/ehci.c	2004-08-02 17:37:34.000000000 +0200
+++ src/sys/dev/usb/ehci.c	2005-04-05 14:14:44.000000000 +0200
@@ -88,16 +88,16 @@
 #include <sys/malloc.h>
 #include <sys/kernel.h>
 #if defined(__NetBSD__) || defined(__OpenBSD__)
-#include <sys/device.h>
+
 #include <sys/select.h>
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 #include <sys/endian.h>
 #include <sys/module.h>
 #include <sys/bus.h>
 #include <machine/bus_pio.h>
 #include <machine/bus_memio.h>
 #include <sys/lockmgr.h>
-#if defined(DIAGNOSTIC) && defined(__i386__) && defined(__FreeBSD__)
+#if defined(DIAGNOSTIC) && defined(__i386__) && defined(__FreeBSD_kernel__)
 #include <machine/cpu.h>
 #endif
 #endif
@@ -117,7 +117,7 @@
 #include <dev/usb/ehcireg.h>
 #include <dev/usb/ehcivar.h>
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #include <machine/clock.h>
 
 #define delay(d)                DELAY(d)
@@ -2231,7 +2231,7 @@
 		    EHCI_QTD_NBUFFERS * EHCI_PAGE_SIZE) {
 			/* we can handle it in this QTD */
 			curlen = len;
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 		/* XXX This is pretty broken: Because we do not allocate
 		 * a contiguous buffer (contiguous in physical pages) we
 		 * can only transfer one page in one go.
@@ -2257,7 +2257,7 @@
 				curlen = len;
 			}
 #endif
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 			/* See comment above (XXX) */
 			curlen = EHCI_PAGE_SIZE -
 				 EHCI_PAGE_MASK(dataphys);
diff -ur src.old/sys/dev/usb/ehcireg.h src/sys/dev/usb/ehcireg.h
--- src.old/sys/dev/usb/ehcireg.h	2004-08-02 14:56:00.000000000 +0200
+++ src/sys/dev/usb/ehcireg.h	2005-04-05 14:14:45.000000000 +0200
@@ -182,7 +182,7 @@
 #define EHCI_PAGE_SIZE 0x1000
 #define EHCI_PAGE(x) ((x) &~ 0xfff)
 #define EHCI_PAGE_OFFSET(x) ((x) & 0xfff)
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #define EHCI_PAGE_MASK(x) ((x) & 0xfff)
 #endif
 
diff -ur src.old/sys/dev/usb/ehcivar.h src/sys/dev/usb/ehcivar.h
--- src.old/sys/dev/usb/ehcivar.h	2004-08-02 17:37:34.000000000 +0200
+++ src/sys/dev/usb/ehcivar.h	2005-04-05 14:14:45.000000000 +0200
@@ -95,7 +95,7 @@
 	bus_space_tag_t iot;
 	bus_space_handle_t ioh;
 	bus_size_t sc_size;
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	void *ih;
 
 	struct resource *io_res;
diff -ur src.old/sys/dev/usb/if_auereg.h src/sys/dev/usb/if_auereg.h
--- src.old/sys/dev/usb/if_auereg.h	2004-05-23 14:35:24.000000000 +0200
+++ src/sys/dev/usb/if_auereg.h	2005-04-05 14:14:45.000000000 +0200
@@ -222,7 +222,7 @@
 #define AUE_INC(x, y)		(x) = (x + 1) % y
 
 struct aue_softc {
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #define GET_MII(sc) (device_get_softc((sc)->aue_miibus))
 #elif defined(__NetBSD__)
 #define GET_MII(sc) (&(sc)->aue_mii)
diff -ur src.old/sys/dev/usb/if_axereg.h src/sys/dev/usb/if_axereg.h
--- src.old/sys/dev/usb/if_axereg.h	2004-05-23 14:35:24.000000000 +0200
+++ src/sys/dev/usb/if_axereg.h	2005-04-05 14:14:45.000000000 +0200
@@ -144,7 +144,7 @@
 #define AXE_INC(x, y)		(x) = (x + 1) % y
 
 struct axe_softc {
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #define GET_MII(sc) (device_get_softc((sc)->axe_miibus))
 #elif defined(__NetBSD__)
 #define GET_MII(sc) (&(sc)->axe_mii)
diff -ur src.old/sys/dev/usb/if_ruereg.h src/sys/dev/usb/if_ruereg.h
--- src.old/sys/dev/usb/if_ruereg.h	2004-05-23 14:35:24.000000000 +0200
+++ src/sys/dev/usb/if_ruereg.h	2005-04-05 14:14:46.000000000 +0200
@@ -231,7 +231,7 @@
 	struct usb_qdat		rue_qdat;
 };
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #define GET_MII(sc)	(device_get_softc((sc)->rue_miibus))
 #elif defined(__NetBSD__)
 #define GET_MII(sc)	(&(sc)->rue_mii)
diff -ur src.old/sys/dev/usb/if_udav.c src/sys/dev/usb/if_udav.c
--- src.old/sys/dev/usb/if_udav.c	2004-08-11 05:38:55.000000000 +0200
+++ src/sys/dev/usb/if_udav.c	2005-04-05 14:14:46.000000000 +0200
@@ -52,9 +52,9 @@
 #include "opt_ns.h"
 #endif
 #if defined(__NetBSD__)
-#include "bpfilter.h"
+
 #endif
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #define NBPFILTER	1
 #endif
 #if defined(__NetBSD__)
@@ -68,14 +68,14 @@
 #include <sys/kernel.h>
 #include <sys/module.h>
 #include <sys/socket.h>
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #include <sys/types.h>
 #include <sys/lockmgr.h>
 #include <sys/sockio.h>
 #endif
 
 #if defined(__NetBSD__)
-#include <sys/device.h>
+
 #endif
 
 #if NRND > 0
@@ -107,10 +107,10 @@
 #include <netinet/in.h>
 #include <netinet/if_inarp.h>
 #endif /* INET */
-#elif defined(__FreeBSD__) /* defined(__NetBSD__) */
+#elif defined(__FreeBSD_kernel__) /* defined(__NetBSD__) */
 #include <netinet/in.h>
 #include <netinet/if_ether.h>
-#endif /* defined(__FreeBSD__) */
+#endif /* defined(__FreeBSD_kernel__) */
 
 #if defined(__NetBSD__)
 #ifdef NS
@@ -137,7 +137,7 @@
 
 #include <dev/usb/if_udavreg.h>
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 MODULE_DEPEND(udav, usb, 1, 1, 1);
 MODULE_DEPEND(udav, ether, 1, 1, 1);
 MODULE_DEPEND(udav, miibus, 1, 1, 1);
@@ -146,12 +146,12 @@
 /* "controller miibus0" required.  See GENERIC if you get errors here. */
 #include "miibus_if.h"
 
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 /* Function declarations */
 USB_DECLARE_DRIVER(udav);
 #endif
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 Static int udav_match(device_ptr_t);
 Static int udav_attach(device_ptr_t);
 Static int udav_detach(device_ptr_t);
@@ -165,7 +165,7 @@
 Static void udav_start(struct ifnet *);
 Static int udav_send(struct udav_softc *, struct mbuf *, int);
 Static void udav_txeof(usbd_xfer_handle, usbd_private_handle, usbd_status);
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 Static void udav_rxstart(struct ifnet *ifp);
 #endif
 Static void udav_rxeof(usbd_xfer_handle, usbd_private_handle, usbd_status);
@@ -184,7 +184,7 @@
 Static void udav_miibus_statchg(device_ptr_t);
 #if defined(__NetBSD__)
 Static int udav_init(struct ifnet *);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 Static void udav_init(void *);
 #endif
 Static void udav_setmulti(struct udav_softc *);
@@ -201,7 +201,7 @@
 Static int udav_mem_write1(struct udav_softc *, int, unsigned char);
 #endif
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 Static device_method_t udav_methods[] = {
 	/* Device interface */
 	DEVMETHOD(device_probe,		udav_match),
@@ -232,7 +232,7 @@
 DRIVER_MODULE(udav, uhub, udav_driver, udav_devclass, usbd_driver_load, 0);
 DRIVER_MODULE(miibus, udav, miibus_driver, miibus_devclass, 0, 0);
 
-#endif /* defined(__FreeBSD__) */
+#endif /* defined(__FreeBSD_kernel__) */
 
 /* Macros */
 #ifdef UDAV_DEBUG
@@ -359,13 +359,13 @@
 		goto bad;
 	}
 
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500000
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500000
 	mtx_init(&sc->sc_mtx, device_get_nameunit(self), MTX_NETWORK_LOCK,
 	    MTX_DEF | MTX_RECURSE);
 #endif
 #if defined(__NetBSD__)
 	s = splnet();
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
         UDAV_LOCK(sc);
 #endif
 
@@ -378,7 +378,7 @@
 		printf("%s: read MAC address failed\n", devname);
 #if defined(__NetBSD__)
 		splx(s);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
                 UDAV_UNLOCK(sc);
 #endif
 		goto bad;
@@ -387,7 +387,7 @@
 	/* Print Ethernet Address */
 	printf("%s: Ethernet address %s\n", devname, ether_sprintf(eaddr));
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	bcopy(eaddr, (char *)&sc->sc_ac.ac_enaddr, ETHER_ADDR_LEN);
 #endif
 
@@ -397,7 +397,7 @@
 	ifp->if_mtu = ETHERMTU;
 #if defined(__NetBSD__)
 	strncpy(ifp->if_xname, devname, IFNAMSIZ);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	if_initname(ifp, "udav",  device_get_unit(self));
 #endif
 	ifp->if_flags = IFF_BROADCAST | IFF_SIMPLEX | IFF_MULTICAST |
@@ -409,7 +409,7 @@
 #if defined(__NetBSD__)
 	ifp->if_stop = udav_stop;
 #endif
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	ifp->if_baudrate = 10000000;
 	ifp->if_snd.ifq_maxlen = IFQ_MAXLEN;
 #endif
@@ -440,7 +440,7 @@
 	/* attach the interface */
 	if_attach(ifp);
 	Ether_ifattach(ifp, eaddr);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	if (mii_phy_probe(self, &sc->sc_miibus,
 	    udav_ifmedia_change, udav_ifmedia_status)) {
 		printf("%s: MII without any PHY!\n", USBDEVNAME(sc->sc_dev));
@@ -464,13 +464,13 @@
 #endif
 
 	usb_callout_init(sc->sc_stat_ch);
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	usb_register_netisr();
 #endif
 	sc->sc_attached = 1;
 #if defined(__NetBSD__)
         splx(s);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
         UDAV_UNLOCK(sc);
 #endif
 
@@ -508,7 +508,7 @@
 
 #if defined(__NetBSD__)
 	s = splusb();
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
         UDAV_LOCK(sc);
 #endif
 
@@ -546,11 +546,11 @@
 
 #if defined(__NetBSD__)
         splx(s);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
         UDAV_UNLOCK(sc);
 #endif
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	mtx_destroy(&sc->sc_mtx);
 #endif
 
@@ -801,14 +801,14 @@
 #if defined(__NetBSD__)
 Static int
 udav_init(struct ifnet *ifp)
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 Static void
 udav_init(void *xsc)
 #endif
 {
 #if defined(__NetBSD__)
 	struct udav_softc *sc = ifp->if_softc;
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	struct udav_softc *sc = (struct udav_softc *)xsc;
 	struct ifnet	*ifp = GET_IFP(sc);
 #endif
@@ -823,13 +823,13 @@
 	if (sc->sc_dying)
 #if defined(__NetBSD__)
 		return (EIO);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 		return ;
 #endif
 
 #if defined(__NetBSD__)
 	s = splnet();
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
         UDAV_LOCK(sc);
 #endif
 
@@ -838,7 +838,7 @@
 
 #if defined(__NetBSD__)
 	eaddr = LLADDR(ifp->if_sadl);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	eaddr = sc->sc_ac.ac_enaddr ;
 #endif
 	udav_csr_write(sc, UDAV_PAR, eaddr, ETHER_ADDR_LEN);
@@ -862,7 +862,7 @@
 #if defined(__NetBSD__)
 		splx(s);
 		return (EIO);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
                 UDAV_UNLOCK(sc);
 		return ;
 #endif
@@ -875,7 +875,7 @@
 #if defined(__NetBSD__)
 		splx(s);
 		return (EIO);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
                 UDAV_UNLOCK(sc);
 		return ;
 #endif
@@ -898,7 +898,7 @@
 #if defined(__NetBSD__)
                         splx(s);
                         return (EIO);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
                         UDAV_UNLOCK(sc);
                         return ;
 #endif
@@ -910,7 +910,7 @@
 
 #if defined(__NetBSD__)
 	splx(s);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
         UDAV_UNLOCK(sc);
 #endif
 
@@ -918,7 +918,7 @@
 
 #if defined(__NetBSD__)
 	return (0);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	return ;
 #endif
 }
@@ -992,7 +992,7 @@
 #if defined(__NetBSD__)
 	struct ether_multi *enm;
 	struct ether_multistep step;
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	struct ifmultiaddr *ifma;
 #endif
 	u_int8_t hashes[8];
@@ -1035,7 +1035,7 @@
 		hashes[h>>3] |= 1 << (h & 0x7);
 		ETHER_NEXT_MULTI(step, enm);
 	}
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 #if __FreeBSD_version >= 500000
 	TAILQ_FOREACH(ifma, &ifp->if_multiaddrs, ifma_link)
 #else
@@ -1241,14 +1241,14 @@
 		return;
 #if defined(__NetBSD__)
 	IFQ_POLL(&ifp->if_snd, m_head);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	IF_DEQUEUE(&ifp->if_snd, m_head);
 #endif
 	if (m_head == NULL)
 		return;
 
 	if (udav_send(sc, m_head, 0)) {
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 		IF_PREPEND(&ifp->if_snd, m_head);
 #endif
 		ifp->if_flags |= IFF_OACTIVE;
@@ -1336,7 +1336,7 @@
 
 #if defined(__NetBSD__)
 	s = splnet();
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
         UDAV_LOCK(sc);
 #endif
 
@@ -1349,7 +1349,7 @@
 		if (status == USBD_NOT_STARTED || status == USBD_CANCELLED) {
 #if defined(__NetBSD__)
 			splx(s);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
                         UDAV_UNLOCK(sc);
 #endif
 			return;
@@ -1365,7 +1365,7 @@
 		}
 #if defined(__NetBSD__)
 		splx(s);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
                 UDAV_UNLOCK(sc);
 #endif
 		return;
@@ -1378,14 +1378,14 @@
 
 #if defined(__NetBSD__)
 	if (IFQ_IS_EMPTY(&ifp->if_snd) == 0)
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	if ( ifp->if_snd.ifq_head != NULL )
 #endif
 		udav_start(ifp);
 
 #if defined(__NetBSD__)
 	splx(s);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
         UDAV_UNLOCK(sc);
 #endif
 }
@@ -1458,13 +1458,13 @@
 	m->m_pkthdr.len = m->m_len = total_len;
 #if defined(__NetBSD__)
 	m->m_pkthdr.rcvif = ifp;
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	m->m_pkthdr.rcvif = (struct ifnet *)&sc->sc_qdat;
 #endif
 
 #if defined(__NetBSD__)
 	s = splnet();
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
         UDAV_LOCK(sc);
 #endif
 
@@ -1484,7 +1484,7 @@
 #if defined(__NetBSD__)
 	IF_INPUT(ifp, m);
 #endif
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	usb_ether_input(m);
         UDAV_UNLOCK(sc);
         return ;
@@ -1493,7 +1493,7 @@
 #if defined(__NetBSD__)
  done1:
 	splx(s);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
         UDAV_UNLOCK(sc);
 #endif
  done:
@@ -1533,12 +1533,12 @@
 
 #if defined(__NetBSD__)
 	s = splnet();
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
         UDAV_LOCK(sc);
 #endif
 
 	switch (cmd) {
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	case SIOCSIFFLAGS:
 		if (ifp->if_flags & IFF_UP) {
 			if (ifp->if_flags & IFF_RUNNING &&
@@ -1586,7 +1586,7 @@
 
 #if defined(__NetBSD__)
 	splx(s);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
         UDAV_UNLOCK(sc);
 #endif
 
@@ -1610,7 +1610,7 @@
 
 #if defined(__NetBSD__)
 	s = splusb();
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
         UDAV_LOCK(sc)
 #endif
 	c = &sc->sc_cdata.udav_tx_chain[0];
@@ -1619,13 +1619,13 @@
 
 #if defined(__NetBSD__)
 	if (IFQ_IS_EMPTY(&ifp->if_snd) == 0)
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	if ( ifp->if_snd.ifq_head != NULL )
 #endif
 		udav_start(ifp);
 #if defined(__NetBSD__)
 	splx(s);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
         UDAV_UNLOCK(sc);
 #endif
 }
@@ -1814,7 +1814,7 @@
 
 #if defined(__NetBSD__)
 	s = splnet();
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
         UDAV_LOCK(sc);
 #endif
 
@@ -1828,7 +1828,7 @@
 			sc->sc_link++;
 #if defined(__NetBSD__)
 			if (IFQ_IS_EMPTY(&ifp->if_snd) == 0)
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 			if ( ifp->if_snd.ifq_head != NULL )
 #endif
 				   udav_start(ifp);
@@ -1839,7 +1839,7 @@
 
 #if defined(__NetBSD__)
 	splx(s);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
         UDAV_UNLOCK(sc);
 #endif
 }
@@ -1854,7 +1854,7 @@
 	sc->sc_refcnt++;
 #if defined(__NetBSD__)
 	lockmgr(&sc->sc_mii_lock, LK_EXCLUSIVE, NULL);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	lockmgr(&sc->sc_mii_lock, LK_EXCLUSIVE, NULL, NULL);
 #endif
 }
@@ -1867,7 +1867,7 @@
 
 #if defined(__NetBSD__)
 	lockmgr(&sc->sc_mii_lock, LK_RELEASE, NULL);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	lockmgr(&sc->sc_mii_lock, LK_RELEASE, NULL, NULL);
 #endif
 	if (--sc->sc_refcnt < 0)
@@ -1999,7 +1999,7 @@
 	/* Nothing to do */
 }
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 /*
  * Stop all chip I/O so that the kernel's probe routines don't
  * get confused by errant DMAs when rebooting.
diff -ur src.old/sys/dev/usb/if_udavreg.h src/sys/dev/usb/if_udavreg.h
--- src.old/sys/dev/usb/if_udavreg.h	2004-05-23 14:35:25.000000000 +0200
+++ src/sys/dev/usb/if_udavreg.h	2005-04-05 14:14:46.000000000 +0200
@@ -142,18 +142,18 @@
 #define	 UDAV_GPR_GEPIO1	(1<<1) /* General purpose 1 */
 #define	 UDAV_GPR_GEPIO0	(1<<0) /* General purpose 0 */
 
-#if defined(__FreeBSD__) || defined(__OpenBSD__)
+#if defined(__FreeBSD_kernel__) || defined(__OpenBSD__)
 #define	GET_IFP(sc)		(&(sc)->sc_ac.ac_if)
 #elif defined(__NetBSD__)
 #define	GET_IFP(sc)		(&(sc)->sc_ec.ec_if)
 #endif
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #define GET_MII(sc)	(device_get_softc((sc)->sc_miibus))
 #else
 #define	GET_MII(sc)		(&(sc)->sc_mii)
 #endif
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #if 0
 #define UDAV_LOCK(_sc)		mtx_lock(&(_sc)->sc_mtx)
 #define UDAV_UNLOCK(_sc)	mtx_unlock(&(_sc)->sc_mtx)
@@ -185,7 +185,7 @@
 };
 
 struct udav_softc {
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	struct arpcom		sc_ac ; /* struct ifnet must be top of softc */
 #endif
 	USBBASEDEVICE		sc_dev;	/* base device */
@@ -207,7 +207,7 @@
 
 	/* Ethernet */
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	device_t		sc_miibus ;
 	struct mtx		sc_mtx ;
 	struct usb_qdat		sc_qdat;
diff -ur src.old/sys/dev/usb/ohci.c src/sys/dev/usb/ohci.c
--- src.old/sys/dev/usb/ohci.c	2004-08-02 17:37:34.000000000 +0200
+++ src/sys/dev/usb/ohci.c	2005-04-05 14:14:46.000000000 +0200
@@ -64,15 +64,15 @@
 #include <sys/malloc.h>
 #include <sys/kernel.h>
 #if defined(__NetBSD__) || defined(__OpenBSD__)
-#include <sys/device.h>
+
 #include <sys/select.h>
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 #include <sys/endian.h>
 #include <sys/module.h>
 #include <sys/bus.h>
 #include <machine/bus_pio.h>
 #include <machine/bus_memio.h>
-#if defined(DIAGNOSTIC) && defined(__i386__) && defined(__FreeBSD__)
+#if defined(DIAGNOSTIC) && defined(__i386__) && defined(__FreeBSD_kernel__)
 #include <machine/cpu.h>
 #endif
 #endif
@@ -92,7 +92,7 @@
 #include <dev/usb/ohcireg.h>
 #include <dev/usb/ohcivar.h>
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #include <machine/clock.h>
 
 #define delay(d)                DELAY(d)
diff -ur src.old/sys/dev/usb/ohcivar.h src/sys/dev/usb/ohcivar.h
--- src.old/sys/dev/usb/ohcivar.h	2004-08-02 17:37:35.000000000 +0200
+++ src/sys/dev/usb/ohcivar.h	2005-04-05 14:14:46.000000000 +0200
@@ -92,7 +92,7 @@
 	bus_space_handle_t ioh;
 	bus_size_t sc_size;
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	void *ih;
 
 	struct resource *io_res;
diff -ur src.old/sys/dev/usb/rio500_usb.h src/sys/dev/usb/rio500_usb.h
--- src.old/sys/dev/usb/rio500_usb.h	2000-04-08 19:02:13.000000000 +0200
+++ src/sys/dev/usb/rio500_usb.h	2005-04-05 14:14:46.000000000 +0200
@@ -21,7 +21,7 @@
 
 /*  $FreeBSD: src/sys/dev/usb/rio500_usb.h,v 1.1 2000/04/08 17:02:13 n_hibma Exp $ */
 
-#if defined(__FreeBSD__) || defined(__NetBSD__) || defined(__OpenBSD__)
+#if defined(__FreeBSD_kernel__) || defined(__NetBSD__) || defined(__OpenBSD__)
 #include <sys/ioccom.h>
 #ifndef USB_VENDOR_DIAMOND
 #define USB_VENDOR_DIAMOND 0x841
@@ -33,7 +33,7 @@
 
 struct RioCommand
 {
-#if defined(__FreeBSD__) || defined(__NetBSD__) || defined(__OpenBSD__)
+#if defined(__FreeBSD_kernel__) || defined(__NetBSD__) || defined(__OpenBSD__)
   u_int16_t  length;
 #else
   short length;
@@ -46,7 +46,7 @@
   int  timeout;
 };
 
-#if defined(__FreeBSD__) || defined(__NetBSD__) || defined(__OpenBSD__)
+#if defined(__FreeBSD_kernel__) || defined(__NetBSD__) || defined(__OpenBSD__)
 #define RIO_SEND_COMMAND	_IOWR('U', 200, struct RioCommand)
 #define RIO_RECV_COMMAND	_IOWR('U', 201, struct RioCommand)
 #else
diff -ur src.old/sys/dev/usb/ufm.c src/sys/dev/usb/ufm.c
--- src.old/sys/dev/usb/ufm.c	2004-08-16 01:39:18.000000000 +0200
+++ src/sys/dev/usb/ufm.c	2005-04-05 14:14:47.000000000 +0200
@@ -37,9 +37,9 @@
 #include <sys/kernel.h>
 #include <sys/malloc.h>
 #if defined(__NetBSD__)
-#include <sys/device.h>
+
 #include <sys/ioctl.h>
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 #include <sys/module.h>
 #include <sys/bus.h>
 #include <sys/ioccom.h>
@@ -83,7 +83,7 @@
 int ufmioctl(dev_t, u_long, caddr_t, int, usb_proc_ptr);
 
 cdev_decl(ufm);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 d_open_t  ufmopen;
 d_close_t ufmclose;
 d_ioctl_t ufmioctl;
@@ -99,7 +99,7 @@
  	.d_bmaj =	-1
 #endif
 };
-#endif  /*defined(__FreeBSD__)*/
+#endif  /*defined(__FreeBSD_kernel__)*/
 
 #define FM_CMD0		0x00
 #define FM_CMD_SET_FREQ	0x01
@@ -163,7 +163,7 @@
 
 	sc->sc_udev = udev = uaa->device;
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
  	if ((!uaa->device) || (!uaa->iface)) {
 		ermsg = "device or iface";
  		goto nobulk;
@@ -202,7 +202,7 @@
 	}
 	sc->sc_epaddr = edesc->bEndpointAddress;
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	/* XXX no error trapping, no storing of struct cdev **/
 	(void) make_dev(&ufm_cdevsw, device_get_unit(self),
 			UID_ROOT, GID_OPERATOR,
@@ -428,7 +428,7 @@
 	int maj, mn;
 
 	DPRINTF(("ufm_detach: sc=%p flags=%d\n", sc, flags));
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	DPRINTF(("ufm_detach: sc=%p\n", sc));
 #endif
 
@@ -450,7 +450,7 @@
 	/* Nuke the vnodes for any open instances (calls close). */
 	mn = self->dv_unit * USB_MAX_ENDPOINTS;
 	vdevgone(maj, mn, mn + USB_MAX_ENDPOINTS - 1, VCHR);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	/* XXX not implemented yet */
 #endif
 
@@ -461,7 +461,7 @@
 }
 #endif /* defined(__NetBSD__) || defined(__OpenBSD__) */
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 Static int
 ufm_detach(device_t self)
 {
diff -ur src.old/sys/dev/usb/ugen.c src/sys/dev/usb/ugen.c
--- src.old/sys/dev/usb/ugen.c	2004-08-16 01:39:18.000000000 +0200
+++ src/sys/dev/usb/ugen.c	2005-04-05 14:14:47.000000000 +0200
@@ -53,9 +53,9 @@
 #include <sys/kernel.h>
 #include <sys/malloc.h>
 #if defined(__NetBSD__) || defined(__OpenBSD__)
-#include <sys/device.h>
+
 #include <sys/ioctl.h>
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 #include <sys/module.h>
 #include <sys/bus.h>
 #include <sys/ioccom.h>
@@ -100,7 +100,7 @@
 
 struct ugen_endpoint {
 	struct ugen_softc *sc;
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	struct cdev *dev;
 #endif
 	usb_endpoint_descriptor_t *edesc;
@@ -127,7 +127,7 @@
 struct ugen_softc {
 	USBBASEDEVICE sc_dev;		/* base device */
 	usbd_device_handle sc_udev;
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	struct cdev *dev;
 #endif
 
@@ -142,7 +142,7 @@
 
 #if defined(__NetBSD__) || defined(__OpenBSD__)
 cdev_decl(ugen);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 d_open_t  ugenopen;
 d_close_t ugenclose;
 d_read_t  ugenread;
@@ -175,7 +175,7 @@
 Static int ugen_do_write(struct ugen_softc *, int, struct uio *, int);
 Static int ugen_do_ioctl(struct ugen_softc *, int, u_long,
 			 caddr_t, int, usb_proc_ptr);
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 Static void ugen_make_devnodes(struct ugen_softc *sc);
 Static void ugen_destroy_devnodes(struct ugen_softc *sc);
 #endif
@@ -239,7 +239,7 @@
 		USB_ATTACH_ERROR_RETURN;
 	}
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	/* the main device, ctrl endpoint */
 	sc->dev = make_dev(&ugen_cdevsw, UGENMINOR(USBDEVUNIT(sc->sc_dev), 0),
 		UID_ROOT, GID_OPERATOR, 0644, "%s", USBDEVNAME(sc->sc_dev));
@@ -248,7 +248,7 @@
 	USB_ATTACH_SUCCESS_RETURN;
 }
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 Static void
 ugen_make_devnodes(struct ugen_softc *sc)
 {
@@ -322,7 +322,7 @@
 	DPRINTFN(1,("ugen_set_config: %s to configno %d, sc=%p\n",
 		    USBDEVNAME(sc->sc_dev), configno, sc));
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	ugen_destroy_devnodes(sc);
 #endif
 
@@ -371,7 +371,7 @@
 		}
 	}
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	ugen_make_devnodes(sc);
 #endif
 
@@ -870,7 +870,7 @@
 
 #if defined(__NetBSD__) || defined(__OpenBSD__)
 	DPRINTF(("ugen_detach: sc=%p flags=%d\n", sc, flags));
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	DPRINTF(("ugen_detach: sc=%p\n", sc));
 #endif
 
@@ -904,7 +904,7 @@
 	/* Nuke the vnodes for any open instances (calls close). */
 	mn = self->dv_unit * USB_MAX_ENDPOINTS;
 	vdevgone(maj, mn, mn + USB_MAX_ENDPOINTS - 1, VCHR);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	/* destroy the device for the control endpoint */
 	destroy_dev(sc->dev);
 	ugen_destroy_devnodes(sc);
@@ -1034,7 +1034,7 @@
 	if (err)
 		return (err);
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	/* destroy the existing devices, we remake the new ones in a moment */
 	ugen_destroy_devnodes(sc);
 #endif
@@ -1068,7 +1068,7 @@
 		sce->iface = iface;
 	}
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	/* make the new devices */
 	ugen_make_devnodes(sc);
 #endif
@@ -1466,6 +1466,6 @@
 	return (revents);
 }
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 DRIVER_MODULE(ugen, uhub, ugen_driver, ugen_devclass, usbd_driver_load, 0);
 #endif
diff -ur src.old/sys/dev/usb/uhci.c src/sys/dev/usb/uhci.c
--- src.old/sys/dev/usb/uhci.c	2004-08-02 22:53:31.000000000 +0200
+++ src/sys/dev/usb/uhci.c	2005-04-05 14:14:48.000000000 +0200
@@ -66,9 +66,9 @@
 #include <sys/kernel.h>
 #include <sys/malloc.h>
 #if defined(__NetBSD__) || defined(__OpenBSD__)
-#include <sys/device.h>
+
 #include <sys/select.h>
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 #include <sys/endian.h>
 #include <sys/module.h>
 #include <sys/bus.h>
@@ -96,7 +96,7 @@
 /* Use bandwidth reclamation for control transfers. Some devices choke on it. */
 /*#define UHCI_CTL_LOOP */
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #include <machine/clock.h>
 
 #define delay(d)		DELAY(d)
diff -ur src.old/sys/dev/usb/uhci_pci.c src/sys/dev/usb/uhci_pci.c
--- src.old/sys/dev/usb/uhci_pci.c	2004-08-02 17:37:35.000000000 +0200
+++ src/sys/dev/usb/uhci_pci.c	2005-04-05 14:14:48.000000000 +0200
@@ -56,7 +56,7 @@
 #include <sys/module.h>
 #include <sys/bus.h>
 #include <sys/queue.h>
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #include <sys/bus.h>
 
 #include <machine/bus.h>
diff -ur src.old/sys/dev/usb/uhcivar.h src/sys/dev/usb/uhcivar.h
--- src.old/sys/dev/usb/uhcivar.h	2004-08-02 17:37:35.000000000 +0200
+++ src/sys/dev/usb/uhcivar.h	2005-04-05 14:14:48.000000000 +0200
@@ -139,7 +139,7 @@
 	bus_space_tag_t iot;
 	bus_space_handle_t ioh;
 	bus_size_t sc_size;
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	void *ih;
 
 	struct resource *io_res;
diff -ur src.old/sys/dev/usb/uhid.c src/sys/dev/usb/uhid.c
--- src.old/sys/dev/usb/uhid.c	2004-10-13 02:51:01.000000000 +0200
+++ src/sys/dev/usb/uhid.c	2005-04-05 14:14:48.000000000 +0200
@@ -58,10 +58,10 @@
 #endif
 #include <sys/signalvar.h>
 #if defined(__NetBSD__) || defined(__OpenBSD__)
-#include <sys/device.h>
+
 #include <sys/ioctl.h>
 #include <sys/file.h>
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 #include <sys/ioccom.h>
 #include <sys/filio.h>
 #include <sys/module.h>
@@ -135,7 +135,7 @@
 	int sc_refcnt;
 	u_char sc_dying;
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	struct cdev *dev;
 #endif
 };
@@ -146,7 +146,7 @@
 
 #if defined(__NetBSD__) || defined(__OpenBSD__)
 cdev_decl(uhid);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 d_open_t	uhidopen;
 d_close_t	uhidclose;
 d_read_t	uhidread;
@@ -274,7 +274,7 @@
 	sc->sc_repdesc = desc;
 	sc->sc_repdesc_size = size;
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	sc->dev = make_dev(&uhid_cdevsw, device_get_unit(self),
 			UID_ROOT, GID_OPERATOR,
 			0644, "uhid%d", device_get_unit(self));
@@ -339,7 +339,7 @@
 	/* Nuke the vnodes for any open instances (calls close). */
 	mn = self->dv_unit;
 	vdevgone(maj, mn, mn, VCHR);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	destroy_dev(sc->dev);
 #endif
 
@@ -751,6 +751,6 @@
 	return (revents);
 }
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 DRIVER_MODULE(uhid, uhub, uhid_driver, uhid_devclass, usbd_driver_load, 0);
 #endif
diff -ur src.old/sys/dev/usb/uhub.c src/sys/dev/usb/uhub.c
--- src.old/sys/dev/usb/uhub.c	2004-09-13 05:00:06.000000000 +0200
+++ src/sys/dev/usb/uhub.c	2005-04-05 14:14:48.000000000 +0200
@@ -49,9 +49,9 @@
 #include <sys/kernel.h>
 #include <sys/malloc.h>
 #if defined(__NetBSD__) || defined(__OpenBSD__)
-#include <sys/device.h>
+
 #include <sys/proc.h>
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 #include <sys/module.h>
 #include <sys/bus.h>
 #endif
@@ -89,7 +89,7 @@
 Static usbd_status uhub_explore(usbd_device_handle hub);
 Static void uhub_intr(usbd_xfer_handle, usbd_private_handle,usbd_status);
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 Static bus_child_location_str_t uhub_child_location_str;
 Static bus_child_pnpinfo_str_t uhub_child_pnpinfo_str;
 #endif
@@ -107,7 +107,7 @@
 /* Create the driver instance for the hub connected to hub case */
 CFATTACH_DECL(uhub_uhub, sizeof(struct uhub_softc),
     uhub_match, uhub_attach, uhub_detach, uhub_activate);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 USB_DECLARE_DRIVER_INIT(uhub,
 	DEVMETHOD(bus_child_pnpinfo_str, uhub_child_pnpinfo_str),
 	DEVMETHOD(bus_child_location_str, uhub_child_location_str),
@@ -554,7 +554,7 @@
 
 #if defined(__NetBSD__) || defined(__OpenBSD__)
 	DPRINTF(("uhub_detach: sc=%p flags=%d\n", sc, flags));
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	DPRINTF(("uhub_detach: sc=%port\n", sc));
 #endif
 
@@ -580,7 +580,7 @@
 	return (0);
 }
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 int
 uhub_child_location_str(device_t cbdev, device_t child, char *buf,
     size_t buflen)
@@ -702,7 +702,7 @@
 		usb_needs_explore(sc->sc_hub);
 }
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 DRIVER_MODULE(uhub, usb, uhubroot_driver, uhubroot_devclass, 0, 0);
 DRIVER_MODULE(uhub, uhub, uhub_driver, uhub_devclass, usbd_driver_load, 0);
 #endif
diff -ur src.old/sys/dev/usb/ulpt.c src/sys/dev/usb/ulpt.c
--- src.old/sys/dev/usb/ulpt.c	2004-08-16 01:39:18.000000000 +0200
+++ src/sys/dev/usb/ulpt.c	2005-04-05 14:14:48.000000000 +0200
@@ -50,9 +50,9 @@
 #include <sys/kernel.h>
 #include <sys/fcntl.h>
 #if defined(__NetBSD__) || defined(__OpenBSD__)
-#include <sys/device.h>
+
 #include <sys/ioctl.h>
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 #include <sys/ioccom.h>
 #include <sys/module.h>
 #include <sys/bus.h>
@@ -129,7 +129,7 @@
 	int sc_refcnt;
 	u_char sc_dying;
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	struct cdev *dev;
 	struct cdev *dev_noprime;
 #endif
@@ -148,7 +148,7 @@
 };
 #elif defined(__OpenBSD__)
 cdev_decl(ulpt);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 Static d_open_t ulptopen;
 Static d_close_t ulptclose;
 Static d_write_t ulptwrite;
@@ -350,7 +350,7 @@
 	}
 #endif
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	sc->dev = make_dev(&ulpt_cdevsw, device_get_unit(self),
 		UID_ROOT, GID_OPERATOR, 0644, "ulpt%d", device_get_unit(self));
 	sc->dev_noprime = make_dev(&ulpt_cdevsw,
@@ -392,7 +392,7 @@
 
 #if defined(__NetBSD__) || defined(__OpenBSD__)
 	DPRINTF(("ulpt_detach: sc=%p flags=%d\n", sc, flags));
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	DPRINTF(("ulpt_detach: sc=%p\n", sc));
 #endif
 
@@ -423,7 +423,7 @@
 	/* Nuke the vnodes for any open instances (calls close). */
 	mn = self->dv_unit;
 	vdevgone(maj, mn, mn, VCHR);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	destroy_dev(sc->dev);
 	destroy_dev(sc->dev_noprime);
 #endif
@@ -523,7 +523,7 @@
 	sc->sc_flags = flags;
 	DPRINTF(("ulptopen: flags=0x%x\n", (unsigned)flags));
 
-#if defined(USB_DEBUG) && defined(__FreeBSD__)
+#if defined(USB_DEBUG) && defined(__FreeBSD_kernel__)
 	/* Ignoring these flags might not be a good idea */
 	if ((flags & ~ULPT_NOPRIME) != 0)
 		printf("ulptopen: flags ignored: %b\n", flags,
@@ -876,6 +876,6 @@
 }
 #endif
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 DRIVER_MODULE(ulpt, uhub, ulpt_driver, ulpt_devclass, usbd_driver_load, 0);
 #endif
diff -ur src.old/sys/dev/usb/umass.c src/sys/dev/usb/umass.c
--- src.old/sys/dev/usb/umass.c	2004-09-20 07:28:08.000000000 +0200
+++ src/sys/dev/usb/umass.c	2005-04-05 14:14:49.000000000 +0200
@@ -715,7 +715,7 @@
 				int buflen, int printlen);
 #endif
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 MODULE_DEPEND(umass, cam, 1,1,1);
 #endif
 
diff -ur src.old/sys/dev/usb/ums.c src/sys/dev/usb/ums.c
--- src.old/sys/dev/usb/ums.c	2004-08-16 01:39:18.000000000 +0200
+++ src/sys/dev/usb/ums.c	2005-04-05 14:14:49.000000000 +0200
@@ -346,7 +346,7 @@
 	sc->status.button = sc->status.obutton = 0;
 	sc->status.dx = sc->status.dy = sc->status.dz = 0;
 
-#ifndef __FreeBSD__
+#ifndef __FreeBSD_kernel__
 	sc->rsel.si_flags = 0;
 	sc->rsel.si_pid = 0;
 #endif
diff -ur src.old/sys/dev/usb/urio.c src/sys/dev/usb/urio.c
--- src.old/sys/dev/usb/urio.c	2004-08-16 01:39:18.000000000 +0200
+++ src/sys/dev/usb/urio.c	2005-04-05 14:14:49.000000000 +0200
@@ -49,9 +49,9 @@
 #include <sys/kernel.h>
 #include <sys/malloc.h>
 #if defined(__NetBSD__)
-#include <sys/device.h>
+
 #include <sys/ioctl.h>
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 #include <sys/module.h>
 #include <sys/bus.h>
 #include <sys/ioccom.h>
@@ -108,7 +108,7 @@
 #define RIO_UE_GET_DIR(p) ((UE_GET_DIR(p) == UE_DIR_IN) ? RIO_IN :\
 			  ((UE_GET_DIR(p) == UE_DIR_OUT) ? RIO_OUT :\
 							   RIO_NODIR))
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 d_open_t  urioopen;
 d_close_t urioclose;
 d_read_t  urioread;
@@ -132,7 +132,7 @@
 #define RIO_UE_GET_DIR(p) ((UE_GET_DIR(p) == UE_DIR_IN) ? RIO_IN :\
 		 	  ((UE_GET_DIR(p) == UE_DIR_OUT) ? RIO_OUT :\
 			    				   RIO_NODIR))
-#endif  /*defined(__FreeBSD__)*/
+#endif  /*defined(__FreeBSD_kernel__)*/
 
 #define	URIO_BBSIZE	1024
 
@@ -147,9 +147,9 @@
 	int sc_epaddr[2];
 
 	int sc_refcnt;
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	struct cdev *sc_dev_t;
-#endif	/* defined(__FreeBSD__) */
+#endif	/* defined(__FreeBSD_kernel__) */
 #if defined(__NetBSD__) || defined(__OpenBSD__)
 	u_char sc_dying;
 #endif
@@ -203,7 +203,7 @@
 
 	sc->sc_udev = udev = uaa->device;
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
  	if ((!uaa->device) || (!uaa->iface)) {
 		ermsg = "device or iface";
  		goto nobulk;
@@ -260,7 +260,7 @@
 		goto nobulk;
 	}
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	/* XXX no error trapping, no storing of struct cdev **/
 	sc->sc_dev_t = make_dev(&urio_cdevsw, device_get_unit(self),
 			UID_ROOT, GID_OPERATOR,
@@ -613,7 +613,7 @@
 	int maj, mn;
 
 	DPRINTF(("urio_detach: sc=%p flags=%d\n", sc, flags));
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	DPRINTF(("urio_detach: sc=%p\n", sc));
 #endif
 
@@ -670,7 +670,7 @@
 }
 #endif /* defined(__NetBSD__) || defined(__OpenBSD__) */
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 Static int
 urio_detach(device_t self)
 {
diff -ur src.old/sys/dev/usb/usb.c src/sys/dev/usb/usb.c
--- src.old/sys/dev/usb/usb.c	2004-08-02 17:37:35.000000000 +0200
+++ src/sys/dev/usb/usb.c	2005-04-05 14:14:49.000000000 +0200
@@ -62,8 +62,8 @@
 #include <sys/mutex.h>
 #endif
 #if defined(__NetBSD__) || defined(__OpenBSD__)
-#include <sys/device.h>
-#elif defined(__FreeBSD__)
+
+#elif defined(__FreeBSD_kernel__)
 #include <sys/unistd.h>
 #include <sys/module.h>
 #include <sys/bus.h>
@@ -90,13 +90,13 @@
 #define USBUNIT(d)	(minor(d))	/* usb_discover device nodes, kthread */
 #define USB_DEV_MINOR	255		/* event queue device */
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 MALLOC_DEFINE(M_USB, "USB", "USB");
 MALLOC_DEFINE(M_USBDEV, "USBdev", "USB device");
 MALLOC_DEFINE(M_USBHC, "USBHC", "USB host controller");
 
 #include "usb_if.h"
-#endif /* defined(__FreeBSD__) */
+#endif /* defined(__FreeBSD_kernel__) */
 
 #include <machine/bus.h>
 
@@ -127,7 +127,7 @@
 
 struct usb_softc {
 	USBBASEDEVICE	sc_dev;		/* base device */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct cdev	*sc_usbdev;	/* /dev/usbN device */
 #endif
 	usbd_bus_handle sc_bus;		/* USB controller */
@@ -142,7 +142,7 @@
 
 #if defined(__NetBSD__) || defined(__OpenBSD__)
 cdev_decl(usb);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 d_open_t  usbopen;
 d_close_t usbclose;
 d_read_t usbread;
@@ -165,7 +165,7 @@
 #endif
 
 Static void	usb_discover(void *);
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 Static bus_child_detached_t usb_child_detached;
 #endif
 Static void	usb_create_event_thread(void *);
@@ -173,7 +173,7 @@
 Static void	usb_task_thread(void *);
 Static struct proc *usb_task_thread_proc = NULL;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 Static struct cdev *usb_dev;		/* The /dev/usb device. */
 Static int usb_ndevs;			/* Number of /dev/usbN devices. */
 Static int usb_taskcreated;		/* USB task thread exists. */
@@ -203,7 +203,7 @@
 			DEVMETHOD(device_shutdown, bus_generic_shutdown)
 			);
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 MODULE_VERSION(usb, 1);
 #endif
 
@@ -217,7 +217,7 @@
 {
 #if defined(__NetBSD__) || defined(__OpenBSD__)
 	struct usb_softc *sc = (struct usb_softc *)self;
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	struct usb_softc *sc = device_get_softc(self);
 	void *aux = device_get_ivars(self);
 #endif
@@ -236,7 +236,7 @@
 	sc->sc_bus->usbctl = sc;
 	sc->sc_port.power = USB_MAX_POWER;
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	printf("%s", USBDEVNAME(sc->sc_dev));
 #endif
 	usbrev = sc->sc_bus->usbrev;
@@ -295,7 +295,7 @@
 		 * until the USB event thread is running, which means that
 		 * the keyboard will not work until after cold boot.
 		 */
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 		if (cold)
 #else
 		if (cold && (sc->sc_dev.dv_cfdata->cf_flags & 1))
@@ -315,7 +315,7 @@
 	usb_kthread_create(usb_create_event_thread, sc);
 #endif
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	usb_create_event_thread(sc);
 	/* The per controller devices (used for usb_discover) */
 	/* XXX This is redundant now, but old usbd's will want it */
@@ -393,7 +393,7 @@
 {
 	struct usb_softc *sc = arg;
 
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500000
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500000
 	mtx_lock(&Giant);
 #endif
 
@@ -443,7 +443,7 @@
 	struct usb_task *task;
 	int s;
 
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500000
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500000
 	mtx_lock(&Giant);
 #endif
 
@@ -589,7 +589,7 @@
 		return (EIO);
 
 	switch (cmd) {
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	/* This part should be deleted */
   	case USB_DISCOVER:
   		break;
@@ -694,7 +694,7 @@
 
 		return (revents);
 	} else {
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 		return (0);	/* select/poll never wakes up - back compat */
 #else
 		return (ENXIO);
@@ -708,7 +708,7 @@
 {
 	struct usb_softc *sc = v;
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	/* splxxx should be changed to mutexes for preemption safety some day */
 	int s;
 #endif
@@ -724,20 +724,20 @@
 	 * but this is guaranteed since this function is only called
 	 * from the event thread for the controller.
 	 */
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	s = splusb();
 #endif
 	while (sc->sc_bus->needs_explore && !sc->sc_dying) {
 		sc->sc_bus->needs_explore = 0;
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 		splx(s);
 #endif
 		sc->sc_bus->root_hub->hub->explore(sc->sc_bus->root_hub);
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 		s = splusb();
 #endif
 	}
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	splx(s);
 #endif
 }
@@ -906,7 +906,7 @@
 		DPRINTF(("usb_detach: event thread dead\n"));
 	}
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	destroy_dev(sc->sc_usbdev);
 	if (--usb_ndevs == 0) {
 		destroy_dev(usb_dev);
@@ -936,7 +936,7 @@
 	return (0);
 }
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 Static void
 usb_child_detached(device_t self, device_t child)
 {
diff -ur src.old/sys/dev/usb/usb.h src/sys/dev/usb/usb.h
--- src.old/sys/dev/usb/usb.h	2002-11-06 22:37:21.000000000 +0100
+++ src/sys/dev/usb/usb.h	2005-04-05 14:14:49.000000000 +0200
@@ -98,7 +98,7 @@
 #define USETDW(w,v) (*(u_int32_t *)(w) = (v))
 #endif
 
-#if defined(__FreeBSD__) && (__FreeBSD_version <= 500014)
+#if defined(__FreeBSD_kernel__) && (__FreeBSD_version <= 500014)
 #define UPACKED __attribute__ ((packed))
 #else
 #define UPACKED __packed
diff -ur src.old/sys/dev/usb/usb_mem.c src/sys/dev/usb/usb_mem.c
--- src.old/sys/dev/usb/usb_mem.c	2004-08-02 15:59:02.000000000 +0200
+++ src/sys/dev/usb/usb_mem.c	2005-04-05 14:14:49.000000000 +0200
@@ -53,9 +53,9 @@
 #include <sys/malloc.h>
 #include <sys/kernel.h>
 #if defined(__NetBSD__) || defined(__OpenBSD__)
-#include <sys/device.h>		/* for usbdivar.h */
+		/* for usbdivar.h */
 #include <machine/bus.h>
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 #include <sys/endian.h>
 #include <sys/module.h>
 #include <sys/bus.h>
diff -ur src.old/sys/dev/usb/usb_mem.h src/sys/dev/usb/usb_mem.h
--- src.old/sys/dev/usb/usb_mem.h	2003-09-01 03:07:24.000000000 +0200
+++ src/sys/dev/usb/usb_mem.h	2005-04-05 14:14:49.000000000 +0200
@@ -41,7 +41,7 @@
 typedef struct usb_dma_block {
 	bus_dma_tag_t tag;
 	bus_dmamap_t map;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	void *kaddr;
 #else
         caddr_t kaddr;
@@ -54,7 +54,7 @@
 	LIST_ENTRY(usb_dma_block) next;
 } usb_dma_block_t;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define DMAADDR(dma, o) ((dma)->block->segs[0].ds_addr + (dma)->offs + (o))
 #else
 #define DMAADDR(dma, o) (((char *)(dma)->block->map->dm_segs[0].ds_addr) + (dma)->offs + (o))
diff -ur src.old/sys/dev/usb/usb_port.h src/sys/dev/usb/usb_port.h
--- src.old/sys/dev/usb/usb_port.h	2004-09-26 07:54:28.000000000 +0200
+++ src/sys/dev/usb/usb_port.h	2005-04-05 14:14:50.000000000 +0200
@@ -328,7 +328,7 @@
 #define USB_DO_ATTACH(dev, bdev, parent, args, print, sub) \
 	(config_found_sm(parent, args, print, sub))
 
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 /*
  * FreeBSD
  */
@@ -524,7 +524,7 @@
 SYSCTL_DECL(_hw_usb);
 #endif
 
-#endif /* __FreeBSD__ */
+#endif /* 5 */
 
 #endif /* _USB_PORT_H */
 
diff -ur src.old/sys/dev/usb/usb_subr.c src/sys/dev/usb/usb_subr.c
--- src.old/sys/dev/usb/usb_subr.c	2004-09-13 05:01:56.000000000 +0200
+++ src/sys/dev/usb/usb_subr.c	2005-04-05 14:14:50.000000000 +0200
@@ -54,9 +54,9 @@
 #include <sys/kernel.h>
 #include <sys/malloc.h>
 #if defined(__NetBSD__) || defined(__OpenBSD__)
-#include <sys/device.h>
+
 #include <sys/select.h>
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 #include <sys/module.h>
 #include <sys/bus.h>
 #endif
@@ -72,7 +72,7 @@
 #include "usbdevs.h"
 #include <dev/usb/usb_quirks.h>
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #include <machine/clock.h>
 #define delay(d)         DELAY(d)
 #endif
@@ -862,7 +862,7 @@
 	device_ptr_t *tmpdv;
 	usbd_interface_handle ifaces[256]; /* 256 is the absolute max */
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	/* XXX FreeBSD may leak resources on failure cases -- fixme */
  	device_t bdev;
 	struct usb_attach_arg *uaap;
@@ -964,7 +964,7 @@
 				ifaces[i] = 0; /* consumed */
 				found++;
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 				/* create another child for the next iface */
 				bdev = device_add_child(parent, NULL, -1);
 				if (!bdev) {
@@ -984,7 +984,7 @@
 			}
 		}
 		if (found != 0) {
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 			/* remove the last created child.  It is unused */
 			device_delete_child(parent, bdev);
 			/* free(uaap, M_USB); */ /* May be needed? xxx */
diff -ur src.old/sys/dev/usb/usbdi.c src/sys/dev/usb/usbdi.c
--- src.old/sys/dev/usb/usbdi.c	2004-09-03 22:01:32.000000000 +0200
+++ src/sys/dev/usb/usbdi.c	2005-04-05 14:14:50.000000000 +0200
@@ -43,8 +43,8 @@
 #include <sys/param.h>
 #include <sys/systm.h>
 #if defined(__NetBSD__) || defined(__OpenBSD__)
-#include <sys/device.h>
-#elif defined(__FreeBSD__)
+
+#elif defined(__FreeBSD_kernel__)
 #include <sys/module.h>
 #include <sys/bus.h>
 #include "usb_if.h"
@@ -63,7 +63,7 @@
 #include <dev/usb/usbdivar.h>
 #include <dev/usb/usb_mem.h>
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #include "usb_if.h"
 #include <machine/clock.h>
 #define delay(d)	DELAY(d)
@@ -945,7 +945,7 @@
 	usbd_status err;
 
 #ifdef DIAGNOSTIC
-#if defined(__i386__) && defined(__FreeBSD__)
+#if defined(__i386__) && defined(__FreeBSD_kernel__)
 	KASSERT(curthread->td_intr_nesting_level == 0,
 	       	("usbd_do_request: in interrupt context"));
 #endif
@@ -1142,7 +1142,7 @@
 	return (NULL);
 }
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 int
 usbd_driver_load(module_t mod, int what, void *arg)
 {
diff -ur src.old/sys/dev/usb/usbdi.h src/sys/dev/usb/usbdi.h
--- src.old/sys/dev/usb/usbdi.h	2004-08-16 01:39:18.000000000 +0200
+++ src/sys/dev/usb/usbdi.h	2005-04-05 14:14:50.000000000 +0200
@@ -88,7 +88,7 @@
 #define USBD_NO_TIMEOUT 0
 #define USBD_DEFAULT_TIMEOUT 5000 /* ms = 5 s */
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #endif
 
 usbd_status usbd_open_pipe(usbd_interface_handle iface, u_int8_t address,
@@ -243,7 +243,7 @@
 /* No match */
 #define UMATCH_NONE					 0
 
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 /* FreeBSD needs values less than zero */
 #define UMATCH_VENDOR_PRODUCT_REV			(-10)
 #define UMATCH_VENDOR_PRODUCT				(-20)
@@ -266,7 +266,7 @@
 #define USBD_SHOW_DEVICE_CLASS		0x1
 #define USBD_SHOW_INTERFACE_CLASS	0x2
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 int usbd_driver_load(module_t mod, int what, void *arg);
 #endif
 
diff -ur src.old/sys/dev/usb/usbdi_util.c src/sys/dev/usb/usbdi_util.c
--- src.old/sys/dev/usb/usbdi_util.c	2004-05-30 22:08:45.000000000 +0200
+++ src/sys/dev/usb/usbdi_util.c	2005-04-05 14:14:50.000000000 +0200
@@ -47,8 +47,8 @@
 #include <sys/malloc.h>
 #if defined(__NetBSD__) || defined(__OpenBSD__)
 #include <sys/proc.h>
-#include <sys/device.h>
-#elif defined(__FreeBSD__)
+
+#elif defined(__FreeBSD_kernel__)
 #include <sys/bus.h>
 #endif
 
diff -ur src.old/sys/dev/usb/usbdivar.h src/sys/dev/usb/usbdivar.h
--- src.old/sys/dev/usb/usbdivar.h	2004-06-30 04:56:24.000000000 +0200
+++ src/sys/dev/usb/usbdivar.h	2005-04-05 14:14:50.000000000 +0200
@@ -277,7 +277,7 @@
 
 #if defined(__NetBSD__)
 #include "locators.h"
-#elif defined(__FreeBSD__) || defined(__OpenBSD__)
+#elif defined(__FreeBSD_kernel__) || defined(__OpenBSD__)
 /* XXX these values are used to statically bind some elements in the USB tree
  * to specific driver instances. This should be somehow emulated in FreeBSD
  * but can be done later on.
diff -ur src.old/sys/dev/usb/uscanner.c src/sys/dev/usb/uscanner.c
--- src.old/sys/dev/usb/uscanner.c	2004-09-20 07:03:28.000000000 +0200
+++ src/sys/dev/usb/uscanner.c	2005-04-05 14:14:50.000000000 +0200
@@ -51,8 +51,8 @@
 #include <sys/kernel.h>
 #include <sys/malloc.h>
 #if defined(__NetBSD__) || defined(__OpenBSD__)
-#include <sys/device.h>
-#elif defined(__FreeBSD__)
+
+#elif defined(__FreeBSD_kernel__)
 #include <sys/module.h>
 #include <sys/bus.h>
 #include <sys/conf.h>
@@ -234,7 +234,7 @@
 	USBBASEDEVICE		sc_dev;		/* base device */
 	usbd_device_handle	sc_udev;
 	usbd_interface_handle	sc_iface;
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	struct cdev *dev;
 #endif
 
@@ -263,7 +263,7 @@
 
 #if defined(__NetBSD__) || defined(__OpenBSD__)
 cdev_decl(uscanner);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 d_open_t  uscanneropen;
 d_close_t uscannerclose;
 d_read_t  uscannerread;
@@ -369,7 +369,7 @@
 	sc->sc_bulkin = ed_bulkin->bEndpointAddress;
 	sc->sc_bulkout = ed_bulkout->bEndpointAddress;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	/* the main device, ctrl endpoint */
 	sc->dev = make_dev(&uscanner_cdevsw, USBDEVUNIT(sc->sc_dev),
 		UID_ROOT, GID_OPERATOR, 0644, "%s", USBDEVNAME(sc->sc_dev));
@@ -635,7 +635,7 @@
 
 #if defined(__NetBSD__) || defined(__OpenBSD__)
 	DPRINTF(("uscanner_detach: sc=%p flags=%d\n", sc, flags));
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	DPRINTF(("uscanner_detach: sc=%p\n", sc));
 #endif
 
@@ -664,7 +664,7 @@
 	/* Nuke the vnodes for any open instances (calls close). */
 	mn = self->dv_unit * USB_MAX_ENDPOINTS;
 	vdevgone(maj, mn, mn + USB_MAX_ENDPOINTS - 1, VCHR);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	/* destroy the device for the control endpoint */
 	destroy_dev(sc->dev);
 #endif
@@ -697,6 +697,6 @@
 	return (revents);
 }
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 DRIVER_MODULE(uscanner, uhub, uscanner_driver, uscanner_devclass, usbd_driver_load, 0);
 #endif
diff -ur src.old/sys/dev/usb/uvisor.c src/sys/dev/usb/uvisor.c
--- src.old/sys/dev/usb/uvisor.c	2004-06-27 14:41:44.000000000 +0200
+++ src/sys/dev/usb/uvisor.c	2005-04-05 14:14:51.000000000 +0200
@@ -59,8 +59,8 @@
 #include <sys/systm.h>
 #include <sys/kernel.h>
 #if defined(__NetBSD__) || defined(__OpenBSD__)
-#include <sys/device.h>
-#elif defined(__FreeBSD__)
+
+#elif defined(__FreeBSD_kernel__)
 #include <sys/module.h>
 #include <sys/bus.h>
 #endif
diff -ur src.old/sys/dev/usb/uvscom.c src/sys/dev/usb/uvscom.c
--- src.old/sys/dev/usb/uvscom.c	2004-06-27 14:41:44.000000000 +0200
+++ src/sys/dev/usb/uvscom.c	2005-04-05 14:14:51.000000000 +0200
@@ -47,7 +47,7 @@
 #include <sys/conf.h>
 #include <sys/tty.h>
 #include <sys/file.h>
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #include <sys/bus.h>
 #include <sys/ioccom.h>
 #if __FreeBSD_version >= 500014
@@ -57,7 +57,7 @@
 #endif
 #else
 #include <sys/ioctl.h>
-#include <sys/device.h>
+
 #endif
 #include <sys/proc.h>
 #include <sys/poll.h>
diff -ur src.old/sys/dev/wi/if_wireg.h src/sys/dev/wi/if_wireg.h
--- src.old/sys/dev/wi/if_wireg.h	2003-12-28 07:58:52.000000000 +0100
+++ src/sys/dev/wi/if_wireg.h	2005-04-05 14:14:55.000000000 +0200
@@ -83,7 +83,7 @@
 #ifdef __NetBSD__
 #define OS_STRING_NAME	"NetBSD"
 #endif
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define OS_STRING_NAME	"FreeBSD"
 #endif
 #ifdef __OpenBSD__
diff -ur src.old/sys/gnu/ext2fs/ext2_fs.h src/sys/gnu/ext2fs/ext2_fs.h
--- src.old/sys/gnu/ext2fs/ext2_fs.h	2004-02-18 15:08:25.000000000 +0100
+++ src/sys/gnu/ext2fs/ext2_fs.h	2005-04-05 14:15:16.000000000 +0200
@@ -108,7 +108,7 @@
 #define EXT2_MIN_BLOCK_SIZE		1024
 #define	EXT2_MAX_BLOCK_SIZE		4096
 #define EXT2_MIN_BLOCK_LOG_SIZE		  10
-#if defined(__KERNEL__) || (defined(__FreeBSD__) && defined(_KERNEL))
+#if defined(__KERNEL__) || (defined(__FreeBSD_kernel__) && defined(_KERNEL))
 # define EXT2_BLOCK_SIZE(s)		((s)->s_blocksize)
 #else
 # define EXT2_BLOCK_SIZE(s)		(EXT2_MIN_BLOCK_SIZE << (s)->s_log_block_size)
@@ -150,7 +150,7 @@
 # define EXT2_FRAG_SIZE(s)		((s)->u.ext2_sb.s_frag_size)
 # define EXT2_FRAGS_PER_BLOCK(s)	((s)->u.ext2_sb.s_frags_per_block)
 #else
-# if defined(_KERNEL) && defined(__FreeBSD__)
+# if defined(_KERNEL) && defined(__FreeBSD_kernel__)
 # define EXT2_FRAG_SIZE(s)		((s)->s_frag_size)
 # else
 # define EXT2_FRAG_SIZE(s)		(EXT2_MIN_FRAG_SIZE << (s)->s_log_frag_size)
diff -ur src.old/sys/i4b/include/i4b_global.h src/sys/i4b/include/i4b_global.h
--- src.old/sys/i4b/include/i4b_global.h	2004-07-15 10:26:05.000000000 +0200
+++ src/sys/i4b/include/i4b_global.h	2005-04-05 14:15:40.000000000 +0200
@@ -40,7 +40,7 @@
  *	hiding OS differences in the kernel
  *---------------------------------------------------------------------------*/ 
 
-#if defined(__FreeBSD__) && __FreeBSD__ >= 5
+#if defined(__FreeBSD_kernel__) && 5 >= 5
 /*
  * Deprecated LKM interface.
  */
diff -ur src.old/sys/i4b/layer1/ifpi/i4b_ifpi_pci.c src/sys/i4b/layer1/ifpi/i4b_ifpi_pci.c
--- src.old/sys/i4b/layer1/ifpi/i4b_ifpi_pci.c	2004-03-17 18:50:49.000000000 +0100
+++ src/sys/i4b/layer1/ifpi/i4b_ifpi_pci.c	2005-04-05 14:15:41.000000000 +0200
@@ -642,7 +642,7 @@
 	/* init the ISAC */
 	ifpi_isac_init(sc);
 
-#if defined (__FreeBSD__) && __FreeBSD__ > 4
+#if defined(__FreeBSD_kernel__) && 5 > 4
 	/* Init the channel mutexes */
 	chan = &sc->sc_chan[HSCX_CH_A];
 	if(!mtx_initialized(&chan->rx_queue.ifq_mtx))
@@ -682,7 +682,7 @@
 	sc->sc_obuf2 = NULL;
 	sc->sc_freeflag2 = 0;
 
-#if defined(__FreeBSD__) && __FreeBSD__ >=3
+#if defined(__FreeBSD_kernel__) && 5 >=3
 	callout_handle_init(&sc->sc_T3_callout);
 	callout_handle_init(&sc->sc_T4_callout);	
 #endif
@@ -872,7 +872,7 @@
 				
 					  /* move rx'd data to rx queue */
 
-#if defined (__FreeBSD__) && __FreeBSD__ > 4
+#if defined(__FreeBSD_kernel__) && 5 > 4
 					  (void) IF_HANDOFF(&chan->rx_queue, chan->in_mbuf, NULL);
 #else
 					  if(!(IF_QFULL(&chan->rx_queue)))
@@ -1108,7 +1108,7 @@
 static void
 avma1pp_bchannel_setup(int unit, int h_chan, int bprot, int activate)
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct l1_softc *sc = ifpi_scp[unit];
 #else
 	struct l1_softc *sc = isic_find_sc(unit);
@@ -1176,7 +1176,7 @@
 static void
 avma1pp_bchannel_start(int unit, int h_chan)
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct l1_softc *sc = ifpi_scp[unit];
 #else
 	struct l1_softc *sc = isic_find_sc(unit);
@@ -1249,7 +1249,7 @@
 static isdn_link_t *
 avma1pp_ret_linktab(int unit, int channel)
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct l1_softc *sc = ifpi_scp[unit];
 #else
 	struct l1_softc *sc = isic_find_sc(unit);
@@ -1265,7 +1265,7 @@
 static void
 avma1pp_set_linktab(int unit, int channel, drvr_link_t *dlt)
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct l1_softc *sc = ifpi_scp[unit];
 #else
 	struct l1_softc *sc = isic_find_sc(unit);
@@ -1330,7 +1330,7 @@
 static void
 avma1pp_bchannel_stat(int unit, int h_chan, bchan_statistics_t *bsp)
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct l1_softc *sc = ifpi_scp[unit];
 #else
 	struct l1_softc *sc = isic_find_sc(unit);
diff -ur src.old/sys/i4b/layer1/ifpi2/i4b_ifpi2_pci.c src/sys/i4b/layer1/ifpi2/i4b_ifpi2_pci.c
--- src.old/sys/i4b/layer1/ifpi2/i4b_ifpi2_pci.c	2004-07-18 22:13:31.000000000 +0200
+++ src/sys/i4b/layer1/ifpi2/i4b_ifpi2_pci.c	2005-04-05 14:15:42.000000000 +0200
@@ -579,7 +579,7 @@
 	/* init the ISAC */
 	ifpi2_isacsx_init(sc);
 
-#if defined (__FreeBSD__) && __FreeBSD__ > 4
+#if defined(__FreeBSD_kernel__) && 5 > 4
 	/* Init the channel mutexes */
 	chan = &sc->sc_chan[HSCX_CH_A];
 	if(!mtx_initialized(&chan->rx_queue.ifq_mtx))
@@ -619,7 +619,7 @@
 	sc->sc_obuf2 = NULL;
 	sc->sc_freeflag2 = 0;
 
-#if defined(__FreeBSD__) && __FreeBSD__ >=3
+#if defined(__FreeBSD_kernel__) && 5 >=3
 	callout_handle_init(&sc->sc_T3_callout);
 	callout_handle_init(&sc->sc_T4_callout);	
 #endif
@@ -809,7 +809,7 @@
 				
 					  /* move rx'd data to rx queue */
 
-#if defined (__FreeBSD__) && __FreeBSD__ > 4
+#if defined(__FreeBSD_kernel__) && 5 > 4
 					  (void) IF_HANDOFF(&chan->rx_queue, chan->in_mbuf, NULL);
 #else
 					  if(!(IF_QFULL(&chan->rx_queue)))
@@ -1055,7 +1055,7 @@
 static void
 avma1pp2_bchannel_setup(int unit, int h_chan, int bprot, int activate)
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct l1_softc *sc = ifpi2_scp[unit];
 #else
 	struct l1_softc *sc = isic_find_sc(unit);
@@ -1123,7 +1123,7 @@
 static void
 avma1pp2_bchannel_start(int unit, int h_chan)
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct l1_softc *sc = ifpi2_scp[unit];
 #else
 	struct l1_softc *sc = isic_find_sc(unit);
@@ -1196,7 +1196,7 @@
 static isdn_link_t *
 avma1pp2_ret_linktab(int unit, int channel)
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct l1_softc *sc = ifpi2_scp[unit];
 #else
 	struct l1_softc *sc = isic_find_sc(unit);
@@ -1212,7 +1212,7 @@
 static void
 avma1pp2_set_linktab(int unit, int channel, drvr_link_t *dlt)
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct l1_softc *sc = ifpi2_scp[unit];
 #else
 	struct l1_softc *sc = isic_find_sc(unit);
@@ -1277,7 +1277,7 @@
 static void
 avma1pp2_bchannel_stat(int unit, int h_chan, bchan_statistics_t *bsp)
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct l1_softc *sc = ifpi2_scp[unit];
 #else
 	struct l1_softc *sc = isic_find_sc(unit);
diff -ur src.old/sys/i4b/layer1/ifpnp/i4b_ifpnp_avm.c src/sys/i4b/layer1/ifpnp/i4b_ifpnp_avm.c
--- src.old/sys/i4b/layer1/ifpnp/i4b_ifpnp_avm.c	2004-03-17 18:50:50.000000000 +0100
+++ src/sys/i4b/layer1/ifpnp/i4b_ifpnp_avm.c	2005-04-05 14:15:42.000000000 +0200
@@ -792,7 +792,7 @@
 						 activity = ACT_RX;
 				
 					  /* move rx'd data to rx queue */
-#if defined (__FreeBSD__) && __FreeBSD__ > 4
+#if defined(__FreeBSD_kernel__) && 5 > 4
 					  (void) IF_HANDOFF(&chan->rx_queue, chan->in_mbuf, NULL);
 #else
 					  if(!(IF_QFULL(&chan->rx_queue)))
@@ -1042,7 +1042,7 @@
 
 	chan->rx_queue.ifq_maxlen = IFQ_MAXLEN;
 
-#if defined (__FreeBSD__) && __FreeBSD__ > 4
+#if defined(__FreeBSD_kernel__) && 5 > 4
 	if(!mtx_initialized(&chan->rx_queue.ifq_mtx))
 		mtx_init(&chan->rx_queue.ifq_mtx, "i4b_avm_pnp_rx", NULL, MTX_DEF);
 #endif
@@ -1061,7 +1061,7 @@
 
 	chan->tx_queue.ifq_maxlen = IFQ_MAXLEN;
 
-#if defined (__FreeBSD__) && __FreeBSD__ > 4
+#if defined(__FreeBSD_kernel__) && 5 > 4
 	if(!mtx_initialized(&chan->tx_queue.ifq_mtx))
 		mtx_init(&chan->tx_queue.ifq_mtx, "i4b_avm_pnp_tx", NULL, MTX_DEF);
 #endif
diff -ur src.old/sys/i4b/layer1/ihfc/i4b_ihfc_drv.c src/sys/i4b/layer1/ihfc/i4b_ihfc_drv.c
--- src.old/sys/i4b/layer1/ihfc/i4b_ihfc_drv.c	2003-06-11 01:39:45.000000000 +0200
+++ src/sys/i4b/layer1/ihfc/i4b_ihfc_drv.c	2005-04-05 14:15:43.000000000 +0200
@@ -355,7 +355,7 @@
 
 			S_IFQUEUE.ifq_maxlen = IFQ_MAXLEN;
 
-#if defined (__FreeBSD__) && __FreeBSD__ > 4
+#if defined(__FreeBSD_kernel__) && 5 > 4
 			if(!mtx_initialized(&S_IFQUEUE.ifq_mtx))
 				mtx_init(&S_IFQUEUE.ifq_mtx, "i4b_ihfc", NULL, MTX_DEF);
 #endif
@@ -381,7 +381,7 @@
 
 			S_IFQUEUE.ifq_maxlen = IFQ_MAXLEN;
 
-#if defined (__FreeBSD__) && __FreeBSD__ > 4
+#if defined(__FreeBSD_kernel__) && 5 > 4
 			if(!mtx_initialized(&S_IFQUEUE.ifq_mtx))
 				mtx_init(&S_IFQUEUE.ifq_mtx, "i4b_ihfc", NULL, MTX_DEF);
 #endif
diff -ur src.old/sys/i4b/layer1/itjc/i4b_itjc_pci.c src/sys/i4b/layer1/itjc/i4b_itjc_pci.c
--- src.old/sys/i4b/layer1/itjc/i4b_itjc_pci.c	2004-03-17 18:50:50.000000000 +0100
+++ src/sys/i4b/layer1/itjc/i4b_itjc_pci.c	2005-04-05 14:15:46.000000000 +0200
@@ -1729,7 +1729,7 @@
 	sc->sc_obuf2 = NULL;
 	sc->sc_freeflag2 = 0;
 
-#if defined(__FreeBSD__) && __FreeBSD__ >=3
+#if defined(__FreeBSD_kernel__) && 5 >=3
 	callout_handle_init(&sc->sc_T3_callout);
 	callout_handle_init(&sc->sc_T4_callout);	
 #endif
@@ -1829,7 +1829,7 @@
 static void
 itjc_bchannel_setup(int unit, int h_chan, int bprot, int activate)
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct l1_softc		*sc	= itjc_scp[unit];
 #else
 	struct l1_softc		*sc	= isic_find_sc(unit);
@@ -1920,7 +1920,7 @@
 	 * But, don't despair. The impact of it is unnoticeable.
 	 */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct l1_softc  *sc	= itjc_scp[unit];
 #else
 	struct l1_softc	 *sc	= isic_find_sc(unit);
@@ -1980,7 +1980,7 @@
 isdn_link_t *
 itjc_ret_linktab(int unit, int channel)
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct l1_softc		*sc = itjc_scp[unit];
 #else
 	struct l1_softc		*sc = isic_find_sc(unit);
@@ -1996,7 +1996,7 @@
 void
 itjc_set_linktab(int unit, int channel, drvr_link_t *dlt)
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct l1_softc *sc	= itjc_scp[unit];
 #else
 	struct l1_softc *sc	= isic_find_sc(unit);
@@ -2062,7 +2062,7 @@
 static void
 itjc_bchannel_stat(int unit, int h_chan, bchan_statistics_t *bsp)
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct l1_softc *sc = itjc_scp[unit];
 #else
 	struct l1_softc *sc = isic_find_sc(unit);
diff -ur src.old/sys/i4b/layer1/iwic/i4b_iwic_bchan.c src/sys/i4b/layer1/iwic/i4b_iwic_bchan.c
--- src.old/sys/i4b/layer1/iwic/i4b_iwic_bchan.c	2003-06-11 01:48:55.000000000 +0200
+++ src/sys/i4b/layer1/iwic/i4b_iwic_bchan.c	2005-04-05 14:15:46.000000000 +0200
@@ -247,7 +247,7 @@
 				if(!(i4b_l1_bchan_tel_silence(chan->in_mbuf->m_data, chan->in_mbuf->m_len)))
 					activity = ACT_RX;
 
-#if defined (__FreeBSD__) && __FreeBSD__ > 4
+#if defined(__FreeBSD_kernel__) && 5 > 4
 				(void) IF_HANDOFF(&chan->rx_queue, chan->in_mbuf, NULL);
 #else
 				if(!(IF_QFULL(&chan->rx_queue)))
@@ -429,7 +429,7 @@
 
 	chan->rx_queue.ifq_maxlen = IFQ_MAXLEN;
 
-#if defined (__FreeBSD__) && __FreeBSD__ > 4
+#if defined(__FreeBSD_kernel__) && 5 > 4
 	if(!mtx_initialized(&chan->rx_queue.ifq_mtx))
 		mtx_init(&chan->rx_queue.ifq_mtx, "i4b_iwic_rx", NULL, MTX_DEF);
 #endif
@@ -448,7 +448,7 @@
 
 	chan->tx_queue.ifq_maxlen = IFQ_MAXLEN;
 
-#if defined (__FreeBSD__) && __FreeBSD__ > 4	
+#if defined(__FreeBSD_kernel__) && 5 > 4	
 	if(!mtx_initialized(&chan->tx_queue.ifq_mtx))
 		mtx_init(&chan->tx_queue.ifq_mtx, "i4b_iwic_tx", NULL, MTX_DEF);
 #endif
diff -ur src.old/sys/kern/uipc_socket.c src/sys/kern/uipc_socket.c
--- src.old/sys/kern/uipc_socket.c	2004-11-04 02:17:31.000000000 +0100
+++ src/sys/kern/uipc_socket.c	2005-04-05 14:16:16.000000000 +0200
@@ -1976,7 +1976,7 @@
 	}
 }
 
-/* XXX; prepare mbuf for (__FreeBSD__ < 3) routines. */
+/* XXX; prepare mbuf for (5 < 3) routines. */
 int
 soopt_getm(struct sockopt *sopt, struct mbuf **mp)
 {
@@ -2025,7 +2025,7 @@
 	return 0;
 }
 
-/* XXX; copyin sopt data into mbuf chain for (__FreeBSD__ < 3) routines. */
+/* XXX; copyin sopt data into mbuf chain for (5 < 3) routines. */
 int
 soopt_mcopyin(struct sockopt *sopt, struct mbuf *m)
 {
@@ -2054,7 +2054,7 @@
 	return 0;
 }
 
-/* XXX; copyout mbuf chain data into soopt for (__FreeBSD__ < 3) routines. */
+/* XXX; copyout mbuf chain data into soopt for (5 < 3) routines. */
 int
 soopt_mcopyout(struct sockopt *sopt, struct mbuf *m)
 {
diff -ur src.old/sys/net/if_atm.h src/sys/net/if_atm.h
--- src.old/sys/net/if_atm.h	2004-01-26 13:13:11.000000000 +0100
+++ src/sys/net/if_atm.h	2005-04-05 14:18:13.000000000 +0200
@@ -201,7 +201,7 @@
 
 #if defined(__NetBSD__) || defined(__OpenBSD__) || defined(__bsdi__)
 #define	RTALLOC1(A,B)		rtalloc1((A),(B))
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 #define	RTALLOC1(A,B)		rtalloc1((A),(B),0UL)
 #endif
 
diff -ur src.old/sys/net/if_atmsubr.c src/sys/net/if_atmsubr.c
--- src.old/sys/net/if_atmsubr.c	2004-04-25 11:24:51.000000000 +0200
+++ src/sys/net/if_atmsubr.c	2005-04-05 14:18:13.000000000 +0200
@@ -183,11 +183,11 @@
 			break;
 			
 		default:
-#if (defined(__FreeBSD__) && __FreeBSD_version >= 501113) || \
+#if (defined(__FreeBSD_kernel__) && __FreeBSD_version >= 501113) || \
     defined(__NetBSD__) || defined(__OpenBSD__)
 			printf("%s: can't handle af%d\n", ifp->if_xname, 
 			    dst->sa_family);
-#elif defined(__FreeBSD__) || defined(__bsdi__)
+#elif defined(__FreeBSD_kernel__) || defined(__bsdi__)
 			printf("%s%d: can't handle af%d\n", ifp->if_name, 
 			    ifp->if_unit, dst->sa_family);
 #endif
@@ -306,12 +306,12 @@
 				return; /* failed */
 			alc = mtod(m, struct atmllc *);
 			if (bcmp(alc, ATMLLC_HDR, 6)) {
-#if (defined(__FreeBSD__) && __FreeBSD_version >= 501113) || \
+#if (defined(__FreeBSD_kernel__) && __FreeBSD_version >= 501113) || \
     defined(__NetBSD__) || defined(__OpenBSD__)
 				printf("%s: recv'd invalid LLC/SNAP frame "
 				    "[vp=%d,vc=%d]\n", ifp->if_xname,
 				    ATM_PH_VPI(ah), ATM_PH_VCI(ah));
-#elif defined(__FreeBSD__) || defined(__bsdi__)
+#elif defined(__FreeBSD_kernel__) || defined(__bsdi__)
 				printf("%s%d: recv'd invalid LLC/SNAP frame "
 				    "[vp=%d,vc=%d]\n", ifp->if_name,
 				    ifp->if_unit, ATM_PH_VPI(ah),
@@ -374,10 +374,10 @@
 
 #if defined(__NetBSD__) || defined(__OpenBSD__)
 	TAILQ_FOREACH(ifa, &ifp->if_addrlist, ifa_list)
-#elif defined(__FreeBSD__) && (__FreeBSD__ > 2)
+#elif defined(__FreeBSD_kernel__) && (5 > 2)
 	for (ifa = TAILQ_FIRST(&ifp->if_addrhead); ifa; 
 	    ifa = TAILQ_NEXT(ifa, ifa_link))
-#elif defined(__FreeBSD__) || defined(__bsdi__)
+#elif defined(__FreeBSD_kernel__) || defined(__bsdi__)
 	for (ifa = ifp->if_addrlist; ifa; ifa = ifa->ifa_next) 
 #endif
 		if ((sdl = (struct sockaddr_dl *)ifa->ifa_addr) &&
diff -ur src.old/sys/net/if_spppsubr.c src/sys/net/if_spppsubr.c
--- src.old/sys/net/if_spppsubr.c	2004-09-15 17:14:18.000000000 +0200
+++ src/sys/net/if_spppsubr.c	2005-04-05 14:18:15.000000000 +0200
@@ -22,7 +22,7 @@
 
 #include <sys/param.h>
 
-#if defined(__FreeBSD__) && __FreeBSD__ >= 3
+#if defined(__FreeBSD_kernel__) && 5 >= 3
 #include "opt_inet.h"
 #include "opt_inet6.h"
 #include "opt_ipx.h"
@@ -42,7 +42,7 @@
 #include <sys/sockio.h>
 #include <sys/socket.h>
 #include <sys/syslog.h>
-#if defined(__FreeBSD__) && __FreeBSD__ >= 3
+#if defined(__FreeBSD_kernel__) && 5 >= 3
 #include <sys/random.h>
 #endif
 #include <sys/malloc.h>
@@ -78,7 +78,7 @@
 #include <netinet/tcp.h>
 #endif
 
-#if defined (__FreeBSD__) || defined (__OpenBSD__)
+#if defined(__FreeBSD_kernel__) || defined (__OpenBSD__)
 # include <netinet/if_ether.h>
 #else
 # include <net/ethertypes.h>
@@ -91,7 +91,7 @@
 
 #include <net/if_sppp.h>
 
-#if defined(__FreeBSD__) && __FreeBSD__ >= 3
+#if defined(__FreeBSD_kernel__) && 5 >= 3
 # define UNTIMEOUT(fun, arg, handle) untimeout(fun, arg, handle)
 # define TIMEOUT(fun, arg1, arg2, handle) handle = timeout(fun, arg1, arg2)
 # define IOCTL_CMD_T	u_long
@@ -260,11 +260,11 @@
 };
 
 static struct sppp *spppq;
-#if defined(__FreeBSD__) && __FreeBSD__ >= 3
+#if defined(__FreeBSD_kernel__) && 5 >= 3
 static struct callout_handle keepalive_ch;
 #endif
 
-#if defined(__FreeBSD__) && __FreeBSD__ >= 3 && __FreeBSD_version < 501113
+#if defined(__FreeBSD_kernel__) && 5 >= 3 && __FreeBSD_version < 501113
 #define	SPP_FMT		"%s%d: "
 #define	SPP_ARGS(ifp)	(ifp)->if_name, (ifp)->if_unit
 #else
@@ -1280,7 +1280,7 @@
 			++sp->pp_loopcnt;
 
 			/* Generate new local sequence number */
-#if defined(__FreeBSD__) && __FreeBSD__ >= 3
+#if defined(__FreeBSD_kernel__) && 5 >= 3
 			sp->pp_seq[IDX_LCP] = random();
 #else
 			sp->pp_seq[IDX_LCP] ^= time.tv_sec ^ time.tv_usec;
@@ -2079,7 +2079,7 @@
 	sp->lcp.max_terminate = 2;
 	sp->lcp.max_configure = 10;
 	sp->lcp.max_failure = 10;
-#if defined(__FreeBSD__) && __FreeBSD__ >= 3
+#if defined(__FreeBSD_kernel__) && 5 >= 3
 	callout_handle_init(&sp->ch[IDX_LCP]);
 #endif
 }
@@ -2507,7 +2507,7 @@
 				if (magic == ~sp->lcp.magic) {
 					if (debug)
 						log(-1, "magic glitch ");
-#if defined(__FreeBSD__) && __FreeBSD__ >= 3
+#if defined(__FreeBSD_kernel__) && 5 >= 3
 					sp->lcp.magic = random();
 #else
 					sp->lcp.magic = time.tv_sec + time.tv_usec;
@@ -2692,7 +2692,7 @@
 
 	if (sp->lcp.opts & (1 << LCP_OPT_MAGIC)) {
 		if (! sp->lcp.magic)
-#if defined(__FreeBSD__) && __FreeBSD__ >= 3
+#if defined(__FreeBSD_kernel__) && 5 >= 3
 			sp->lcp.magic = random();
 #else
 			sp->lcp.magic = time.tv_sec + time.tv_usec;
@@ -2775,7 +2775,7 @@
 	sp->fail_counter[IDX_IPCP] = 0;
 	sp->pp_seq[IDX_IPCP] = 0;
 	sp->pp_rseq[IDX_IPCP] = 0;
-#if defined(__FreeBSD__) && __FreeBSD__ >= 3
+#if defined(__FreeBSD_kernel__) && 5 >= 3
 	callout_handle_init(&sp->ch[IDX_IPCP]);
 #endif
 }
@@ -3263,7 +3263,7 @@
 #if defined(__NetBSD__)
 	callout_init(&sp->ch[IDX_IPV6CP]);
 #endif
-#if defined(__FreeBSD__) && __FreeBSD__ >= 3
+#if defined(__FreeBSD_kernel__) && 5 >= 3
 	callout_handle_init(&sp->ch[IDX_IPV6CP]);
 #endif
 }
@@ -4062,7 +4062,7 @@
 	sp->fail_counter[IDX_CHAP] = 0;
 	sp->pp_seq[IDX_CHAP] = 0;
 	sp->pp_rseq[IDX_CHAP] = 0;
-#if defined(__FreeBSD__) && __FreeBSD__ >= 3
+#if defined(__FreeBSD_kernel__) && 5 >= 3
 	callout_handle_init(&sp->ch[IDX_CHAP]);
 #endif
 }
@@ -4205,7 +4205,7 @@
 
 	/* Compute random challenge. */
 	ch = (u_long *)sp->myauth.challenge;
-#if defined(__FreeBSD__) && __FreeBSD__ >= 3
+#if defined(__FreeBSD_kernel__) && 5 >= 3
 	read_random(&seed, sizeof seed);
 #else
 	{
@@ -4395,7 +4395,7 @@
 	sp->fail_counter[IDX_PAP] = 0;
 	sp->pp_seq[IDX_PAP] = 0;
 	sp->pp_rseq[IDX_PAP] = 0;
-#if defined(__FreeBSD__) && __FreeBSD__ >= 3
+#if defined(__FreeBSD_kernel__) && 5 >= 3
 	callout_handle_init(&sp->ch[IDX_PAP]);
 	callout_handle_init(&sp->pap_my_to_ch);
 #endif
@@ -4706,7 +4706,7 @@
 	 * aliases don't make any sense on a p2p link anyway.
 	 */
 	si = 0;
-#if defined(__FreeBSD__) && __FreeBSD__ >= 3
+#if defined(__FreeBSD_kernel__) && 5 >= 3
 	TAILQ_FOREACH(ifa, &ifp->if_addrhead, ifa_link)
 #elif defined(__NetBSD__) || defined (__OpenBSD__)
 	for (ifa = TAILQ_FIRST(&ifp->if_addrlist);
@@ -4755,7 +4755,7 @@
 	 * aliases don't make any sense on a p2p link anyway.
 	 */
 	si = 0;
-#if defined(__FreeBSD__) && __FreeBSD__ >= 3
+#if defined(__FreeBSD_kernel__) && 5 >= 3
 	TAILQ_FOREACH(ifa, &ifp->if_addrhead, ifa_link)
 #elif defined(__NetBSD__) || defined (__OpenBSD__)
 	for (ifa = TAILQ_FIRST(&ifp->if_addrlist);
@@ -4834,7 +4834,7 @@
 	 * Pick the first link-local AF_INET6 address from the list,
 	 * aliases don't make any sense on a p2p link anyway.
 	 */
-#if defined(__FreeBSD__) && __FreeBSD__ >= 3
+#if defined(__FreeBSD_kernel__) && 5 >= 3
 	for (ifa = ifp->if_addrhead.tqh_first, si = 0;
 	     ifa;
 	     ifa = ifa->ifa_link.tqe_next)
@@ -4899,7 +4899,7 @@
 	 */
 
 	sin6 = NULL;
-#if defined(__FreeBSD__) && __FreeBSD__ >= 3
+#if defined(__FreeBSD_kernel__) && 5 >= 3
 	for (ifa = ifp->if_addrhead.tqh_first;
 	     ifa;
 	     ifa = ifa->ifa_link.tqe_next)
diff -ur src.old/sys/net/net_osdep.h src/sys/net/net_osdep.h
--- src.old/sys/net/net_osdep.h	2003-11-04 15:08:31.000000000 +0100
+++ src/sys/net/net_osdep.h	2005-04-05 14:18:17.000000000 +0200
@@ -228,11 +228,11 @@
  *	others: bpfilter.h, NBPFILTER
  *	FreeBSD4: bpf.h, NBPF
  *	solution:
- *		#if defined(__FreeBSD__) && __FreeBSD__ >= 4
+ *		#if defined(__FreeBSD_kernel__) && 5 >= 4
  *		#include "bpf.h"
  *		#define NBPFILTER	NBPF
  *		#else
- *		#include "bpfilter.h"
+ *		
  *		#endif
  *
  * - protosw for IPv4 (sys/netinet)
diff -ur src.old/sys/net/zlib.c src/sys/net/zlib.c
--- src.old/sys/net/zlib.c	2004-06-20 19:42:34.000000000 +0200
+++ src/sys/net/zlib.c	2005-04-05 14:18:19.000000000 +0200
@@ -24,7 +24,7 @@
 #define NO_ZCFUNCS
 #define MY_ZCALLOC
 
-#if defined(__FreeBSD__) && defined(_KERNEL)
+#if defined(__FreeBSD_kernel__) && defined(_KERNEL)
 #define inflate	inflate_ppp	/* FreeBSD already has an inflate :-( */
 #endif
 
diff -ur src.old/sys/net/zlib.h src/sys/net/zlib.h
--- src.old/sys/net/zlib.h	2002-05-29 22:24:09.000000000 +0200
+++ src/sys/net/zlib.h	2005-04-05 14:18:20.000000000 +0200
@@ -509,7 +509,7 @@
    done by inflate().
 */
 
-#if defined(__FreeBSD__) && defined(_KERNEL)
+#if defined(__FreeBSD_kernel__) && defined(_KERNEL)
 #define inflate       inflate_ppp     /* FreeBSD already has an inflate :-( */
 #endif
 
diff -ur src.old/sys/net80211/ieee80211_ioctl.h src/sys/net80211/ieee80211_ioctl.h
--- src.old/sys/net80211/ieee80211_ioctl.h	2004-03-31 00:57:57.000000000 +0200
+++ src/sys/net80211/ieee80211_ioctl.h	2005-04-05 14:18:21.000000000 +0200
@@ -82,7 +82,7 @@
 	u_int32_t	is_crypto_nomem;	/* no memory for crypto ctx */
 };
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 /*
  * FreeBSD-style ioctls.
  */
@@ -130,6 +130,6 @@
 #endif
 
 #define	SIOCG80211STATS		_IOWR('i', 236, struct ifreq)
-#endif /* __FreeBSD__ */
+#endif /* 5 */
 
 #endif /* _NET80211_IEEE80211_IOCTL_H_ */
diff -ur src.old/sys/netatalk/aarp.c src/sys/netatalk/aarp.c
--- src.old/sys/netatalk/aarp.c	2004-08-10 05:23:05.000000000 +0200
+++ src/sys/netatalk/aarp.c	2005-04-05 14:18:22.000000000 +0200
@@ -109,9 +109,9 @@
 #define AARPT_KILLC	20
 #define AARPT_KILLI	3
 
-# if !defined(__FreeBSD__)
+# if !defined(__FreeBSD_kernel__)
 extern u_char			etherbroadcastaddr[6];
-# endif /* __FreeBSD__ */
+# endif /* 5 */
 
 static const u_char atmulticastaddr[ 6 ] = {
     0x09, 0x00, 0x07, 0xff, 0xff, 0xff,
diff -ur src.old/sys/netgraph/atm/atmpif/ng_atmpif_harp.c src/sys/netgraph/atm/atmpif/ng_atmpif_harp.c
--- src.old/sys/netgraph/atm/atmpif/ng_atmpif_harp.c	2004-09-15 17:14:19.000000000 +0200
+++ src/sys/netgraph/atm/atmpif/ng_atmpif_harp.c	2005-04-05 14:18:38.000000000 +0200
@@ -200,7 +200,7 @@
 	    "%s", "Virt. ATM 1.0");
 	snprintf(vup->vu_config.ac_firm_vers,
 	    sizeof(vup->vu_config.ac_firm_vers),
-	    "%d", __FreeBSD__);
+	    "%d", 5);
 
 	/*
 	 * Set the interface capabilities
diff -ur src.old/sys/netipsec/ipsec_osdep.h src/sys/netipsec/ipsec_osdep.h
--- src.old/sys/netipsec/ipsec_osdep.h	2003-09-30 00:47:45.000000000 +0200
+++ src/sys/netipsec/ipsec_osdep.h	2005-04-05 14:19:01.000000000 +0200
@@ -60,7 +60,7 @@
  *    NetBSD splnet equates to FreeBSD splimp.
  * which is hidden by the macro IPSEC_SPLASSERT_SOFTNET(msg).
  */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #if __FreeBSD_version < 500000
 #define IPSEC_SPLASSERT(_x,_y) SPLASSERT(_x, _y)
 #else
@@ -68,7 +68,7 @@
 #endif
 #define IPSEC_SPLASSERT_SOFTNET(_m) IPSEC_SPLASSERT(net,_m)
 #define IPSEC_ASSERT(_c,_m) KASSERT(_c, _m)
-#endif	/* __FreeBSD__ */
+#endif	/* 5 */
 
 #ifdef	__NetBSD__
 #define IPSEC_SPLASSERT(x,y) (void)0
@@ -81,10 +81,10 @@
  * FreeBSD uses:
  *    u_int read_random(void *outbuf, int nbytes).
  */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <sys/random.h>
 /* do nothing, use native random code. */
-#endif /* __FreeBSD__ */
+#endif /* 5 */
 
 #ifdef	__NetBSD__
 #include <sys/rnd.h>
@@ -159,9 +159,9 @@
  * For now, we provide an emulation of IF_HANOOFF() which works
  * for protocol input queues.
  */
-#ifdef __FreeBSD__ 
+#ifdef __FreeBSD_kernel__ 
 /* nothing to do */
-#endif /* __FreeBSD__ */
+#endif /* 5 */
 #ifdef __NetBSD__
 #define IF_HANDOFF(ifq, m, f) if_handoff(ifq, m, f, 0)
   
@@ -216,10 +216,10 @@
  * This difference is wrapped inside  the IPSEC_PRIVILEGED_SO() macro.
  *
  */
-#ifdef __FreeBSD__ 
+#ifdef __FreeBSD_kernel__ 
 #define IPSEC_IS_PRIVILEGED_SO(_so) \
 	((_so)->so_cred && (_so)->so_cred->cr_uid == 0)
-#endif	/* __FreeBSD__ */
+#endif	/* 5 */
 
 #ifdef __NetBSD__
 /* superuser opened socket? */
@@ -234,9 +234,9 @@
  * This version of fast-ipsec source code  uses rawcb_list as the head,
  *  and (to avoid namespace collisions) uses rcb_list as the "next" field.
  */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define rcb_list list
-#endif /* __FreeBSD__ */
+#endif /* 5 */
 #ifdef __NetBSD__
 #define rawcb_list rawcb
 #endif	/* __NetBSD__ */
@@ -250,7 +250,7 @@
  * NB: Is it worth introducing iterator (find-first-list/find-next-list)
  * functions or macros to encapsulate these?
  */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 /* nothing to do for raw interface list */
 #endif	/* FreeBSD */
 #ifdef __NetBSD__
diff -ur src.old/sys/netnatm/natm.c src/sys/netnatm/natm.c
--- src.old/sys/netnatm/natm.c	2004-10-21 11:30:48.000000000 +0200
+++ src/sys/netnatm/natm.c	2005-04-05 14:19:05.000000000 +0200
@@ -405,7 +405,7 @@
 
 #if defined(__NetBSD__) || defined(__OpenBSD__)
 int natm_usrreq(so, req, m, nam, control, p)
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 int natm_usrreq(so, req, m, nam, control)
 #endif
 
@@ -610,7 +610,7 @@
       snatm->snatm_family = AF_NATM;
 #if defined(__NetBSD__) || defined(__OpenBSD__)
       bcopy(npcb->npcb_ifp->if_xname, snatm->snatm_if, sizeof(snatm->snatm_if));
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
       snprintf(snatm->snatm_if, sizeof(snatm->snatm_if),
 	"%s%d", npcb->npcb_ifp->if_name, npcb->npcb_ifp->if_unit);
 #endif
diff -ur src.old/sys/netnatm/natm.h src/sys/netnatm/natm.h
--- src.old/sys/netnatm/natm.h	2003-08-06 16:34:38.000000000 +0200
+++ src/sys/netnatm/natm.h	2005-04-05 14:19:05.000000000 +0200
@@ -55,7 +55,7 @@
 	u_int8_t	snatm_vpi;		/* vpi */
 };
 
-#if defined(__FreeBSD__) && defined(_KERNEL)
+#if defined(__FreeBSD_kernel__) && defined(_KERNEL)
 
 #define	SPLSOFTNET() splnet()
 
@@ -115,18 +115,18 @@
 #if defined(__NetBSD__) || defined(__OpenBSD__)
 int	natm_usrreq(struct socket *, int, struct mbuf *,
 	    struct mbuf *, struct mbuf *, struct proc *);
-#elif defined(__FreeBSD__)
-#if __FreeBSD__ > 2
+#elif defined(__FreeBSD_kernel__)
+#if 5 > 2
 /*
  * FreeBSD new usrreqs style appeared since 2.2.  compatibility to old style
  * has gone since 3.0.
  */
 #define	FREEBSD_USRREQS
 extern struct pr_usrreqs natm_usrreqs;
-#else /* !( __FreeBSD__ > 2) */
+#else /* !( 5 > 2) */
 int	natm_usrreq(struct socket *, int, struct mbuf *,
 	    struct mbuf *, struct mbuf *);
-#endif /* !( __FreeBSD__ > 2) */
+#endif /* !( 5 > 2) */
 #endif
 
 #ifdef SYSCTL_HANDLER_ARGS
diff -ur src.old/sys/netnatm/natm_proto.c src/sys/netnatm/natm_proto.c
--- src.old/sys/netnatm/natm_proto.c	2003-11-08 23:28:40.000000000 +0100
+++ src/sys/netnatm/natm_proto.c	2005-04-05 14:19:05.000000000 +0200
@@ -125,6 +125,6 @@
 	netisr_register(NETISR_NATM, natmintr, &natmintrq, 0);
 }
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 DOMAIN_SET(natm);
 #endif
diff -ur src.old/sys/pci/if_de.c src/sys/pci/if_de.c
--- src.old/sys/pci/if_de.c	2004-10-23 05:12:33.000000000 +0200
+++ src/sys/pci/if_de.c	2005-04-05 14:19:23.000000000 +0200
@@ -3449,7 +3449,7 @@
 #endif
 #endif /* TULIP_BUS_DMA */
 
-#ifndef __FreeBSD__
+#ifndef __FreeBSD_kernel__
 	    if (sc->tulip_if.if_bpf != NULL) {
 		if (me == ms)
 		    bpf_tap(&sc->tulip_if, mtod(ms, caddr_t), total_len);
@@ -4752,7 +4752,7 @@
 	   sc->tulip_revinfo & 0x0F,
 	   (sc->tulip_features & (TULIP_HAVE_ISVSROM|TULIP_HAVE_OKSROM))
 		 == TULIP_HAVE_ISVSROM ? " (invalid EESPROM checksum)" : "");
-#ifndef __FreeBSD__
+#ifndef __FreeBSD_kernel__
     printf("%s: address %6D\n",
 	   sc->tulip_xname, sc->tulip_enaddr, ":");
 #endif
diff -ur src.old/sys/pci/ncr.c src/sys/pci/ncr.c
--- src.old/sys/pci/ncr.c	2004-09-20 22:57:37.000000000 +0200
+++ src/sys/pci/ncr.c	2005-04-05 14:19:27.000000000 +0200
@@ -49,7 +49,7 @@
 
 #define NCR_GETCC_WITHMSG
 
-#if defined (__FreeBSD__) && defined(_KERNEL)
+#if defined(__FreeBSD_kernel__) && defined(_KERNEL)
 #include "opt_ncr.h"
 #endif
 
diff -ur src.old/sys/sys/device_port.h src/sys/sys/device_port.h
--- src.old/sys/sys/device_port.h	2000-10-23 14:55:51.000000000 +0200
+++ src/sys/sys/device_port.h	2005-04-05 14:19:45.000000000 +0200
@@ -28,13 +28,13 @@
  */
 
 #if defined(__NetBSD__)
-# include <sys/device.h>
-#elif defined(__FreeBSD__)
+
+#elif defined(__FreeBSD_kernel__)
 # if __FreeBSD_version >= 400001
 #  include <sys/module.h>
 #  include <sys/bus.h>
 # else
-#  include <sys/device.h>
+
 # endif
 #endif
 
@@ -47,7 +47,7 @@
 # define DEVPORT_DEVNAME(dev)		(dev).dv_xname
 # define DEVPORT_DEVUNIT(dev)		(dev).dv_unit
 
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 /*
  * FreeBSD (compatibility for struct device)
  */
@@ -111,5 +111,5 @@
 # endif
 #endif
 
-#endif /* __FreeBSD__ */
+#endif /* 5 */
 
diff -ur src.old/sys/sys/mtio.h src/sys/sys/mtio.h
--- src.old/sys/sys/mtio.h	2004-04-07 06:19:49.000000000 +0200
+++ src/sys/sys/mtio.h	2005-04-05 14:19:49.000000000 +0200
@@ -60,7 +60,7 @@
 #define MTCACHE		8	/* enable controller cache */
 #define MTNOCACHE	9	/* disable controller cache */
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 /* Set block size for device. If device is a variable size dev		*/
 /* a non zero parameter will change the device to a fixed block size	*/
 /* device with block size set to that of the parameter passed in.	*/
@@ -103,7 +103,7 @@
 #define	MTIO_DSREG_UNL	45	/* Unloading */
 #define	MTIO_DSREG_LD	46	/* Loading */
 
-#endif	/* __FreeBSD__ */
+#endif	/* 5 */
 
 /* structure for MTIOCGET - mag tape get status command */
 
@@ -120,7 +120,7 @@
 	 * more accurate count.
 	 */
 	short	mt_resid;	/* residual count */
-#if defined (__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	int32_t mt_blksiz;	/* presently operating blocksize */
 	int32_t mt_density;	/* presently operating density */
 	u_int32_t mt_comp;	/* presently operating compression */
diff -ur src.old/sys/sys/socketvar.h src/sys/sys/socketvar.h
--- src.old/sys/sys/socketvar.h	2004-10-21 11:30:48.000000000 +0200
+++ src/sys/sys/socketvar.h	2005-04-05 14:19:52.000000000 +0200
@@ -517,7 +517,7 @@
 int	sooptcopyin(struct sockopt *sopt, void *buf, size_t len, size_t minlen);
 int	sooptcopyout(struct sockopt *sopt, const void *buf, size_t len);
 
-/* XXX; prepare mbuf for (__FreeBSD__ < 3) routines. */
+/* XXX; prepare mbuf for (5 < 3) routines. */
 int	soopt_getm(struct sockopt *sopt, struct mbuf **mp);
 int	soopt_mcopyin(struct sockopt *sopt, struct mbuf *m);
 int	soopt_mcopyout(struct sockopt *sopt, struct mbuf *m);
diff -ur src.old/sys/sys/timex.h src/sys/sys/timex.h
--- src.old/sys/sys/timex.h	2002-04-28 11:51:45.000000000 +0200
+++ src/sys/sys/timex.h	2005-04-05 14:19:54.000000000 +0200
@@ -217,7 +217,7 @@
 	long	stbcnt;		/* stability limit exceeded (ro) */
 };
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 
 #ifdef _KERNEL
 void	ntp_update_second(int64_t *adjustment, time_t *newsec);
@@ -230,6 +230,6 @@
 __END_DECLS
 #endif /* _KERNEL */
 
-#endif /* __FreeBSD__ */
+#endif /* 5 */
 
 #endif /* !_SYS_TIMEX_H_ */
