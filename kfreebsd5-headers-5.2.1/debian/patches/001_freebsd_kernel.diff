diff -ur src.old/sys/contrib/dev/acpica/acenv.h src/sys/contrib/dev/acpica/acenv.h
--- src.old/sys/contrib/dev/acpica/acenv.h	2003-05-01 22:40:03.000000000 +0200
+++ src/sys/contrib/dev/acpica/acenv.h	2004-08-07 00:22:26.000000000 +0200
@@ -204,7 +204,7 @@
 #elif defined(MSDOS)        /* Must appear after WIN32 and WIN64 check */
 #include "acdos16.h"
 
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 #include "acfreebsd.h"
 
 #elif defined(MODESTO)
diff -ur src.old/sys/contrib/ipfilter/netinet/ip_compat.h src/sys/contrib/ipfilter/netinet/ip_compat.h
--- src.old/sys/contrib/ipfilter/netinet/ip_compat.h	2003-10-31 19:31:56.000000000 +0100
+++ src/sys/contrib/ipfilter/netinet/ip_compat.h	2004-08-07 00:22:26.000000000 +0200
@@ -214,7 +214,7 @@
 #endif /* BSD > 199306 */
 
 
-#if defined(__FreeBSD__) && (defined(KERNEL) || defined(_KERNEL))
+#if defined(__FreeBSD_kernel__) && (defined(KERNEL) || defined(_KERNEL))
 # include <sys/param.h>
 # ifndef __FreeBSD_version
 #  ifdef IPFILTER_LKM
@@ -245,7 +245,7 @@
 /*
  * These operating systems already take care of the problem for us.
  */
-#if defined(__NetBSD__) || defined(__OpenBSD__) || defined(__FreeBSD__) || \
+#if defined(__NetBSD__) || defined(__OpenBSD__) || defined(__FreeBSD_kernel__) || \
     defined(__sgi)
 typedef u_int32_t       u_32_t;
 # if defined(_KERNEL) && !defined(IPFILTER_LKM)
@@ -283,7 +283,7 @@
 #endif /* __NetBSD__ || __OpenBSD__ || __FreeBSD__ || __sgi */
 
 #ifdef	USE_INET6
-# if defined(__NetBSD__) || defined(__OpenBSD__) || defined(__FreeBSD__)
+# if defined(__NetBSD__) || defined(__OpenBSD__) || defined(__FreeBSD_kernel__)
 #  include <netinet/ip6.h>
 #  ifdef	_KERNEL
 #   include <netinet6/ip6_var.h>
@@ -543,7 +543,7 @@
 #   define	GETUNIT(n, v)	ifunit(n)
 #   if (defined(NetBSD) && (NetBSD <= 1991011) && (NetBSD >= 199606)) || \
         (defined(OpenBSD) && (OpenBSD >= 199603)) || \
-	(defined(__FreeBSD__) && (__FreeBSD_version >= 501113))
+	(defined(__FreeBSD_kernel__) && (__FreeBSD_version >= 501113))
 #    define	IFNAME(x)	((struct ifnet *)x)->if_xname
 #   else
 #    define	USE_GETIFNAME	1
@@ -580,13 +580,13 @@
 # ifndef	GET_MINOR
 #  define	GET_MINOR(x)	minor(x)
 # endif
-# if (BSD >= 199306) || defined(__FreeBSD__)
+# if (BSD >= 199306) || defined(__FreeBSD_kernel__)
 #  if (defined(__NetBSD_Version__) && (__NetBSD_Version__ < 105180000)) || \
-       defined(__FreeBSD__) || (defined(OpenBSD) && (OpenBSD < 200206)) || \
+       defined(__FreeBSD_kernel__) || (defined(OpenBSD) && (OpenBSD < 200206)) || \
        defined(_BSDI_VERSION)
 #   include <vm/vm.h>
 #  endif
-#  if !defined(__FreeBSD__) || (defined (__FreeBSD_version) && \
+#  if !defined(__FreeBSD_kernel__) || (defined (__FreeBSD_version) && \
       (__FreeBSD_version >= 300000))
 #   if (defined(__NetBSD_Version__) && (__NetBSD_Version__ >= 105180000)) || \
        (defined(OpenBSD) && (OpenBSD >= 200111))
diff -ur src.old/sys/contrib/ngatm/netnatm/saal/sscfu.h src/sys/contrib/ngatm/netnatm/saal/sscfu.h
--- src.old/sys/contrib/ngatm/netnatm/saal/sscfu.h	2003-10-22 09:41:15.000000000 +0200
+++ src/sys/contrib/ngatm/netnatm/saal/sscfu.h	2004-08-07 00:22:26.000000000 +0200
@@ -41,7 +41,7 @@
  * Define how a buffer looks like.
  */
 #ifdef _KERNEL
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define SSCFU_MBUF_T mbuf
 #endif
 #else
diff -ur src.old/sys/contrib/ngatm/netnatm/saal/sscfupriv.h src/sys/contrib/ngatm/netnatm/saal/sscfupriv.h
--- src.old/sys/contrib/ngatm/netnatm/saal/sscfupriv.h	2003-10-22 09:41:15.000000000 +0200
+++ src/sys/contrib/ngatm/netnatm/saal/sscfupriv.h	2004-08-07 00:22:26.000000000 +0200
@@ -31,7 +31,7 @@
  * Private SSCF-UNI definitions.
  */
 #ifdef _KERNEL
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <netgraph/atm/sscfu/ng_sscfu_cust.h>
 #endif
 #else
diff -ur src.old/sys/contrib/ngatm/netnatm/saal/sscop.h src/sys/contrib/ngatm/netnatm/saal/sscop.h
--- src.old/sys/contrib/ngatm/netnatm/saal/sscop.h	2003-10-22 09:41:15.000000000 +0200
+++ src/sys/contrib/ngatm/netnatm/saal/sscop.h	2004-08-07 00:22:26.000000000 +0200
@@ -39,7 +39,7 @@
  * Define how a buffer looks like.
  */
 #ifdef _KERNEL
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define SSCOP_MBUF_T mbuf
 #endif
 #else
diff -ur src.old/sys/contrib/ngatm/netnatm/saal/sscoppriv.h src/sys/contrib/ngatm/netnatm/saal/sscoppriv.h
--- src.old/sys/contrib/ngatm/netnatm/saal/sscoppriv.h	2003-10-22 09:41:16.000000000 +0200
+++ src/sys/contrib/ngatm/netnatm/saal/sscoppriv.h	2004-08-07 00:22:26.000000000 +0200
@@ -32,7 +32,7 @@
  *
  */
 #ifdef _KERNEL
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <netgraph/atm/sscop/ng_sscop_cust.h>
 #endif
 #else	/* !_KERNEL */
diff -ur src.old/sys/contrib/ngatm/netnatm/sig/unipriv.h src/sys/contrib/ngatm/netnatm/sig/unipriv.h
--- src.old/sys/contrib/ngatm/netnatm/sig/unipriv.h	2003-11-07 09:46:20.000000000 +0100
+++ src/sys/contrib/ngatm/netnatm/sig/unipriv.h	2004-08-07 00:22:26.000000000 +0200
@@ -34,7 +34,7 @@
 #define unipriv_h
 
 #ifdef _KERNEL
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <netgraph/atm/uni/ng_uni_cust.h>
 #endif
 #else
diff -ur src.old/sys/contrib/ngatm/netnatm/unimsg.h src/sys/contrib/ngatm/netnatm/unimsg.h
--- src.old/sys/contrib/ngatm/netnatm/unimsg.h	2003-10-22 09:41:15.000000000 +0200
+++ src/sys/contrib/ngatm/netnatm/unimsg.h	2004-08-07 00:22:26.000000000 +0200
@@ -35,7 +35,7 @@
 
 #include <sys/types.h>
 #ifdef _KERNEL
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <sys/systm.h>
 #endif
 #else
diff -ur src.old/sys/dev/asr/i2oadptr.h src/sys/dev/asr/i2oadptr.h
--- src.old/sys/dev/asr/i2oadptr.h	2002-05-14 23:59:10.000000000 +0200
+++ src/sys/dev/asr/i2oadptr.h	2004-08-07 00:22:26.000000000 +0200
@@ -83,7 +83,7 @@
 #if !defined(I2O_ADPTR_HDR)
 #define	I2O_ADPTR_HDR
 
-#if ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD__))
+#if ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD_kernel__))
 # if (KERN_VERSION < 3)
 #  include "i386/pci/i2omsg.h"
 # else
diff -ur src.old/sys/dev/asr/i2obscsi.h src/sys/dev/asr/i2obscsi.h
--- src.old/sys/dev/asr/i2obscsi.h	2002-05-14 23:59:10.000000000 +0200
+++ src/sys/dev/asr/i2obscsi.h	2004-08-07 00:22:26.000000000 +0200
@@ -83,7 +83,7 @@
 #if !defined(I2O_BASE_SCSI_HDR)
 #define	I2O_BASE_SCSI_HDR
 
-#if ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD__))
+#if ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD_kernel__))
 # if (KERN_VERSION < 3)
 #  include    "i386/pci/i2omsg.h"	   /* Include the Base Message file */
 # else
diff -ur src.old/sys/dev/asr/i2oexec.h src/sys/dev/asr/i2oexec.h
--- src.old/sys/dev/asr/i2oexec.h	2002-05-14 23:59:10.000000000 +0200
+++ src/sys/dev/asr/i2oexec.h	2004-08-07 00:22:26.000000000 +0200
@@ -92,7 +92,7 @@
 
 #define	I2OEXEC_REV 1_5_4  /* I2OExec header file revision string */
 
-#if ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD__))
+#if ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD_kernel__))
 # if (!defined(KERN_VERSION))
 #  include <sys/sysctl.h>
 # endif
diff -ur src.old/sys/dev/asr/i2omsg.h src/sys/dev/asr/i2omsg.h
--- src.old/sys/dev/asr/i2omsg.h	2002-05-14 23:59:10.000000000 +0200
+++ src/sys/dev/asr/i2omsg.h	2004-08-07 00:22:26.000000000 +0200
@@ -116,7 +116,7 @@
 
 
 
-#if ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD__))
+#if ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD_kernel__))
 # if (KERN_VERSION < 3)
 #  include "i386/pci/i2otypes.h"
 # else
diff -ur src.old/sys/dev/asr/i2otypes.h src/sys/dev/asr/i2otypes.h
--- src.old/sys/dev/asr/i2otypes.h	2002-05-14 23:59:10.000000000 +0200
+++ src/sys/dev/asr/i2otypes.h	2004-08-07 00:22:26.000000000 +0200
@@ -87,7 +87,7 @@
 
 /* include architecture/compiler dependencies */
 
-#if ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD__))
+#if ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD_kernel__))
 # if (KERN_VERSION < 3)
 #  include "i386/pci/i2odep.h"
 # else
diff -ur src.old/sys/dev/asr/i2outil.h src/sys/dev/asr/i2outil.h
--- src.old/sys/dev/asr/i2outil.h	2002-05-14 23:59:10.000000000 +0200
+++ src/sys/dev/asr/i2outil.h	2004-08-07 00:22:26.000000000 +0200
@@ -92,7 +92,7 @@
 
 #define	I2OUTIL_REV 1_5_4  /* I2OUtil header file revision string */
 
-#if ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD__))
+#if ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD_kernel__))
 # if (KERN_VERSION < 3)
 #  include   "i386/pci/i2omsg.h"      /* Include the Base Message file */
 # else
diff -ur src.old/sys/dev/asr/osd_defs.h src/sys/dev/asr/osd_defs.h
--- src.old/sys/dev/asr/osd_defs.h	2002-05-14 23:54:56.000000000 +0200
+++ src/sys/dev/asr/osd_defs.h	2004-08-07 00:22:26.000000000 +0200
@@ -56,7 +56,7 @@
 # define _DPT_LINUX
 #elif (defined(__bsdi__))
 # define _DPT_BSDI
-#elif (defined(__FreeBSD__))
+#elif (defined(__FreeBSD_kernel__))
 # undef _DPT_FREE_BSD
 # define _DPT_FREE_BSD
 #else
diff -ur src.old/sys/dev/asr/osd_util.h src/sys/dev/asr/osd_util.h
--- src.old/sys/dev/asr/osd_util.h	2003-01-01 19:48:49.000000000 +0100
+++ src/sys/dev/asr/osd_util.h	2004-08-07 00:22:26.000000000 +0200
@@ -78,7 +78,7 @@
 
 #if (defined(KERNEL) && defined(__bsdi__))
 # include	 "i386/isa/dpt_osd_defs.h"
-#elif ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD__))
+#elif ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD_kernel__))
 # if (KERN_VERSION < 3)
 #  include	  "i386/isa/dpt_osd_defs.h"
 # else
diff -ur src.old/sys/dev/asr/sys_info.h src/sys/dev/asr/sys_info.h
--- src.old/sys/dev/asr/sys_info.h	2004-08-03 08:59:31.000000000 +0200
+++ src/sys/dev/asr/sys_info.h	2004-08-07 00:22:26.000000000 +0200
@@ -53,7 +53,7 @@
 
 #if (defined(KERNEL) && defined(__bsdi__))
 # include	 "i386/isa/dpt_osd_util.h"
-#elif ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD__))
+#elif ((defined(KERNEL) || defined(_KERNEL)) && defined(__FreeBSD_kernel__))
 # if (KERN_VERSION < 3)
 #  include	  "i386/isa/dpt_osd_util.h"
 # else
diff -ur src.old/sys/dev/awi/awivar.h src/sys/dev/awi/awivar.h
--- src.old/sys/dev/awi/awivar.h	2003-06-28 08:14:14.000000000 +0200
+++ src/sys/dev/awi/awivar.h	2004-08-07 00:22:26.000000000 +0200
@@ -94,7 +94,7 @@
 	struct ethercom		sc_ec;
 	void			*sc_ih; /* interrupt handler */
 #endif
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #if __FreeBSD_version >= 40000
 	struct {
 		char	dv_xname[64];	/*XXX*/
diff -ur src.old/sys/dev/bktr/bktr_os.h src/sys/dev/bktr/bktr_os.h
--- src.old/sys/dev/bktr/bktr_os.h	2003-12-01 20:03:50.000000000 +0100
+++ src/sys/dev/bktr/bktr_os.h	2004-08-07 00:22:26.000000000 +0200
@@ -47,7 +47,7 @@
 /******************************/
 /* *** Memory Allocation  *** */
 /******************************/
-#if (defined(__FreeBSD__) || defined(__bsdi__))
+#if (defined(__FreeBSD_kernel__) || defined(__bsdi__))
 vm_offset_t     get_bktr_mem( int unit, unsigned size );
 #endif
 
@@ -59,7 +59,7 @@
 /************************************/
 /* *** Interrupt Enable/Disable *** */
 /************************************/
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #if (__FreeBSD_version >=500000)
 #define USE_VBIMUTEX
 #define	DECLARE_INTR_MASK(s)	/* no need to declare 's' */
diff -ur src.old/sys/dev/bktr/bktr_reg.h src/sys/dev/bktr/bktr_reg.h
--- src.old/sys/dev/bktr/bktr_reg.h	2003-12-01 20:03:50.000000000 +0100
+++ src/sys/dev/bktr/bktr_reg.h	2004-08-07 00:22:26.000000000 +0200
@@ -50,7 +50,7 @@
  * Support the older kernel options on FreeBSD and OpenBSD.
  *
  */
-#if defined(__FreeBSD__) || defined(__OpenBSD__)
+#if defined(__FreeBSD_kernel__) || defined(__OpenBSD__)
 #if defined(BROOKTREE_ALLOC_PAGES)
 #define BKTR_ALLOC_PAGES BROOKTREE_ALLOC_PAGES
 #endif
@@ -461,7 +461,7 @@
  * memory mapped structure method only works on 32 bit processors
  * with the right type of endianness.
  */
-#if defined(__NetBSD__) || ( defined(__FreeBSD__) && (__FreeBSD_version >=300000) )
+#if defined(__NetBSD__) || ( defined(__FreeBSD_kernel__) && (__FreeBSD_version >=300000) )
 #define INB(bktr,offset)	bus_space_read_1((bktr)->memt,(bktr)->memh,(offset))
 #define INW(bktr,offset)	bus_space_read_2((bktr)->memt,(bktr)->memh,(offset))
 #define INL(bktr,offset)	bus_space_read_4((bktr)->memt,(bktr)->memh,(offset))
@@ -729,7 +729,7 @@
 typedef int ioctl_cmd_t;
 #endif
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #if (__FreeBSD_version >= 300000)
 typedef u_long ioctl_cmd_t;
 #endif
diff -ur src.old/sys/dev/cnw/if_cnwioctl.h src/sys/dev/cnw/if_cnwioctl.h
--- src.old/sys/dev/cnw/if_cnwioctl.h	2001-03-16 08:25:42.000000000 +0100
+++ src/sys/dev/cnw/if_cnwioctl.h	2004-08-07 00:22:26.000000000 +0200
@@ -98,7 +98,7 @@
 	struct cnwtrail trail[128];
 };
 
-#if !defined(__FreeBSD__)
+#if !defined(__FreeBSD_kernel__)
 #define ifr_domain	ifr_ifru.ifru_flags     /* domain */
 #define ifr_key		ifr_ifru.ifru_flags     /* scramble key */
 #else
diff -ur src.old/sys/dev/cx/machdep.h src/sys/dev/cx/machdep.h
--- src.old/sys/dev/cx/machdep.h	2003-12-03 08:29:38.000000000 +0100
+++ src/sys/dev/cx/machdep.h	2004-08-07 00:22:26.000000000 +0200
@@ -68,7 +68,7 @@
 /*
  * FreeBSD and BSD/OS
  */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #   include <sys/param.h>
 #   include <machine/cpufunc.h>
 #   include <sys/libkern.h>
diff -ur src.old/sys/dev/drm/drm.h src/sys/dev/drm/drm.h
--- src.old/sys/dev/drm/drm.h	2003-11-12 21:56:30.000000000 +0100
+++ src/sys/dev/drm/drm.h	2004-08-07 00:22:26.000000000 +0200
@@ -48,8 +48,8 @@
 #define DRM_IOC_WRITE		_IOC_WRITE
 #define DRM_IOC_READWRITE	_IOC_READ|_IOC_WRITE
 #define DRM_IOC(dir, group, nr, size) _IOC(dir, group, nr, size)
-#elif defined(__FreeBSD__) || defined(__NetBSD__) || defined(__OpenBSD__)
-#if defined(__FreeBSD__) && defined(IN_MODULE)
+#elif defined(__FreeBSD_kernel__) || defined(__NetBSD__) || defined(__OpenBSD__)
+#if defined(__FreeBSD_kernel__) && defined(IN_MODULE)
 /* Prevent name collision when including sys/ioccom.h */
 #undef ioctl
 #include <sys/ioccom.h>
diff -ur src.old/sys/dev/drm/drmP.h src/sys/dev/drm/drmP.h
--- src.old/sys/dev/drm/drmP.h	2003-11-12 21:56:30.000000000 +0100
+++ src/sys/dev/drm/drmP.h	2004-08-07 00:22:26.000000000 +0200
@@ -62,7 +62,7 @@
 
 /* There's undoubtably more of this file to go into these OS dependent ones. */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include "dev/drm/drm_os_freebsd.h"
 #elif defined __NetBSD__
 #include "dev/drm/drm_os_netbsd.h"
@@ -315,7 +315,7 @@
 	const char	  *name;	/* Simple driver name		   */
 	char		  *unique;	/* Unique identifier: e.g., busid  */
 	int		  unique_len;	/* Length of unique field	   */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	device_t	  device;	/* Device instance from newbus     */
 #endif
 	dev_t		  devnode;	/* Device number for mknod	   */
@@ -324,7 +324,7 @@
 	int		  flags;	/* Flags to open(2)		   */
 
 				/* Locks */
-#if defined(__FreeBSD__) && __FreeBSD_version > 500000
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version > 500000
 #if __HAVE_DMA
 	struct mtx	  dma_lock;	/* protects dev->dma */
 #endif
@@ -360,7 +360,7 @@
 				/* Context support */
 	int		  irq;		/* Interrupt used by board	   */
 	int		  irq_enabled;	/* True if the irq handler is enabled */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	int		  irqrid;	/* Interrupt used by board */
 	struct resource   *irqr;	/* Resource for interrupt used by board	   */
 #elif defined(__NetBSD__)
@@ -384,7 +384,7 @@
    	atomic_t          vbl_received;
 #endif
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	struct sigio      *buf_sigio;	/* Processes waiting for SIGIO     */
 #elif defined(__NetBSD__)
 	pid_t		  buf_pgid;
diff -ur src.old/sys/dev/drm/drm_bufs.h src/sys/dev/drm/drm_bufs.h
--- src.old/sys/dev/drm/drm_bufs.h	2003-11-12 21:56:30.000000000 +0100
+++ src/sys/dev/drm/drm_bufs.h	2004-08-07 00:22:26.000000000 +0200
@@ -877,7 +877,7 @@
 	const int zero = 0;
 	vm_offset_t address;
 	struct vmspace *vms;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	vm_ooffset_t foff;
 	vm_size_t size;
 	vm_offset_t vaddr;
@@ -898,7 +898,7 @@
 		return 0;	/* FIXME: Shouldn't this be EINVAL or something? */
 #endif /* __NetBSD__ */
 
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500000
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500000
 	vms = p->td_proc->p_vmspace;
 #else
 	vms = p->p_vmspace;
@@ -926,7 +926,7 @@
 		foff = 0;
 	}
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	vaddr = round_page((vm_offset_t)vms->vm_daddr + MAXDSIZ);
 	retcode = vm_mmap(&vms->vm_map, &vaddr, size, PROT_READ | PROT_WRITE,
 	    VM_PROT_ALL, MAP_SHARED, SLIST_FIRST(&kdev->si_hlist), foff );
diff -ur src.old/sys/dev/drm/drm_drv.h src/sys/dev/drm/drm_drv.h
--- src.old/sys/dev/drm/drm_drv.h	2003-11-12 21:56:30.000000000 +0100
+++ src/sys/dev/drm/drm_drv.h	2004-08-07 00:22:26.000000000 +0200
@@ -117,7 +117,7 @@
 static int DRM(init)(device_t nbdev);
 static void DRM(cleanup)(drm_device_t *dev);
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define DRIVER_SOFTC(unit) \
 	((drm_device_t *) devclass_get_softc(DRM(devclass), unit))
 
@@ -210,7 +210,7 @@
 
 const char *DRM(find_description)(int vendor, int device);
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 static struct cdevsw DRM(cdevsw) = {
 	.d_open =	DRM( open ),
 	.d_close =	DRM( close ),
@@ -487,7 +487,7 @@
 	dev->last_context = 0;
 	dev->if_version = 0;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	dev->buf_sigio = NULL;
 #elif defined(__NetBSD__)
 	dev->buf_pgid = 0;
@@ -616,7 +616,7 @@
 static int DRM(init)( device_t nbdev )
 {
 	int unit;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	drm_device_t *dev;
 #elif defined(__NetBSD__)
 	drm_device_t *dev = nbdev;
@@ -627,7 +627,7 @@
 	DRM_DEBUG( "\n" );
 	DRIVER_PREINIT();
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	unit = device_get_unit(nbdev);
 	dev = device_get_softc(nbdev);
 	memset( (void *)dev, 0, sizeof(*dev) );
@@ -715,7 +715,7 @@
 	DRM_LOCK();
 	DRM(takedown)(dev);
 	DRM_UNLOCK();
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	destroy_dev(dev->devnode);
 #if __FreeBSD_version >= 500000
 	mtx_destroy(&dev->dev_lock);
@@ -735,7 +735,7 @@
 	DRM_DEBUG( "\n" );
 
 	DRM(sysctl_cleanup)( dev );
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	destroy_dev(dev->devnode);
 #endif
 #if __HAVE_CTX_BITMAP
@@ -765,7 +765,7 @@
 #endif
 	DRIVER_POSTCLEANUP();
 	DRM(mem_uninit)();
-#if defined(__FreeBSD__) &&  __FreeBSD_version >= 500000
+#if defined(__FreeBSD_kernel__) &&  __FreeBSD_version >= 500000
 	mtx_destroy(&dev->dev_lock);
 #endif
 	DRM(free)(dev->maplist, sizeof(*dev->maplist), DRM_MEM_MAPS);
@@ -815,7 +815,7 @@
 	if ( !retcode ) {
 		atomic_inc( &dev->counts[_DRM_STAT_OPENS] );
 		DRM_LOCK();
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		device_busy(dev->device);
 #endif
 		if ( !dev->open_count++ )
@@ -850,7 +850,7 @@
 	 * Begin inline drm_release
 	 */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	DRM_DEBUG( "pid = %d, device = 0x%lx, open_count = %d\n",
 		   DRM_CURRENTPID, (long)dev->device, dev->open_count );
 #elif defined(__NetBSD__)
@@ -892,7 +892,7 @@
 				break;	/* Got lock */
 			}
 				/* Contention */
-#if defined(__FreeBSD__) && __FreeBSD_version > 500000
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version > 500000
 			retcode = msleep((void *)&dev->lock.lock_queue,
 			    dev->dev_lock, PZERO | PCATCH, "drmlk2", 0);
 #else
@@ -914,7 +914,7 @@
 
 #if defined (__FreeBSD__) && (__FreeBSD_version >= 500000)
 	funsetown(&dev->buf_sigio);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 	funsetown(dev->buf_sigio);
 #elif defined(__NetBSD__)
 	dev->buf_pgid = 0;
@@ -930,7 +930,7 @@
 	 */
 
 	atomic_inc( &dev->counts[_DRM_STAT_CLOSES] );
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	device_unbusy(dev->device);
 #endif
 	if (--dev->open_count == 0) {
@@ -959,7 +959,7 @@
 	atomic_inc( &dev->counts[_DRM_STAT_IOCTLS] );
 	++priv->ioctl_count;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	DRM_DEBUG( "pid=%d, cmd=0x%02lx, nr=0x%02x, dev 0x%lx, auth=%d\n",
 		 DRM_CURRENTPID, cmd, nr, (long)dev->device, priv->authenticated );
 #elif defined(__NetBSD__)
@@ -972,7 +972,7 @@
 	case FIOASYNC:
 		return 0;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	case FIOSETOWN:
 		return fsetown(*(int *)data, &dev->buf_sigio);
 
@@ -1047,7 +1047,7 @@
 		}
 
 		/* Contention */
-#if defined(__FreeBSD__) && __FreeBSD_version > 500000
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version > 500000
 		ret = msleep((void *)&dev->lock.lock_queue, &dev->dev_lock,
 		    PZERO | PCATCH, "drmlk2", 0);
 #else
diff -ur src.old/sys/dev/drm/drm_fops.h src/sys/dev/drm/drm_fops.h
--- src.old/sys/dev/drm/drm_fops.h	2003-11-12 21:56:30.000000000 +0100
+++ src/sys/dev/drm/drm_fops.h	2004-08-07 00:22:26.000000000 +0200
@@ -96,7 +96,7 @@
 		TAILQ_INSERT_TAIL(&dev->files, priv, link);
 	}
 	DRM_UNLOCK();
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	kdev->si_drv1 = dev;
 #endif
 	return 0;
diff -ur src.old/sys/dev/drm/drm_irq.h src/sys/dev/drm/drm_irq.h
--- src.old/sys/dev/drm/drm_irq.h	2003-11-12 21:56:30.000000000 +0100
+++ src/sys/dev/drm/drm_irq.h	2004-08-07 00:22:26.000000000 +0200
@@ -52,7 +52,7 @@
 	return 0;
 }
 
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500000
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500000
 static irqreturn_t
 DRM(irq_handler_wrap)(DRM_IRQ_ARGS)
 {
@@ -96,7 +96,7 @@
 	DRM(driver_irq_preinstall)( dev );
 
 				/* Install handler */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	dev->irqrid = 0;
 	dev->irqr = bus_alloc_resource(dev->device, SYS_RES_IRQ, &dev->irqrid,
 				      0, ~0, 1, RF_SHAREABLE);
@@ -163,7 +163,7 @@
 
 	DRM(driver_irq_uninstall)( dev );
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	bus_teardown_intr(dev->device, dev->irqr, dev->irqh);
 	bus_release_resource(dev->device, SYS_RES_IRQ, irqrid, dev->irqr);
 #elif defined(__NetBSD__)
diff -ur src.old/sys/dev/drm/drm_memory.h src/sys/dev/drm/drm_memory.h
--- src.old/sys/dev/drm/drm_memory.h	2003-10-24 03:48:16.000000000 +0200
+++ src/sys/dev/drm/drm_memory.h	2004-08-07 00:22:26.000000000 +0200
@@ -33,7 +33,7 @@
 
 #include "dev/drm/drmP.h"
 
-#if defined(__FreeBSD__) || defined(__NetBSD__)
+#if defined(__FreeBSD_kernel__) || defined(__NetBSD__)
 #define malloctype DRM(M_DRM)
 /* The macros conflicted in the MALLOC_DEFINE */
 MALLOC_DEFINE(malloctype, "drm", "DRM Data Structures");
@@ -85,7 +85,7 @@
 
 void *DRM(ioremap)( drm_device_t *dev, drm_local_map_t *map )
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	return pmap_mapdev(map->offset, map->size);
 #elif defined(__NetBSD__)
 	map->iot = dev->pa.pa_memt;
@@ -98,7 +98,7 @@
 
 void DRM(ioremapfree)(drm_local_map_t *map)
 {
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	pmap_unmapdev((vm_offset_t) map->handle, map->size);
 #elif defined(__NetBSD__)
 	bus_space_unmap(map->iot, map->ioh, map->size);
@@ -127,7 +127,7 @@
 }
 #endif /* __REALLY_HAVE_AGP */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 int
 DRM(mtrr_add)(unsigned long offset, size_t size, int flags)
 {
diff -ur src.old/sys/dev/drm/drm_memory_debug.h src/sys/dev/drm/drm_memory_debug.h
--- src.old/sys/dev/drm/drm_memory_debug.h	2003-10-24 03:48:16.000000000 +0200
+++ src/sys/dev/drm/drm_memory_debug.h	2004-08-07 00:22:26.000000000 +0200
@@ -104,7 +104,7 @@
 	DRM_SPINUNINIT(DRM(mem_lock));
 }
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 /* drm_mem_info is called whenever a process reads /dev/drm/mem. */
 static int
 DRM(_mem_info)(drm_mem_stats_t *stats, struct sysctl_oid *oidp, void *arg1, 
@@ -226,7 +226,7 @@
 	map->iot = dev->pa.pa_memt;
 #endif
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	if (!(pt = pmap_mapdev(map->offset, map->size))) {
 #elif defined(__NetBSD__)
 	if (bus_space_map(map->iot, map->offset, map->size, 
@@ -283,7 +283,7 @@
 		DRM_MEM_ERROR(DRM_MEM_MAPPINGS,
 			      "Attempt to free NULL pointer\n");
 	else
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		pmap_unmapdev((vm_offset_t) map->handle, map->size);
 #elif defined(__NetBSD__)
 		bus_space_unmap(map->iot, map->ioh, map->size);
diff -ur src.old/sys/dev/drm/drm_os_freebsd.h src/sys/dev/drm/drm_os_freebsd.h
--- src.old/sys/dev/drm/drm_os_freebsd.h	2003-11-12 21:56:30.000000000 +0100
+++ src/sys/dev/drm/drm_os_freebsd.h	2004-08-07 00:22:26.000000000 +0200
@@ -227,7 +227,7 @@
 
 #define DRM_HZ hz
 
-#if defined(__FreeBSD__) && __FreeBSD_version > 500000
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version > 500000
 #define DRM_WAIT_ON( ret, queue, timeout, condition )		\
 for ( ret = 0 ; !ret && !(condition) ; ) {			\
 	mtx_lock(&dev->irq_lock);				\
diff -ur src.old/sys/dev/drm/drm_sysctl.h src/sys/dev/drm/drm_sysctl.h
--- src.old/sys/dev/drm/drm_sysctl.h	2003-10-24 23:45:21.000000000 +0200
+++ src/sys/dev/drm/drm_sysctl.h	2004-08-07 00:22:26.000000000 +0200
@@ -24,7 +24,7 @@
  * $FreeBSD: src/sys/dev/drm/drm_sysctl.h,v 1.6 2003/10/24 21:45:21 anholt Exp $
  */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 
 #include <sys/sysctl.h>
 
diff -ur src.old/sys/dev/drm/drm_vm.h src/sys/dev/drm/drm_vm.h
--- src.old/sys/dev/drm/drm_vm.h	2003-10-24 03:48:16.000000000 +0200
+++ src/sys/dev/drm/drm_vm.h	2004-08-07 00:22:26.000000000 +0200
@@ -25,10 +25,10 @@
  * $FreeBSD: src/sys/dev/drm/drm_vm.h,v 1.8 2003/10/24 01:48:16 anholt Exp $
  */
 
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500102
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500102
 static int DRM(dma_mmap)(dev_t kdev, vm_offset_t offset, vm_paddr_t *paddr, 
     int prot)
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 static int DRM(dma_mmap)(dev_t kdev, vm_offset_t offset, int prot)
 #elif defined(__NetBSD__)
 static paddr_t DRM(dma_mmap)(dev_t kdev, vm_offset_t offset, int prot)
@@ -46,7 +46,7 @@
 	physical = dma->pagelist[page];
 
 	DRM_DEBUG("0x%08lx (page %lu) => 0x%08lx\n", (long)offset, page, physical);
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500102
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500102
 	*paddr = physical;
 	return 0;
 #else
@@ -54,10 +54,10 @@
 #endif
 }
 
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500102
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500102
 int DRM(mmap)(dev_t kdev, vm_offset_t offset, vm_paddr_t *paddr, 
     int prot)
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 int DRM(mmap)(dev_t kdev, vm_offset_t offset, int prot)
 #elif defined(__NetBSD__)
 paddr_t DRM(mmap)(dev_t kdev, off_t offset, int prot)
@@ -76,7 +76,7 @@
 	if (dev->dma
 	    && offset >= 0
 	    && offset < ptoa(dev->dma->page_count))
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500102
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500102
 		return DRM(dma_mmap)(kdev, offset, paddr, prot);
 #else
 		return DRM(dma_mmap)(kdev, offset, prot);
@@ -109,7 +109,7 @@
 	case _DRM_FRAME_BUFFER:
 	case _DRM_REGISTERS:
 	case _DRM_AGP:
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500102
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500102
 		*paddr = offset;
 		return 0;
 #else
@@ -117,7 +117,7 @@
 #endif
 	case _DRM_SCATTER_GATHER:
 	case _DRM_SHM:
-#if defined(__FreeBSD__) && __FreeBSD_version >= 500102
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version >= 500102
 		*paddr = vtophys(offset);
 		return 0;
 #else
diff -ur src.old/sys/dev/nsp/nspvar.h src/sys/dev/nsp/nspvar.h
--- src.old/sys/dev/nsp/nspvar.h	2002-06-01 01:39:04.000000000 +0200
+++ src/sys/dev/nsp/nspvar.h	2004-08-07 00:22:26.000000000 +0200
@@ -52,7 +52,7 @@
 	void *sc_ih;
 #endif	/* __NetBSD__ */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	bus_space_tag_t sc_iot;
 	bus_space_handle_t sc_ioh;
 	bus_space_tag_t sc_memt;
diff -ur src.old/sys/dev/owi/if_wireg.h src/sys/dev/owi/if_wireg.h
--- src.old/sys/dev/owi/if_wireg.h	2003-08-24 07:42:49.000000000 +0200
+++ src/sys/dev/owi/if_wireg.h	2004-08-07 00:22:26.000000000 +0200
@@ -83,7 +83,7 @@
 #ifdef __NetBSD__
 #define OS_STRING_NAME	"NetBSD"
 #endif
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define OS_STRING_NAME	"FreeBSD"
 #endif
 #ifdef __OpenBSD__
diff -ur src.old/sys/dev/pdq/pdqvar.h src/sys/dev/pdq/pdqvar.h
--- src.old/sys/dev/pdq/pdqvar.h	2003-10-31 19:32:03.000000000 +0100
+++ src/sys/dev/pdq/pdqvar.h	2004-08-07 00:22:26.000000000 +0200
@@ -61,7 +61,7 @@
 
 #if defined(PDQTEST)
 #include <pdq_os_test.h>
-#elif defined(__FreeBSD__) || defined(__bsdi__) || defined(__NetBSD__)
+#elif defined(__FreeBSD_kernel__) || defined(__bsdi__) || defined(__NetBSD__)
 
 #include <sys/param.h>
 #include <sys/systm.h>
@@ -73,14 +73,14 @@
 #include <vm/vm_kern.h>
 
 #define	PDQ_USE_MBUFS
-#if defined(__NetBSD__) || defined(__FreeBSD__)
+#if defined(__NetBSD__) || defined(__FreeBSD_kernel__)
 #define	PDQ_OS_PREFIX			"%s: "
 #define	PDQ_OS_PREFIX_ARGS		pdq->pdq_os_name
 #else
 #define	PDQ_OS_PREFIX			"%s%d: "
 #define	PDQ_OS_PREFIX_ARGS		pdq->pdq_os_name, pdq->pdq_unit
 #endif
-#if defined(__FreeBSD__) && BSD >= 199506
+#if defined(__FreeBSD_kernel__) && BSD >= 199506
 #define	PDQ_OS_PAGESIZE			PAGE_SIZE
 #else
 #define	PDQ_OS_PAGESIZE			NBPG
@@ -95,7 +95,7 @@
 #endif
 #define	PDQ_OS_MEMALLOC(n)		malloc(n, M_DEVBUF, M_NOWAIT)
 #define	PDQ_OS_MEMFREE(p, n)		free((void *) p, M_DEVBUF)
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define	PDQ_OS_MEMALLOC_CONTIG(n)	vm_page_alloc_contig(n, 0, 0xffffffff, PAGE_SIZE)
 #define	PDQ_OS_MEMFREE_CONTIG(p, n)	kmem_free(kernel_map, (vaddr_t) p, n)
 #else
@@ -105,7 +105,7 @@
 #endif
 #endif /* __FreeBSD__ */
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #include <vm/pmap.h>
 #include <vm/vm_extern.h>
 #include <machine/cpufunc.h>
@@ -309,7 +309,7 @@
     struct ethercom sc_ec;
     bus_dma_tag_t sc_dmatag;
 #define	sc_if		sc_ec.ec_if
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
     struct kern_devconf *sc_kdc;	/* freebsd cruft */
     struct arpcom sc_ac;
 #define	sc_if		sc_ac.ac_if
diff -ur src.old/sys/dev/raidframe/rf_configure.h src/sys/dev/raidframe/rf_configure.h
--- src.old/sys/dev/raidframe/rf_configure.h	2002-10-20 10:17:35.000000000 +0200
+++ src/sys/dev/raidframe/rf_configure.h	2004-08-07 00:22:26.000000000 +0200
@@ -48,7 +48,7 @@
 
 #if defined(__NetBSD__)
 #include <sys/ioctl.h>
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 #include <sys/ioccom.h>
 #include <sys/filio.h>
 #endif
diff -ur src.old/sys/dev/raidframe/rf_dag.h src/sys/dev/raidframe/rf_dag.h
--- src.old/sys/dev/raidframe/rf_dag.h	2002-10-20 10:17:35.000000000 +0200
+++ src/sys/dev/raidframe/rf_dag.h	2004-08-07 00:22:26.000000000 +0200
@@ -49,7 +49,7 @@
 #define RF_INTR_CONTEXT     1	/* we were invoked from interrupt context */
 #define RF_MAX_ANTECEDENTS 20	/* max num of antecedents a node may posses */
 
-#if defined(__FreeBSD__) && __FreeBSD_version > 500005
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version > 500005
 #include <sys/bio.h>
 #endif
 #include <sys/buf.h>
diff -ur src.old/sys/dev/raidframe/rf_debugMem.h src/sys/dev/raidframe/rf_debugMem.h
--- src.old/sys/dev/raidframe/rf_debugMem.h	2002-10-20 10:17:36.000000000 +0200
+++ src/sys/dev/raidframe/rf_debugMem.h	2004-08-07 00:22:26.000000000 +0200
@@ -44,7 +44,7 @@
 #include <sys/types.h>
 #include <sys/malloc.h>
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 MALLOC_DECLARE(M_RAIDFRAME);
 #endif
 
diff -ur src.old/sys/dev/raidframe/rf_etimer.h src/sys/dev/raidframe/rf_etimer.h
--- src.old/sys/dev/raidframe/rf_etimer.h	2002-10-20 10:17:36.000000000 +0200
+++ src/sys/dev/raidframe/rf_etimer.h	2004-08-07 00:22:26.000000000 +0200
@@ -53,7 +53,7 @@
                         (_t_).st = mono_time;                   \
                         splx(s);                                \
                 }
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 #define RF_ETIMER_START(_t_)                                    \
                 {                                               \
                         int s;                                  \
@@ -72,7 +72,7 @@
                         (_t_).et = mono_time;                   \
                         splx(s);                                \
                 }
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 #define RF_ETIMER_STOP(_t_)                                     \
                 {                                               \
                         int s;                                  \
diff -ur src.old/sys/dev/raidframe/rf_general.h src/sys/dev/raidframe/rf_general.h
--- src.old/sys/dev/raidframe/rf_general.h	2002-10-20 10:17:36.000000000 +0200
+++ src/sys/dev/raidframe/rf_general.h	2004-08-07 00:22:26.000000000 +0200
@@ -89,7 +89,7 @@
 #define RF_BZERO(_bp,_b,_l)  bzero(_b,_l)	/* XXX This is likely
 						 * incorrect. GO */
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #define NBPG PAGE_SIZE
 #endif
 
diff -ur src.old/sys/dev/raidframe/rf_kintf.h src/sys/dev/raidframe/rf_kintf.h
--- src.old/sys/dev/raidframe/rf_kintf.h	2002-10-20 10:17:36.000000000 +0200
+++ src/sys/dev/raidframe/rf_kintf.h	2004-08-07 00:22:26.000000000 +0200
@@ -40,7 +40,7 @@
 #if defined(__NetBSD__)
 #define RF_LTSLEEP(cond, pri, text, time, mutex)	\
 		ltsleep(cond, pri, text, time, mutex)
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 #if __FreeBSD_version > 500005
 #define RF_LTSLEEP(cond, pri, text, time, mutex) \
 		msleep(cond, mutex, pri, text, time);
diff -ur src.old/sys/dev/raidframe/rf_raidframe.h src/sys/dev/raidframe/rf_raidframe.h
--- src.old/sys/dev/raidframe/rf_raidframe.h	2002-10-20 10:17:36.000000000 +0200
+++ src/sys/dev/raidframe/rf_raidframe.h	2004-08-07 00:22:26.000000000 +0200
@@ -93,7 +93,7 @@
 #define RAIDFRAME_CONFIGURE	_IOW ('r',  1, void *)	/* config an array */
 #if defined(__NetBSD__)
 #define RAIDFRAME_SHUTDOWN	_IO  ('r',  2)		/* shutdown the array */
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 #define RAIDFRAME_SHUTDOWN	_IOW ('r',  2, int)	/* shutdown the array */
 #endif
 #define RAIDFRAME_TUR		_IOW ('r',  3, dev_t)	/* debug only: test
diff -ur src.old/sys/dev/raidframe/rf_stripelocks.h src/sys/dev/raidframe/rf_stripelocks.h
--- src.old/sys/dev/raidframe/rf_stripelocks.h	2002-10-20 10:17:37.000000000 +0200
+++ src/sys/dev/raidframe/rf_stripelocks.h	2004-08-07 00:22:26.000000000 +0200
@@ -45,7 +45,7 @@
 #ifndef _RF__RF_STRIPELOCKS_H_
 #define _RF__RF_STRIPELOCKS_H_
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #include <sys/types.h>
 #if __FreeBSD_version > 500005
 #include <sys/bio.h>
diff -ur src.old/sys/dev/raidframe/rf_threadstuff.h src/sys/dev/raidframe/rf_threadstuff.h
--- src.old/sys/dev/raidframe/rf_threadstuff.h	2003-03-20 22:17:39.000000000 +0100
+++ src/sys/dev/raidframe/rf_threadstuff.h	2004-08-07 00:22:26.000000000 +0200
@@ -123,7 +123,7 @@
 	    (struct proc **)&(_handle_), _name_)
 #define RF_THREAD_EXIT(ret)	\
 	kthread_exit(ret)
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 #if __FreeBSD_version > 500005
 #define RF_CREATE_THREAD(_handle_, _func_, _arg_, _name_) \
 	kthread_create((void (*)(void *))(_func_), (void *)(_arg_), \
@@ -210,7 +210,7 @@
 }
 #endif
 
-#if defined(__FreeBSD__) && __FreeBSD_version > 500005
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version > 500005
 int     rf_mutex_init(struct mtx *, const char *);
 int     rf_mutex_destroy(struct mtx *);
 int	_rf_create_managed_mutex(RF_ShutdownList_t **, struct mtx *,
diff -ur src.old/sys/dev/raidframe/rf_types.h src/sys/dev/raidframe/rf_types.h
--- src.old/sys/dev/raidframe/rf_types.h	2003-04-29 15:36:00.000000000 +0200
+++ src/sys/dev/raidframe/rf_types.h	2004-08-07 00:22:26.000000000 +0200
@@ -239,7 +239,7 @@
 typedef union RF_GenericParam_u RF_DagParam_t;
 typedef union RF_GenericParam_u RF_CBParam_t;
 
-#if defined(__FreeBSD__) && __FreeBSD_version > 500005
+#if defined(__FreeBSD_kernel__) && __FreeBSD_version > 500005
 typedef struct bio	*RF_Buf_t;
 #else
 typedef struct buf	*RF_Buf_t;
diff -ur src.old/sys/dev/snc/dp83932var.h src/sys/dev/snc/dp83932var.h
--- src.old/sys/dev/snc/dp83932var.h	2003-02-10 14:31:49.000000000 +0100
+++ src/sys/dev/snc/dp83932var.h	2004-08-07 00:22:26.000000000 +0200
@@ -37,7 +37,7 @@
 #ifdef __NetBSD__
 #define	splhardnet	splnet
 #endif
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define	splhardnet	splimp
 #ifndef NBPG
 #define NBPG PAGE_SIZE
diff -ur src.old/sys/dev/twe/twe_compat.h src/sys/dev/twe/twe_compat.h
--- src.old/sys/dev/twe/twe_compat.h	2003-12-02 08:57:20.000000000 +0100
+++ src/sys/dev/twe/twe_compat.h	2004-08-07 00:22:26.000000000 +0200
@@ -32,7 +32,7 @@
  * Portability and compatibility interfaces.
  */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 /******************************************************************************
  * FreeBSD
  */
diff -ur src.old/sys/dev/usb/dsbr100io.h src/sys/dev/usb/dsbr100io.h
--- src.old/sys/dev/usb/dsbr100io.h	2002-03-04 04:51:19.000000000 +0100
+++ src/sys/dev/usb/dsbr100io.h	2004-08-07 00:22:26.000000000 +0200
@@ -30,11 +30,11 @@
 
 /*  $FreeBSD: src/sys/dev/usb/dsbr100io.h,v 1.1 2002/03/04 03:51:19 alfred Exp $ */
 
-#if defined(__FreeBSD__) || defined(__NetBSD__) || defined(__OpenBSD__)
+#if defined(__FreeBSD_kernel__) || defined(__NetBSD__) || defined(__OpenBSD__)
 #include <sys/ioccom.h>
 #endif
 
-#if defined(__FreeBSD__) || defined(__NetBSD__) || defined(__OpenBSD__)
+#if defined(__FreeBSD_kernel__) || defined(__NetBSD__) || defined(__OpenBSD__)
 #define FM_SET_FREQ	_IOWR('U', 200, int)
 #define FM_GET_FREQ	_IOWR('U', 201, int)
 #define FM_START	_IOWR('U', 202, int)
diff -ur src.old/sys/dev/usb/ehcireg.h src/sys/dev/usb/ehcireg.h
--- src.old/sys/dev/usb/ehcireg.h	2003-04-14 16:04:07.000000000 +0200
+++ src/sys/dev/usb/ehcireg.h	2004-08-07 00:22:26.000000000 +0200
@@ -174,7 +174,7 @@
 #define EHCI_PAGE_SIZE 0x1000
 #define EHCI_PAGE(x) ((x) &~ 0xfff)
 #define EHCI_PAGE_OFFSET(x) ((x) & 0xfff)
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #define EHCI_PAGE_MASK(x) ((x) & 0xfff)
 #endif
 
diff -ur src.old/sys/dev/usb/ehcivar.h src/sys/dev/usb/ehcivar.h
--- src.old/sys/dev/usb/ehcivar.h	2003-04-14 16:04:07.000000000 +0200
+++ src/sys/dev/usb/ehcivar.h	2004-08-07 00:22:26.000000000 +0200
@@ -78,7 +78,7 @@
 	bus_space_tag_t iot;
 	bus_space_handle_t ioh;
 	bus_size_t sc_size;
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	void *ih;
 
 	struct resource *io_res;
diff -ur src.old/sys/dev/usb/if_auereg.h src/sys/dev/usb/if_auereg.h
--- src.old/sys/dev/usb/if_auereg.h	2003-10-04 23:41:01.000000000 +0200
+++ src/sys/dev/usb/if_auereg.h	2004-08-07 00:22:26.000000000 +0200
@@ -222,7 +222,7 @@
 #define AUE_INC(x, y)		(x) = (x + 1) % y
 
 struct aue_softc {
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #define GET_MII(sc) (device_get_softc((sc)->aue_miibus))
 #elif defined(__NetBSD__)
 #define GET_MII(sc) (&(sc)->aue_mii)
diff -ur src.old/sys/dev/usb/if_axereg.h src/sys/dev/usb/if_axereg.h
--- src.old/sys/dev/usb/if_axereg.h	2003-06-15 23:45:43.000000000 +0200
+++ src/sys/dev/usb/if_axereg.h	2004-08-07 00:22:26.000000000 +0200
@@ -144,7 +144,7 @@
 #define AXE_INC(x, y)		(x) = (x + 1) % y
 
 struct axe_softc {
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #define GET_MII(sc) (device_get_softc((sc)->axe_miibus))
 #elif defined(__NetBSD__)
 #define GET_MII(sc) (&(sc)->axe_mii)
diff -ur src.old/sys/dev/usb/if_ruereg.h src/sys/dev/usb/if_ruereg.h
--- src.old/sys/dev/usb/if_ruereg.h	2003-10-04 23:41:01.000000000 +0200
+++ src/sys/dev/usb/if_ruereg.h	2004-08-07 00:22:26.000000000 +0200
@@ -230,7 +230,7 @@
 	struct timeval		rue_rx_notice;
 };
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #define GET_MII(sc)	(device_get_softc((sc)->rue_miibus))
 #elif defined(__NetBSD__)
 #define GET_MII(sc)	(&(sc)->rue_mii)
diff -ur src.old/sys/dev/usb/ohcivar.h src/sys/dev/usb/ohcivar.h
--- src.old/sys/dev/usb/ohcivar.h	2003-07-16 01:19:49.000000000 +0200
+++ src/sys/dev/usb/ohcivar.h	2004-08-07 00:22:26.000000000 +0200
@@ -89,7 +89,7 @@
 	bus_space_handle_t ioh;
 	bus_size_t sc_size;
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	void *ih;
 
 	struct resource *io_res;
diff -ur src.old/sys/dev/usb/rio500_usb.h src/sys/dev/usb/rio500_usb.h
--- src.old/sys/dev/usb/rio500_usb.h	2000-04-08 19:02:13.000000000 +0200
+++ src/sys/dev/usb/rio500_usb.h	2004-08-07 00:22:26.000000000 +0200
@@ -21,7 +21,7 @@
 
 /*  $FreeBSD: src/sys/dev/usb/rio500_usb.h,v 1.1 2000/04/08 17:02:13 n_hibma Exp $ */
 
-#if defined(__FreeBSD__) || defined(__NetBSD__) || defined(__OpenBSD__)
+#if defined(__FreeBSD_kernel__) || defined(__NetBSD__) || defined(__OpenBSD__)
 #include <sys/ioccom.h>
 #ifndef USB_VENDOR_DIAMOND
 #define USB_VENDOR_DIAMOND 0x841
@@ -33,7 +33,7 @@
 
 struct RioCommand
 {
-#if defined(__FreeBSD__) || defined(__NetBSD__) || defined(__OpenBSD__)
+#if defined(__FreeBSD_kernel__) || defined(__NetBSD__) || defined(__OpenBSD__)
   u_int16_t  length;
 #else
   short length;
@@ -46,7 +46,7 @@
   int  timeout;
 };
 
-#if defined(__FreeBSD__) || defined(__NetBSD__) || defined(__OpenBSD__)
+#if defined(__FreeBSD_kernel__) || defined(__NetBSD__) || defined(__OpenBSD__)
 #define RIO_SEND_COMMAND	_IOWR('U', 200, struct RioCommand)
 #define RIO_RECV_COMMAND	_IOWR('U', 201, struct RioCommand)
 #else
diff -ur src.old/sys/dev/usb/uhcivar.h src/sys/dev/usb/uhcivar.h
--- src.old/sys/dev/usb/uhcivar.h	2003-07-16 01:19:49.000000000 +0200
+++ src/sys/dev/usb/uhcivar.h	2004-08-07 00:22:26.000000000 +0200
@@ -136,7 +136,7 @@
 	bus_space_tag_t iot;
 	bus_space_handle_t ioh;
 	bus_size_t sc_size;
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 	void *ih;
 
 	struct resource *io_res;
diff -ur src.old/sys/dev/usb/usb.h src/sys/dev/usb/usb.h
--- src.old/sys/dev/usb/usb.h	2004-08-03 09:03:51.000000000 +0200
+++ src/sys/dev/usb/usb.h	2004-08-07 00:22:26.000000000 +0200
@@ -98,7 +98,7 @@
 #define USETDW(w,v) (*(u_int32_t *)(w) = (v))
 #endif
 
-#if defined(__FreeBSD__) && (__FreeBSD_version <= 500014)
+#if defined(__FreeBSD_kernel__) && (__FreeBSD_version <= 500014)
 #define UPACKED __attribute__ ((packed))
 #else
 #define UPACKED __packed
diff -ur src.old/sys/dev/usb/usb_mem.h src/sys/dev/usb/usb_mem.h
--- src.old/sys/dev/usb/usb_mem.h	2003-09-01 03:07:24.000000000 +0200
+++ src/sys/dev/usb/usb_mem.h	2004-08-07 00:22:26.000000000 +0200
@@ -41,7 +41,7 @@
 typedef struct usb_dma_block {
 	bus_dma_tag_t tag;
 	bus_dmamap_t map;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 	void *kaddr;
 #else
         caddr_t kaddr;
@@ -54,7 +54,7 @@
 	LIST_ENTRY(usb_dma_block) next;
 } usb_dma_block_t;
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define DMAADDR(dma, o) ((dma)->block->segs[0].ds_addr + (dma)->offs + (o))
 #else
 #define DMAADDR(dma, o) (((char *)(dma)->block->map->dm_segs[0].ds_addr) + (dma)->offs + (o))
diff -ur src.old/sys/dev/usb/usb_port.h src/sys/dev/usb/usb_port.h
--- src.old/sys/dev/usb/usb_port.h	2003-11-10 00:54:21.000000000 +0100
+++ src/sys/dev/usb/usb_port.h	2004-08-07 00:22:26.000000000 +0200
@@ -326,7 +326,7 @@
 #define USB_DO_ATTACH(dev, bdev, parent, args, print, sub) \
 	(config_found_sm(parent, args, print, sub))
 
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 /*
  * FreeBSD
  */
diff -ur src.old/sys/dev/usb/usbdi.h src/sys/dev/usb/usbdi.h
--- src.old/sys/dev/usb/usbdi.h	2003-07-14 22:31:03.000000000 +0200
+++ src/sys/dev/usb/usbdi.h	2004-08-07 00:22:26.000000000 +0200
@@ -88,7 +88,7 @@
 #define USBD_NO_TIMEOUT 0
 #define USBD_DEFAULT_TIMEOUT 5000 /* ms = 5 s */
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 #define USB_CDEV_MAJOR 108
 #endif
 
@@ -244,7 +244,7 @@
 /* No match */
 #define UMATCH_NONE					 0
 
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 /* FreeBSD needs values less than zero */
 #define UMATCH_VENDOR_PRODUCT_REV			(-10)
 #define UMATCH_VENDOR_PRODUCT				(-20)
@@ -264,7 +264,7 @@
 
 #endif
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 int usbd_driver_load(module_t mod, int what, void *arg);
 #endif
 
diff -ur src.old/sys/dev/usb/usbdivar.h src/sys/dev/usb/usbdivar.h
--- src.old/sys/dev/usb/usbdivar.h	2003-07-16 00:42:37.000000000 +0200
+++ src/sys/dev/usb/usbdivar.h	2004-08-07 00:22:26.000000000 +0200
@@ -276,7 +276,7 @@
 
 #if defined(__NetBSD__)
 #include "locators.h"
-#elif defined(__FreeBSD__) || defined(__OpenBSD__)
+#elif defined(__FreeBSD_kernel__) || defined(__OpenBSD__)
 /* XXX these values are used to statically bind some elements in the USB tree
  * to specific driver instances. This should be somehow emulated in FreeBSD
  * but can be done later on.
diff -ur src.old/sys/dev/wi/if_wireg.h src/sys/dev/wi/if_wireg.h
--- src.old/sys/dev/wi/if_wireg.h	2003-09-06 00:29:30.000000000 +0200
+++ src/sys/dev/wi/if_wireg.h	2004-08-07 00:22:26.000000000 +0200
@@ -83,7 +83,7 @@
 #ifdef __NetBSD__
 #define OS_STRING_NAME	"NetBSD"
 #endif
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define OS_STRING_NAME	"FreeBSD"
 #endif
 #ifdef __OpenBSD__
diff -ur src.old/sys/gnu/ext2fs/ext2_fs.h src/sys/gnu/ext2fs/ext2_fs.h
--- src.old/sys/gnu/ext2fs/ext2_fs.h	2002-05-16 21:07:59.000000000 +0200
+++ src/sys/gnu/ext2fs/ext2_fs.h	2004-08-07 00:22:26.000000000 +0200
@@ -108,7 +108,7 @@
 #define EXT2_MIN_BLOCK_SIZE		1024
 #define	EXT2_MAX_BLOCK_SIZE		4096
 #define EXT2_MIN_BLOCK_LOG_SIZE		  10
-#if defined(__KERNEL__) || (defined(__FreeBSD__) && defined(_KERNEL))
+#if defined(__KERNEL__) || (defined(__FreeBSD_kernel__) && defined(_KERNEL))
 # define EXT2_BLOCK_SIZE(s)		((s)->s_blocksize)
 #else
 # define EXT2_BLOCK_SIZE(s)		(EXT2_MIN_BLOCK_SIZE << (s)->s_log_block_size)
@@ -150,7 +150,7 @@
 # define EXT2_FRAG_SIZE(s)		((s)->u.ext2_sb.s_frag_size)
 # define EXT2_FRAGS_PER_BLOCK(s)	((s)->u.ext2_sb.s_frags_per_block)
 #else
-# if defined(_KERNEL) && defined(__FreeBSD__)
+# if defined(_KERNEL) && defined(__FreeBSD_kernel__)
 # define EXT2_FRAG_SIZE(s)		((s)->s_frag_size)
 # else
 # define EXT2_FRAG_SIZE(s)		(EXT2_MIN_FRAG_SIZE << (s)->s_log_frag_size)
diff -ur src.old/sys/i386/isa/bs/bsfunc.h src/sys/i386/isa/bs/bsfunc.h
--- src.old/sys/i386/isa/bs/bsfunc.h	2002-03-20 08:39:49.000000000 +0100
+++ src/sys/i386/isa/bs/bsfunc.h	2004-08-07 00:22:26.000000000 +0200
@@ -215,7 +215,7 @@
 	if ((bsc->sc_flags & BSSTARTTIMEOUT) == 0)
 	{
 		bsc->sc_flags |= BSSTARTTIMEOUT;
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		bsc->timeout_ch =
 #endif
 		timeout(bstimeout, bsc, BS_TIMEOUT_INTERVAL);
@@ -229,7 +229,7 @@
 
 	if (bsc->sc_flags & BSSTARTTIMEOUT)
 	{
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 		untimeout(bstimeout, bsc,
 				  bsc->timeout_ch);
 #else
diff -ur src.old/sys/i386/isa/bs/bsif.h src/sys/i386/isa/bs/bsif.h
--- src.old/sys/i386/isa/bs/bsif.h	2003-11-03 23:37:28.000000000 +0100
+++ src/sys/i386/isa/bs/bsif.h	2004-08-07 00:22:26.000000000 +0200
@@ -49,7 +49,7 @@
 	bus_dma_tag_t sc_dmat;		
 
 #endif	/* __NetBSD__ */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define OS_DEPEND_DEVICE_HEADER			\
 	int unit;
 
@@ -63,7 +63,7 @@
 #if	defined(__NetBSD__)
 #define BSHW_NBPG	NBPG
 #endif
-#if	defined(__FreeBSD__)
+#if	defined(__FreeBSD_kernel__)
 #define BSHW_NBPG	PAGE_SIZE
 #endif
 
@@ -103,7 +103,7 @@
 #include <scsi/scsi_disk.h>
 #endif	/* __NetBSD__ */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <sys/bus.h>
 #include <sys/conf.h>
 #include <sys/interrupt.h>
@@ -177,7 +177,7 @@
 #define	XSBS_SCSI_NOSLEEP	SCSI_NOSLEEP
 #define XSBS_SCSI_POLL	SCSI_POLL
 #endif	/* __NetBSD__ */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define XSBS_SCSI_POLL	SCSI_NOMASK
 #endif	/* __FreeBSD__ */
 
@@ -190,7 +190,7 @@
 XSBS_INT32T bs_target_open(struct scsi_link *, struct cfdata *);
 XSBS_INT32T bs_scsi_cmd(struct scsi_xfer *);
 #endif
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 void bs_scsi_cmd(struct cam_sim *sim, union ccb *ccb);
 #endif
 extern int delaycount;
@@ -201,7 +201,7 @@
 int bsprint(void *, const char *);
 #endif	/* __NetBSD__ */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 static BS_INLINE void memcopy(void *from, void *to, register size_t len);
 u_int32_t bs_adapter_info(int);
 #define delay(y) DELAY(y)
diff -ur src.old/sys/i386/isa/bs/bsvar.h src/sys/i386/isa/bs/bsvar.h
--- src.old/sys/i386/isa/bs/bsvar.h	2002-03-20 08:39:50.000000000 +0100
+++ src/sys/i386/isa/bs/bsvar.h	2004-08-07 00:22:26.000000000 +0200
@@ -34,7 +34,7 @@
  * Copyright (c) 1994, 1995, 1996 Naofumi HONDA.  All rights reserved.
  */
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define	BS_INLINE	__inline
 #else
 #define	BS_INLINE	inline
diff -ur src.old/sys/i4b/include/i4b_global.h src/sys/i4b/include/i4b_global.h
--- src.old/sys/i4b/include/i4b_global.h	2003-11-10 15:20:34.000000000 +0100
+++ src/sys/i4b/include/i4b_global.h	2004-08-07 00:22:26.000000000 +0200
@@ -40,7 +40,7 @@
  *	hiding OS differences in the kernel
  *---------------------------------------------------------------------------*/ 
 
-#if defined(__FreeBSD__) && __FreeBSD__ >= 5
+#if defined(__FreeBSD_kernel__) && __FreeBSD__ >= 5
 /*
  * Deprecated LKM interface.
  */
diff -ur src.old/sys/net/if_atm.h src/sys/net/if_atm.h
--- src.old/sys/net/if_atm.h	2003-08-06 16:53:26.000000000 +0200
+++ src/sys/net/if_atm.h	2004-08-07 00:22:26.000000000 +0200
@@ -199,7 +199,7 @@
 
 #if defined(__NetBSD__) || defined(__OpenBSD__) || defined(__bsdi__)
 #define	RTALLOC1(A,B)		rtalloc1((A),(B))
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 #define	RTALLOC1(A,B)		rtalloc1((A),(B),0UL)
 #endif
 
diff -ur src.old/sys/net/net_osdep.h src/sys/net/net_osdep.h
--- src.old/sys/net/net_osdep.h	2003-11-04 15:08:31.000000000 +0100
+++ src/sys/net/net_osdep.h	2004-08-07 00:22:26.000000000 +0200
@@ -228,7 +228,7 @@
  *	others: bpfilter.h, NBPFILTER
  *	FreeBSD4: bpf.h, NBPF
  *	solution:
- *		#if defined(__FreeBSD__) && __FreeBSD__ >= 4
+ *		#if defined(__FreeBSD_kernel__) && __FreeBSD__ >= 4
  *		#include "bpf.h"
  *		#define NBPFILTER	NBPF
  *		#else
diff -ur src.old/sys/net/zlib.h src/sys/net/zlib.h
--- src.old/sys/net/zlib.h	2002-05-29 22:24:09.000000000 +0200
+++ src/sys/net/zlib.h	2004-08-07 00:22:26.000000000 +0200
@@ -509,7 +509,7 @@
    done by inflate().
 */
 
-#if defined(__FreeBSD__) && defined(_KERNEL)
+#if defined(__FreeBSD_kernel__) && defined(_KERNEL)
 #define inflate       inflate_ppp     /* FreeBSD already has an inflate :-( */
 #endif
 
diff -ur src.old/sys/net80211/ieee80211_ioctl.h src/sys/net80211/ieee80211_ioctl.h
--- src.old/sys/net80211/ieee80211_ioctl.h	2003-10-18 01:15:30.000000000 +0200
+++ src/sys/net80211/ieee80211_ioctl.h	2004-08-07 00:22:26.000000000 +0200
@@ -82,7 +82,7 @@
 	u_int32_t	is_crypto_nomem;	/* no memory for crypto ctx */
 };
 
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 /*
  * FreeBSD-style ioctls.
  */
diff -ur src.old/sys/netipsec/ipsec_osdep.h src/sys/netipsec/ipsec_osdep.h
--- src.old/sys/netipsec/ipsec_osdep.h	2003-09-30 00:47:45.000000000 +0200
+++ src/sys/netipsec/ipsec_osdep.h	2004-08-07 00:22:26.000000000 +0200
@@ -60,7 +60,7 @@
  *    NetBSD splnet equates to FreeBSD splimp.
  * which is hidden by the macro IPSEC_SPLASSERT_SOFTNET(msg).
  */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #if __FreeBSD_version < 500000
 #define IPSEC_SPLASSERT(_x,_y) SPLASSERT(_x, _y)
 #else
@@ -81,7 +81,7 @@
  * FreeBSD uses:
  *    u_int read_random(void *outbuf, int nbytes).
  */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #include <sys/random.h>
 /* do nothing, use native random code. */
 #endif /* __FreeBSD__ */
@@ -159,7 +159,7 @@
  * For now, we provide an emulation of IF_HANOOFF() which works
  * for protocol input queues.
  */
-#ifdef __FreeBSD__ 
+#ifdef __FreeBSD_kernel__ 
 /* nothing to do */
 #endif /* __FreeBSD__ */
 #ifdef __NetBSD__
@@ -216,7 +216,7 @@
  * This difference is wrapped inside  the IPSEC_PRIVILEGED_SO() macro.
  *
  */
-#ifdef __FreeBSD__ 
+#ifdef __FreeBSD_kernel__ 
 #define IPSEC_IS_PRIVILEGED_SO(_so) \
 	((_so)->so_cred && (_so)->so_cred->cr_uid == 0)
 #endif	/* __FreeBSD__ */
@@ -234,7 +234,7 @@
  * This version of fast-ipsec source code  uses rawcb_list as the head,
  *  and (to avoid namespace collisions) uses rcb_list as the "next" field.
  */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 #define rcb_list list
 #endif /* __FreeBSD__ */
 #ifdef __NetBSD__
@@ -250,7 +250,7 @@
  * NB: Is it worth introducing iterator (find-first-list/find-next-list)
  * functions or macros to encapsulate these?
  */
-#ifdef __FreeBSD__
+#ifdef __FreeBSD_kernel__
 /* nothing to do for raw interface list */
 #endif	/* FreeBSD */
 #ifdef __NetBSD__
diff -ur src.old/sys/netnatm/natm.h src/sys/netnatm/natm.h
--- src.old/sys/netnatm/natm.h	2003-08-06 16:34:38.000000000 +0200
+++ src/sys/netnatm/natm.h	2004-08-07 00:22:26.000000000 +0200
@@ -55,7 +55,7 @@
 	u_int8_t	snatm_vpi;		/* vpi */
 };
 
-#if defined(__FreeBSD__) && defined(_KERNEL)
+#if defined(__FreeBSD_kernel__) && defined(_KERNEL)
 
 #define	SPLSOFTNET() splnet()
 
@@ -115,7 +115,7 @@
 #if defined(__NetBSD__) || defined(__OpenBSD__)
 int	natm_usrreq(struct socket *, int, struct mbuf *,
 	    struct mbuf *, struct mbuf *, struct proc *);
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 #if __FreeBSD__ > 2
 /*
  * FreeBSD new usrreqs style appeared since 2.2.  compatibility to old style
diff -ur src.old/sys/sys/device_port.h src/sys/sys/device_port.h
--- src.old/sys/sys/device_port.h	2000-10-23 14:55:51.000000000 +0200
+++ src/sys/sys/device_port.h	2004-08-07 00:22:26.000000000 +0200
@@ -29,7 +29,7 @@
 
 #if defined(__NetBSD__)
 # include <sys/device.h>
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 # if __FreeBSD_version >= 400001
 #  include <sys/module.h>
 #  include <sys/bus.h>
@@ -47,7 +47,7 @@
 # define DEVPORT_DEVNAME(dev)		(dev).dv_xname
 # define DEVPORT_DEVUNIT(dev)		(dev).dv_unit
 
-#elif defined(__FreeBSD__)
+#elif defined(__FreeBSD_kernel__)
 /*
  * FreeBSD (compatibility for struct device)
  */
diff -ur src.old/sys/sys/mtio.h src/sys/sys/mtio.h
--- src.old/sys/sys/mtio.h	2002-05-14 09:30:13.000000000 +0200
+++ src/sys/sys/mtio.h	2004-08-07 00:22:26.000000000 +0200
@@ -64,7 +64,7 @@
 #define MTCACHE		8	/* enable controller cache */
 #define MTNOCACHE	9	/* disable controller cache */
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD_kernel__)
 /* Set block size for device. If device is a variable size dev		*/
 /* a non zero parameter will change the device to a fixed block size	*/
 /* device with block size set to that of the parameter passed in.	*/
