diff -Nur lib.old/lib/libkvm/kvm.c lib/libkvm/kvm.c
--- lib.old/lib/libkvm/kvm.c	2004-06-08 15:08:19.000000000 +0200
+++ lib/libkvm/kvm.c	2005-12-20 11:20:23.000000000 +0100
@@ -51,6 +51,7 @@
 #include <sys/stat.h>
 #include <sys/sysctl.h>
 #include <sys/linker.h>
+#include <sys/sysctl.h>
 
 #include <vm/vm.h>
 #include <vm/vm_param.h>
@@ -63,11 +64,14 @@
 #include <limits.h>
 #include <nlist.h>
 #include <paths.h>
+#include <stdarg.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
 #include <unistd.h>
 
+#include <bsd/bsd.h>
+
 #include "kvm_private.h"
 
 /* from src/lib/libc/gen/nlist.c */
@@ -80,7 +84,19 @@
 	return (kd->errbuf);
 }
 
-#include <stdarg.h>
+const char *
+getbootfile(void)
+{
+	static char name[MAXPATHLEN];
+	size_t size = sizeof name;
+	int mib[2];
+
+	mib[0] = CTL_KERN;
+	mib[1] = KERN_BOOTFILE;
+	if (sysctl(mib, 2, name, &size, NULL, 0) == -1)
+		return ("/boot/kernel/kernel");
+	return (name);
+}
 
 /*
  * Report an error using printf style arguments.  "program" is kd->program
@@ -235,7 +251,7 @@
 kvm_openfiles(uf, mf, sf, flag, errout)
 	const char *uf;
 	const char *mf;
-	const char *sf __unused;
+	const char *sf;
 	int flag;
 	char *errout;
 {
@@ -254,7 +270,7 @@
 kvm_open(uf, mf, sf, flag, errstr)
 	const char *uf;
 	const char *mf;
-	const char *sf __unused;
+	const char *sf;
 	int flag;
 	const char *errstr;
 {
diff -Nur lib.old/lib/libkvm/kvm_file.c lib/libkvm/kvm_file.c
--- lib.old/lib/libkvm/kvm_file.c	2003-07-31 23:44:31.000000000 +0200
+++ lib/libkvm/kvm_file.c	2005-12-20 11:32:50.000000000 +0100
@@ -64,7 +64,7 @@
 #include <sys/sysctl.h>
 
 #include <limits.h>
-#include <ndbm.h>
+#include <gdbm-ndbm.h>
 #include <paths.h>
 
 #include "kvm_private.h"
@@ -81,6 +81,7 @@
 	int op, arg, nfiles;
 	long filehead_o;
 {
+#if 0
 	int buflen = kd->arglen, n = 0;
 	struct file *fp;
 	char *where = kd->argspc;
@@ -118,6 +119,8 @@
 		return (0);
 	}
 	return (nfiles);
+#endif
+	return 0;
 }
 
 char *
@@ -126,6 +129,7 @@
 	int op, arg;
 	int *cnt;
 {
+#if 0
 	int mib[2], st, nfiles;
 	size_t size;
 	struct file *fp, *fplim;
@@ -189,4 +193,6 @@
 	}
 	*cnt = nfiles;
 	return (kd->argspc);
+#endif
+	return 0;
 }
diff -Nur lib.old/lib/libkvm/kvm_getloadavg.c lib/libkvm/kvm_getloadavg.c
--- lib.old/lib/libkvm/kvm_getloadavg.c	2001-11-20 09:26:37.000000000 +0100
+++ lib/libkvm/kvm_getloadavg.c	2005-12-20 11:52:23.000000000 +0100
@@ -48,6 +48,7 @@
 #include <limits.h>
 #include <nlist.h>
 #include <kvm.h>
+#include <sys/_types.h>
 
 #include "kvm_private.h"
 
@@ -59,6 +60,11 @@
 	{ "" },
 };
 
+struct loadavg {
+	__fixpt_t       ldavg[3];
+	long            fscale;
+};
+
 /*
  * kvm_getloadavg() -- Get system load averages, from live or dead kernels.
  *
diff -Nur lib.old/lib/libkvm/kvm_getswapinfo.c lib/libkvm/kvm_getswapinfo.c
--- lib.old/lib/libkvm/kvm_getswapinfo.c	2004-07-31 20:49:53.000000000 +0200
+++ lib/libkvm/kvm_getswapinfo.c	2005-12-20 12:00:15.000000000 +0100
@@ -47,6 +47,8 @@
 #include <unistd.h>
 #include <limits.h>
 
+#include <bsd/bsd.h>
+
 #include "kvm_private.h"
 
 #define NL_SWAPBLIST	0
@@ -118,11 +120,13 @@
 		return -1;
 
 	mibi = SWI_MAXMIB - 1;
+#if 0
 	if (sysctlnametomib("vm.swap_info", soid, &mibi) == -1) {
 		_kvm_err(kd, kd->program, "sysctlnametomib failed: %s",
 		    strerror(errno));
 		return -1;
 	}
+#endif
 	bzero(&tot, sizeof(tot));
 	for (unswdev = 0;; unswdev++) {
 		soid[mibi] = unswdev;
@@ -151,8 +155,10 @@
 			swap_ary[unswdev].ksw_total = ttl;
 			swap_ary[unswdev].ksw_used = xsd.xsw_used;
 			swap_ary[unswdev].ksw_flags = xsd.xsw_flags;
+#if 0
 			GETSWDEVNAME(xsd.xsw_dev, swap_ary[unswdev].ksw_devname,
 			     flags);
+#endif
 		}
 		tot.ksw_total += ttl;
 		tot.ksw_used += xsd.xsw_used;
diff -Nur lib.old/lib/libkvm/kvm_private.h lib/libkvm/kvm_private.h
--- lib.old/lib/libkvm/kvm_private.h	2002-03-22 10:18:38.000000000 +0100
+++ lib/libkvm/kvm_private.h	2005-12-20 11:13:35.000000000 +0100
@@ -70,14 +70,12 @@
 /*
  * Functions used internally by kvm, but across kvm modules.
  */
-void	 _kvm_err(kvm_t *kd, const char *program, const char *fmt, ...)
-	    __printflike(3, 4);
+void	 _kvm_err(kvm_t *kd, const char *program, const char *fmt, ...);
 void	 _kvm_freeprocs(kvm_t *kd);
 void	 _kvm_freevtop(kvm_t *);
 int	 _kvm_initvtop(kvm_t *);
 int	 _kvm_kvatop(kvm_t *, u_long, u_long *);
 void	*_kvm_malloc(kvm_t *kd, size_t);
 void	*_kvm_realloc(kvm_t *kd, void *, size_t);
-void	 _kvm_syserr (kvm_t *kd, const char *program, const char *fmt, ...)
-	    __printflike(3, 4);
+void	 _kvm_syserr (kvm_t *kd, const char *program, const char *fmt, ...);
 int	 _kvm_uvatop(kvm_t *, const struct proc *, u_long, u_long *);
diff -Nur lib.old/lib/libkvm/kvm_proc.c lib/libkvm/kvm_proc.c
--- lib.old/lib/libkvm/kvm_proc.c	2005-03-01 10:30:14.000000000 +0100
+++ lib/libkvm/kvm_proc.c	2005-12-20 12:03:51.000000000 +0100
@@ -77,6 +77,8 @@
 #include <memory.h>
 #include <paths.h>
 
+#include <bsd/bsd.h>
+
 #include "kvm_private.h"
 
 #define KREAD(kd, addr, obj) \
@@ -94,6 +96,7 @@
 	struct kinfo_proc *bp;
 	int maxcnt;
 {
+#if 0
 	int cnt = 0;
 	struct kinfo_proc kinfo_proc, *kp;
 	struct pgrp pgrp;
@@ -414,6 +417,8 @@
 		++cnt;
 	}
 	return (cnt);
+#endif
+	return -1;
 }
 
 /*
diff -Nur lib.old/lib/libkvm/Makefile lib/libkvm/Makefile
--- lib.old/lib/libkvm/Makefile	2003-08-18 17:25:38.000000000 +0200
+++ lib/libkvm/Makefile	2005-12-20 12:11:11.000000000 +0100
@@ -2,8 +2,9 @@
 # $FreeBSD: src/lib/libkvm/Makefile,v 1.14 2003/08/18 15:25:38 obrien Exp $
 
 LIB=	kvm
-SHLIBDIR?= /lib
-CFLAGS+=-DLIBC_SCCS -I${.CURDIR}
+SHLIB_MAJOR=	0
+SHLIBDIR?=	/usr/lib
+LDADD=		-lbsd -lfreebsd
 SRCS=	kvm.c kvm_${MACHINE_ARCH}.c kvm_file.c kvm_getloadavg.c \
 	kvm_getswapinfo.c kvm_proc.c
 INCS=	kvm.h
