---
 lib/libkvm/Makefile             |    2 +-
 lib/libkvm/kvm.c                |   16 ++++++++++++----
 lib/libkvm/kvm_amd64.c          |    9 +++++----
 lib/libkvm/kvm_cptime.c         |    5 +++--
 lib/libkvm/kvm_file.c           |    8 +++++++-
 lib/libkvm/kvm_getloadavg.c     |   14 ++++++++++----
 lib/libkvm/kvm_getswapinfo.c    |   13 +++++++++----
 lib/libkvm/kvm_minidump_amd64.c |   10 ++++++++++
 lib/libkvm/kvm_minidump_i386.c  |   10 ++++++++++
 lib/libkvm/kvm_pcpu.c           |    6 +++---
 lib/libkvm/kvm_private.h        |    4 ++--
 lib/libkvm/kvm_proc.c           |   19 +++++++++++--------
 12 files changed, 83 insertions(+), 33 deletions(-)

Index: freebsd-libs/lib/libkvm/Makefile
===================================================================
--- freebsd-libs.orig/lib/libkvm/Makefile	2009-11-14 09:09:01.000000000 +0000
+++ freebsd-libs/lib/libkvm/Makefile	2009-11-14 09:09:01.000000000 +0000
@@ -2,8 +2,8 @@
 # $FreeBSD$
 
 LIB=	kvm
+LDADD= -lbsd
 SHLIBDIR?= /lib
-CFLAGS+=-DLIBC_SCCS -I${.CURDIR}
 
 .if ${MACHINE} == "sun4v"
 CFLAGS+=-DSUN4V
Index: freebsd-libs/lib/libkvm/kvm.c
===================================================================
--- freebsd-libs.orig/lib/libkvm/kvm.c	2009-11-14 09:09:01.000000000 +0000
+++ freebsd-libs/lib/libkvm/kvm.c	2009-11-14 09:09:01.000000000 +0000
@@ -50,6 +50,7 @@
 #include <sys/stat.h>
 #include <sys/sysctl.h>
 #include <sys/linker.h>
+#include <sys/sysctl.h>
 
 #include <net/vnet.h>
 
@@ -70,6 +71,10 @@
 #include <strings.h>
 #include <unistd.h>
 
+#ifndef _PATH_FWMEM
+#define _PATH_FWMEM     "/dev/fwmem"
+#endif
+
 #include "kvm_private.h"
 
 /* from src/lib/libc/gen/nlist.c */
@@ -151,6 +156,7 @@
 	char *errout;
 {
 	struct stat st;
+	static char name[MAXPATHLEN];
 
 	kd->vmfd = -1;
 	kd->pmfd = -1;
@@ -160,8 +166,17 @@
 	kd->argspc = 0;
 	kd->argv = 0;
 
-	if (uf == 0)
-		uf = getbootfile();
+	if (uf == 0) {
+		size_t size = sizeof(name);
+		int mib[2];
+
+		mib[0] = CTL_KERN;
+		mib[1] = KERN_BOOTFILE;
+		if (sysctl(mib, 2, name, &size, NULL, 0) == -1)
+			strcpy(name, "/boot/kernel/kernel");
+
+		uf = name;
+	}
 	else if (strlen(uf) >= MAXPATHLEN) {
 		_kvm_err(kd, kd->program, "exec file name too long");
 		goto failed;
@@ -244,7 +259,7 @@
 kvm_openfiles(uf, mf, sf, flag, errout)
 	const char *uf;
 	const char *mf;
-	const char *sf __unused;
+	const char *sf;
 	int flag;
 	char *errout;
 {
@@ -262,7 +277,7 @@
 kvm_open(uf, mf, sf, flag, errstr)
 	const char *uf;
 	const char *mf;
-	const char *sf __unused;
+	const char *sf;
 	int flag;
 	const char *errstr;
 {
Index: freebsd-libs/lib/libkvm/kvm_file.c
===================================================================
--- freebsd-libs.orig/lib/libkvm/kvm_file.c	2009-11-14 09:09:01.000000000 +0000
+++ freebsd-libs/lib/libkvm/kvm_file.c	2009-11-14 09:09:01.000000000 +0000
@@ -59,7 +59,7 @@
 #include <sys/sysctl.h>
 
 #include <limits.h>
-#include <ndbm.h>
+#include <gdbm-ndbm.h>
 #include <paths.h>
 #include <stdlib.h>
 
@@ -80,6 +80,7 @@
 	int op, arg, nprocs;
 	long allproc_o;
 {
+#if 0
 	struct proc proc;
 	struct filedesc filed;
 	int buflen = kd->arglen, ocnt = 0, n = 0, once = 0, i;
@@ -151,6 +152,7 @@
 	return (n);
 fail:
 	free(ofiles);
+#endif
 	return (0);
 	
 }
@@ -166,6 +168,7 @@
 
 	_kvm_syserr(kd, kd->program, "kvm_getfiles has been broken for years");
 	return (0);
+#if 0
 	if (ISALIVE(kd)) {
 		size = 0;
 		mib[0] = CTL_KERN;
@@ -228,4 +231,6 @@
 	}
 	*cnt = nfiles;
 	return (kd->argspc);
+#endif
+	return 0;
 }
Index: freebsd-libs/lib/libkvm/kvm_getloadavg.c
===================================================================
--- freebsd-libs.orig/lib/libkvm/kvm_getloadavg.c	2009-11-14 09:09:01.000000000 +0000
+++ freebsd-libs/lib/libkvm/kvm_getloadavg.c	2009-11-14 09:09:01.000000000 +0000
@@ -44,15 +44,21 @@
 #include <limits.h>
 #include <nlist.h>
 #include <kvm.h>
+#include <sys/_types.h>
 
 #include "kvm_private.h"
 
 static struct nlist nl[] = {
-	{ "_averunnable" },
+	{ { "_averunnable" } },
 #define	X_AVERUNNABLE	0
-	{ "_fscale" },
+	{ { "_fscale" } },
 #define	X_FSCALE	1
-	{ "" },
+	{ { "" } },
+};
+
+struct loadavg {
+	__fixpt_t       ldavg[3];
+	long            fscale;
 };
 
 /*
Index: freebsd-libs/lib/libkvm/kvm_getswapinfo.c
===================================================================
--- freebsd-libs.orig/lib/libkvm/kvm_getswapinfo.c	2009-11-14 09:09:01.000000000 +0000
+++ freebsd-libs/lib/libkvm/kvm_getswapinfo.c	2009-11-14 09:09:01.000000000 +0000
@@ -47,13 +47,16 @@
 #include <string.h>
 #include <unistd.h>
 #include <limits.h>
+#include <bsd/string.h>
+
+
 
 #include "kvm_private.h"
 
 static struct nlist kvm_swap_nl[] = {
-	{ "_swtailq" },		/* list of swap devices and sizes */
-	{ "_dmmax" },		/* maximum size of a swap block */
-	{ NULL }
+	{ { "_swtailq" } },		/* list of swap devices and sizes */
+	{ { "_dmmax" } },		/* maximum size of a swap block */
+	{ { NULL } }
 };
 
 #define NL_SWTAILQ	0
@@ -210,8 +213,10 @@
 			swap_ary[unswdev].ksw_total = ttl;
 			swap_ary[unswdev].ksw_used = xsd.xsw_used;
 			swap_ary[unswdev].ksw_flags = xsd.xsw_flags;
+#if 0
 			GETSWDEVNAME(xsd.xsw_dev, swap_ary[unswdev].ksw_devname,
 			     flags);
+#endif
 		}
 		tot.ksw_total += ttl;
 		tot.ksw_used += xsd.xsw_used;
Index: freebsd-libs/lib/libkvm/kvm_minidump_amd64.c
===================================================================
--- freebsd-libs.orig/lib/libkvm/kvm_minidump_amd64.c	2009-11-14 09:09:01.000000000 +0000
+++ freebsd-libs/lib/libkvm/kvm_minidump_amd64.c	2009-11-14 09:09:01.000000000 +0000
@@ -100,6 +100,15 @@
 	return (-1);
 }
 
+__inline__ u_long
+bsfq(u_long mask)
+{
+	u_long  result;
+
+	__asm __volatile("bsfq %1,%0" : "=r" (result) : "rm" (mask));
+	return (result);
+}
+
 static int
 inithash(kvm_t *kd, uint64_t *base, int len, off_t off)
 {
Index: freebsd-libs/lib/libkvm/kvm_minidump_i386.c
===================================================================
--- freebsd-libs.orig/lib/libkvm/kvm_minidump_i386.c	2009-11-14 09:09:01.000000000 +0000
+++ freebsd-libs/lib/libkvm/kvm_minidump_i386.c	2009-11-14 09:09:01.000000000 +0000
@@ -102,6 +102,16 @@
 	return (-1);
 }
 
+__inline__ u_int
+bsfl(u_int mask)
+{
+	u_int   result;
+
+	__asm __volatile("bsfl %1,%0" : "=r" (result) : "rm" (mask));
+	return (result);
+}
+
+
 static int
 inithash(kvm_t *kd, uint32_t *base, int len, off_t off)
 {
Index: freebsd-libs/lib/libkvm/kvm_private.h
===================================================================
--- freebsd-libs.orig/lib/libkvm/kvm_private.h	2009-11-14 09:09:01.000000000 +0000
+++ freebsd-libs/lib/libkvm/kvm_private.h	2009-11-14 09:09:01.000000000 +0000
@@ -34,6 +34,8 @@
  * $FreeBSD$
  */
 
+#include <stdint.h>
+
 struct __kvm {
 	/*
 	 * a string to be prepended to error messages
@@ -74,7 +76,7 @@
  * Functions used internally by kvm, but across kvm modules.
  */
 void	 _kvm_err(kvm_t *kd, const char *program, const char *fmt, ...)
-	    __printflike(3, 4);
+	    __attribute__((format(printf,3,4)));
 void	 _kvm_freeprocs(kvm_t *kd);
 void	 _kvm_freevtop(kvm_t *);
 int	 _kvm_initvtop(kvm_t *);
@@ -83,7 +85,7 @@
 int	 _kvm_nlist(kvm_t *, struct nlist *, int);
 void	*_kvm_realloc(kvm_t *kd, void *, size_t);
 void	 _kvm_syserr (kvm_t *kd, const char *program, const char *fmt, ...)
-	    __printflike(3, 4);
+	    __attribute__((format(printf,3,4)));
 int	 _kvm_uvatop(kvm_t *, const struct proc *, u_long, u_long *);
 int	 _kvm_vnet_selectpid(kvm_t *, pid_t);
 int	 _kvm_vnet_initialized(kvm_t *, int);
Index: freebsd-libs/lib/libkvm/kvm_proc.c
===================================================================
--- freebsd-libs.orig/lib/libkvm/kvm_proc.c	2009-11-14 09:09:01.000000000 +0000
+++ freebsd-libs/lib/libkvm/kvm_proc.c	2009-11-14 09:09:01.000000000 +0000
@@ -54,7 +54,7 @@
 #include <sys/_lock.h>
 #include <sys/_mutex.h>
 #include <sys/_task.h>
-#include <sys/cpuset.h>
+
 #include <sys/user.h>
 #include <sys/proc.h>
 #define	_WANT_PRISON	/* make jail.h give us 'struct prison' */
@@ -101,6 +101,7 @@
 	struct kinfo_proc *bp;
 	int maxcnt;
 {
+#if 0
 	int cnt = 0;
 	struct kinfo_proc kinfo_proc, *kp;
 	struct pgrp pgrp;
@@ -427,6 +428,8 @@
 		++cnt;
 	}
 	return (cnt);
+#endif
+	return -1;
 }
 
 /*
Index: freebsd-libs/lib/libkvm/kvm_amd64.c
===================================================================
--- freebsd-libs.orig/lib/libkvm/kvm_amd64.c	2009-11-14 09:09:01.000000000 +0000
+++ freebsd-libs/lib/libkvm/kvm_amd64.c	2009-11-14 09:09:01.000000000 +0000
@@ -53,6 +53,7 @@
 #include <stdlib.h>
 #include <string.h>
 #include <unistd.h>
+#include <string.h>
 #include <nlist.h>
 #include <kvm.h>
 
Index: freebsd-libs/lib/libkvm/kvm_cptime.c
===================================================================
--- freebsd-libs.orig/lib/libkvm/kvm_cptime.c	2009-11-14 09:09:01.000000000 +0000
+++ freebsd-libs/lib/libkvm/kvm_cptime.c	2009-11-14 09:09:01.000000000 +0000
@@ -44,8 +44,8 @@
 #include "kvm_private.h"
 
 static struct nlist kvm_cp_time_nl[] = {
-	{ "_cp_time" },			/* (deprecated) */
-	{ NULL },
+	{ { "_cp_time" } },			/* (deprecated) */
+	{ { NULL } },
 };
 
 #define	NL_CP_TIME		0
Index: freebsd-libs/lib/libkvm/kvm_pcpu.c
===================================================================
--- freebsd-libs.orig/lib/libkvm/kvm_pcpu.c	2009-11-14 09:09:01.000000000 +0000
+++ freebsd-libs/lib/libkvm/kvm_pcpu.c	2009-11-14 09:09:01.000000000 +0000
@@ -41,9 +41,9 @@
 #include "kvm_private.h"
 
 static struct nlist kvm_pcpu_nl[] = {
-	{ "_cpuid_to_pcpu" },
-	{ "_mp_maxcpus" },
-	{ NULL },
+	{ { "_cpuid_to_pcpu" } },
+	{ { "_mp_maxcpus" } },
+	{ { NULL } },
 };
 
 /*
Index: freebsd-libs/lib/libkvm/kvm_vnet.c
===================================================================
--- freebsd-libs.orig/lib/libkvm/kvm_vnet.c	2009-11-14 09:14:36.000000000 +0000
+++ freebsd-libs/lib/libkvm/kvm_vnet.c	2009-11-14 09:15:01.000000000 +0000
@@ -69,18 +69,18 @@
 		 * here to __{start,stop}_set_vnet.
 		 */
 #define	NLIST_START_VNET	0
-		{ .n_name = "___start_" VNET_SETNAME },
+		{ "___start_" VNET_SETNAME },
 #define	NLIST_STOP_VNET		1
-		{ .n_name = "___stop_" VNET_SETNAME },
+		{ "___stop_" VNET_SETNAME },
 #define	NLIST_VNET_HEAD		2
-		{ .n_name = "vnet_head" },
+		{ "vnet_head" },
 #define	NLIST_ALLPROC		3
-		{ .n_name = "allproc" },
+		{ "allproc" },
 #define	NLIST_DUMPTID		4
-		{ .n_name = "dumptid" },
+		{ "dumptid" },
 #define	NLIST_PROC0		5
-		{ .n_name = "proc0" },
-		{ .n_name = NULL },
+		{ "proc0" },
+		{ NULL },
 	};
 	uintptr_t procp, tdp, credp;
 	lwpid_t dumptid;
