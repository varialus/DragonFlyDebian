---
 lib/libdevstat/Makefile  |    4 ++--
 lib/libdevstat/devstat.c |   10 +++++++---
 2 files changed, 9 insertions(+), 5 deletions(-)

--- a/lib/libdevstat/Makefile
+++ b/lib/libdevstat/Makefile
@@ -8,7 +8,7 @@
 INCS=	devstat.h
 
 DPADD=	${LIBKVM}
-LDADD=	-lkvm
+LDADD=	-lfreebsd -lrt ../libkvm/libkvm.so.0
 
 MAN=	devstat.3
 
@@ -31,7 +31,7 @@
 MLINKS+=devstat.3 compute_stats.3
 MLINKS+=devstat.3 compute_etime.3
 
-CFLAGS+=-I${.CURDIR}
+CFLAGS+=-I. -I../libkvm
 
 WARNS?=	2
 
--- a/lib/libdevstat/devstat.c
+++ b/lib/libdevstat/devstat.c
@@ -44,6 +44,7 @@
 #include <stdarg.h>
 #include <kvm.h>
 #include <nlist.h>
+#include <time.h>
 
 #include "devstat.h"
 
@@ -1562,8 +1563,8 @@
 {
 	struct nlist nl[2];
 
-	nl[0].n_name = (char *)name;
-	nl[1].n_name = NULL;
+	nl[0].n_un.n_name = (char *)name;
+	nl[1].n_un.n_name = NULL;
 
 	if (kvm_nlist(kd, nl) == -1) {
 		snprintf(devstat_errbuf, sizeof(devstat_errbuf),
@@ -1588,6 +1589,7 @@
 	struct devstatlist dhead;
 	int num_devs;
 	char *rv = NULL;
+	char *oldrv;
 
 	if ((num_devs = devstat_getnumdevs(kd)) <= 0)
 		return(NULL);
@@ -1615,9 +1617,11 @@
 			return(NULL);
 		}
 		nds = &ds;
-		rv = (char *)reallocf(rv, sizeof(gen) + 
+		oldrv = rv;
+		rv = (char *)realloc(rv, sizeof(gen) + 
 				      sizeof(ds) * (i + 1));
 		if (rv == NULL) {
+			free(oldrv);		
 			snprintf(devstat_errbuf, sizeof(devstat_errbuf), 
 				 "%s: out of memory (malloc failed)",
 				 __func__);
