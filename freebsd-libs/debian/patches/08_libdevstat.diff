---
 lib/libdevstat/Makefile  |    4 ++--
 lib/libdevstat/devstat.c |    6 +++++-
 2 files changed, 7 insertions(+), 3 deletions(-)

--- a/lib/libdevstat/Makefile
+++ b/lib/libdevstat/Makefile
@@ -8,7 +8,7 @@ SRCS=	devstat.c
 INCS=	devstat.h
 
 DPADD=	${LIBKVM}
-LDADD=	-lkvm
+LDADD=	-lrt ../libkvm/libkvm.so.0
 
 MAN=	devstat.3
 
@@ -31,7 +31,7 @@ MLINKS+=devstat.3 buildmatch.3
 MLINKS+=devstat.3 compute_stats.3
 MLINKS+=devstat.3 compute_etime.3
 
-CFLAGS+=-I${.CURDIR}
+CFLAGS+=-I. -I../libkvm
 
 WARNS?=	2
 
--- a/lib/libdevstat/devstat.c
+++ b/lib/libdevstat/devstat.c
@@ -45,6 +45,7 @@ __FBSDID("$FreeBSD$");
 #include <stdarg.h>
 #include <kvm.h>
 #include <nlist.h>
+#include <time.h>
 
 #include "devstat.h"
 
@@ -1589,6 +1590,7 @@ get_devstat_kvm(kvm_t *kd)
 	struct devstatlist dhead;
 	int num_devs;
 	char *rv = NULL;
+	char *oldrv;
 
 	if ((num_devs = devstat_getnumdevs(kd)) <= 0)
 		return(NULL);
@@ -1616,9 +1618,11 @@ get_devstat_kvm(kvm_t *kd)
 			return(NULL);
 		}
 		nds = &ds;
-		rv = (char *)reallocf(rv, sizeof(gen) + 
+		oldrv = rv;
+		rv = (char *)realloc(rv, sizeof(gen) + 
 				      sizeof(ds) * (i + 1));
 		if (rv == NULL) {
+			free(oldrv);		
 			snprintf(devstat_errbuf, sizeof(devstat_errbuf), 
 				 "%s: out of memory (malloc failed)",
 				 __func__);
