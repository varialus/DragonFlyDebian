
Sent to freebsd-hackers (2011-07-02)

--- a/sys/dev/aic7xxx/aicasm/Makefile
+++ b/sys/dev/aic7xxx/aicasm/Makefile
@@ -3,6 +3,10 @@
 #
 # $FreeBSD$
 
+.if !defined(OPSYS)
+OPSYS!=	uname -s
+.endif
+
 PROG=	aicasm
 
 CSRCS=	aicasm.c aicasm_symbol.c
@@ -14,8 +18,9 @@
 SRCS=	${GENHDRS} ${CSRCS} ${YSRCS} ${LSRCS}
 CLEANFILES+= ${GENHDRS} ${YSRCS:R:C/(.*)/\1.output/g}
 DPADD=	${LIBL}
-LDADD=	-ll
+LDADD=	-ll -ldb -lbsd
 WARNS?=	5
+NO_WERROR?=	1
 
 # Correct path for kernel builds
 # Don't rely on the kernel's .depend file
@@ -24,8 +29,15 @@
 DEPENDFILE=	.depend_aicasm
 .endif
 
+LIBBSD_CFLAGS!=	pkg-config --cflags libbsd-overlay
+CFLAGS+=	${LIBBSD_CFLAGS}
+
+# This would discard implicit include flags in upstream GCC
+.if ${OPSYS} == "FreeBSD"
 NOSTDINC=	-nostdinc
 CFLAGS+= ${NOSTDINC} -I/usr/include -I.
+.endif
+
 .ifdef MAKESRCPATH
 CFLAGS+= -I${MAKESRCPATH}
 .endif
--- a/sys/dev/aic7xxx/aicasm/aicasm_gram.y
+++ b/sys/dev/aic7xxx/aicasm/aicasm_gram.y
@@ -51,12 +51,7 @@
 #include <stdlib.h>
 #include <string.h>
 #include <sysexits.h>
-
-#ifdef __linux__
-#include "../queue.h"
-#else
 #include <sys/queue.h>
-#endif
 
 #include "aicasm.h"
 #include "aicasm_symbol.h"
@@ -1534,7 +1529,7 @@
 }
 
 static void
-add_macro_arg(const char *argtext, int argnum __unused)
+add_macro_arg(const char *argtext, int argnum)
 {
 	struct macro_arg *marg;
 	int retval;
--- a/sys/dev/aic7xxx/aicasm/aicasm_symbol.c
+++ b/sys/dev/aic7xxx/aicasm/aicasm_symbol.c
@@ -44,10 +44,11 @@
 
 #include <sys/types.h>
 
-#ifdef __linux__
-#include "aicdb.h"
+#include <sys/param.h>		/* BSD */
+#ifdef BSD
+#include <db.h>			/* BSD native libdb */
 #else
-#include <db.h>
+#include <db_185.h>		/* Sleepycat 1.85 compat */
 #endif
 #include <ctype.h>
 #include <fcntl.h>
--- a/sys/dev/aic7xxx/aicasm/aicasm.c
+++ b/sys/dev/aic7xxx/aicasm/aicasm.c
@@ -53,7 +53,7 @@
 #include <sysexits.h>
 #include <unistd.h>
 
-#if linux
+#ifdef __GLIBC__
 #include <endian.h>
 #else
 #include <machine/endian.h>
--- a/sys/dev/aic7xxx/aicasm/aicasm.h
+++ b/sys/dev/aic7xxx/aicasm/aicasm.h
@@ -42,11 +42,7 @@
  * $FreeBSD$
  */
 
-#ifdef __linux__
-#include "../queue.h"
-#else
 #include <sys/queue.h>
-#endif
 
 #ifndef TRUE
 #define TRUE 1
--- a/sys/dev/aic7xxx/aicasm/aicasm_macro_gram.y
+++ b/sys/dev/aic7xxx/aicasm/aicasm_macro_gram.y
@@ -51,12 +51,7 @@
 #include <stdlib.h>
 #include <string.h>
 #include <sysexits.h>
-
-#ifdef __linux__
-#include "../queue.h"
-#else
 #include <sys/queue.h>
-#endif
 
 #include "aicasm.h"
 #include "aicasm_symbol.h"
--- a/sys/dev/aic7xxx/aicasm/aicasm_macro_scan.l
+++ b/sys/dev/aic7xxx/aicasm/aicasm_macro_scan.l
@@ -51,11 +51,7 @@
 #include <stdio.h>
 #include <string.h>
 #include <sysexits.h>
-#ifdef __linux__
-#include "../queue.h"
-#else
 #include <sys/queue.h>
-#endif
 
 #include "aicasm.h"
 #include "aicasm_symbol.h"
--- a/sys/dev/aic7xxx/aicasm/aicasm_scan.l
+++ b/sys/dev/aic7xxx/aicasm/aicasm_scan.l
@@ -51,11 +51,7 @@
 #include <stdio.h>
 #include <string.h>
 #include <sysexits.h>
-#ifdef __linux__
-#include "../queue.h"
-#else
 #include <sys/queue.h>
-#endif
 
 #include "aicasm.h"
 #include "aicasm_symbol.h"
--- a/sys/dev/aic7xxx/aicasm/aicasm_symbol.h
+++ b/sys/dev/aic7xxx/aicasm/aicasm_symbol.h
@@ -42,11 +42,7 @@
  * $FreeBSD$
  */
 
-#ifdef __linux__
-#include "../queue.h"
-#else
 #include <sys/queue.h>
-#endif
 
 typedef enum {
 	UNINITIALIZED,
