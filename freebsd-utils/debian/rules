#!/usr/bin/make -f
# Sample debian/rules that uses cdbs.  Originaly written by Robert Millan.
# This file is public domain.
  
DEB_TAR_SRCDIR                  := src
DEB_AUTO_CLEANUP_RCS            := yes
DEB_UPDATE_RCD_PARAMS_freebsd-utils	:= "start 20 S ."
DEB_UPDATE_RCD_PARAMS_module-init-tools	:= "start 20 S ."
DEB_UPDATE_RCD_PARAMS_kbdcontrol	:= "start 48 S ."

package=freebsd-utils

SHELL:=bash
PATH:=/usr/lib/freebsd:$(PATH)
PMAKE=make COPTS="-D_GNU_SOURCE" NO_WERROR=1 NOGCCERROR=1 NOSHARED=NO NO_SHARED=NO
export LDADD=-lbsd -lfreebsd

include /usr/share/cdbs/1/rules/debhelper.mk
include /usr/share/cdbs/1/rules/tarball.mk
include /usr/share/cdbs/1/rules/patchsys-quilt.mk

build/freebsd-utils:: apply-patches
	set -e ; for i in sbin/{ccdconfig,dmesg,mdconfig,mount,mount_std,umount,swapon,sysctl} usr.sbin/rpc.umntall \
		sbin/mount_{autofs,cd9660,ext2fs,hpfs,msdosfs,ntfs,nullfs,reiserfs,udf,unionfs} \
		usr.bin/ktrace \
	; do \
		$(PMAKE) -C $(DEB_SRCDIR)/$$i ; \
	done
# FIXME: add mount_{xfs,nfs},chflags

build/module-init-tools:: apply-patches
	set -e ; for i in sbin/kld{load,stat,unload,config} \
	; do \
		$(PMAKE) -C $(DEB_SRCDIR)/$$i ; \
	done

build/net-tools:: apply-patches
	cp -p debian/pf_ruleset.c build-tree/src/sbin/pfctl/
	set -e ; for i in sbin/{ifconfig,route,pfctl} usr.sbin/authpf \
	; do \
		$(PMAKE) -C $(DEB_SRCDIR)/$$i ; \
	done
# FIXME: netstat

build/kbdcontrol:: apply-patches
	set -e ; for i in usr.sbin/kbdcontrol \
	; do \
		$(PMAKE) -C $(DEB_SRCDIR)/$$i ; \
	done
	sed -e "s/@choices@/`cd $(DEB_SRCDIR)/share/syscons/keymaps && echo *.kbd | sed -e \"s/ /, /g\"`/g" \
	< debian/kbdcontrol.templates.in > debian/kbdcontrol.templates

clean::
	rm -f debian/kbdcontrol.templates debian/stamp-sed

pre-build:: debian/stamp-sed
debian/stamp-sed: $(_cdbs_tarball_stamps)
	find $(DEB_SRCDIR) -name "*.[hcy]" | (set -e ; while read i ; do sed -i $$i \
		-e "/^__FBSDID/d" \
		-e "s/[ \t]*__\(dead2\|unused\|result\)[ \t]*/ /g" \
		-e "s,<sys/queue\.h>,<bsd/queue.h>,g" \
		-e "s/getline/bsd_&/g" \
	; done)
	find $(DEB_SRCDIR) -name Makefile | (set -e ; while read i ; do sed -i $$i \
		-e "s/^LDADD=/LDADD+=/g" \
	; done)
	set -e ; find $(DEB_SRCDIR)/contrib/pf/ -name "*.[hcy]" | (while read i ; do \
		sed -i $$i \
		-e 's/defined\( \|\t\)*(\( \|\t\)*__FreeBSD__\( \|\t\)*)/defined(__FreeBSD_kernel__)/g' \
		-e 's/#\( \|\t\)*ifdef\( \|\t\)*__FreeBSD__/#ifdef __FreeBSD_kernel__/g' \
		-e 's/#\( \|\t\)*ifndef\( \|\t\)*__FreeBSD__/#ifndef __FreeBSD_kernel__/g' \
	; done)
	touch debian/stamp-sed
