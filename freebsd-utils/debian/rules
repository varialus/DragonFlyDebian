#!/usr/bin/make -f
# Sample debian/rules that uses cdbs.  Originaly written by Robert Millan.
# This file is public domain.
  
DEB_TAR_SRCDIR                  := src
DEB_AUTO_CLEANUP_RCS            := yes
DEB_DH_INSTALLINIT_ARGS		:= --no-start --update-rcd-params="start 20 S ."

package=freebsd-utils

SHELL:=bash
PATH:=/usr/lib/freebsd:$(PATH)
PMAKE=make COPTS="-D_GNU_SOURCE" NO_WERROR=1 NOGCCERROR=1 NOSHARED=NO NO_SHARED=NO
export LDADD=-lbsd -lfreebsd

build/freebsd-utils:: apply-patches
	set -e ; for i in sbin/{dmesg,mdconfig,mount,mount_std,umount,swapon,sysctl} usr.sbin/rpc.umntall \
		sbin/mount_{autofs,ext2fs,hpfs,nullfs,reiserfs,unionfs} \
	; do \
		$(PMAKE) -C $(DEB_SRCDIR)/$$i ; \
	done
# FIXME: add mount_{xfs,cd9660,msdosfs,nfs,nfs4,ntfs,udf,umapfs},fdisk,bsdlabel

build/kldutils:: apply-patches
	set -e ; for i in sbin/kld{load,stat,unload} \
	; do \
		$(PMAKE) -C $(DEB_SRCDIR)/$$i ; \
	done
# FIXME: add kldconfig

build/net-tools:: apply-patches
	set -e ; for i in sbin/{ifconfig,route,netstat} \
	; do \
		$(PMAKE) -C $(DEB_SRCDIR)/$$i ; \
	done
# FIXME: enable in debian/control

clean::
	rm -f debian/kbdcontrol.templates

build/kbdcontrol:: apply-patches
	set -e ; for i in usr.sbin/kbdcontrol \
	; do \
		$(PMAKE) -C $(DEB_SRCDIR)/$$i ; \
	done
	sed -e "s/@choices@/`cd $(DEB_SRCDIR)/share/syscons/keymaps && echo *.kbd | sed -e \"s/ /, /g\"`/g" \
	< debian/kbdcontrol.templates.in > debian/kbdcontrol.templates

include /usr/share/cdbs/1/rules/tarball.mk
pre-build:: $(_cdbs_tarball_stamps)
	find $(DEB_SRCDIR) -type f | (set -e ; while read i ; do sed -i $$i \
		-e "/^__FBSDID/d" \
		-e "s/[ \t]*__\(dead2\|unused\|result\)[ \t]*//g" \
		-e "s,<sys/queue\.h>,<bsd/queue.h>,g" \
		-e "s,<sys/iconv\.h>,<iconv.h>,g" \
		-e "s/^LDADD=/LDADD+=/g" \
		-e "s/getline/bsd_&/g" \
	; done)


include /usr/share/cdbs/1/rules/debhelper.mk
include /usr/share/cdbs/1/rules/tarball.mk
include /usr/share/cdbs/1/rules/simple-patchsys.mk
