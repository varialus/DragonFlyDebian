#!/usr/bin/make -f

v		:= $(shell dpkg-parsechangelog | grep ^Version: | sed -e 's/^.*: //g' -e 's/[+-].*//g')
cpu		:= $(shell dpkg-architecture -qDEB_HOST_ARCH_CPU)

ifeq ($(cpu), amd64)
cpu := i386
endif

DEB_TAR_SRCDIR                  := kfreebsd-source-$(v)
#DEB_AUTO_CLEANUP_RCS            := yes

package=kfreebsd-loader

PATH:=/usr/lib/freebsd:$(PATH)
PMAKE=make COPTS="-D_GNU_SOURCE" NO_WERROR=1 NOGCCERROR=1 NOSHARED=NO NO_SHARED=NO
#export LDADD=-lbsd -lfreebsd

build/$(package):: apply-patches
	set -e ; for i in loader cdboot ; do \
		$(PMAKE) -C $(DEB_SRCDIR)/sys/boot/$(cpu)/$$i ; \
	done

clean::
	ln -sf /usr/src/kfreebsd-source-$(v).tar.bz2 src.tar.bz2

include /usr/share/cdbs/1/rules/tarball.mk

pre-build:: $(_cdbs_tarball_stamps)
	find $(DEB_SRCDIR)/sys/boot/ -type f | (set -e ; while read i ; do sed -i $$i \
		-e "/^__FBSDID/d" \
		-e "s/[ \t]*__\(dead2\|used\|unused\|result\|section\)[ \t]*//g" \
		-e "s,<sys/queue\.h>,<bsd/queue.h>,g" \
		-e "s,<sys/iconv\.h>,<iconv.h>,g" \
		-e "s/^LDADD=/LDADD+=/g" \
		-e "s/getline/bsd_&/g" \
	; done)

include /usr/share/cdbs/1/rules/debhelper.mk
include /usr/share/cdbs/1/rules/tarball.mk
include /usr/share/cdbs/1/rules/simple-patchsys.mk
