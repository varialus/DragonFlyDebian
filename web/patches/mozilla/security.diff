diff -Nur mozilla/security.old/coreconf/GNU.mk mozilla/security/coreconf/GNU.mk
--- mozilla/security.old/coreconf/GNU.mk	1970-01-01 01:00:00.000000000 +0100
+++ mozilla/security/coreconf/GNU.mk	2004-07-22 22:33:44.000000000 +0200
@@ -0,0 +1,37 @@
+#
+# The contents of this file are subject to the Mozilla Public
+# License Version 1.1 (the "License"); you may not use this file
+# except in compliance with the License. You may obtain a copy of
+# the License at http://www.mozilla.org/MPL/
+# 
+# Software distributed under the License is distributed on an "AS
+# IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
+# implied. See the License for the specific language governing
+# rights and limitations under the License.
+# 
+# The Original Code is the Netscape security libraries.
+# 
+# The Initial Developer of the Original Code is Netscape
+# Communications Corporation.  Portions created by Netscape are 
+# Copyright (C) 1994-2000 Netscape Communications Corporation.  All
+# Rights Reserved.
+# 
+# Contributor(s):
+# 
+# Alternatively, the contents of this file may be used under the
+# terms of the GNU General Public License Version 2 or later (the
+# "GPL"), in which case the provisions of the GPL are applicable 
+# instead of those above.  If you wish to allow use of your 
+# version of this file only under the terms of the GPL and not to
+# allow others to use your version of this file under the MPL,
+# indicate your decision by deleting the provisions above and
+# replace them with the notice and other provisions required by
+# the GPL.  If you do not delete the provisions above, a recipient
+# may use your version of this file under either the MPL or the
+# GPL.
+#
+# Config stuff for GNU
+#
+
+KERNEL=gnumach
+include $(CORE_DEPTH)/coreconf/Linux.mk
diff -Nur mozilla/security.old/coreconf/GNU_kFreeBSD.mk mozilla/security/coreconf/GNU_kFreeBSD.mk
--- mozilla/security.old/coreconf/GNU_kFreeBSD.mk	1970-01-01 01:00:00.000000000 +0100
+++ mozilla/security/coreconf/GNU_kFreeBSD.mk	2004-07-22 22:33:54.000000000 +0200
@@ -0,0 +1,37 @@
+#
+# The contents of this file are subject to the Mozilla Public
+# License Version 1.1 (the "License"); you may not use this file
+# except in compliance with the License. You may obtain a copy of
+# the License at http://www.mozilla.org/MPL/
+# 
+# Software distributed under the License is distributed on an "AS
+# IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
+# implied. See the License for the specific language governing
+# rights and limitations under the License.
+# 
+# The Original Code is the Netscape security libraries.
+# 
+# The Initial Developer of the Original Code is Netscape
+# Communications Corporation.  Portions created by Netscape are 
+# Copyright (C) 1994-2000 Netscape Communications Corporation.  All
+# Rights Reserved.
+# 
+# Contributor(s):
+# 
+# Alternatively, the contents of this file may be used under the
+# terms of the GNU General Public License Version 2 or later (the
+# "GPL"), in which case the provisions of the GPL are applicable 
+# instead of those above.  If you wish to allow use of your 
+# version of this file only under the terms of the GPL and not to
+# allow others to use your version of this file under the MPL,
+# indicate your decision by deleting the provisions above and
+# replace them with the notice and other provisions required by
+# the GPL.  If you do not delete the provisions above, a recipient
+# may use your version of this file under either the MPL or the
+# GPL.
+#
+# Config stuff for GNU/kFreeBSD
+#
+
+KERNEL=kfreebsd
+include $(CORE_DEPTH)/coreconf/Linux.mk
diff -Nur mozilla/security.old/coreconf/GNU_kNetBSD.mk mozilla/security/coreconf/GNU_kNetBSD.mk
--- mozilla/security.old/coreconf/GNU_kNetBSD.mk	1970-01-01 01:00:00.000000000 +0100
+++ mozilla/security/coreconf/GNU_kNetBSD.mk	2004-07-22 22:34:01.000000000 +0200
@@ -0,0 +1,37 @@
+#
+# The contents of this file are subject to the Mozilla Public
+# License Version 1.1 (the "License"); you may not use this file
+# except in compliance with the License. You may obtain a copy of
+# the License at http://www.mozilla.org/MPL/
+# 
+# Software distributed under the License is distributed on an "AS
+# IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
+# implied. See the License for the specific language governing
+# rights and limitations under the License.
+# 
+# The Original Code is the Netscape security libraries.
+# 
+# The Initial Developer of the Original Code is Netscape
+# Communications Corporation.  Portions created by Netscape are 
+# Copyright (C) 1994-2000 Netscape Communications Corporation.  All
+# Rights Reserved.
+# 
+# Contributor(s):
+# 
+# Alternatively, the contents of this file may be used under the
+# terms of the GNU General Public License Version 2 or later (the
+# "GPL"), in which case the provisions of the GPL are applicable 
+# instead of those above.  If you wish to allow use of your 
+# version of this file only under the terms of the GPL and not to
+# allow others to use your version of this file under the MPL,
+# indicate your decision by deleting the provisions above and
+# replace them with the notice and other provisions required by
+# the GPL.  If you do not delete the provisions above, a recipient
+# may use your version of this file under either the MPL or the
+# GPL.
+#
+# Config stuff for GNU/kNetBSD
+#
+
+KERNEL=knetbsd
+include $(CORE_DEPTH)/coreconf/Linux.mk
diff -Nur mozilla/security.old/coreconf/Linux.mk mozilla/security/coreconf/Linux.mk
--- mozilla/security.old/coreconf/Linux.mk	2004-07-22 18:16:28.000000000 +0200
+++ mozilla/security/coreconf/Linux.mk	2004-07-22 22:35:29.000000000 +0200
@@ -30,7 +30,7 @@
 # may use your version of this file under either the MPL or the
 # GPL.
 #
-# Config stuff for Linux
+# Config stuff for GNU and variants
 #
 
 include $(CORE_DEPTH)/coreconf/UNIX.mk
@@ -51,70 +51,70 @@
 DEFAULT_COMPILER = gcc
 
 ifeq ($(OS_TEST),m68k)
-	OS_REL_CFLAGS	= -DLINUX1_2 -D_XOPEN_SOURCE
+	OS_REL_CFLAGS	= -D_XOPEN_SOURCE
 	CPU_ARCH	= m68k
 else		
 ifeq ($(OS_TEST),ppc)
-	OS_REL_CFLAGS	= -DLINUX1_2 -D_XOPEN_SOURCE
+	OS_REL_CFLAGS	= -D_XOPEN_SOURCE
 	CPU_ARCH	= ppc
 else
 ifeq ($(OS_TEST),alpha)
-        OS_REL_CFLAGS   = -D_ALPHA_ -DLINUX1_2 -D_XOPEN_SOURCE
+        OS_REL_CFLAGS   = -D_ALPHA_ -D_XOPEN_SOURCE
 	CPU_ARCH	= alpha
 else
 ifeq ($(OS_TEST),ia64)
-	OS_REL_CFLAGS	= -DLINUX1_2 -D_XOPEN_SOURCE
+	OS_REL_CFLAGS	= -D_XOPEN_SOURCE
 	CPU_ARCH	= ia64
 else
 ifeq ($(OS_TEST),x86_64)
-	OS_REL_CFLAGS	= -DLINUX1_2 -D_XOPEN_SOURCE
+	OS_REL_CFLAGS	= -D_XOPEN_SOURCE
 	CPU_ARCH	= x86_64
 else
 ifeq ($(OS_TEST),sparc)
-	OS_REL_CFLAGS   = -DLINUX1_2 -D_XOPEN_SOURCE
+	OS_REL_CFLAGS   = -D_XOPEN_SOURCE
 	CPU_ARCH        = sparc
 else
 ifeq ($(OS_TEST),sparc64)
-	OS_REL_CFLAGS   = -DLINUX1_2 -D_XOPEN_SOURCE
+	OS_REL_CFLAGS   = -D_XOPEN_SOURCE
 	CPU_ARCH        = sparc
 else
 ifeq (,$(filter-out arm% sa110,$(OS_TEST)))
-	OS_REL_CFLAGS   = -DLINUX1_2 -D_XOPEN_SOURCE
+	OS_REL_CFLAGS   = -D_XOPEN_SOURCE
 	CPU_ARCH        = arm
 else
 ifeq ($(OS_TEST),parisc)
-	OS_REL_CFLAGS   = -DLINUX1_2 -D_XOPEN_SOURCE
+	OS_REL_CFLAGS   = -D_XOPEN_SOURCE
 	CPU_ARCH        = hppa
 else
 ifeq ($(OS_TEST),parisc64)
-	OS_REL_CFLAGS   = -DLINUX1_2 -D_XOPEN_SOURCE
+	OS_REL_CFLAGS   = -D_XOPEN_SOURCE
 	CPU_ARCH        = hppa
 else
 ifeq ($(OS_TEST),s390)
-	OS_REL_CFLAGS   = -DLINUX1_2 -D_XOPEN_SOURCE
+	OS_REL_CFLAGS   = -D_XOPEN_SOURCE
 	CPU_ARCH        = s390
 else
 ifeq ($(OS_TEST),s390x)
-	OS_REL_CFLAGS   = -DLINUX1_2 -D_XOPEN_SOURCE
+	OS_REL_CFLAGS   = -D_XOPEN_SOURCE
 	CPU_ARCH        = s390x
 else
 ifeq ($(OS_TEST),mips)
-	OS_REL_CFLAGS   = -DLINUX1_2 -D_XOPEN_SOURCE
+	OS_REL_CFLAGS   = -D_XOPEN_SOURCE
 	CPU_ARCH        = mips
 else
 ifeq ($(OS_TEST),parisc)
-       OS_REL_CFLAGS   = -DLINUX1_2 -D_XOPEN_SOURCE
+       OS_REL_CFLAGS   = -D_XOPEN_SOURCE
        CPU_ARCH        = hppa
 else
 ifeq ($(OS_TEST),parisc64)
-       OS_REL_CFLAGS   = -DLINUX1_2 -D_XOPEN_SOURCE
+       OS_REL_CFLAGS   = -D_XOPEN_SOURCE
        CPU_ARCH        = hppa
 else
 ifeq ($(OS_TEST),s390)
-	OS_REL_CFLAGS	= -DLINUX1_2 -D_XOPEN_SOURCE
+	OS_REL_CFLAGS	= -D_XOPEN_SOURCE
 	CPU_ARCH	= s390
 else
-	OS_REL_CFLAGS	= -DLINUX1_2 -Di386 -D_XOPEN_SOURCE
+	OS_REL_CFLAGS	= -Di386 -D_XOPEN_SOURCE
 	CPU_ARCH	= x86
 endif
 endif
@@ -133,10 +133,13 @@
 endif
 endif
 
+ifeq ($(KERNEL),linux)
+OS_REL_CFLAGS	= -DLINUX1_2
+endif
 
 LIBC_TAG		= _glibc
 
-ifeq ($(OS_RELEASE),2.0)
+ifeq ($(KERNEL)-$(OS_RELEASE),linux-2.0)
 	OS_REL_CFLAGS	+= -DLINUX2_0
 	MKSHLIB		= $(CC) -shared -Wl,-soname -Wl,$(@:$(OBJDIR)/%.so=%.so)
 	ifdef BUILD_OPT
@@ -153,20 +156,27 @@
 OS_PTHREAD = -lpthread 
 endif
 
-OS_CFLAGS		= $(DSO_CFLAGS) $(OS_REL_CFLAGS) -ansi -Wall -pipe -DLINUX -Dlinux -D_POSIX_SOURCE -D_BSD_SOURCE -DHAVE_STRERROR
+OS_CFLAGS		= $(DSO_CFLAGS) $(OS_REL_CFLAGS) -ansi -Wall -pipe -D_POSIX_SOURCE -D_BSD_SOURCE -DHAVE_STRERROR
 OS_LIBS			= -L/lib $(OS_PTHREAD) -ldl -lc
+ifeq ($(KERNEL),linux)
+OS_CFLAGS += -DLINUX -Dlinux
+endif
 
 ifdef USE_PTHREADS
 	DEFINES		+= -D_REENTRANT
 endif
 
+ifeq ($(KERNEL),linux)
 ARCH			= linux
+else
+ARCH			= gnu
+endif
 
 DSO_CFLAGS		= -fPIC
 DSO_LDOPTS		= -shared
 DSO_LDFLAGS		=
 
-# INCLUDES += -I/usr/include -Y/usr/include/linux
+# INCLUDES += -I/usr/include
 G++INCLUDES		= -I/usr/include/g++
 
 #
diff -Nur mozilla/security.old/coreconf/config.mk mozilla/security/coreconf/config.mk
--- mozilla/security.old/coreconf/config.mk	2004-01-28 01:01:56.000000000 +0100
+++ mozilla/security/coreconf/config.mk	2004-07-22 20:51:38.000000000 +0200
@@ -59,7 +59,7 @@
 #######################################################################
 
 TARGET_OSES = FreeBSD BSD_OS NetBSD OpenUNIX OS2 QNX Darwin BeOS OpenBSD \
-              OpenVMS AIX
+              OpenVMS AIX GNU GNU_kFreeBSD GNU_kNetBSD
 
 ifeq (,$(filter-out $(TARGET_OSES),$(OS_TARGET)))
 include $(CORE_DEPTH)/coreconf/$(OS_TARGET).mk
diff -Nur mozilla/security.old/nss/lib/freebl/ecl/Makefile mozilla/security/nss/lib/freebl/ecl/Makefile
--- mozilla/security.old/nss/lib/freebl/ecl/Makefile	2003-10-17 15:45:34.000000000 +0200
+++ mozilla/security/nss/lib/freebl/ecl/Makefile	2004-07-22 21:34:39.000000000 +0200
@@ -65,7 +65,7 @@
 ifeq ($(TARGET),v8SOLARIS)
 ECL_USE_FP=1
 else
-ifeq ($(TARGET),x86LINUX)
+ifeq (,)
 ECL_USE_FP=1
 endif
 endif
diff -Nur mozilla/security.old/nss/lib/freebl/mpi/target.mk mozilla/security/nss/lib/freebl/mpi/target.mk
--- mozilla/security.old/nss/lib/freebl/mpi/target.mk	2003-10-17 15:45:36.000000000 +0200
+++ mozilla/security/nss/lib/freebl/mpi/target.mk	2004-07-22 21:34:14.000000000 +0200
@@ -203,13 +203,13 @@
 export OBJECT_MODE
 endif
 
-ifeq ($(TARGET),x86LINUX)
+ifeq (,)
 #Linux
 AS_OBJS = mpi_x86.o
 MPICMN += -DMP_ASSEMBLY_MULTIPLY -DMP_ASSEMBLY_SQUARE -DMP_ASSEMBLY_DIV_2DX1D
 MPICMN += -DMP_MONT_USE_MP_MUL
-CFLAGS= -O2 -fPIC -DLINUX1_2 -Di386 -D_XOPEN_SOURCE -DLINUX2_1 -ansi -Wall \
- -pipe -DLINUX -Dlinux -D_POSIX_SOURCE -D_BSD_SOURCE -DHAVE_STRERROR \
+CFLAGS= -O2 -fPIC -Di386 -D_XOPEN_SOURCE -ansi -Wall \
+ -pipe -D_POSIX_SOURCE -D_BSD_SOURCE -DHAVE_STRERROR \
  -DXP_UNIX -UDEBUG -DNDEBUG -D_REENTRANT $(MPICMN)
 #CFLAGS= -g -fPIC -DLINUX1_2 -Di386 -D_XOPEN_SOURCE -DLINUX2_1 -ansi -Wall \
  -pipe -DLINUX -Dlinux -D_POSIX_SOURCE -D_BSD_SOURCE -DHAVE_STRERROR \
