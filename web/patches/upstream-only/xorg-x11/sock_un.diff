Author: Petr Salinger
Status: Submitted upstream as bug #4982 (https://bugs.freedesktop.org/show_bug.cgi?id=4982)

Index: xc/lib/dps/csconndi.c
===================================================================
--- xc/lib/dps/csconndi.c.orig	2006-01-09 19:56:33.483548000 +0100
+++ xc/lib/dps/csconndi.c	2006-01-09 20:00:52.000000000 +0100
@@ -506,7 +506,7 @@
     sprintf (unaddr.sun_path, "%s_%d", CSDPS_UNIX_PATH, port);
 
     addr = (struct sockaddr *) &unaddr;
-    addrlen = strlen(unaddr.sun_path) + sizeof(unaddr.sun_family);
+    addrlen = strlen(unaddr.sun_path) + offsetof(struct sockaddr_un, sun_path);
 
     /*
      * Open the network connection.
Index: xc/lib/xtrans/Xtranssock.c
===================================================================
--- xc/lib/xtrans/Xtranssock.c.orig	2006-01-09 19:57:04.000000000 +0100
+++ xc/lib/xtrans/Xtranssock.c	2006-01-09 20:00:52.000000000 +0100
@@ -1111,7 +1111,7 @@
     sockname.sun_len = strlen(sockname.sun_path);
     namelen = SUN_LEN(&sockname);
 #else
-    namelen = strlen(sockname.sun_path) + sizeof(sockname.sun_family);
+    namelen = strlen(sockname.sun_path) + offsetof(struct sockaddr_un, sun_path);
 #endif
 
     unlink (sockname.sun_path);
@@ -2001,7 +2001,7 @@
     sockname.sun_len = strlen (sockname.sun_path);
     namelen = SUN_LEN (&sockname);
 #else
-    namelen = strlen (sockname.sun_path) + sizeof (sockname.sun_family);
+    namelen = strlen (sockname.sun_path) + offsetof(struct sockaddr_un, sun_path);
 #endif
 
 
@@ -2015,7 +2015,7 @@
 	return TRANS_CONNECT_FAILED;
     }
     old_namelen = strlen (old_sockname.sun_path) +
-	sizeof (old_sockname.sun_family);
+    	offsetof(struct sockaddr_un, sun_path);
 #endif
 
 
