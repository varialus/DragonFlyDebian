
Author: rmh
Status: upstream rejected/ignored it

diff -Nur cdrtools-2.01.old/README.FreeBSD cdrtools-2.01/README.FreeBSD
--- cdrtools-2.01.old/README.FreeBSD	2004-05-19 16:11:07.000000000 +0200
+++ cdrtools-2.01/README.FreeBSD	2005-08-18 13:54:42.000000000 +0200
@@ -1,42 +1,14 @@
-Important notice for ATAPI support on FreeBSD:
+Important notice for ATAPI support on FreeBSD and derivatives:
 
-A long time it was not possible to decently write CD's using ATAPI drives
-on FreeBSD because ATAPI was not supported in an orthogonal way on FreeBSD.
+FreeBSD releases starting with 4.8 include ATAPI/CAM support; For FreeBSD 4.x,
+follow the instructions in /sys/conf/LINT.
 
-These days (in the mid of november 2001) first ATAPI support for FreeBSD is
-available as patch. Please read:
+FreeBSD releases starting with 5.0 include ATAPI/CAM support.  For FreeBSD 5.x,
+follow the instructions in /sys/conf/NOTES.
 
-http://www.freebsd.org/cgi/getmsg.cgi?fetch=136602+0+/usr/local/www/db/text/2001/freebsd-current/20011111.freebsd-current
-
-and get the FreeBSD kernel patch from:
-
-http://www.cuivre.fr.eu.org/~thomas/atapicam/
-
-Thanks to Thomas Quinot <thomas@cuivre.fr.eu.org> for the patch.
-
-We tested the patch with a collegue today (23.11.2001), here is the result:
-
--	From our tests, it compiles with FreeBSD 4.x and FreeBSD current (5.0)
-	but does not boot with FreeBSD current so we used 4.x for our tests
-	I hope that Thomas Quinot <thomas@cuivre.fr.eu.org> and
-	Kenneth D. Merry <ken@kdm.org> will help to make it work with
-	FreeBSD current soon.
-
--	The Author of the patch, Thomas Quinot <thomas@cuivre.fr.eu.org>, observed
-	that it runs on *some* -CURRENT machines and hangs on *some* -STABLE
-	machines so you may want to test what works best for you.
-
--	It does not run the SCSI commands in silent mode so the ATAPI low level
-	code prints unwanted kernel messages when you start cdrecord.
-
--	cdrecord runs without problems so far it has been tested!
-
-You need to apply the patch, change your kernel configuration to include
-
-options                ATAPICAM
-
-and then recompile install and boot the new kernel.
-Make enough /dev/pass* devices and start testing.....
+GNU/kFreeBSD systems are based on kernel of FreeBSD 5.0 or later, which includes
+ATAPI/CAM support.  It is probably enabled in default kernels (consult your
+distribution's documentation).
 
 /*--------------------------------------------------------------------------*/
 From shamrock@cypherpunks.to Mon May  3 07:35:50 1999
diff -Nur cdrtools-2.01.old/RULES/os-gnu-kfreebsd.def cdrtools-2.01/RULES/os-gnu-kfreebsd.def
--- cdrtools-2.01.old/RULES/os-gnu-kfreebsd.def	1970-01-01 01:00:00.000000000 +0100
+++ cdrtools-2.01/RULES/os-gnu-kfreebsd.def	2005-08-18 13:51:58.000000000 +0200
@@ -0,0 +1,23 @@
+#ident "@(#)os-gnu-kfreebsd.def	1.1 05/08/18 "
+###########################################################################
+# Written 1997 by J. Schilling
+###########################################################################
+#
+# Global os definitions for GNU/kFreeBSD
+#
+###########################################################################
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2, or (at your option)
+# any later version.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+# 
+# You should have received a copy of the GNU General Public License
+# along with this program; see the file COPYING.  If not, write to
+# the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
+###########################################################################
+MANSTYLE=	bsd
diff -Nur cdrtools-2.01.old/cdda2wav/interface.c cdrtools-2.01/cdda2wav/interface.c
--- cdrtools-2.01.old/cdda2wav/interface.c	2004-08-05 11:57:27.000000000 +0200
+++ cdrtools-2.01/cdda2wav/interface.c	2005-08-18 13:19:10.000000000 +0200
@@ -439,12 +439,12 @@
 #endif
 #endif
        break;
-#if defined (__linux__) || defined (__FreeBSD__)
+#if defined (__linux__) || defined (__FreeBSD__) || defined(__FreeBSD_kernel__)
 #if defined (__linux__)
     case SCSI_CDROM_MAJOR:     /* scsi cd */
     default:			/* for example ATAPI cds */
 #else
-#if defined (__FreeBSD__)
+#if defined (__FreeBSD__) || defined(__FreeBSD_kernel__)
     case 117:
 	if (!S_ISCHR(statstruct->st_mode)) {
 	    fprintf(stderr, "%s is not a char device\n",pdev_name);
diff -Nur cdrtools-2.01.old/cdda2wav/ioctl.c cdrtools-2.01/cdda2wav/ioctl.c
--- cdrtools-2.01.old/cdda2wav/ioctl.c	2003-12-27 17:29:28.000000000 +0100
+++ cdrtools-2.01/cdda2wav/ioctl.c	2005-08-18 13:19:10.000000000 +0200
@@ -156,7 +156,7 @@
 	    fprintf( stderr, "can't get TocEntry #%d lba (error %d).\n", i+1, err );
 	    exit( MEDIA_ERROR );
 	}
-#ifdef	__FreeBSD__
+#if defined(__FreeBSD__) || defined(__FreeBSD_kernel__)
 	entry[i].cdte_addr.lba = be32_to_cpu(entry[i].cdte_addr.lba);
 #endif
     }
@@ -168,7 +168,7 @@
 	fprintf( stderr, "can't get TocEntry LEADOUT lba (error %d).\n", err );
 	exit( MEDIA_ERROR );
     }
-#ifdef	__FreeBSD__
+#if defined(__FreeBSD__) || defined(__FreeBSD_kernel__)
     entry[i].cdte_addr.lba = be32_to_cpu(entry[i].cdte_addr.lba);
 #endif
 
@@ -196,7 +196,7 @@
 {
       /* trash the cache */
 
-#if	defined __FreeBSD__
+#if	defined(__FreeBSD__) || defined(__FreeBSD_kernel__)
       static struct cdrom_read_audio arg2;
 
       arg2.address.lba = find_an_off_sector(lSector, SectorBurstVal);
@@ -266,7 +266,7 @@
   static int nothing_read = 1;
 
 /* read 2352 bytes audio data */
-#if	defined __FreeBSD__
+#if	defined(__FreeBSD__) || defined(__FreeBSD_kernel__)
   arg.address.lba = lSector;
   arg.addr_format = CDROM_LBA;
   arg.nframes = SectorBurstVal;
@@ -395,7 +395,7 @@
 {
     struct cdrom_subchnl sub_ch;
 
-#if	defined __FreeBSD__
+#if	defined(__FreeBSD__) || defined(__FreeBSD_kernel__)
     struct cd_sub_channel_info sub_ch_info;
 
     if (x && x->verbose) {
@@ -433,7 +433,7 @@
           return NULL;
       }
       case GET_POSITIONDATA:
-#if	defined __FreeBSD__
+#if	defined(__FreeBSD__) || defined(__FreeBSD_kernel__)
       sub_ch.data_format = CD_CURRENT_POSITION;
 #endif
 #if defined (__linux__)
diff -Nur cdrtools-2.01.old/cdda2wav/mycdrom.h cdrtools-2.01/cdda2wav/mycdrom.h
--- cdrtools-2.01.old/cdda2wav/mycdrom.h	2002-09-04 14:07:16.000000000 +0200
+++ cdrtools-2.01/cdda2wav/mycdrom.h	2005-08-18 13:19:11.000000000 +0200
@@ -52,7 +52,7 @@
 
 #   endif /* if 0 */
 #  else /* not Sun SVR4 */
-#   if defined __FreeBSD__ || defined __NetBSD__ || defined __OpenBSD__
+#   if defined __FreeBSD__ || defined __FreeBSD_kernel__ || defined __NetBSD__ || defined __OpenBSD__
 #    if !defined CDIOCREADAUDIO
 #     undef HAVE_IOCTL_INTERFACE
 #    else
diff -Nur cdrtools-2.01.old/libscg/scsihack.c cdrtools-2.01/libscg/scsihack.c
--- cdrtools-2.01.old/libscg/scsihack.c	2003-11-28 02:33:18.000000000 +0100
+++ cdrtools-2.01/libscg/scsihack.c	2005-08-18 13:19:11.000000000 +0200
@@ -129,7 +129,7 @@
 
 #endif	/* linux */
 
-#if	defined(__FreeBSD__) || defined(__NetBSD__) || defined(__OpenBSD__)
+#if	defined(__FreeBSD__) || defined(__FreeBSD_kernel__) || defined(__NetBSD__) || defined(__OpenBSD__)
 #define	SCSI_IMPL		/* We have a SCSI implementation for *BSD */
 
 #include "scsi-bsd.c"
