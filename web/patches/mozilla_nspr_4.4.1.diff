
Note: This is an essential component for porting Mozilla. For details, see
      http://www.mozilla.org/projects/nspr/

Status: Won't merge yet. It fails to pass the test suite (in pr/tests)

diff -Nur nspr-4.4.1.old/mozilla/nsprpub/config/GNU.mk nspr-4.4.1/mozilla/nsprpub/config/GNU.mk
--- nspr-4.4.1.old/mozilla/nsprpub/config/GNU.mk	1970-01-01 01:00:00.000000000 +0100
+++ nspr-4.4.1/mozilla/nsprpub/config/GNU.mk	2004-07-28 01:38:24.000000000 +0200
@@ -0,0 +1,2 @@
+define_linux = no
+include $(MOD_DEPTH)/config/Linux.mk
diff -Nur nspr-4.4.1.old/mozilla/nsprpub/config/Linux.mk nspr-4.4.1/mozilla/nsprpub/config/Linux.mk
--- nspr-4.4.1.old/mozilla/nsprpub/config/Linux.mk	2002-06-14 00:00:29.000000000 +0200
+++ nspr-4.4.1/mozilla/nsprpub/config/Linux.mk	2004-07-28 01:38:17.000000000 +0200
@@ -41,6 +41,12 @@
 
 include $(MOD_DEPTH)/config/UNIX.mk
 
+ifeq ($(define_linux),)
+define_linux = -DLINUX
+else
+define_linux =
+endif
+
 #
 # XXX
 # Temporary define for the Client; to be removed when binary release is used
@@ -81,7 +87,7 @@
 OS_INCLUDES		=
 G++INCLUDES		= -I/usr/include/g++
 
-PLATFORM_FLAGS		= -ansi -Wall -pipe -DLINUX
+PLATFORM_FLAGS		= -ansi -Wall -pipe $(define_linux)
 PORT_FLAGS		= -D_POSIX_SOURCE -D_BSD_SOURCE -D_SVID_SOURCE -DHAVE_STRERROR -DHAVE_FCNTL_FILE_LOCKING
 
 OS_CFLAGS		= $(DSO_CFLAGS) $(PLATFORM_FLAGS) $(PORT_FLAGS)
diff -Nur nspr-4.4.1.old/mozilla/nsprpub/config/arch.mk nspr-4.4.1/mozilla/nsprpub/config/arch.mk
--- nspr-4.4.1.old/mozilla/nsprpub/config/arch.mk	2001-02-21 18:13:05.000000000 +0100
+++ nspr-4.4.1/mozilla/nsprpub/config/arch.mk	2004-07-28 01:38:17.000000000 +0200
@@ -116,6 +116,9 @@
 OS_ARCH		:= UNIXWARE
 OS_RELEASE	:= $(shell uname -v)
 endif
+ifneq (,$(findstring GNU/,$(OS_ARCH)))
+OS_ARCH		:= GNU
+endif
 
 #
 # Handle FreeBSD 2.2-STABLE and Linux 2.0.30-osfmach3
diff -Nur nspr-4.4.1.old/mozilla/nsprpub/config/nsinstall.c nspr-4.4.1/mozilla/nsprpub/config/nsinstall.c
--- nspr-4.4.1.old/mozilla/nsprpub/config/nsinstall.c	2002-12-12 01:28:25.000000000 +0100
+++ nspr-4.4.1/mozilla/nsprpub/config/nsinstall.c	2004-07-28 01:38:17.000000000 +0200
@@ -95,7 +95,7 @@
 }
 #endif /* NEXTSTEP */
 
-#ifdef LINUX
+#if defined(LINUX) || defined(__GNU__) || defined(__GLIBC__)
 #include <getopt.h>
 #endif
 
diff -Nur nspr-4.4.1.old/mozilla/nsprpub/configure.in nspr-4.4.1/mozilla/nsprpub/configure.in
--- nspr-4.4.1.old/mozilla/nsprpub/configure.in	2003-11-25 01:09:04.000000000 +0100
+++ nspr-4.4.1/mozilla/nsprpub/configure.in	2004-07-28 01:38:17.000000000 +0200
@@ -919,6 +919,7 @@
     fi
     AC_DEFINE(XP_UNIX)
     AC_DEFINE(FREEBSD)
+    AC_DEFINE(KFREEBSD)
     AC_DEFINE(HAVE_BSD_FLOCK)
     CFLAGS="$CFLAGS $(DSO_CFLAGS) -ansi -Wall"
     MOZ_OBJFORMAT=`test -x /usr/bin/objformat && /usr/bin/objformat || echo aout`
@@ -1173,7 +1174,7 @@
 	esac
     ;;
 
-*-linux*)
+*-linux* | *-gnu* | *-k*bsd*-gnu)
     if test -z "$USE_NSPR_THREADS"; then
         USE_PTHREADS=1
         IMPL_STRATEGY=_PTH
@@ -1184,7 +1185,12 @@
     AC_DEFINE(_SVID_SOURCE)
     AC_DEFINE(_LARGEFILE64_SOURCE)
     AC_DEFINE(HAVE_FCNTL_FILE_LOCKING)
-    AC_DEFINE(LINUX)
+    case "$target" in
+      *-linux*) AC_DEFINE(LINUX) ;;
+      *-kfreebsd*-gnu) AC_DEFINE(KFREEBSD) ;;
+      *-knetbsd*-gnu) AC_DEFINE(KNETBSD) ;;
+      *-gnu*) AC_DEFINE(HURD) ;;
+    esac
     CFLAGS="$CFLAGS -ansi -Wall"
     CXXFLAGS="$CXXFLAGS -ansi -Wall"
     MDCPUCFG_H=_linux.cfg
@@ -1407,6 +1413,7 @@
 *-netbsd*)
     AC_DEFINE(XP_UNIX)
     AC_DEFINE(NETBSD)
+    AC_DEFINE(KNETBSD)
     AC_DEFINE(HAVE_BSD_FLOCK)
     USE_NSPR_THREADS=1
     MDCPUCFG_H=_netbsd.cfg
@@ -2182,7 +2189,7 @@
 	        _PTHREAD_LDFLAGS=
 	    fi
 	    ;;
-    *-linux*)
+    *-linux* | *-gnu* | *-k*bsd*-gnu)
         AC_DEFINE(_REENTRANT)
         ;;
     esac
@@ -2266,7 +2273,7 @@
         fi
     fi
     ;;
-*-linux*)
+*-linux* | *-gnu* | *-k*bsd*-gnu)
     if test -n "$USE_NSPR_THREADS"; then
         AC_DEFINE(_PR_LOCAL_THREADS_ONLY)
     fi
diff -Nur nspr-4.4.1.old/mozilla/nsprpub/pr/include/md/_linux.cfg nspr-4.4.1/mozilla/nsprpub/pr/include/md/_linux.cfg
--- nspr-4.4.1.old/mozilla/nsprpub/pr/include/md/_linux.cfg	2003-01-23 18:03:19.000000000 +0100
+++ nspr-4.4.1/mozilla/nsprpub/pr/include/md/_linux.cfg	2004-07-28 01:38:17.000000000 +0200
@@ -39,7 +39,7 @@
 #define XP_UNIX
 #endif
 
-#ifndef LINUX
+#if !defined(LINUX) && defined(__linux__)
 #define LINUX
 #endif
 
diff -Nur nspr-4.4.1.old/mozilla/nsprpub/pr/include/md/_pth.h nspr-4.4.1/mozilla/nsprpub/pr/include/md/_pth.h
--- nspr-4.4.1.old/mozilla/nsprpub/pr/include/md/_pth.h	2002-12-12 00:10:39.000000000 +0100
+++ nspr-4.4.1/mozilla/nsprpub/pr/include/md/_pth.h	2004-07-28 01:38:17.000000000 +0200
@@ -35,6 +35,17 @@
 #ifndef nspr_pth_defs_h_
 #define nspr_pth_defs_h_
 
+#if defined(LINUX)
+#elif defined(__GNU__)
+# define HURD_PTHREAD /* may switch to libpth or NPTL */
+# error Using Hurd pthreads?
+  /* Apparently, you need to find an invalid pthread_t value for the macros
+     below. However, it seems that Hurd pthreads don't have such. (rmh) */
+#elif defined(__GLIBC__)
+  /* fallback case, e.g. for GNU/k*BSD */
+# define LIBPTH
+#endif
+
 /*
 ** Appropriate definitions of entry points not used in a pthreads world
 */
@@ -136,7 +147,7 @@
 	(!memcmp(&(t), &pt_zero_tid, sizeof(pthread_t)))
 #define _PT_PTHREAD_COPY_THR_HANDLE(st, dt)   (dt) = (st)
 #elif defined(IRIX) || defined(OSF1) || defined(AIX) || defined(SOLARIS) \
-	|| defined(HPUX) || defined(LINUX) || defined(FREEBSD) \
+	|| defined(HPUX) || defined(LINUX) || defined(LIBPTH) || defined(FREEBSD) \
 	|| defined(NETBSD) || defined(OPENBSD) || defined(BSDI) \
 	|| defined(VMS) || defined(NTO) || defined(DARWIN) \
 	|| defined(UNIXWARE)
@@ -188,7 +199,7 @@
 /*
  * These platforms don't have sigtimedwait()
  */
-#if (defined(AIX) && !defined(AIX4_3_PLUS)) || defined(LINUX) \
+#if (defined(AIX) && !defined(AIX4_3_PLUS)) || (defined(LINUX) && !defined(__GLIBC__)) \
 	|| defined(FREEBSD) || defined(NETBSD) || defined(OPENBSD) \
 	|| defined(BSDI) || defined(VMS) || defined(UNIXWARE) \
 	|| defined(DARWIN)
@@ -228,7 +239,7 @@
 #define PT_PRIO_MAX            sched_get_priority_max(SCHED_OTHER)
 #endif /* defined(_PR_DCETHREADS) */
 
-#elif defined(LINUX) || defined(FREEBSD)
+#elif defined(LINUX) || defined(__GNU__) || defined(__GLIBC__) || defined(FREEBSD)
 #define PT_PRIO_MIN            sched_get_priority_min(SCHED_OTHER)
 #define PT_PRIO_MAX            sched_get_priority_max(SCHED_OTHER)
 #elif defined(NTO)
@@ -280,7 +291,7 @@
 		onemillisec.tv_nsec = 1000000L;			\
         nanosleep(&onemillisec,NULL);			\
     PR_END_MACRO
-#elif defined(HPUX) || defined(LINUX) || defined(SOLARIS) \
+#elif defined(HPUX) || defined(LINUX) || defined(__GNU__) || defined(__GLIBC__) || defined(SOLARIS) \
 	|| defined(FREEBSD) || defined(NETBSD) || defined(OPENBSD) \
 	|| defined(BSDI) || defined(NTO) || defined(DARWIN) \
 	|| defined(UNIXWARE)
diff -Nur nspr-4.4.1.old/mozilla/nsprpub/pr/include/md/_unixos.h nspr-4.4.1/mozilla/nsprpub/pr/include/md/_unixos.h
--- nspr-4.4.1.old/mozilla/nsprpub/pr/include/md/_unixos.h	2002-03-27 16:13:47.000000000 +0100
+++ nspr-4.4.1/mozilla/nsprpub/pr/include/md/_unixos.h	2004-07-28 01:38:17.000000000 +0200
@@ -43,7 +43,7 @@
  * Linux: FD_SETSIZE is defined in /usr/include/sys/select.h and should
  * not be redefined.
  */
-#if !defined(LINUX) && !defined(DARWIN) && !defined(NEXTSTEP)
+#if !defined(LINUX) && !defined(__GNU__) && !defined(__GLIBC__) && !defined(DARWIN) && !defined(NEXTSTEP)
 #ifndef FD_SETSIZE
 #define FD_SETSIZE  4096
 #endif
diff -Nur nspr-4.4.1.old/mozilla/nsprpub/pr/include/md/prosdep.h nspr-4.4.1/mozilla/nsprpub/pr/include/md/prosdep.h
--- nspr-4.4.1.old/mozilla/nsprpub/pr/include/md/prosdep.h	2001-10-26 06:55:42.000000000 +0200
+++ nspr-4.4.1/mozilla/nsprpub/pr/include/md/prosdep.h	2004-07-28 01:38:17.000000000 +0200
@@ -87,7 +87,7 @@
 #elif defined(IRIX)
 #include "md/_irix.h"
 
-#elif defined(LINUX)
+#elif defined(LINUX) || defined(__GNU__) || defined(__GLIBC__)
 #include "md/_linux.h"
 
 #elif defined(OSF1)
diff -Nur nspr-4.4.1.old/mozilla/nsprpub/pr/src/md/prosdep.c nspr-4.4.1/mozilla/nsprpub/pr/src/md/prosdep.c
--- nspr-4.4.1.old/mozilla/nsprpub/pr/src/md/prosdep.c	2001-10-26 06:55:48.000000000 +0200
+++ nspr-4.4.1/mozilla/nsprpub/pr/src/md/prosdep.c	2004-07-28 01:38:17.000000000 +0200
@@ -60,7 +60,7 @@
 
     /* Get page size */
 #ifdef XP_UNIX
-#if defined SUNOS4 || defined LINUX || defined BSDI || defined AIX \
+#if defined SUNOS4 || defined LINUX || defined __GNU__ || defined __GLIBC__ || defined BSDI || defined AIX \
         || defined FREEBSD || defined NETBSD || defined OPENBSD \
         || defined DARWIN || defined NEXTSTEP
     _pr_pageSize = getpagesize();
diff -Nur nspr-4.4.1.old/mozilla/nsprpub/pr/src/md/unix/unix.c nspr-4.4.1/mozilla/nsprpub/pr/src/md/unix/unix.c
--- nspr-4.4.1.old/mozilla/nsprpub/pr/src/md/unix/unix.c	2002-12-12 00:03:31.000000000 +0100
+++ nspr-4.4.1/mozilla/nsprpub/pr/src/md/unix/unix.c	2004-07-28 01:38:17.000000000 +0200
@@ -65,7 +65,7 @@
  * PRInt32* pointer to a _PRSockLen_t* pointer.
  */
 #if defined(HAVE_SOCKLEN_T) \
-    || (defined(LINUX) && defined(__GLIBC__) && __GLIBC__ >= 2)
+    || (defined(__GLIBC__) && __GLIBC__ >= 2)
 #define _PRSockLen_t socklen_t
 #elif defined(IRIX) || defined(HPUX) || defined(OSF1) || defined(SOLARIS) \
     || defined(AIX4_1) || defined(LINUX) || defined(SONY) \
diff -Nur nspr-4.4.1.old/mozilla/nsprpub/pr/src/md/unix/uxproces.c nspr-4.4.1/mozilla/nsprpub/pr/src/md/unix/uxproces.c
--- nspr-4.4.1.old/mozilla/nsprpub/pr/src/md/unix/uxproces.c	2002-01-23 02:10:41.000000000 +0100
+++ nspr-4.4.1/mozilla/nsprpub/pr/src/md/unix/uxproces.c	2004-07-28 01:38:17.000000000 +0200
@@ -89,7 +89,7 @@
  * that can share the virtual address space and file descriptors.
  */
 #if (defined(IRIX) && !defined(_PR_PTHREADS)) \
-        || (defined(LINUX) && defined(_PR_PTHREADS))
+        || ((defined(LINUX) || defined(__GNU__) || defined(__GLIBC__)) && defined(_PR_PTHREADS))
 #define _PR_SHARE_CLONES
 #endif
 
@@ -103,7 +103,7 @@
  */
 
 #if defined(_PR_GLOBAL_THREADS_ONLY) \
-	|| (defined(_PR_PTHREADS) && !defined(LINUX))
+	|| (defined(_PR_PTHREADS) && !defined(LINUX) && !defined(__GNU__) && !defined(__GLIBC__))
 #define _PR_NATIVE_THREADS
 #endif
 
diff -Nur nspr-4.4.1.old/mozilla/nsprpub/pr/src/md/unix/uxrng.c nspr-4.4.1/mozilla/nsprpub/pr/src/md/unix/uxrng.c
--- nspr-4.4.1.old/mozilla/nsprpub/pr/src/md/unix/uxrng.c	2002-06-14 05:24:33.000000000 +0200
+++ nspr-4.4.1/mozilla/nsprpub/pr/src/md/unix/uxrng.c	2004-07-28 01:38:17.000000000 +0200
@@ -135,7 +135,7 @@
     return 0;
 }
 
-#elif (defined(LINUX) || defined(FREEBSD) || defined(NETBSD) || defined(OPENBSD))
+#elif (defined(LINUX) || defined(KFREEBSD) || defined(KNETBSD) || defined(OPENBSD))
 #include <sys/types.h>
 #include <sys/stat.h>
 #include <fcntl.h>
diff -Nur nspr-4.4.1.old/mozilla/nsprpub/pr/src/misc/prnetdb.c nspr-4.4.1/mozilla/nsprpub/pr/src/misc/prnetdb.c
--- nspr-4.4.1.old/mozilla/nsprpub/pr/src/misc/prnetdb.c	2003-04-30 02:44:16.000000000 +0200
+++ nspr-4.4.1/mozilla/nsprpub/pr/src/misc/prnetdb.c	2004-07-28 01:38:17.000000000 +0200
@@ -105,7 +105,7 @@
 #define _PR_HAVE_GETPROTO_R_INT
 #endif
 
-#if (defined(LINUX) && defined(__GLIBC__) && __GLIBC__ >= 2)
+#if (defined(__GLIBC__) && __GLIBC__ >= 2)
 #define _PR_HAVE_GETPROTO_R
 #define _PR_HAVE_5_ARG_GETPROTO_R
 #endif
diff -Nur nspr-4.4.1.old/mozilla/nsprpub/pr/src/pthreads/ptio.c nspr-4.4.1/mozilla/nsprpub/pr/src/pthreads/ptio.c
--- nspr-4.4.1.old/mozilla/nsprpub/pr/src/pthreads/ptio.c	2003-07-15 00:12:19.000000000 +0200
+++ nspr-4.4.1/mozilla/nsprpub/pr/src/pthreads/ptio.c	2004-07-28 01:38:17.000000000 +0200
@@ -200,7 +200,7 @@
 #if defined(SOLARIS)
 #define _PRSockOptVal_t char *
 #elif defined(IRIX) || defined(OSF1) || defined(AIX) || defined(HPUX) \
-    || defined(LINUX) || defined(FREEBSD) || defined(BSDI) || defined(VMS) \
+    || defined(LINUX) || defined(__GNU__) || defined(__GLIBC__) || defined(FREEBSD) || defined(BSDI) || defined(VMS) \
     || defined(NTO) || defined(OPENBSD) || defined(DARWIN) \
     || defined(UNIXWARE)
 #define _PRSockOptVal_t void *
@@ -214,7 +214,7 @@
 #define _PRSelectFdSetArg_t void *
 #elif defined(IRIX) || (defined(AIX) && !defined(AIX4_1)) \
     || defined(OSF1) || defined(SOLARIS) \
-    || defined(HPUX10_30) || defined(HPUX11) || defined(LINUX) \
+    || defined(HPUX10_30) || defined(HPUX11) || defined(LINUX) || defined(__GNU__) || defined(__GLIBC__) \
     || defined(FREEBSD) || defined(NETBSD) || defined(OPENBSD) \
     || defined(BSDI) || defined(VMS) || defined(NTO) || defined(DARWIN) \
     || defined(UNIXWARE)
@@ -298,7 +298,7 @@
  * most current systems.
  */
 #if defined(HAVE_SOCKLEN_T) \
-    || (defined(LINUX) && defined(__GLIBC__) && __GLIBC__ >= 2)
+    || (defined(__GLIBC__) && __GLIBC__ >= 2)
 typedef socklen_t pt_SockLen;
 #elif (defined(AIX) && !defined(AIX4_1)) \
     || defined(VMS)
@@ -354,14 +354,14 @@
     int nbytes_to_send;                     /* size of header and file */
 #endif  /* SOLARIS */
 
-#ifdef LINUX
+#if defined(LINUX) || defined(__GNU__) || defined(__GLIBC__)
     /*
      * For sendfile()
      */
     int in_fd;                              /* descriptor of file to send */
     off_t offset;
     size_t count;
-#endif  /* LINUX */
+#endif  /* LINUX || __GNU__ || __GLIBC__ */
  
     PRIntervalTime timeout;                 /* client (relative) timeout */
 
@@ -3252,7 +3252,7 @@
 };
 
 #if defined(HPUX) || defined(OSF1) || defined(SOLARIS) || defined (IRIX) \
-    || defined(AIX) || defined(LINUX) || defined(FREEBSD) || defined(NETBSD) \
+    || defined(AIX) || defined(LINUX) || defined(__GNU__) || defined(__GLIBC__) || defined(FREEBSD) || defined(NETBSD) \
     || defined(OPENBSD) || defined(BSDI) || defined(VMS) || defined(NTO) \
     || defined(DARWIN) || defined(UNIXWARE)
 #define _PR_FCNTL_FLAGS O_NONBLOCK
@@ -4732,7 +4732,7 @@
 
 #include <sys/types.h>
 #include <sys/time.h>
-#if !defined(SUNOS4) && !defined(HPUX) && !defined(LINUX)
+#if !defined(SUNOS4) && !defined(HPUX) && !defined(LINUX) && !defined(__GNU__) && !defined(__GLIBC__)
 #include <sys/select.h>
 #endif
 
diff -Nur nspr-4.4.1.old/mozilla/nsprpub/pr/tests/Makefile.in nspr-4.4.1/mozilla/nsprpub/pr/tests/Makefile.in
--- nspr-4.4.1.old/mozilla/nsprpub/pr/tests/Makefile.in	2003-05-14 03:24:06.000000000 +0200
+++ nspr-4.4.1/mozilla/nsprpub/pr/tests/Makefile.in	2004-07-28 01:38:17.000000000 +0200
@@ -370,8 +370,8 @@
     EXTRA_LIBS = -lsocket -lnsl -lgen -lresolv
 endif
 
-ifeq ($(OS_ARCH), Linux)
-    ifeq ($(OS_RELEASE), 1.2)
+ifneq (,$(findstring $(OS_ARCH),Linux GNU))
+    ifeq ($(OS_ARCH)-$(OS_RELEASE), Linux-1.2)
         EXTRA_LIBS = -ldl
     else
         LDOPTS += -Xlinker -rpath $(ABSOLUTE_LIB_DIR)
@@ -542,7 +542,7 @@
 endif
 endif
 
-ifeq ($(OS_TARGET),Linux)
+ifneq (,$(findstring $(OS_TARGET),Linux GNU))
 ECHO = /bin/echo
 endif
 
