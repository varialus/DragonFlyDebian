Author: Robert Millan <rmh@debian.org>
Status: not-sent-upstream
Description:
 Use expect to set a timeout on tests, to avoid them hanging indefinitely.

Index: b/timeout
===================================================================
--- /dev/null
+++ b/timeout
@@ -0,0 +1,8 @@
+#!/bin/sh
+if test -e $1 ; then
+  expect << EOF
+set timeout 30
+eval spawn `pwd`/$1 $2
+expect
+EOF
+fi
Index: b/Makefile
===================================================================
--- a/Makefile
+++ b/Makefile
@@ -46,7 +46,11 @@ TIMEOUT = $(top_builddir)/t0 $(TIMEOUT_V
 all: build-tests run-tests 
 
 build-tests: $(BUILD_TESTS:.c=.test)
-run-tests: $(RUN_TESTS:.test=.run-test)
+run-tests:
+	-chmod 755 timeout
+	for i in $(RUN_TESTS); do \
+		./timeout $$i; \
+	done
 
 functional-tests: functional-make functional-run
 stress-tests: stress-make stress-run
Index: b/functional/mqueues/run.sh
===================================================================
--- a/functional/mqueues/run.sh
+++ b/functional/mqueues/run.sh
@@ -12,7 +12,7 @@ RunTest()
 {
 	echo "TEST: " $1
 	TOTAL=$TOTAL+1
-	./$1
+	../../timeout $1
 	if [ $? == 0 ]; then
 		PASS=$PASS+1
 		echo -ne "\t\t\t***TEST PASSED***\n\n"
Index: b/functional/semaphores/run.sh
===================================================================
--- a/functional/semaphores/run.sh
+++ b/functional/semaphores/run.sh
@@ -12,7 +12,7 @@ RunTest()
 {
 	echo "TEST: " $1
 	TOTAL=$TOTAL+1
-	./$1
+	../../timeout $1
 	if [ $? == 0 ]; then
 		PASS=$PASS+1
 		echo -ne "\t\t\t***TEST PASSED***\n\n"
Index: b/functional/threads/pi_test/run.sh
===================================================================
--- a/functional/threads/pi_test/run.sh
+++ b/functional/threads/pi_test/run.sh
@@ -21,7 +21,7 @@ Run()
 {
         echo "TEST: " $1
         TOTAL=$TOTAL+1
-        ./$1 > output.$1
+        ../../timeout $1 > output.$1
         if [ $? == 0 ]; then
                 PASS=$PASS+1
                 echo -ne "\t\t\t***TEST PASSED***\n\n"
Index: b/functional/threads/robust_test/run.sh
===================================================================
--- a/functional/threads/robust_test/run.sh
+++ b/functional/threads/robust_test/run.sh
@@ -7,7 +7,7 @@ Run()
 {
         echo "TEST: " $1
         TOTAL=$TOTAL+1
-        ./$1
+        ../../timeout $1
         if [ $? == 0 ]; then
                 PASS=$PASS+1
                 echo -ne "\t\t\t***TEST PASSED***\n\n"
Index: b/stress/mqueues/run.sh
===================================================================
--- a/stress/mqueues/run.sh
+++ b/stress/mqueues/run.sh
@@ -12,7 +12,7 @@ RunTest()
 {
 	echo "TEST: " $1 $2
 	TOTAL=$TOTAL+1
-	./$1 $2
+	../../timeout $1 $2
 	if [ $? == 0 ]; then
 		PASS=$PASS+1
 		echo -ne "\t\t\t***TEST PASSED***\n\n"
Index: b/stress/semaphores/run.sh
===================================================================
--- a/stress/semaphores/run.sh
+++ b/stress/semaphores/run.sh
@@ -12,7 +12,7 @@ RunTest()
 {
 	echo "TEST: " $1 $2
 	TOTAL=$TOTAL+1
-	./$1 $2
+	../../timeout $1 $2
 	if [ $? == 0 ]; then
 		PASS=$PASS+1
 		echo -ne "\t\t\t***TEST PASSED***\n\n"
